import{r as p,j as e,B as ye,o as ue,s as ut,R as jt,u as Pn,d as on,A as Fn,a as Nn}from"./supabase.js";function Dt(){const[i,s]=p.useState(null),[t,r]=p.useState(!0);return p.useEffect(()=>{var C;let g=!1;(()=>{try{const v=[];for(let I=0;I<localStorage.length;I++){const b=localStorage.key(I);b&&b.startsWith("sb-")&&v.push(b)}v.forEach(I=>localStorage.removeItem(I))}catch(v){console.warn("âš ï¸ Failed to clear cached session data:",v)}})(),(async()=>{var v,I,b;try{const F=await((v=window.electronAPI)==null?void 0:v.authGetSession()),_=((b=(I=F==null?void 0:F.data)==null?void 0:I.session)==null?void 0:b.user)||null;s(_||null)}catch(F){console.error("âŒ Failed to get initial session:",F),s(null)}})(),(async()=>{var v;try{await((v=window.electronAPI)==null?void 0:v.authSetupListener())}catch(I){console.error("âŒ Failed to setup auth listener:",I)}})();const y=({event:v,session:I})=>{s(v==="INITIAL_SESSION"&&!I?null:(I==null?void 0:I.user)??null),g||(r(!1),g=!0),window.electronAPI&&(window.electronAPI.setCurrentUser(I==null?void 0:I.user),window.electronAPI.setSupabaseSession(I)),v==="SIGNED_OUT"&&window.electronAPI&&(setTimeout(()=>{window.electronAPI.resetWindowSize()},300),setTimeout(()=>{window.electronAPI.resetWindowSize()},1e3))};(C=window.electronAPI)!=null&&C.onAuthStateChange?window.electronAPI.onAuthStateChange(y):console.error("âŒ onAuthStateChange method not available on window.electronAPI");const k=setTimeout(()=>{var v;g||(console.warn("âš ï¸ Auth state change timeout - falling back to session check"),(v=window.electronAPI)==null||v.authGetSession().then(I=>{var F,_;const b=((_=(F=I==null?void 0:I.data)==null?void 0:F.session)==null?void 0:_.user)||null;s(b),r(!1),g=!0}).catch(()=>{s(null),r(!1),g=!0}))},3e3);return()=>{clearTimeout(k)}},[]),{signIn:async(g,f)=>{var m;try{const c=await((m=window.electronAPI)==null?void 0:m.authSignIn(g,f));return c!=null&&c.error?{error:{message:c.error},data:null}:c}catch(c){return console.error("Sign-in error:",c),{error:{message:c.message||"Network error - please check your internet connection"},data:null}}},signUp:async(g,f)=>{var m;try{const c=await((m=window.electronAPI)==null?void 0:m.authSignUp(g,f));return c!=null&&c.error?{error:{message:c.error},data:null}:c}catch(c){return console.error("Sign-up error:",c),{error:{message:c.message||"Network error - please check your internet connection"},data:null}}},signOut:async()=>{var f;const g=await((f=window.electronAPI)==null?void 0:f.authSignOut());if(window.electronAPI)try{setTimeout(()=>{window.electronAPI.resetWindowSize()},100)}catch(m){console.warn("Failed to reset window size:",m)}if(g!=null&&g.error)throw new Error(g.error);return g},user:i,loading:t}}function Mn(){const[i,s]=p.useState(!1),[t,r]=p.useState(""),[n,l]=p.useState(""),a=async c=>{s(!0),r(c);try{const y=await window.electronAPI.generateReport(c);if(typeof y=="string"){const k={text:y,tokens:{input:0,output:0,total:0}};return l(y),k}else return l(y.text),y}catch(y){throw console.error("ðŸ” generateReport error:",y),y}finally{s(!1)}},g=async c=>await window.electronAPI.readPrompt(c);return{generateReport:a,loading:i,debugPrompt:t,debugResult:n,generateReportFromTemplates:async(c,y,k)=>{const C=Date.now();let v={input:0,output:0,total:0};try{let I=k;if(!I){const K=await g("classify"),B=await a(K.replace("{{FINDINGS}}",c||""));I=B.text.trim(),v.input+=B.tokens.input,v.output+=B.tokens.output,v.total+=B.tokens.total}const b=y[I];if(!b||!b.template||!b.generate_prompt)return{error:!0,message:`âŒ No valid template or prompt found for: ${I}`};const F=b.template||"",R=(b.generate_prompt||"").replace("{{STUDY_TYPE}}",I||"").replace("{{TEMPLATE}}",F||"").replace("{{FINDINGS}}",c||"").replace(/{{[^}]+}}/g,""),W=await a(R);v.input+=W.tokens.input,v.output+=W.tokens.output,v.total+=W.tokens.total;const ne=((Date.now()-C)/1e3).toFixed(1);return{template:F,result:W.text,studyType:I,generationTime:ne,totalTokens:v}}catch{return{error:!0,message:"âŒ Report generation failed. See console for details."}}},generateImpressionFromTemplates:async(c,y,k)=>{const C=Date.now();let v={input:0,output:0,total:0};try{let I=k;if(!I){const K=await g("classify"),B=await a(K.replace("{{FINDINGS}}",c||""));I=B.text.trim(),v.input+=B.tokens.input,v.output+=B.tokens.output,v.total+=B.tokens.total}const b=y[I];if(!b||!b.template||!b.generate_impression)return{error:!0,message:`âŒ No valid impression template found for: ${I}`};const F=b.template||"",R=(b.generate_impression||"").replace("{{STUDY_TYPE}}",I||"").replace("{{TEMPLATE}}",F||"").replace("{{FINDINGS}}",c||"").replace(/{{[^}]+}}/g,""),W=await a(R);v.input+=W.tokens.input,v.output+=W.tokens.output,v.total+=W.tokens.total;const ne=((Date.now()-C)/1e3).toFixed(1);return{template:F,result:W.text,studyType:I,generationTime:ne,totalTokens:v}}catch{return{error:!0,message:"âŒ Impression generation failed. See console for details."}}}}}function On(i,s,t){var l;console.log("ðŸ” BuildPrompt received agent_logic:",JSON.stringify(t,null,2));let r=`You are an expert radiologist generating a comprehensive radiology report.

`;s&&(r+=`TEMPLATE STRUCTURE - You MUST follow this exact structure:

`,r+=s+`

`,r+=`IMPORTANT: Preserve ALL section headers (text ending with ":") EXACTLY as shown above. Do not add, remove, or modify any section headers.

`),r+=`IMPORTANT: The following imaging findings have been identified and MUST be incorporated into the report. Do not omit any findings:

`,r+=`=== FINDINGS TO INCORPORATE ===
`,r+=i+`
`,r+=`=== END OF FINDINGS ===

`;const n=[];if(t.formatting&&(t.formatting.preserve_template_punctuation&&n.push("Preserve all punctuation and formatting exactly as shown in the template."),t.formatting.use_bullet_points&&n.push("Use bullet points for listing multiple findings within each section."),t.formatting.capitalize_sections&&n.push("Ensure all section headers are in UPPERCASE.")),t.report&&(t.report.no_hallucinated_findings&&n.push("Do not invent findings. Only report what is explicitly stated in the findings."),n.push('CRITICAL: You must incorporate ALL the findings provided between the "=== FINDINGS TO INCORPORATE ===" markers into the appropriate sections of the report. Do not omit any findings.'),n.push("SECTION HEADERS: You MUST preserve ALL section headers exactly as shown in the template (e.g., FINDINGS:, IMPRESSION:, etc.). Do not add, remove, or modify any section headers."),n.push("SECTION CONTENT: While section headers must be preserved exactly, the content within each section can be written in a natural, fluid manner based on the findings provided."),t.report.include_technique_section&&n.push("Include a TECHNIQUE section describing the imaging protocol used."),t.report.include_comparison&&n.push("Include a COMPARISON section if prior imaging is mentioned."),t.report.use_medical_abbreviations&&n.push("Use standard medical abbreviations where appropriate."),t.report.expand_lesions&&n.push("For each lesion, describe location, size, morphology, and enhancement characteristics."),t.report.cartilage_placement&&(t.report.cartilage_placement.trochlear_cartilage_in_patellofemoral&&n.push("Ensure trochlear cartilage findings are included in the patellofemoral compartment."),t.report.cartilage_placement.mention_patellar_if_trochlear_defect_present&&n.push("If a trochlear defect is present, confirm that the patellar cartilage is explicitly stated as intact or abnormal.")),t.report.anatomic_routing_rules&&(console.log("ðŸ” Processing anatomic_routing_rules:",t.report.anatomic_routing_rules),t.report.anatomic_routing_rules.loose_bodies==="joints"&&n.push("Describe loose bodies under the joints section."),t.report.anatomic_routing_rules.bone_contusions==="ossea_or_bone_marrow"&&n.push("Describe bone contusions under the osseous structures or bone marrow section."),t.report.anatomic_routing_rules.joint_effusions==="joint_space"&&n.push("Describe joint effusions under the joint space section."))),t.impression){if(t.impression.numerically_itemized&&n.push("IMPRESSION FORMAT: Write the impression section as a numbered list (1, 2, 3, etc.)."),t.impression.omit_minor_or_incidental_findings_unless_relevant&&n.push("In the impression, omit mild or incidental findings unless relevant to the clinical history."),t.impression.concise_summary&&n.push("Keep the impression concise, focusing on clinically significant findings."),t.impression.include_recommendations&&n.push("Include follow-up recommendations when appropriate."),t.impression.differential_diagnosis&&n.push("Provide differential diagnoses for significant findings when appropriate."),t.impression.first_item_should_address_clinical_concern&&n.push("The first impression item should address the clinical concern."),t.impression.exclude_by_default&&Array.isArray(t.impression.exclude_by_default)){console.log("ðŸ” Processing exclude_by_default:",t.impression.exclude_by_default);const a=t.impression.exclude_by_default.join(", ");n.push(`Do not include the following EXACT phrases unless clinically relevant: ${a}. Note: Only exclude the EXACT phrases listed - similar but different findings should still be included.`)}t.impression.mention_muscle_atrophy_if&&(console.log("ðŸ” Processing mention_muscle_atrophy_if:",t.impression.mention_muscle_atrophy_if),t.impression.mention_muscle_atrophy_if==="moderate_or_severe"&&n.push("Only mention muscle atrophy if it is moderate or severe."))}return t.anatomy&&(t.anatomy.combine_meniscus_and_cartilage_findings&&n.push("Combine meniscus and cartilage findings in the same section for better organization."),t.anatomy.group_by_anatomic_region&&n.push("Group findings by anatomic region (e.g., anterior, posterior, medial, lateral)."),t.anatomy.describe_bilateral_structures&&n.push("For bilateral structures, describe each side separately and note any asymmetry.")),t.clinical&&(t.clinical.correlate_with_symptoms&&n.push("Correlate findings with clinical symptoms when provided."),t.clinical.mention_clinical_significance&&n.push("Comment on the clinical significance of major findings.")),t.measurements&&(t.measurements.include_all_measurements&&n.push("Include all measurements mentioned in the findings."),t.measurements.use_metric_system&&n.push("Use metric system (mm, cm) for all measurements."),t.measurements.describe_change_from_prior&&n.push("When prior measurements are available, describe interval change.")),t.severity&&(t.severity.use_standard_grading&&n.push("Use standard grading systems (e.g., mild/moderate/severe) consistently."),t.severity.avoid_vague_terms&&n.push('Avoid vague terms like "some" or "several" - be specific.')),t.style&&(t.style.active_voice&&n.push("Use active voice when describing findings."),t.style.avoid_hedging&&n.push("Avoid excessive hedging language unless uncertainty is clinically relevant."),t.style.professional_tone&&n.push("Maintain a professional, objective tone throughout.")),t.custom_instructions&&(Array.isArray(t.custom_instructions)?n.push(...t.custom_instructions):typeof t.custom_instructions=="string"&&n.push(t.custom_instructions)),n.length>0?(console.log(`ðŸ” Generated ${n.length} instructions from agent_logic:`,n),r+=`Instructions:
`,n.forEach((a,g)=>{r+=`${g+1}. ${a}
`}),r+=`
`):console.log("âš ï¸ No instructions generated from agent_logic"),t.examples&&Array.isArray(t.examples)&&(r+=`Examples:
`,t.examples.forEach((a,g)=>{a.context?r+=`Example ${g+1} (${a.context}):
`:r+=`Example ${g+1}:
`,a.input&&(r+=`Input: ${a.input}
`),a.output&&(r+=`Output: ${a.output}
`),r+=`
`})),r+=`Generate a complete radiology report following these requirements:
`,r+=`1. Use the EXACT section headers from the template (preserve all text ending with ":")
`,r+=`2. Fill each section with appropriate content based on the findings provided
`,r+=`3. Incorporate ALL findings from the "=== FINDINGS TO INCORPORATE ===" section
`,r+=`4. Write fluid, natural content within each section while maintaining clinical accuracy
`,r+=`5. Do NOT add, remove, or modify any section headers from the template
`,(l=t.impression)!=null&&l.numerically_itemized?r+=`6. Format the IMPRESSION section as a numbered list (1, 2, 3, etc.)
`:r+=`6. Write the IMPRESSION section in paragraph form with clear, concise statements
`,r}function Dn(i,s,t){var g,f,m;console.log("ðŸ” BuildEnhancedPrompt received agent_logic:",JSON.stringify(t,null,2));let r=`You are an expert radiologist generating a comprehensive radiology report.

`;s&&(r+=`TEMPLATE STRUCTURE - MANDATORY COMPLIANCE:

`,r+=s+`

`,r+=`CRITICAL: Preserve ALL section headers (text ending with ":") EXACTLY as shown above. Any deviation from the template structure will be considered an error.

`,r+=`CRITICAL SPACING RULE: Always include a space after colons in section headers (e.g., "Neurovascular structures: Unremarkable" NOT "Neurovascular structures:Unremarkable"). This spacing is mandatory and must be preserved exactly as shown in the template.

`),r+=`MANDATORY FINDINGS INCORPORATION:

`,r+=`=== FINDINGS TO INCORPORATE ===
`,r+=i+`
`,r+=`=== END OF FINDINGS ===

`,r+=`CRITICAL REQUIREMENT: Every single finding above MUST appear in the appropriate section of your report. Omitting any finding is unacceptable.

`;const n=[],l=[],a=[];if(t.impression){if(t.impression.numerically_itemized?(n.push("IMPRESSION FORMATTING: The impression section MUST be formatted as a numbered list (1, 2, 3, etc.). This is non-negotiable."),n.push("IMPRESSION SPACING: Separate each numbered item with a double line break.")):(g=t.formatting)!=null&&g.use_bullet_points?(n.push("IMPRESSION FORMATTING: The impression section MUST be formatted as a bullet point list using â€¢ symbols."),n.push("IMPRESSION SPACING: Separate each bullet point with a double line break."),n.push('BULLET FORMAT: Start each item with "â€¢ " followed by the diagnosis/finding.')):l.push("IMPRESSION SPACING: Write the impression as separate statements, each separated by a double line break."),t.impression.exclude_by_default&&Array.isArray(t.impression.exclude_by_default)&&t.impression.exclude_by_default.length>0){const y=t.impression.exclude_by_default.map(k=>k.replace(/_/g," ").toLowerCase());n.push("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),n.push("âš ï¸ MANDATORY EXCLUSION RULES FOR IMPRESSION:"),y.forEach(k=>{n.push(`âŒ DO NOT include "${k}" in the impression section`)}),y.some(k=>k.includes("baker"))&&n.push(`âŒ SPECIFICALLY: Never mention "Small Baker's cyst" or any small Baker cyst in the impression`),n.push("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),n.push("These exclusions are MANDATORY unless causing active symptoms.")}t.impression.first_item_should_address_clinical_concern&&n.push("CLINICAL FOCUS: The first item in the impression MUST directly address the primary clinical concern or indication."),t.impression.omit_minor_or_incidental_findings_unless_relevant&&a.push("Focus the impression on clinically significant findings. Omit mild or incidental findings unless they relate to the clinical history."),t.impression.concise_summary&&a.push("Keep the impression concise and focused on the most important findings."),t.impression.include_recommendations&&a.push("Include specific follow-up recommendations when clinically appropriate."),t.impression.mention_muscle_atrophy_if&&(console.log("ðŸ” Processing mention_muscle_atrophy_if:",t.impression.mention_muscle_atrophy_if),t.impression.mention_muscle_atrophy_if==="moderate_or_severe"?n.push("MUSCLE ATROPHY RULE: Only mention muscle atrophy if it is explicitly described as moderate or severe. Do not mention mild muscle atrophy."):t.impression.mention_muscle_atrophy_if==="severe"?n.push("MUSCLE ATROPHY RULE: Only mention muscle atrophy if it is explicitly described as severe. Do not mention mild or moderate muscle atrophy."):t.impression.mention_muscle_atrophy_if==="never"&&n.push("MUSCLE ATROPHY RULE: Do NOT mention muscle atrophy regardless of severity."))}return t.formatting&&(t.formatting.preserve_template_punctuation&&n.push('CRITICAL: Preserve ALL punctuation, spacing, and formatting EXACTLY as shown in the template. This includes spaces after colons (e.g., "Section: Content" not "Section:Content"), proper line breaks, and all other spacing.'),t.formatting.use_bullet_points&&l.push("Use bullet points for listing multiple findings within each section."),t.formatting.capitalize_sections&&l.push("Ensure all section headers are in UPPERCASE.")),t.report&&(t.report.no_hallucinated_findings&&n.push("ACCURACY RULE: Do not invent, assume, or hallucinate any findings. Only report what is explicitly stated in the provided findings."),t.report.cartilage_placement&&(t.report.cartilage_placement.trochlear_cartilage_in_patellofemoral&&n.push("CARTILAGE PLACEMENT: Trochlear cartilage findings MUST be described within the patellofemoral compartment section."),t.report.cartilage_placement.mention_patellar_if_trochlear_defect_present&&n.push("CARTILAGE CORRELATION: If any trochlear defect is present, you MUST explicitly state the condition of the patellar cartilage (intact or abnormal).")),t.report.expand_lesions&&a.push("For each lesion, describe location, size, morphology, and enhancement characteristics when available.")),t.clinical&&(t.clinical.correlate_with_symptoms&&a.push("Correlate findings with clinical symptoms when clinical history is provided."),t.clinical.mention_clinical_significance&&a.push("Comment on the clinical significance of major findings.")),t.measurements&&(t.measurements.include_all_measurements&&l.push("Include all measurements mentioned in the findings."),t.measurements.use_metric_system&&l.push("Use metric system (mm, cm) for all measurements.")),t.anatomy&&(t.anatomy.combine_meniscus_and_cartilage_findings&&a.push("Combine meniscus and cartilage findings in the same section for better organization."),t.anatomy.group_by_anatomic_region&&a.push("Group findings by anatomic region (e.g., anterior, posterior, medial, lateral).")),t.severity&&(t.severity.use_standard_grading&&l.push("Use standard grading systems (e.g., mild/moderate/severe) consistently."),t.severity.avoid_vague_terms&&l.push('Avoid vague terms like "some" or "several" - be specific.')),t.style&&(t.style.active_voice&&a.push("Use active voice when describing findings."),t.style.professional_tone&&a.push("Maintain a professional, objective tone throughout.")),t.custom_instructions&&(Array.isArray(t.custom_instructions)?t.custom_instructions.forEach(c=>{n.push(`CUSTOM RULE: ${c}`)}):typeof t.custom_instructions=="string"&&n.push(`CUSTOM RULE: ${t.custom_instructions}`)),n.length>0&&(r+=`CRITICAL RULES - MUST BE FOLLOWED:
`,n.forEach((c,y)=>{r+=`${y+1}. ${c}
`}),r+=`
`),l.length>0&&(r+=`FORMATTING REQUIREMENTS:
`,l.forEach((c,y)=>{r+=`${y+1}. ${c}
`}),r+=`
`),a.length>0&&(r+=`CONTENT GUIDELINES:
`,a.forEach((c,y)=>{r+=`${y+1}. ${c}
`}),r+=`
`),t.examples&&Array.isArray(t.examples)&&(r+=`EXAMPLES:
`,t.examples.forEach((c,y)=>{c.context?r+=`Example ${y+1} (${c.context}):
`:r+=`Example ${y+1}:
`,c.input&&(r+=`Input: ${c.input}
`),c.output&&(r+=`Output: ${c.output}
`),r+=`
`})),r+=`FINAL REQUIREMENTS:
`,r+=`1. Use the EXACT section headers from the template (preserve all text ending with ":")
`,r+=`2. Incorporate EVERY SINGLE finding from the "=== FINDINGS TO INCORPORATE ===" section
`,r+=`3. Follow ALL critical rules above without exception
`,r+=`4. Apply formatting requirements consistently
`,r+=`5. Write natural, clinically accurate content within each section
`,(f=t.impression)!=null&&f.numerically_itemized?r+=`6. IMPRESSION FORMATTING: Use numbered list format (1, 2, 3, etc.) with double line breaks between items.
`:(m=t.formatting)!=null&&m.use_bullet_points?r+=`6. IMPRESSION FORMATTING: Use bullet point format (â€¢ symbol) with double line breaks between items.
`:r+=`6. IMPRESSION FORMATTING: Use paragraph format with double line breaks between separate statements.
`,r+=`
Generate the complete radiology report now. Focus on accuracy and proper formatting as specified above.
`,console.log("ðŸš¨ Enhanced prompt generated with prioritized rules"),console.log(`Critical rules: ${n.length}, Formatting rules: ${l.length}, Content rules: ${a.length}`),r}function un(i,s,t){var c,y,k,C,v,I;const r=[],n=[];console.log("ðŸ” Validating generated report against logic rules...");const a=(b=>{const F=b.match(/IMPRESSION:?\s*([\s\S]*?)(?:\n\n|\n[A-Z]+:|$)/i);return F?F[1].trim():""})(i);if(console.log("ðŸ“ Extracted impression:",a.substring(0,200)+"..."),(c=t.impression)!=null&&c.numerically_itemized&&(/^\s*\d+\./.test(a)||/\n\s*\d+\./.test(a)||r.push("IMPRESSION FORMATTING: Report should use numbered list format (1, 2, 3, etc.) but does not.")),(y=t.impression)!=null&&y.exclude_by_default&&Array.isArray(t.impression.exclude_by_default))for(const b of t.impression.exclude_by_default){const F=b.toLowerCase().trim(),_=a.toLowerCase();new RegExp("\\b"+F.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"\\b","i").test(a)&&(_.includes("significant")||_.includes("severe")||_.includes("moderate")||_.includes("concerning")||_.includes("large")||_.includes("extensive")||r.push(`EXCLUSION RULE VIOLATION: "${b}" appears in impression but should be excluded unless clinically relevant.`))}if((k=t.impression)!=null&&k.mention_muscle_atrophy_if&&a.toLowerCase().includes("muscle")&&(a.toLowerCase().includes("atrophy")||a.toLowerCase().includes("atrophic"))&&(t.impression.mention_muscle_atrophy_if==="moderate_or_severe"?a.toLowerCase().includes("mild")&&a.toLowerCase().includes("muscle")&&r.push("MUSCLE ATROPHY RULE VIOLATION: Mild muscle atrophy mentioned but rule specifies only moderate/severe should be included."):t.impression.mention_muscle_atrophy_if==="severe"&&(a.toLowerCase().includes("mild")||a.toLowerCase().includes("moderate"))&&a.toLowerCase().includes("muscle")&&r.push("MUSCLE ATROPHY RULE VIOLATION: Mild/moderate muscle atrophy mentioned but rule specifies only severe should be included.")),(C=t.report)!=null&&C.no_hallucinated_findings){const b=[/\d+\.\d+ cm/g,/\d+\.\d+ mm/g,/grade [IV]+/gi];for(const F of b)if(F.test(i)&&!F.test(s)){n.push("POTENTIAL HALLUCINATION: Report contains specific details that may not be in original findings.");break}}const g=s.toLowerCase().match(/\b(tear|defect|lesion|edema|effusion|contusion|sprain|strain|fracture|abnormal|mass|cyst)\b/g)||[],f=i.toLowerCase();for(const b of[...new Set(g)])f.includes(b)||r.push(`FINDINGS INCORPORATION: Important finding "${b}" from original findings may not be incorporated into report.`);if((I=(v=t.report)==null?void 0:v.cartilage_placement)!=null&&I.mention_patellar_if_trochlear_defect_present&&i.toLowerCase().includes("trochlear")&&(i.toLowerCase().includes("defect")||i.toLowerCase().includes("tear")||i.toLowerCase().includes("lesion"))&&(i.toLowerCase().includes("patellar")||r.push("CARTILAGE PLACEMENT RULE VIOLATION: Trochlear defect mentioned but patellar cartilage status not addressed.")),t.custom_instructions&&Array.isArray(t.custom_instructions))for(const b of t.custom_instructions){const F=b.toLowerCase().match(/\b(acl|pcl|meniscus|cartilage|ligament|integrity|status)\b/g)||[];F.length>0&&(F.some(U=>i.toLowerCase().includes(U))||n.push(`CUSTOM INSTRUCTION: May not be followed - "${b.substring(0,50)}..."`))}const m=r.length===0;return console.log(`âœ… Validation complete: ${m?"PASSED":"FAILED"}`),console.log(`Violations: ${r.length}, Warnings: ${n.length}`),{passed:m,violations:r,warnings:n}}function rn(){return{LLAMACPP_OPENAI_BASE:{}.LLAMACPP_OPENAI_BASE||"http://127.0.0.1:8080/v1",LLAMACPP_MODEL:{}.LLAMACPP_MODEL||"mistral-7b-instruct-q4_k_m.gguf"}}class Ln{constructor(){this.name="Mistral (Local - llama.cpp)",this.supportsStreaming=!1}async health(){const{LLAMACPP_OPENAI_BASE:s}=rn();try{return(await fetch(`${s}/models`,{method:"GET",signal:AbortSignal.timeout(2e3)})).ok}catch{return!1}}async generate(s){var g,f,m;const{LLAMACPP_OPENAI_BASE:t}=rn(),r={model:"local-llamacpp",messages:[...s.system?[{role:"system",content:s.system}]:[],{role:"user",content:s.prompt}],temperature:s.temperature??.25,top_p:s.topP??.9,max_tokens:s.maxTokens??1200,stop:s.stop??[],frequency_penalty:.1,presence_penalty:.1},n=await fetch(`${t}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!n.ok){const c=await n.text();throw new Error(`llama.cpp error: ${n.status} ${n.statusText} - ${c}`)}const l=await n.json(),a=((m=(f=(g=l==null?void 0:l.choices)==null?void 0:g[0])==null?void 0:f.message)==null?void 0:m.content)??"";if(!a)throw new Error("llama.cpp returned empty content");return a}}async function Bn(){const i=new Ln;if(await i.health())return i;throw new Error(`llama.cpp server is not running.

To start the local AI server:
1. Ensure you have a Mistral model in ./models/ directory
2. Run: npm run llama:serve

The server must be running for local AI to work.`)}async function pn({prompt:i,model:s="gpt-4"}){var t;try{if(typeof window<"u"&&((t=window.electronAPI)!=null&&t.generateReport)){const r=await window.electronAPI.generateReport(i);if(typeof r=="string")return{text:r,tokens:{input:0,output:0,total:0}};if(r!=null&&r.text)return{text:r.text,tokens:r.tokens||{input:0,output:0,total:0}};throw new Error("Invalid response from model")}else return await zn(i,s)}catch(r){throw console.error("Error calling model:",r),r}}async function zn(i,s){const t=s.toLowerCase();if(t.includes("gpt")||t.includes("openai"))return await Un(i,s);if(t.includes("claude"))return await Wn(i,s);if(t.includes("gemini"))return await $n(i);if(t.includes("kimi"))return await Gn(i);if(t.includes("mistral-local")||t==="mistral-local")return await Hn(i);throw new Error(`Unsupported model: ${s}. Supported models: GPT-4, GPT-3.5-Turbo, Claude-3-Sonnet, Claude-3-Opus, Gemini, Kimi, Mistral-Local`)}async function Un(i,s){const t={}.OPENAI_API_KEY;if(!t)throw new Error("OPENAI_API_KEY not found in environment variables");let r="gpt-4o";(s.includes("3.5")||s.includes("turbo"))&&(r="gpt-3.5-turbo");const n=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:r,messages:[{role:"system",content:"You are a helpful radiology assistant."},{role:"user",content:i}],max_tokens:4096,temperature:.7})});if(!n.ok){const a=await n.text();throw new Error(`OpenAI API error: ${n.status} ${n.statusText} - ${a}`)}const l=await n.json();if(!l.choices||l.choices.length===0)throw new Error("No response from OpenAI API");return{text:l.choices[0].message.content||"No content in OpenAI response",tokens:l.usage?{input:l.usage.prompt_tokens||0,output:l.usage.completion_tokens||0,total:l.usage.total_tokens||0}:{input:0,output:0,total:0}}}async function Wn(i,s){const t={}.ANTHROPIC_API_KEY;if(!t)throw new Error("ANTHROPIC_API_KEY not found in environment variables");let r="claude-sonnet-4-20250514",n=4096;s.includes("opus")?(r="claude-opus-4-20250514",n=8192):s.includes("sonnet")&&(r="claude-sonnet-4-20250514",n=4096);const l=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":t,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:r,max_tokens:n,messages:[{role:"user",content:i}]})});if(!l.ok){const g=await l.text();throw new Error(`Anthropic API error: ${l.status} ${l.statusText} - ${g}`)}const a=await l.json();if(!a.content||a.content.length===0)throw new Error("No response from Anthropic API");return{text:a.content[0].text||"No content in Anthropic response",tokens:a.usage?{input:a.usage.input_tokens||0,output:a.usage.output_tokens||0,total:(a.usage.input_tokens||0)+(a.usage.output_tokens||0)}:{input:0,output:0,total:0}}}async function $n(i,s){const t={}.GEMINI_API_KEY;if(!t)throw new Error("GEMINI_API_KEY not found in environment variables");const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:i}]}],generationConfig:{temperature:.7,maxOutputTokens:4096}})});if(!r.ok){const l=await r.text();throw new Error(`Gemini API error: ${r.status} ${r.statusText} - ${l}`)}const n=await r.json();if(!n.candidates||n.candidates.length===0||!n.candidates[0].content.parts.length)throw new Error("No response from Gemini API");return{text:n.candidates[0].content.parts[0].text||"No content in Gemini response",tokens:n.usageMetadata?{input:n.usageMetadata.promptTokenCount||0,output:n.usageMetadata.candidatesTokenCount||0,total:n.usageMetadata.totalTokenCount||0}:{input:0,output:0,total:0}}}async function Gn(i,s){const t={}.MOONSHOT_API_KEY;if(!t)throw new Error("MOONSHOT_API_KEY not found in environment variables");const r=await fetch("https://api.moonshot.ai/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:"kimi-k2-0711-preview",messages:[{role:"system",content:"You are a helpful radiology assistant."},{role:"user",content:i}],temperature:.7,stream:!1})});if(!r.ok){const l=await r.text();throw new Error(`Kimi API error: ${r.status} ${r.statusText} - ${l}`)}const n=await r.json();if(!n.choices||n.choices.length===0)throw new Error("No response from Kimi API");return{text:n.choices[0].message.content||"No content in Kimi response",tokens:n.usage?{input:n.usage.prompt_tokens||0,output:n.usage.completion_tokens||0,total:n.usage.total_tokens||0}:{input:0,output:0,total:0}}}async function Hn(i){var s;try{return{text:await(await Bn()).generate({system:"You are a helpful radiology assistant.",prompt:i,temperature:.25,topP:.9,maxTokens:1200}),tokens:{input:0,output:0,total:0}}}catch(t){if(console.error("Error calling Mistral Local:",t),(s=t.message)!=null&&s.includes("llama.cpp server is not running")){const r=new Error(`Local AI server is not running.

To use local AI:
1. Open a terminal/command prompt
2. Navigate to RadPal directory
3. Run: npm run llama:serve
4. Keep the terminal open
5. Try again in RadPal

For setup help, see docs/mistral-local-setup.md`);throw r.name="LocalAINotRunning",r}throw t}}function Pt(i){const s=/^([A-Z][A-Z\s/]+):/gm,t=[];let r;for(;(r=s.exec(i))!==null;)t.push(r[1]+":");return t}function fn(i,s){const t=Pt(i),r=Pt(s),n=t.filter(a=>!r.includes(a)),l=r.filter(a=>!t.includes(a));return{valid:n.length===0&&l.length===0,missing:n,extra:l}}function Yn(i,s){const t=fn(i,s);if(t.valid)return s;console.warn("âš ï¸ Section header validation failed:",t);const r=Pt(i),n=i.split(`
`);let l=s;for(const a of t.missing)if(n.findIndex(f=>f.trim().startsWith(a))!==-1){const f=Vn(i,a),m=qn(l,r,a);if(m!==-1){const c=l.substring(0,m),y=l.substring(m);l=c+`

`+a+" "+f+y}}return l}function Vn(i,s){const t=i.split(`
`),r=t.findIndex(l=>l.trim().startsWith(s));return r===-1||r===t.length-1?"[Section content]":t[r+1].trim()||"[Section content]"}function qn(i,s,t){const r=s.indexOf(t);if(r===-1)return-1;for(let n=r+1;n<s.length;n++){const l=s[n],a=i.indexOf(`
`+l);if(a!==-1)return a}return i.length}async function Kn(i,s){var r,n;const t=await((n=(r=window.electron)==null?void 0:r.ipcRenderer)==null?void 0:n.invoke("fetch-template-for-generation",i,s));if(!t||t.error)throw new Error((t==null?void 0:t.error)||`No template found for user ${i} and study type "${s}"`);return t.data}async function Xn({userId:i,studyType:s,findings:t,model:r}){console.log("ðŸ¤– Agent generateReport called:",{userId:i,studyType:s,findingsLength:t.length+" characters",findingsPreview:t.substring(0,100)+"...",model:r});try{const n=await Kn(i,s);if(!n)throw new Error(`No template found for user ${i} and study type "${s}"`);const{template:l,agent_logic:a,generate_prompt:g}=n;let f=a;if(!a&&g&&(console.log("ðŸ”„ Using fallback: converting generate_prompt to agent_logic"),f={instructions:g,version:"1.0_fallback"}),!l)throw new Error(`Template is empty for study type "${s}"`);const c=!0?Dn(t,l,f||{}):On(t,l,f||{});console.log("ðŸŽ¯ Using enhanced prompt for better rule compliance");const y=await pn({prompt:c,model:r}),k=fn(l,y.text);let C=y.text;k.valid||(console.warn("âš ï¸ Section header validation failed:",k),C=Yn(l,y.text));const v=un(C,t,f||{});if(v.passed)console.log("âœ… All rules validated successfully");else return console.error("ðŸš¨ Rule validation failed:",v.violations),v.violations.forEach(I=>{console.error("âŒ RULE VIOLATION:",I)}),{...y,text:C,ruleViolations:v.violations,ruleWarnings:v.warnings};return v.warnings.length>0&&console.warn("âš ï¸ Rule warnings:",v.warnings),{...y,text:C,ruleViolations:v.violations,ruleWarnings:v.warnings}}catch(n){throw console.error("Error generating report:",n),n}}function Jn(i,s,t){console.log("ðŸ” BuildImpressionPrompt received agent_logic:",JSON.stringify(t,null,2));let r=`You are an expert radiologist generating a concise radiology impression.

`;s&&(r+=`For reference, the full report template is:
`,r+=s+`

`),r+=`The following imaging findings have been identified and must be incorporated into the impression:
`,r+=i+`

`;const n=[];if(n.push("Generate ONLY the IMPRESSION section - do not include findings or other report sections."),t.impression){if(t.impression.numerically_itemized&&n.push("Write the impression as a numbered list."),t.impression.omit_minor_or_incidental_findings_unless_relevant&&n.push("Omit mild or incidental findings unless relevant to the clinical history."),t.impression.concise_summary&&n.push("Keep the impression concise, focusing only on clinically significant findings."),t.impression.include_recommendations&&n.push("Include follow-up recommendations when appropriate."),t.impression.differential_diagnosis&&n.push("Provide differential diagnoses for significant findings when appropriate."),t.impression.severity_classification&&n.push("Classify findings by severity (mild, moderate, severe) when applicable."),t.impression.prioritize_by_urgency&&n.push("List findings in order of clinical urgency, most urgent first."),t.impression.first_item_should_address_clinical_concern&&n.push("The first impression item should address the clinical concern."),t.impression.exclude_by_default&&Array.isArray(t.impression.exclude_by_default)){console.log("ðŸ” Processing exclude_by_default:",t.impression.exclude_by_default);const l=t.impression.exclude_by_default.join(", ");n.push(`Do not include the following EXACT phrases unless clinically relevant: ${l}. Note: Only exclude the EXACT phrases listed - similar but different findings should still be included.`)}if(t.impression.mention_muscle_atrophy_if&&(console.log("ðŸ” Processing mention_muscle_atrophy_if:",t.impression.mention_muscle_atrophy_if),t.impression.mention_muscle_atrophy_if==="moderate_or_severe"?n.push("Only mention muscle atrophy if it is moderate or severe."):t.impression.mention_muscle_atrophy_if==="severe"?n.push("Only mention muscle atrophy if it is severe."):t.impression.mention_muscle_atrophy_if==="any"&&n.push("Mention muscle atrophy regardless of severity.")),t.impression.combine_compartments&&n.push("Combine meniscus and cartilage findings by compartment (e.g., medial/lateral) in the impression."),t.impression.exclude_unless_surgical&&Array.isArray(t.impression.exclude_unless_surgical)){console.log("ðŸ” Processing exclude_unless_surgical:",t.impression.exclude_unless_surgical);const l=t.impression.exclude_unless_surgical.join(", ");n.push(`Exclude the following findings unless they require surgical intervention: ${l}.`)}}return t.report&&(t.report.no_hallucinated_findings&&n.push("Do not invent findings. Only summarize what is explicitly stated in the findings."),t.report.cartilage_placement&&(t.report.cartilage_placement.group_cartilage_by_compartment_in_impression&&n.push("Group cartilage findings by compartment (medial, lateral, patellofemoral) in the impression."),t.report.cartilage_placement.mention_grade_in_impression&&n.push("Include cartilage defect grades in the impression when available.")),t.report.anatomic_routing_rules&&(console.log("ðŸ” Processing anatomic_routing_rules for impression:",t.report.anatomic_routing_rules),t.report.anatomic_routing_rules.impression_order&&n.push(`Organize impression findings in this order: ${t.report.anatomic_routing_rules.impression_order}.`),t.report.anatomic_routing_rules.group_pathology_by_type&&n.push("Group similar pathology together in the impression (e.g., all ligament tears, all cartilage defects)."))),t.formatting&&(t.formatting.use_bullet_points&&n.push("Use bullet points when listing multiple diagnoses or findings."),t.formatting.capitalize_diagnoses&&n.push("Capitalize the first letter of each diagnosis or major finding.")),t.clinical&&(t.clinical.correlate_with_symptoms&&n.push("Correlate impression with clinical symptoms when provided."),t.clinical.mention_clinical_significance&&n.push("Comment on the clinical significance of findings."),t.clinical.suggest_follow_up&&n.push("Suggest appropriate follow-up when indicated."),t.clinical.include_acuity&&n.push("Specify whether findings are acute, chronic, or acute-on-chronic when determinable."),t.clinical.management_implications&&n.push("Include management implications for significant findings.")),t.measurements&&(t.measurements.include_key_measurements_only&&n.push("Include only the most clinically relevant measurements in the impression."),t.measurements.describe_change_from_prior&&n.push("When prior studies are mentioned, describe interval change.")),t.severity&&(t.severity.highlight_urgent_findings&&n.push("Highlight any urgent or emergent findings at the beginning of the impression."),t.severity.use_standard_terminology&&n.push("Use standardized terminology for describing severity and urgency.")),t.style&&(t.style.definitive_statements&&n.push("Use definitive statements when findings are clear, avoid excessive hedging."),t.style.active_voice&&n.push("Use active voice when possible."),t.style.professional_tone&&n.push("Maintain a professional, objective tone.")),t.anatomy&&(t.anatomy.group_related_findings&&n.push("Group related anatomical findings together in the impression."),t.anatomy.mention_normal_variants&&n.push("Briefly mention significant normal variants that may cause confusion.")),t.custom_impression_instructions&&(Array.isArray(t.custom_impression_instructions)?n.push(...t.custom_impression_instructions):typeof t.custom_impression_instructions=="string"&&n.push(t.custom_impression_instructions)),n.length>0?(console.log(`ðŸ” Generated ${n.length} impression instructions from agent_logic:`,n),r+=`Instructions:
`,n.forEach((l,a)=>{r+=`${a+1}. ${l}
`}),r+=`
`):console.log("âš ï¸ No impression instructions generated from agent_logic"),t.impression_examples&&Array.isArray(t.impression_examples)&&(r+=`Impression Examples:
`,t.impression_examples.forEach((l,a)=>{r+=`Example ${a+1}:
`,l.findings&&(r+=`Findings: ${l.findings}
`),l.impression&&(r+=`Impression: ${l.impression}
`),r+=`
`})),r+="Generate only the IMPRESSION section based on the findings and instructions provided above.",r}function Zn(i,s,t){var g,f,m,c;console.log("ðŸ” BuildEnhancedImpressionPrompt received agent_logic:",JSON.stringify(t,null,2));let r=`You are an expert radiologist generating a concise, well-formatted radiology impression.

`;s&&(r+=`For reference, the full report template is:
`,r+=s+`

`),r+=`ðŸ“‹ FINDINGS TO SUMMARIZE:
`,r+=i+`

`;const n=[],l=[],a=[];if(n.push("Generate ONLY the IMPRESSION section - do not include findings or other report sections."),t.impression){if(t.impression.numerically_itemized?(n.push("IMPRESSION FORMAT: Write the impression as a numbered list (1, 2, 3, etc.)."),n.push("SPACING: Separate each numbered item with a double line break.")):(g=t.formatting)!=null&&g.use_bullet_points?(n.push("IMPRESSION FORMAT: Write the impression as a bullet point list using â€¢ symbols."),n.push("SPACING: Separate each bullet point with a double line break."),n.push('BULLET FORMAT: Start each item with "â€¢ " followed by the diagnosis/finding.')):l.push("Write the impression as separate statements, each separated by a double line break."),t.impression.exclude_by_default&&Array.isArray(t.impression.exclude_by_default)&&t.impression.exclude_by_default.length>0){const k=t.impression.exclude_by_default.map(C=>C.replace(/_/g," ").toLowerCase());n.push("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),n.push("âš ï¸ STRICT EXCLUSION RULES - MUST FOLLOW:"),n.push("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),k.forEach(C=>{n.push(`âŒ EXCLUDE: "${C}" - Do NOT mention this in the impression`)}),k.some(C=>C.includes("baker"))&&n.push(`âŒ SPECIFICALLY: Do NOT mention "Small Baker's cyst" or "Small Baker cyst" or any variation`),k.some(C=>C.includes("effusion"))&&n.push('âŒ SPECIFICALLY: Do NOT mention "Small joint effusion" or "Trace joint effusion"'),n.push("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),n.push("IMPORTANT: These exclusions are MANDATORY unless the finding is causing symptoms or requires immediate treatment."),n.push("Before including ANY finding, check if it matches the exclusion list above.")}t.impression.mention_muscle_atrophy_if&&(console.log("ðŸ” Processing mention_muscle_atrophy_if:",t.impression.mention_muscle_atrophy_if),t.impression.mention_muscle_atrophy_if==="moderate_or_severe"?n.push("MUSCLE ATROPHY: Only mention muscle atrophy if it is explicitly described as moderate or severe. Do NOT mention mild muscle atrophy."):t.impression.mention_muscle_atrophy_if==="severe"?n.push("MUSCLE ATROPHY: Only mention muscle atrophy if it is explicitly described as severe. Do NOT mention mild or moderate muscle atrophy."):t.impression.mention_muscle_atrophy_if==="never"&&n.push("MUSCLE ATROPHY: Do NOT mention muscle atrophy regardless of severity.")),t.impression.first_item_should_address_clinical_concern&&n.push("CLINICAL FOCUS: The first item MUST directly address the primary clinical concern or indication."),t.impression.omit_minor_or_incidental_findings_unless_relevant&&a.push("Focus on clinically significant findings. Omit mild or incidental findings unless they relate to the clinical history."),t.impression.concise_summary&&a.push("Keep the impression concise and focused on the most important findings."),t.impression.include_recommendations&&a.push("Include specific follow-up recommendations when clinically appropriate.")}return(f=t.report)!=null&&f.no_hallucinated_findings&&n.push("ACCURACY: Do not invent, assume, or hallucinate any findings. Only summarize what is explicitly stated in the provided findings."),t.clinical&&(t.clinical.correlate_with_symptoms&&a.push("Correlate impression with clinical symptoms when clinical history is provided."),t.clinical.mention_clinical_significance&&a.push("Comment on the clinical significance of findings.")),t.custom_instructions&&(Array.isArray(t.custom_instructions)?t.custom_instructions.forEach(y=>{n.push(`CUSTOM RULE: ${y}`)}):typeof t.custom_instructions=="string"&&n.push(`CUSTOM RULE: ${t.custom_instructions}`)),n.length>0&&(r+=`ðŸš¨ CRITICAL REQUIREMENTS:
`,n.forEach((y,k)=>{r+=`${k+1}. ${y}
`}),r+=`
`),l.length>0&&(r+=`ðŸ“ FORMATTING RULES:
`,l.forEach((y,k)=>{r+=`${k+1}. ${y}
`}),r+=`
`),a.length>0&&(r+=`ðŸ“ CONTENT GUIDELINES:
`,a.forEach((y,k)=>{r+=`${k+1}. ${y}
`}),r+=`
`),r+=`ðŸŽ¯ FINAL INSTRUCTIONS:
`,(m=t.impression)!=null&&m.numerically_itemized?(r+=`Generate the impression in this EXACT format:

`,r+=`IMPRESSION:
`,r+=`1. [Primary finding addressing clinical concern]

`,r+=`2. [Secondary significant finding]

`,r+=`3. [Additional findings if relevant]
`):(c=t.formatting)!=null&&c.use_bullet_points?(r+=`Generate the impression in this EXACT format:

`,r+=`IMPRESSION:
`,r+=`â€¢ [Primary finding addressing clinical concern]

`,r+=`â€¢ [Secondary significant finding]

`,r+=`â€¢ [Additional findings if relevant]
`):(r+=`Generate the impression with proper spacing:

`,r+=`IMPRESSION:
`,r+=`[Statement about primary finding]

`,r+=`[Statement about secondary finding]

`,r+=`[Additional statements if relevant]
`),r+=`
Generate the impression now following the format requirements above.
`,console.log("ðŸš¨ Enhanced impression prompt generated"),console.log(`Critical instructions: ${n.length}, Formatting: ${l.length}, Content: ${a.length}`),r}function Qn(i,s){var f;if(!((f=s==null?void 0:s.impression)!=null&&f.exclude_by_default)||!Array.isArray(s.impression.exclude_by_default))return i;let t=i;const r=s.impression.exclude_by_default,n=[];r.forEach(m=>{const c=m.replace(/_/g," ").toLowerCase();[c,c.replace(/'/g,""),c.replace(/s$/,""),c+"s"].forEach(k=>{const C=new RegExp(`\\b${k.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}(?=[.,;\\n]|$)`,"gi");n.push(C)})}),r.some(m=>m.toLowerCase().includes("baker"))&&n.push(/\bsmall\s+baker'?s?\s+cysts?\b/gi,/\bbaker'?s?\s+cysts?,?\s+small\b/gi,/\d+\.\s*Small\s+Baker'?s?\s+cysts?\.?/gi),r.some(m=>m.toLowerCase().includes("effusion"))&&n.push(/\bsmall\s+(?:joint\s+)?effusions?\b/gi,/\btrace\s+(?:joint\s+)?effusions?\b/gi,/\d+\.\s*Small\s+joint\s+effusions?\.?/gi),n.forEach(m=>{const c=t.match(m);if(c){console.log(`ðŸš« Post-processing: Removing excluded item "${c[0]}"`);const y=new RegExp(`^\\d+\\.\\s*.*${m.source}.*$`,"gim");y.test(t)?t=t.replace(y,""):t=t.replace(m,"")}}),t=t.replace(/^\d+\.\s*$/gm,"");const l=t.split(`
`);let a=1;return t=l.map(m=>{const c=m.match(/^(\d+)\.\s+(.+)/);if(c){const y=`${a}. ${c[2]}`;return a++,y}return m}).join(`
`),t=t.replace(/\n{3,}/g,`

`),t=t.trim(),t}async function eo(i,s){var r,n;const t=await((n=(r=window.electron)==null?void 0:r.ipcRenderer)==null?void 0:n.invoke("fetch-template-for-generation",i,s));if(!t||t.error)throw new Error((t==null?void 0:t.error)||`No template found for user ${i} and study type "${s}"`);return t.data}async function to({userId:i,studyType:s,findings:t,model:r}){try{const n=await eo(i,s);if(!n)throw new Error(`No template found for user ${i} and study type "${s}"`);const{template:l,agent_logic:a,generate_impression:g}=n;let f=a;!a&&g&&(console.log("ðŸ”„ Using fallback: converting generate_impression to agent_logic"),f={instructions:g,version:"1.0_fallback",impression:{concise_summary:!0}});const c=!0?Zn(t,l||"",f||{}):Jn(t,l||"",f||{});console.log("ðŸŽ¯ Using enhanced impression prompt for better formatting and rule compliance");const y=await pn({prompt:c,model:r});console.log("ðŸ”§ Post-processing impression to enforce exclusion rules...");const k=Qn(y.text,f||{});k!==y.text&&console.log("âœ‚ï¸ Post-processing removed excluded items from impression"),y.text=k;const C=un(k,t,f||{});return C.passed?console.log("âœ… All impression rules validated successfully"):(console.error("ðŸš¨ Impression rule validation failed:",C.violations),C.violations.forEach(v=>{console.error("âŒ IMPRESSION RULE VIOLATION:",v)})),C.warnings.length>0&&console.warn("âš ï¸ Impression rule warnings:",C.warnings),{...y,ruleViolations:C.violations,ruleWarnings:C.warnings}}catch(n){throw console.error("Error generating impression:",n),n}}function no(){const[i,s]=p.useState(!1),[t,r]=p.useState(null),{user:n}=Dt();return{generateReportWithAgent:async(g,f,m)=>{if(!(n!=null&&n.id))throw new Error("User not authenticated");s(!0),r(null);try{const c=await Xn({userId:n.id,studyType:f,findings:g,model:m});return{text:c.text,tokens:c.tokens||{input:0,output:0,total:0}}}catch(c){const y=c instanceof Error?c.message:"Failed to generate report";throw r(y),c}finally{s(!1)}},generateImpressionWithAgent:async(g,f,m)=>{if(!(n!=null&&n.id))throw new Error("User not authenticated");s(!0),r(null);try{const c=await to({userId:n.id,studyType:f,findings:g,model:m});return{text:c.text,tokens:c.tokens||{input:0,output:0,total:0}}}catch(c){const y=c instanceof Error?c.message:"Failed to generate impression";throw r(y),c}finally{s(!1)}},loading:i,error:t}}function sn(i){switch(i){case"openai":return"gpt-4";case"gpt-5":return"gpt-5";case"claude-sonnet":return"claude-3-sonnet";case"claude-opus":return"claude-3-opus";case"claude-opus-4.1":return"claude-opus-4.1";case"gemini":return"gemini-2.5-flash";case"kimi":return"kimi-k2-0711-preview";case"mistral-local":return"mistral-local";default:return"gpt-4"}}function oo(){const i=()=>{try{const l=localStorage.getItem("radpal_window_dimensions");if(l){const a=JSON.parse(l);if(a.width>200&&a.height>100)return{width:a.width,height:a.height,isContracted:a.height<=110}}}catch(l){console.warn("Failed to load saved window dimensions:",l)}return{width:window.innerWidth,height:window.innerHeight,isContracted:window.innerHeight<=110}},[s,t]=p.useState(i()),r=p.useCallback((l,a)=>{try{localStorage.setItem("radpal_window_dimensions",JSON.stringify({width:l,height:a,timestamp:Date.now()}))}catch(g){console.warn("Failed to save window dimensions:",g)}},[]),n=p.useCallback(()=>{const l={width:window.innerWidth,height:window.innerHeight,isContracted:window.innerHeight<=110};t(l),r(l.width,l.height)},[r]);return p.useEffect(()=>{let l;const a=()=>{clearTimeout(l),l=setTimeout(n,150)};return n(),window.addEventListener("resize",a),()=>{clearTimeout(l),window.removeEventListener("resize",a)}},[n]),s}function ro(){return p.useMemo(()=>({textareaStyle:{width:"100%",height:"40vh",minHeight:200,maxHeight:"50vh",padding:"16px 40px 16px 16px",backgroundColor:"transparent",color:"#fff",border:"none",borderRadius:16,resize:"none",fontSize:14,outline:"none",fontFamily:"DM Sans, sans-serif"},modalButtonStyle:{padding:"6px 12px",border:"none",borderRadius:16,fontSize:14,fontWeight:300,transition:"all 0.2s ease"},tokenBarStyle:s=>({width:"100%",height:s<600?8:s<800?10:12,backgroundColor:"rgba(42, 45, 49, 0.6)",borderRadius:(s<600?8:s<800?10:12)/2,border:"none",overflow:"hidden",position:"relative"}),tokenFillStyle:(s,t)=>({width:`${Math.min(t||0,100)}%`,height:"100%",backgroundColor:(t||0)>90?"#E36756":(t||0)>75?"#E1865D":"#3ABC96",transition:"all 0.3s ease",borderRadius:`${(s<600?8:s<800?10:12)/2}px 0 0 ${(s<600?8:s<800?10:12)/2}px`})}),[])}const so=""+new URL("radpal_logo_dev.png",import.meta.url).href;function io(){const{signIn:i,signUp:s}=Dt(),[t,r]=p.useState(""),[n,l]=p.useState(""),[a,g]=p.useState(null),[f,m]=p.useState(!0),[c,y]=p.useState(!1),[k,C]=p.useState(""),[v,I]=p.useState(!1),b=p.useRef(null);p.useEffect(()=>{const R=localStorage.getItem("radpal_remember_login")==="1",W=localStorage.getItem("radpal_email")||"",ne=localStorage.getItem("radpal_password")||"";R&&(m(!0),r(W),l(ne)),b.current&&b.current.focus()},[]);const F=async R=>{var ne;let W=0;for(;W<10;){try{const K=await((ne=window.electronAPI)==null?void 0:ne.checkUserExists(R));if(K!=null&&K.exists)return!0}catch(K){console.error("Error checking user existence:",K)}await new Promise(K=>setTimeout(K,500)),W++}return!1},_=async R=>{var W;try{if(!await F(R))return;const K=await((W=window.electronAPI)==null?void 0:W.triggerTemplateCopy(R));K!=null&&K.success||console.error("Template copy failed:",K==null?void 0:K.error)}catch{}},U=async()=>{var R,W,ne,K;I(!0),g(null);try{if(c){const T=await((R=window.electronAPI)==null?void 0:R.checkInviteCode(k));if(!(T!=null&&T.data)||T!=null&&T.error){g("âŒ Invalid or already used invite code");return}}const B=c?await s(t,n):await i(t,n);if(B.error){g(`âŒ ${B.error.message}`);return}const re=(ne=(W=B.data)==null?void 0:W.user)==null?void 0:ne.id;if(c&&re){const T=await((K=window.electronAPI)==null?void 0:K.markInviteCodeUsed(k,re));T!=null&&T.success||console.error("Failed to mark invite code as used:",T==null?void 0:T.error),await _(re)}f?(localStorage.setItem("radpal_remember_login","1"),localStorage.setItem("radpal_email",t),localStorage.setItem("radpal_password",n)):(localStorage.removeItem("radpal_remember_login"),localStorage.removeItem("radpal_email"),localStorage.removeItem("radpal_password")),g(c?"âœ… Success! Check your email to confirm your account.":"âœ… Success! You are now signed in.")}catch(B){g(`âŒ Login failed: ${B instanceof Error?B.message:"Unknown error"}`)}finally{I(!1)}};return e.jsxs("div",{className:"radpal-login-wrapper",style:{height:"100vh",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"inherit",WebkitAppRegion:"drag",padding:"60px 32px",textAlign:"center",fontFamily:"SF Pro, system-ui, sans-serif",fontWeight:400,position:"relative"},children:[e.jsx("button",{onClick:()=>{var R;(R=window.electronAPI)!=null&&R.closeApp?window.electronAPI.closeApp():window.close()},style:{position:"absolute",top:20,right:20,background:"rgba(227, 103, 86, 0.2)",border:"1px solid rgba(227, 103, 86, 0.3)",borderRadius:"50%",width:32,height:32,color:"#E36756",fontSize:16,fontWeight:"bold",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",WebkitAppRegion:"no-drag",zIndex:1e3,transition:"all 0.2s ease"},onMouseEnter:R=>{R.currentTarget.style.background="rgba(227, 103, 86, 0.3)",R.currentTarget.style.transform="scale(1.1)"},onMouseLeave:R=>{R.currentTarget.style.background="rgba(227, 103, 86, 0.2)",R.currentTarget.style.transform="scale(1)"},children:"Ã—"}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",WebkitAppRegion:"no-drag",maxWidth:350,width:"100%"},children:[e.jsx("img",{src:so,alt:"RadPal Logo",className:"radpal-logo",style:{maxWidth:400,marginBottom:32,backgroundColor:"transparent",mixBlendMode:"normal"}}),e.jsxs("form",{onSubmit:R=>{R.preventDefault(),U()},style:{marginBottom:20,width:"100%",display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(ye,{style:{marginBottom:16,width:"100%",maxWidth:280},children:e.jsx("input",{ref:b,type:"email",placeholder:"Email",value:t,onChange:R=>r(R.target.value),style:{padding:14,width:"100%",borderRadius:16,fontSize:14,fontFamily:"DM Sans, sans-serif",fontWeight:400,backgroundColor:"transparent",color:"#fff",border:"none",outline:"none",WebkitAppRegion:"no-drag"}})}),e.jsx(ye,{style:{marginBottom:16,width:"100%",maxWidth:280},children:e.jsx("input",{type:"password",placeholder:"Password",value:n,onChange:R=>l(R.target.value),style:{padding:14,width:"100%",borderRadius:16,fontSize:14,fontFamily:"DM Sans, sans-serif",fontWeight:400,backgroundColor:"transparent",color:"#fff",border:"none",outline:"none",WebkitAppRegion:"no-drag"}})}),c&&e.jsx(ye,{style:{marginBottom:16,width:"100%",maxWidth:280},children:e.jsx("input",{type:"text",placeholder:"Invite Code",value:k,onChange:R=>C(R.target.value),style:{padding:14,width:"100%",borderRadius:16,fontSize:14,fontFamily:"DM Sans, sans-serif",fontWeight:400,backgroundColor:"transparent",color:"#fff",border:"none",outline:"none",WebkitAppRegion:"no-drag"}})})]}),e.jsx(ye,{onClick:U,style:{marginBottom:20,opacity:v?.5:1,pointerEvents:v?"none":"auto",padding:6},children:e.jsx("button",{disabled:v,style:{padding:"14px 32px",borderRadius:16,fontSize:14,backgroundColor:"transparent",color:"#fff",border:"none",WebkitAppRegion:"no-drag",pointerEvents:"none"},children:v?"Loading...":c?"Sign Up":"Log In"})}),e.jsxs("label",{style:{fontSize:14,display:"flex",alignItems:"center",gap:6,justifyContent:"center",fontFamily:"DM Sans, sans-serif",fontWeight:400,color:"#fff"},children:[e.jsx("input",{type:"checkbox",checked:f,onChange:()=>m(!f),style:{WebkitAppRegion:"no-drag"}}),"Remember Me"]}),a&&e.jsx("p",{className:"login-message-animated",style:{marginTop:20,color:a.startsWith("âœ…")?"green":"red",fontSize:16,fontFamily:"DM Sans, sans-serif",fontWeight:400},children:a}),e.jsxs("p",{style:{marginTop:20,fontSize:14,fontFamily:"DM Sans, sans-serif",fontWeight:400,color:"#fff"},children:[c?"Already have an account?":"Don't have an account?"," ",e.jsx("button",{style:{color:"#7CC2D7",background:"none",border:"none",fontSize:14,fontFamily:"DM Sans, sans-serif",fontWeight:400},onClick:()=>y(!c),children:c?"Log In":"Sign Up"})]})]})]})}const an=({visible:i,selected:s,onSelect:t,onClose:r,onCancel:n})=>{const[l,a]=p.useState(""),[g,f]=p.useState(!1);p.useEffect(()=>{if(s!=="Other")a("");else{const c=localStorage.getItem("customDictationWindow")||"";a(c)}},[s]);const m=()=>{var c,y;s==="Other"&&l.trim()&&(localStorage.setItem("customDictationWindow",l.trim()),(y=(c=window==null?void 0:window.electron)==null?void 0:c.ipcRenderer)==null||y.invoke("set-custom-window-name",l.trim())),r()};return i?e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.4)",backdropFilter:"blur(4px)",WebkitBackdropFilter:"blur(4px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:9999},children:e.jsxs(ye,{style:{padding:24,minWidth:300,maxWidth:400,color:"white",backgroundColor:"rgba(42, 45, 49, 0.8)",backdropFilter:"blur(12px)",WebkitBackdropFilter:"blur(12px)",borderRadius:16,border:"none"},children:[e.jsx("h2",{style:{marginTop:0,fontFamily:"SF Pro, system-ui, sans-serif",fontWeight:400},children:"Select Dictation Software"}),e.jsx(ye,{style:{marginBottom:16},children:e.jsxs("select",{value:s,onChange:c=>t(c.target.value),style:{width:"100%",padding:"10px",fontSize:"16px",fontFamily:"SF Pro, system-ui, sans-serif",fontWeight:400,borderRadius:16,backgroundColor:"transparent",color:"white",border:"none",outline:"none"},children:[e.jsx("option",{value:"PowerScribe",style:{backgroundColor:"#1a1d23",color:"white"},children:"PowerScribe"}),e.jsx("option",{value:"Fluency",style:{backgroundColor:"#1a1d23",color:"white"},children:"Fluency"}),e.jsx("option",{value:"Dragon",style:{backgroundColor:"#1a1d23",color:"white"},children:"Dragon"}),e.jsx("option",{value:"Other",style:{backgroundColor:"#1a1d23",color:"white"},children:"Other"})]})}),s==="Other"&&e.jsxs(ye,{style:{marginBottom:16,padding:8},children:[e.jsx("input",{type:"text",value:l,placeholder:"Enter window title of your dictation software",onChange:c=>a(c.target.value),onFocus:()=>f(!0),onBlur:()=>f(!1),style:{width:"100%",padding:"10px",fontSize:"11px",fontFamily:"DM Sans, sans-serif",fontWeight:400,borderRadius:16,backgroundColor:"transparent",color:"white",border:"none",outline:"none",marginBottom:4}}),g&&e.jsx("div",{style:{fontSize:12,color:"#fff",fontFamily:"DM Sans, sans-serif",fontWeight:400},children:'(Case sensitive. Only partial matching required. e.g. "Dragon" for Dragon Medical One)'})]}),e.jsxs("div",{style:{textAlign:"right",display:"flex",gap:12,justifyContent:"flex-end"},children:[e.jsx(ye,{onClick:()=>{n&&n()},style:{color:"white",padding:"8px 16px",backgroundColor:"rgba(108, 117, 125, 0.3)"},children:"Cancel"}),e.jsx(ye,{onClick:m,style:{color:"white",padding:"8px 16px",backgroundColor:"#3b82f6"},children:"Confirm"})]})]})}):null};function ao(i){const s=i.split("+").map(r=>r.trim()),t={key:"",ctrl:!1,alt:!1,shift:!1,meta:!1};return s.forEach(r=>{const n=r.toLowerCase();n==="ctrl"||n==="control"?t.ctrl=!0:n==="alt"?t.alt=!0:n==="shift"?t.shift=!0:n==="meta"||n==="cmd"||n==="command"?t.meta=!0:t.key=r}),t}function lo(i,s){return i.key===s.key&&i.ctrlKey===s.ctrl&&i.altKey===s.alt&&i.shiftKey===s.shift&&i.metaKey===s.meta}const co="F5";function gn(){return localStorage.getItem("dictation_hotkey")||co}function uo(i){localStorage.setItem("dictation_hotkey",i)}const po=({value:i,onChange:s,style:t})=>{const[r,n]=p.useState(!1),[l,a]=p.useState(i);p.useEffect(()=>{a(i)},[i]);const g=c=>{if(!r||(c.preventDefault(),c.stopPropagation(),["Control","Alt","Shift","Meta"].includes(c.key)))return;const y=[];c.ctrlKey&&y.push("Ctrl"),c.altKey&&y.push("Alt"),c.shiftKey&&y.push("Shift"),c.metaKey&&y.push("Meta");let k=c.key;k===" "&&(k="Space"),k.length===1&&(k=k.toUpperCase()),y.push(k);const C=y.join("+");a(C),s(C),n(!1)},f=()=>{n(!0),a("Press keys...")},m=()=>{n(!1),a(i)};return e.jsx("input",{type:"text",value:l,onClick:f,onKeyDown:g,onBlur:m,readOnly:!0,placeholder:"Click to set hotkey",style:{...t,padding:"4px 8px",borderRadius:4,border:r?"2px solid #3ABC96":"none",backgroundColor:"#2c2c2c",color:r?"#3ABC96":"#fff",fontSize:12,fontFamily:"'DM Sans', sans-serif",fontWeight:400,textAlign:"center",cursor:"pointer"}})},ln=({visible:i,onClose:s})=>{const t=[{hotkey:"F5",action:"dictation",enabled:!0,text:""},{hotkey:"Ctrl+Alt+1",action:"autofill-1",enabled:!0,text:""},{hotkey:"Ctrl+Alt+2",action:"autofill-2",enabled:!0,text:""}],[r,n]=p.useState(t);p.useEffect(()=>{const a=gn(),g=t.map(c=>c.action==="dictation"?{...c,hotkey:a}:c),f=JSON.parse(localStorage.getItem("globalShortcuts")||"[]");if(Array.isArray(f)&&f.length===g.length&&f.every((c,y)=>c.action===g[y].action)){const c=f.map(y=>y.action==="dictation"?{...y,hotkey:a}:y);n(c)}else localStorage.setItem("globalShortcuts",JSON.stringify(g)),n(g)},[]);const l=()=>{var f,m;localStorage.setItem("globalShortcuts",JSON.stringify(r));const a=r.find(c=>c.action==="dictation");a&&uo(a.hotkey);const g=r.map(c=>({hotkey:c.hotkey,action:c.action,text:c.text,enabled:c.enabled}));(m=(f=window.electron)==null?void 0:f.ipcRenderer)==null||m.invoke("compile-autofill-hotkeys",g),s()};return i?e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"modal-content",children:[e.jsx("h2",{style:{fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:400},children:"Keyboard Shortcut Settings"}),r.map((a,g)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:30,opacity:a.enabled?1:.4},children:[e.jsx("input",{type:"checkbox",checked:a.enabled,onChange:f=>{const m=[...r];m[g].enabled=f.target.checked,n(m)}}),a.action==="dictation"?e.jsx(po,{value:a.hotkey,onChange:f=>{const m=[...r];m[g].hotkey=f,n(m)},style:{width:120}}):e.jsx("div",{style:{width:120},children:a.hotkey}),e.jsxs("div",{style:{width:200,fontSize:14,display:"flex",flexDirection:"column",alignItems:"center"},children:[a.action==="dictation"&&"Dictation Toggle",a.action==="autofill-1"&&"Auto Text Fill 1",a.action==="autofill-2"&&"Auto Text Fill 2",a.action.startsWith("autofill")&&e.jsx("input",{type:"password",value:a.text||"",onChange:f=>{const m=[...r];m[g].text=f.target.value,n(m)},placeholder:"Paste text",style:{width:180,marginTop:4,padding:"4px 8px",borderRadius:4,border:"none",backgroundColor:"#2c2c2c",color:"#fff",fontSize:14,fontFamily:"'DM Sans', sans-serif",fontWeight:400}})]})]},g)),e.jsxs("div",{style:{textAlign:"right",marginTop:20,display:"flex",gap:12,justifyContent:"flex-end"},children:[e.jsx("button",{onClick:s,style:{padding:"8px 16px",backgroundColor:"#6c757d",color:"#fff",border:"none",borderRadius:"4px",fontSize:"14px",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:400},children:"Cancel"}),e.jsx("button",{onClick:l,style:{padding:"8px 16px",backgroundColor:"#3ABC96",color:"#fff",border:"none",borderRadius:"4px",fontSize:"14px",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:400},children:"Save"})]})]})}):null};function Ft(i,s){if(console.log("ðŸ”§ deepMergeAgentLogic called with:"),console.log("ðŸ”§ Target (existing):",JSON.stringify(i,null,2)),console.log("ðŸ”§ Source (changes):",JSON.stringify(s,null,2)),!i||typeof i!="object")return console.log("ðŸ”§ Target is not object, returning source"),s;if(!s||typeof s!="object")return console.log("ðŸ”§ Source is not object, returning target"),i;const t={...i};console.log("ðŸ”§ Initial result (copy of target):",JSON.stringify(t,null,2));for(const r in s){const n=s[r],l=t[r];if(console.log(`ðŸ”§ Processing key "${r}":`),console.log("ðŸ”§   - sourceValue:",n),console.log("ðŸ”§   - targetValue:",l),Array.isArray(n))if(Array.isArray(l)){const a=[...l,...n];t[r]=[...new Set(a)],console.log("ðŸ”§   - Array merge result:",t[r])}else t[r]=[...n],console.log("ðŸ”§   - Array replace result:",t[r]);else n&&typeof n=="object"&&!Array.isArray(n)?(console.log(`ðŸ”§   - Recursively merging object for key "${r}"`),t[r]=Ft(l||{},n),console.log(`ðŸ”§   - Recursive merge result for "${r}":`,t[r])):(t[r]=n,console.log(`ðŸ”§   - Primitive overwrite result for "${r}":`,t[r]))}return console.log("ðŸ”§ Final merge result:",JSON.stringify(t,null,2)),t}function he(){return{version:"2.0",formatting:{preserve_template_punctuation:!0,use_bullet_points:!1,capitalize_sections:!0},report:{no_hallucinated_findings:!0,include_technique_section:!1,expand_lesions:!1},impression:{numerically_itemized:!0,omit_minor_or_incidental_findings_unless_relevant:!1,concise_summary:!1,include_recommendations:!1,first_item_should_address_clinical_concern:!1,exclude_by_default:["small_joint_effusion","small_joint_effusions","trace_joint_effusion","trace_bursitis","mild_tendinosis","minimal_degenerative_changes","small_baker_cyst","small_bakers_cyst","small_baker's_cyst","small_baker's_cysts","mild_bone_marrow_edema","minimal_synovitis","trace_fluid"],mention_muscle_atrophy_if:"moderate_or_severe"},anatomy:{combine_meniscus_and_cartilage_findings:!1,group_by_anatomic_region:!1},clinical:{correlate_with_symptoms:!1,mention_clinical_significance:!1},measurements:{include_all_measurements:!0,use_metric_system:!0},severity:{use_standard_grading:!1,avoid_vague_terms:!1},style:{active_voice:!1,professional_tone:!0},custom_instructions:[]}}function vt(i){let s=i.defaultLogic||he();return i.baseLogic&&(s=Ft(s,i.baseLogic)),i.studySpecificLogic&&(s=Ft(s,i.studySpecificLogic)),{mergedLogic:s,layers:i,effectiveLogic:s}}function Lt(i,s){if(!i||!s)return s;const t={};for(const r in s){const n=i[r],l=s[r];if(JSON.stringify(n)!==JSON.stringify(l))if(typeof l=="object"&&!Array.isArray(l)&&l!==null){const a=Lt(n||{},l);Object.keys(a).length>0&&(t[r]=a)}else t[r]=l}return t}function fo(i,s){const t=Lt(i,s),r=[],n=(l,a="")=>{for(const g in l){const f=a?`${a}.${g}`:g,m=l[g];typeof m=="object"&&!Array.isArray(m)&&m!==null?n(m,f):Array.isArray(m)?r.push(`${f}: ${m.length} items`):typeof m=="boolean"?r.push(`${f}: ${m?"enabled":"disabled"}`):r.push(`${f}: "${m}"`)}};return n(t),r}function go(i,s){const t=(r,n)=>{let l=r;for(const a of n)if(l&&typeof l=="object"&&a in l)l=l[a];else return;return l};return s.studySpecificLogic&&t(s.studySpecificLogic,i)!==void 0?"study":s.baseLogic&&t(s.baseLogic,i)!==void 0?"base":s.defaultLogic&&t(s.defaultLogic,i)!==void 0?"default":null}async function Nt(i,s,t=!1){var r,n;console.log("ðŸ” fetchAgentLogic called:",{userId:i,studyType:s,isOfflineMode:t});try{if(t){const l=ue.getAgentLogic("__USER_DEFAULT__")||null,a=ue.getAgentLogic(s)||null,g={defaultLogic:he(),baseLogic:l,studySpecificLogic:a},{mergedLogic:f}=vt(g);return{success:!0,baseLogic:l,studyLogic:a,mergedLogic:f}}if(console.log("ðŸ”Œ Checking for IPC availability:",!!window.electronAPI,!!((r=window.electronAPI)!=null&&r.getLogicLayers)),(n=window.electronAPI)!=null&&n.getLogicLayers){console.log("ðŸ“¡ Calling IPC getLogicLayers...");const l=await window.electronAPI.getLogicLayers(i,s);if(console.log("ðŸ“¥ IPC result:",l),l.error){console.error("Error from IPC:",l.error);const f=ue.getAgentLogic("__USER_DEFAULT__")||null,m=ue.getAgentLogic(s)||null,c={defaultLogic:he(),baseLogic:f,studySpecificLogic:m},{mergedLogic:y}=vt(c);return{success:!0,baseLogic:f,studyLogic:m,mergedLogic:y}}const a={defaultLogic:l.defaultLogic||he(),baseLogic:l.baseLogic,studySpecificLogic:l.studyLogic},{mergedLogic:g}=vt(a);return l.baseLogic&&ue.saveAgentLogic("__USER_DEFAULT__",l.baseLogic),l.studyLogic&&ue.saveAgentLogic(s,l.studyLogic),{success:!0,baseLogic:l.baseLogic,studyLogic:l.studyLogic,mergedLogic:g,lastUpdated:l.lastUpdated||{}}}throw new Error("IPC not available")}catch(l){console.error("Error fetching agent logic:",l);const a=ue.getAgentLogic("__USER_DEFAULT__")||null,g=ue.getAgentLogic(s)||null,f={defaultLogic:he(),baseLogic:a,studySpecificLogic:g},{mergedLogic:m}=vt(f);return{success:!0,baseLogic:a,studyLogic:g,mergedLogic:m}}}async function mn(i,s,t=!1){var r,n;console.log("ðŸ”„ updateBaseLogic called:",{userId:i,hasBaseLogic:!!s,isOfflineMode:t});try{if(t)return ue.saveAgentLogic("__USER_DEFAULT__",s),{success:!0,baseLogic:s};if(console.log("ðŸ”Œ Checking for updateBaseLogic IPC:",!!((r=window.electronAPI)!=null&&r.updateBaseLogic)),(n=window.electronAPI)!=null&&n.updateBaseLogic){console.log("ðŸ“¡ Calling IPC updateBaseLogic...");const l=await window.electronAPI.updateBaseLogic(i,s);if(console.log("ðŸ“¥ Update result:",l),l.error)throw new Error(l.error);return ue.saveAgentLogic("__USER_DEFAULT__",s),{success:!0,baseLogic:s}}throw new Error("IPC not available")}catch(l){return console.error("Error updating base logic:",l),{success:!1,error:l instanceof Error?l.message:"Failed to update base logic"}}}async function hn(i,s,t,r=!1,n=!0){var l;try{let a=t;if(n){const{baseLogic:g}=await Nt(i,s,r);if(g){const m={...he(),...g};a=Lt(m,t)}}if(r)return ue.saveAgentLogic(s,a),{success:!0,studyLogic:a};if((l=window.electronAPI)!=null&&l.updateStudyLogic){const g=await window.electronAPI.updateStudyLogic(i,s,a);if(g.error)throw new Error(g.error);return ue.saveAgentLogic(s,a),{success:!0,studyLogic:a}}throw new Error("IPC not available")}catch(a){return console.error("Error updating study logic:",a),{success:!1,error:a instanceof Error?a.message:"Failed to update study logic"}}}async function mo(i,s,t,r=!1){try{if(t==="base"){const n=he();return mn(i,n,r)}else return r?(ue.saveAgentLogic(s,null),{success:!0,studyLogic:null}):hn(i,s,null,r,!1)}catch(n){return console.error("Error resetting logic:",n),{success:!1,error:n instanceof Error?n.message:"Failed to reset logic"}}}const pt=(i,s)=>{let t=i;for(const r of s)if(t&&typeof t=="object"&&r in t)t=t[r];else return;return t};function ho({userId:i,studyType:s,templates:t={},onClose:r,isOfflineMode:n=!1,userTier:l=1}){const[a,g]=p.useState(s),[f,m]=p.useState("study"),[c,y]=p.useState(!1),[k,C]=p.useState(null),[v,I]=p.useState(null),[b,F]=p.useState(null),[_,U]=p.useState(null),[R,W]=p.useState(null),[ne,K]=p.useState(!1),[B,re]=p.useState(null),[T,Y]=p.useState({}),[se,pe]=p.useState(!1),[de,st]=p.useState({}),[Te,Le]=p.useState(!1),[Ge,it]=p.useState(""),[kt,Je]=p.useState(null),[He,Ze]=p.useState(""),[D,at]=p.useState(null),[Qe,we]=p.useState(!1),[Be,je]=p.useState(""),[$,Ye]=p.useState(null),[ft,Ve]=p.useState(null),[Pe,Fe]=p.useState(""),[gt,qe]=p.useState(!1);p.useEffect(()=>{a&&a.trim()?(console.log("ðŸ“š Loading logic for study type:",a),Ne()):(console.log("âš ï¸ No study type selected, skipping logic load"),ze())},[a,i]),p.useEffect(()=>{switch(f){case"base":U(k||he());break;case"study":U(v||{});break;case"preview":U(b);break}},[f,k,v,b]);const Ne=async()=>{y(!0);try{const h=await Nt(i,a,n);h.success&&(C(h.baseLogic||he()),I(h.studyLogic||{}),F(h.mergedLogic||he()),Y(h.lastUpdated||{}),st({defaultLogic:he(),baseLogic:h.baseLogic,studySpecificLogic:h.studyLogic}))}catch(h){console.error("Error loading logic:",h),ie("error","Failed to load logic configuration")}finally{y(!1)}},ze=async()=>{var h;y(!0);try{const E=await Nt(i,"DUMMY_FOR_BASE",n);E.success&&(C(E.baseLogic||he()),I({}),F(E.baseLogic||he()),Y({base:(h=E.lastUpdated)==null?void 0:h.base}),st({defaultLogic:he(),baseLogic:E.baseLogic,studySpecificLogic:{}}))}catch(E){console.error("Error loading base logic:",E);const X=he();C(X),I({}),F(X)}finally{y(!1)}},G=(h,E)=>{let X=E;typeof E=="string"?X=E.replace(/\s+/g,"_").toLowerCase():Array.isArray(E)&&(X=E.map(j=>typeof j=="string"?j.replace(/\s+/g,"_").toLowerCase():j));const A=j=>{const J=JSON.parse(JSON.stringify(j||{}));let H=J;for(let fe=0;fe<h.length-1;fe++)H[h[fe]]||(H[h[fe]]={}),H=H[h[fe]];return H[h[h.length-1]]=X,J};f==="base"?C(A):f==="study"&&I(A),W(j=>({...j,[f]:!0}))},ae=()=>{if(!Ge.trim())return;const h=Ge.replace(/\s+/g,"_").toLowerCase(),E={};h.includes("impression")&&(E.exclude_by_default=[]),G([h],E),it(""),Le(!1),ie("success",`Section '${Ge}' added`)},Et=h=>{if(!He.trim())return;const E=He.replace(/\s+/g,"_").toLowerCase();G([...h,E],!1),Ze(""),Je(null),ie("success",`Rule '${He}' added`)},mt=()=>{if(!D)return;const h=E=>{const X=JSON.parse(JSON.stringify(E||{}));if(D.path.length===1)delete X[D.path[0]];else{let A=X;for(let j=0;j<D.path.length-2;j++)A=A[D.path[j]];delete A[D.path[D.path.length-2]][D.path[D.path.length-1]]}return X};f==="base"?C(h):f==="study"&&I(h),W(E=>({...E,[f]:!0})),at(null),ie("success",`${D.type==="section"?"Section":"Rule"} deleted`)},lt=()=>{if(!Be.trim())return;const h=pt(_,["custom_instructions"])||[];G(["custom_instructions"],[...h,Be.trim()]),je(""),we(!1),ie("success","Custom instruction added")},Ke=h=>{const X=(pt(_,["custom_instructions"])||[]).filter((A,j)=>j!==h);G(["custom_instructions"],X),ie("success","Custom instruction removed")},ht=(h,E)=>{if(!E.trim()){Ke(h);return}const A=[...pt(_,["custom_instructions"])||[]];A[h]=E.trim(),G(["custom_instructions"],A),Ye(null),ie("success","Custom instruction updated")},et=(h,E)=>{if(!E.trim())return;const X=h[h.length-1]==="custom_instructions"?E.trim():E.trim().replace(/\s+/g,"_").toLowerCase(),A=pt(_,h)||[];G(h,[...A,X]),Fe(""),Ve(null),ie("success","Item added")},L=(h,E)=>{const A=(pt(_,h)||[]).filter((j,J)=>J!==E);G(h,A),ie("success","Item removed")},ct=()=>{var H,fe,_e;const h=_||he();let E=`You are an expert radiologist generating a comprehensive radiology report.

`;const X=t&&t[a]?t[a].template:"[Template will be inserted here]";X&&(E+=`TEMPLATE STRUCTURE - MANDATORY COMPLIANCE:

`,E+=X+`

`,E+=`CRITICAL: Preserve ALL section headers (text ending with ":") EXACTLY as shown above. Any deviation from the template structure will be considered an error.

`,E+=`CRITICAL SPACING RULE: Always include a space after colons in section headers (e.g., "Neurovascular structures: Unremarkable" NOT "Neurovascular structures:Unremarkable"). This spacing is mandatory and must be preserved exactly as shown in the template.

`),E+=`MANDATORY FINDINGS INCORPORATION:

`,E+=`=== FINDINGS TO INCORPORATE ===
`,E+=`[YOUR DICTATED FINDINGS WILL BE INSERTED HERE]
`,E+=`=== END OF FINDINGS ===

`,E+=`CRITICAL REQUIREMENT: Every single finding above MUST appear in the appropriate section of your report. Omitting any finding is unacceptable.

`;const A=[],j=[],J=[];if(h.impression){if(h.impression.numerically_itemized?(A.push("IMPRESSION FORMATTING: The impression section MUST be formatted as a numbered list (1, 2, 3, etc.). This is non-negotiable."),A.push("IMPRESSION SPACING: Separate each numbered item with a double line break.")):(H=h.formatting)!=null&&H.use_bullet_points?(A.push("IMPRESSION FORMATTING: The impression section MUST be formatted as a bullet point list using â€¢ symbols."),A.push("IMPRESSION SPACING: Separate each bullet point with a double line break."),A.push('BULLET FORMAT: Start each item with "â€¢ " followed by the diagnosis/finding.')):j.push("IMPRESSION SPACING: Write the impression as separate statements, each separated by a double line break."),h.impression.exclude_by_default&&Array.isArray(h.impression.exclude_by_default)&&h.impression.exclude_by_default.length>0){const V=h.impression.exclude_by_default.map(M=>M.replace(/_/g," ").toLowerCase());A.push("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),A.push("âš ï¸ MANDATORY EXCLUSION RULES FOR IMPRESSION:"),V.forEach(M=>{A.push(`âŒ DO NOT include "${M}" in the impression section`)}),V.some(M=>M.includes("baker"))&&A.push(`âŒ SPECIFICALLY: Never mention "Small Baker's cyst" or any small Baker cyst in the impression`),A.push("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),A.push("These exclusions are MANDATORY unless causing active symptoms.")}h.impression.first_item_should_address_clinical_concern&&A.push("CLINICAL FOCUS: The first item in the impression MUST directly address the primary clinical concern or indication."),h.impression.omit_minor_or_incidental_findings_unless_relevant&&J.push("Focus the impression on clinically significant findings. Omit mild or incidental findings unless they relate to the clinical history."),h.impression.concise_summary&&J.push("Keep the impression concise and focused on the most important findings."),h.impression.include_recommendations&&J.push("Include specific follow-up recommendations when clinically appropriate."),h.impression.mention_muscle_atrophy_if&&(h.impression.mention_muscle_atrophy_if==="moderate_or_severe"?A.push("MUSCLE ATROPHY RULE: Only mention muscle atrophy if it is explicitly described as moderate or severe. Do not mention mild muscle atrophy."):h.impression.mention_muscle_atrophy_if==="severe"?A.push("MUSCLE ATROPHY RULE: Only mention muscle atrophy if it is explicitly described as severe. Do not mention mild or moderate muscle atrophy."):h.impression.mention_muscle_atrophy_if==="never"&&A.push("MUSCLE ATROPHY RULE: Do NOT mention muscle atrophy regardless of severity."))}return h.formatting&&(h.formatting.preserve_template_punctuation&&A.push('CRITICAL: Preserve ALL punctuation, spacing, and formatting EXACTLY as shown in the template. This includes spaces after colons (e.g., "Section: Content" not "Section:Content"), proper line breaks, and all other spacing.'),h.formatting.use_bullet_points&&j.push("Use bullet points for listing multiple findings within each section."),h.formatting.capitalize_sections&&j.push("Ensure all section headers are in UPPERCASE.")),h.report&&(h.report.no_hallucinated_findings&&A.push("ACCURACY RULE: Do not invent, assume, or hallucinate any findings. Only report what is explicitly stated in the provided findings."),h.report.cartilage_placement&&(h.report.cartilage_placement.trochlear_cartilage_in_patellofemoral&&A.push("CARTILAGE PLACEMENT: Trochlear cartilage findings MUST be described within the patellofemoral compartment section."),h.report.cartilage_placement.mention_patellar_if_trochlear_defect_present&&A.push("CARTILAGE CORRELATION: If any trochlear defect is present, you MUST explicitly state the condition of the patellar cartilage (intact or abnormal).")),h.report.expand_lesions&&J.push("For each lesion, describe location, size, morphology, and enhancement characteristics when available.")),h.clinical&&(h.clinical.correlate_with_symptoms&&J.push("Correlate findings with clinical symptoms when clinical history is provided."),h.clinical.mention_clinical_significance&&J.push("Comment on the clinical significance of major findings.")),h.measurements&&(h.measurements.include_all_measurements&&j.push("Include all measurements mentioned in the findings."),h.measurements.use_metric_system&&j.push("Use metric system (mm, cm) for all measurements.")),h.anatomy&&(h.anatomy.combine_meniscus_and_cartilage_findings&&J.push("Combine meniscus and cartilage findings in the same section for better organization."),h.anatomy.group_by_anatomic_region&&J.push("Group findings by anatomic region (e.g., anterior, posterior, medial, lateral).")),h.severity&&(h.severity.use_standard_grading&&j.push("Use standard grading systems (e.g., mild/moderate/severe) consistently."),h.severity.avoid_vague_terms&&j.push('Avoid vague terms like "some" or "several" - be specific.')),h.style&&(h.style.active_voice&&J.push("Use active voice when describing findings."),h.style.professional_tone&&J.push("Maintain a professional, objective tone throughout.")),h.custom_instructions&&(Array.isArray(h.custom_instructions)?h.custom_instructions.forEach(V=>{A.push(`CUSTOM RULE: ${V}`)}):typeof h.custom_instructions=="string"&&A.push(`CUSTOM RULE: ${h.custom_instructions}`)),A.length>0&&(E+=`CRITICAL RULES - MUST BE FOLLOWED:
`,A.forEach((V,M)=>{E+=`${M+1}. ${V}
`}),E+=`
`),j.length>0&&(E+=`FORMATTING REQUIREMENTS:
`,j.forEach((V,M)=>{E+=`${M+1}. ${V}
`}),E+=`
`),J.length>0&&(E+=`CONTENT GUIDELINES:
`,J.forEach((V,M)=>{E+=`${M+1}. ${V}
`}),E+=`
`),h.examples&&Array.isArray(h.examples)&&(E+=`EXAMPLES:
`,h.examples.forEach((V,M)=>{V.context?E+=`Example ${M+1} (${V.context}):
`:E+=`Example ${M+1}:
`,V.input&&(E+=`Input: ${V.input}
`),V.output&&(E+=`Output: ${V.output}
`),E+=`
`})),E+=`FINAL REQUIREMENTS:
`,E+=`1. Use the EXACT section headers from the template (preserve all text ending with ":")
`,E+=`2. Incorporate EVERY SINGLE finding from the "=== FINDINGS TO INCORPORATE ===" section
`,E+=`3. Follow ALL critical rules above without exception
`,E+=`4. Apply formatting requirements consistently
`,E+=`5. Write natural, clinically accurate content within each section
`,(fe=h.impression)!=null&&fe.numerically_itemized?E+=`6. IMPRESSION FORMATTING: Use numbered list format (1, 2, 3, etc.) with double line breaks between items.
`:(_e=h.formatting)!=null&&_e.use_bullet_points?E+=`6. IMPRESSION FORMATTING: Use bullet point format (â€¢ symbol) with double line breaks between items.
`:E+=`6. IMPRESSION FORMATTING: Use paragraph format with double line breaks between separate statements.
`,E+=`
Generate the complete radiology report now. Focus on accuracy and proper formatting as specified above.
`,E},Ie=async()=>{if(R){y(!0);try{if(R.base&&k){const h=await mn(i,k,n);if(h.success)ie("success","Base logic saved successfully");else throw new Error(h.error)}if(R.study&&v){const h=await hn(i,a,v,n,!0);if(h.success)ie("success","Study-specific logic saved successfully");else throw new Error(h.error)}W(null),await Ne()}catch(h){ie("error",`Save failed: ${h instanceof Error?h.message:"Unknown error"}`)}finally{y(!1),setTimeout(()=>{const h=document.activeElement;h&&h.blur&&h.blur(),document.body.focus();const E=document.querySelector('[contenteditable="true"]');E&&E.focus()},100)}}},bt=async()=>{y(!0);try{const h=await mo(i,a,f,n);if(h.success)ie("success",`${f==="base"?"Base":"Study"} logic reset to default`),await Ne();else throw new Error(h.error)}catch(h){ie("error",`Reset failed: ${h instanceof Error?h.message:"Unknown error"}`)}finally{y(!1),K(!1),setTimeout(()=>{const h=document.activeElement;h&&h.blur&&h.blur(),document.body.focus();const E=document.querySelector('[contenteditable="true"]');E&&E.focus()},100)}},ie=(h,E)=>{re({type:h,text:E}),setTimeout(()=>re(null),3e3)},yt=(h,E=[],X=!1)=>!h||typeof h!="object"?null:(Object.keys(h).forEach(A=>{A.includes("impression")&&typeof h[A]=="object"&&!Array.isArray(h[A])&&(h[A].exclude_by_default||(h[A].exclude_by_default=[]))}),Object.entries(h).map(([A,j])=>{const J=[...E,A],H=A.replace(/_/g," ").replace(/\b\w/g,V=>V.toUpperCase()),fe=f==="preview"?go(J,de):null,_e={default:"#888",base:"#3498db",study:"#9b59b6"}[fe||"default"];return e.jsx("div",{style:{marginLeft:E.length*20,marginBottom:8},children:typeof j=="object"&&!Array.isArray(j)?e.jsxs("div",{children:[e.jsxs("h4",{style:{color:"#3ABC96",fontSize:14,fontWeight:600,marginBottom:8,display:"flex",alignItems:"center",gap:8},children:[H,fe&&f==="preview"&&e.jsxs("span",{style:{fontSize:10,color:_e,fontWeight:400,padding:"2px 6px",backgroundColor:`${_e}20`,borderRadius:4},children:["from ",fe]}),!X&&f!=="preview"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>Je(J.join(".")),style:{padding:"2px 8px",fontSize:11,backgroundColor:"#27ae60",color:"#fff",border:"none",borderRadius:4,cursor:"pointer"},children:"+ Add Rule"}),e.jsx("button",{onClick:()=>at({path:J,type:"section"}),style:{padding:"2px 8px",fontSize:11,backgroundColor:"#e74c3c",color:"#fff",border:"none",borderRadius:4,cursor:"pointer"},children:"Delete Section"})]})]}),kt===J.join(".")&&e.jsxs("div",{style:{marginBottom:12,padding:12,backgroundColor:"rgba(255, 255, 255, 0.05)",borderRadius:6},children:[e.jsx("input",{type:"text",value:He,onChange:V=>Ze(V.target.value),placeholder:"Enter rule name...",style:{padding:"6px 12px",backgroundColor:"rgba(255, 255, 255, 0.1)",color:"#fff",border:"1px solid rgba(255, 255, 255, 0.2)",borderRadius:4,marginRight:8,width:200},onKeyPress:V=>V.key==="Enter"&&Et(J)}),e.jsx("button",{onClick:()=>Et(J),style:{padding:"6px 12px",backgroundColor:"#27ae60",color:"#fff",border:"none",borderRadius:4,cursor:"pointer",marginRight:8},children:"Add"}),e.jsx("button",{onClick:()=>{Je(null),Ze("")},style:{padding:"6px 12px",backgroundColor:"rgba(255, 255, 255, 0.1)",color:"#fff",border:"none",borderRadius:4,cursor:"pointer"},children:"Cancel"})]}),yt(j,J,X)]}):e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[e.jsxs("span",{style:{color:"#ccc",fontSize:12,minWidth:150,display:"flex",alignItems:"center",gap:8},children:[H,":",fe&&f==="preview"&&e.jsx("span",{style:{fontSize:9,color:_e,padding:"1px 4px",backgroundColor:`${_e}20`,borderRadius:3},children:fe}),!X&&f!=="preview"&&A!=="custom_instructions"&&e.jsx("button",{onClick:()=>at({path:J,type:"rule"}),style:{padding:"2px 6px",fontSize:10,backgroundColor:"#e74c3c",color:"#fff",border:"none",borderRadius:3,cursor:"pointer",marginLeft:8},children:"Delete"})]}),X?e.jsx("span",{style:{color:"#fff",fontSize:12},children:Array.isArray(j)?j.join(", "):String(j)}):typeof j=="boolean"?e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"checkbox",checked:j,onChange:V=>G(J,V.target.checked),disabled:X}),e.jsx("span",{style:{color:j?"#3ABC96":"#E36756",fontSize:12},children:j?"âœ“ Enabled":"âœ— Disabled"})]}):Array.isArray(j)?e.jsxs("div",{style:{flex:1,backgroundColor:A==="custom_instructions"?"rgba(52, 152, 219, 0.05)":A==="exclude_by_default"?"rgba(231, 76, 60, 0.05)":"rgba(255, 255, 255, 0.02)",border:A==="custom_instructions"?"1px solid rgba(52, 152, 219, 0.2)":A==="exclude_by_default"?"1px solid rgba(231, 76, 60, 0.2)":"1px solid rgba(255, 255, 255, 0.1)",borderRadius:8,padding:12,marginTop:4},children:[e.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:10},children:e.jsxs("div",{style:{fontSize:11,fontWeight:600,color:A==="custom_instructions"?"#3498db":A==="exclude_by_default"?"#e74c3c":"#3ABC96",textTransform:"uppercase",letterSpacing:.5},children:[A==="custom_instructions"?"ðŸ“ CUSTOM INSTRUCTIONS":A==="exclude_by_default"?"ðŸš« EXCLUSIONS":`ðŸ“‹ ${A.replace(/_/g," ").toUpperCase()}`,e.jsxs("span",{style:{marginLeft:8,fontSize:10,opacity:.7,fontWeight:400},children:["(",j.length," items)"]})]})}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:8,marginBottom:10,minHeight:28},children:j.length===0?e.jsx("span",{style:{color:"#666",fontSize:11,fontStyle:"italic",padding:"4px 0"},children:"No items added yet"}):j.map((V,M)=>e.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:6,padding:A==="custom_instructions"?"6px 10px":"4px 10px",backgroundColor:A==="custom_instructions"?"rgba(52, 152, 219, 0.15)":A==="exclude_by_default"?"rgba(231, 76, 60, 0.15)":"rgba(58, 188, 150, 0.15)",border:A==="custom_instructions"?"1px solid rgba(52, 152, 219, 0.3)":A==="exclude_by_default"?"1px solid rgba(231, 76, 60, 0.3)":"1px solid rgba(58, 188, 150, 0.3)",borderRadius:A==="custom_instructions"?6:14,fontSize:11,maxWidth:A==="custom_instructions"?"100%":"auto"},children:[e.jsx("span",{style:{color:"#fff",lineHeight:A==="custom_instructions"?1.4:1},children:typeof V=="string"?A==="custom_instructions"?V:V.replace(/_/g," "):V}),!X&&e.jsx("button",{onClick:()=>L(J,M),style:{background:"none",border:"none",color:A==="exclude_by_default"?"#e74c3c":"#999",cursor:"pointer",padding:0,fontSize:16,lineHeight:1,opacity:.8,transition:"opacity 0.2s"},onMouseEnter:xe=>xe.currentTarget.style.opacity="1",onMouseLeave:xe=>xe.currentTarget.style.opacity="0.8",children:"Ã—"})]},M))}),!X&&(ft===J.join(".")?e.jsxs("div",{style:{display:"flex",gap:6,padding:"8px",backgroundColor:"rgba(0, 0, 0, 0.2)",borderRadius:6,border:"1px solid rgba(255, 255, 255, 0.1)"},children:[e.jsx("input",{type:"text",value:Pe,onChange:V=>Fe(V.target.value),placeholder:A==="custom_instructions"?"Enter instruction...":A==="exclude_by_default"?"Enter exclusion term...":"Enter item...",style:{flex:1,padding:"5px 10px",backgroundColor:"rgba(255, 255, 255, 0.08)",border:A==="custom_instructions"?"1px solid rgba(52, 152, 219, 0.4)":A==="exclude_by_default"?"1px solid rgba(231, 76, 60, 0.4)":"1px solid rgba(58, 188, 150, 0.4)",borderRadius:4,color:"#fff",fontSize:11,minWidth:A==="custom_instructions"?300:150},onKeyPress:V=>{V.key==="Enter"&&et(J,Pe),V.key==="Escape"&&(Ve(null),Fe(""))},autoFocus:!0}),e.jsx("button",{onClick:()=>et(J,Pe),disabled:!Pe.trim(),style:{padding:"5px 12px",backgroundColor:Pe.trim()?"#27ae60":"rgba(39, 174, 96, 0.3)",color:"#fff",border:"none",borderRadius:4,cursor:Pe.trim()?"pointer":"not-allowed",fontSize:11,fontWeight:500},children:"Add"}),e.jsx("button",{onClick:()=>{Ve(null),Fe("")},style:{padding:"5px 12px",backgroundColor:"rgba(255, 255, 255, 0.1)",color:"#fff",border:"none",borderRadius:4,cursor:"pointer",fontSize:11},children:"Cancel"})]}):e.jsxs("button",{onClick:()=>Ve(J.join(".")),style:{padding:"4px 10px",backgroundColor:A==="custom_instructions"?"rgba(52, 152, 219, 0.2)":A==="exclude_by_default"?"rgba(231, 76, 60, 0.2)":"rgba(58, 188, 150, 0.2)",color:A==="custom_instructions"?"#3498db":A==="exclude_by_default"?"#e74c3c":"#3ABC96",border:A==="custom_instructions"?"1px solid rgba(52, 152, 219, 0.3)":A==="exclude_by_default"?"1px solid rgba(231, 76, 60, 0.3)":"1px solid rgba(58, 188, 150, 0.3)",borderRadius:4,cursor:"pointer",fontSize:10,fontWeight:500},children:["+ Add ",A==="exclude_by_default"?"Exclusion":A==="custom_instructions"?"Instruction":"Item"]}))]}):e.jsx("input",{type:"text",value:String(j).replace(/_/g," "),onChange:V=>G(J,V.target.value),disabled:X,style:{padding:"4px 8px",backgroundColor:"rgba(255, 255, 255, 0.05)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:4,color:"#fff",fontSize:12,minWidth:150}})]})},J.join("."))}).filter(Boolean));return e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.8)",zIndex:1e4,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{style:{width:"90vw",maxWidth:1200,height:"90vh",backgroundColor:"rgb(40, 44, 52)",borderRadius:12,display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsxs("div",{style:{padding:"16px 20px",borderBottom:"1px solid rgba(255, 255, 255, 0.1)",backgroundColor:"rgba(0, 0, 0, 0.3)"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("h2",{style:{color:"#fff",margin:0,fontSize:18,fontWeight:600},children:"Enhanced Logic Editor"}),e.jsx("input",{list:"logic-study-types",value:a,onChange:h=>g(h.target.value),placeholder:"Select study type...",style:{marginTop:8,padding:"6px 12px",backgroundColor:"rgba(255, 255, 255, 0.05)",color:"#fff",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:6,width:250}}),e.jsx("datalist",{id:"logic-study-types",children:Object.keys(t).sort().map(h=>e.jsx("option",{value:h},h))})]}),e.jsx("button",{onClick:()=>{const h=document.querySelector('[contenteditable="true"]');h&&h.focus(),r()},style:{padding:"8px 16px",backgroundColor:"rgba(255, 255, 255, 0.1)",color:"#fff",border:"none",borderRadius:6,cursor:"pointer"},children:"Close"})]}),e.jsxs("div",{style:{marginTop:16,display:"flex",gap:8,flexWrap:"wrap",alignItems:"center"},children:[e.jsxs("button",{onClick:()=>m("base"),style:{padding:"8px 16px",backgroundColor:f==="base"?"#3498db":"rgba(255, 255, 255, 0.1)",color:"#fff",border:"none",borderRadius:6,cursor:"pointer",fontSize:14},children:["Edit Base Logic",T.base&&e.jsxs("span",{style:{fontSize:10,opacity:.7,marginLeft:8},children:["(Updated: ",new Date(T.base).toLocaleDateString(),")"]})]}),e.jsxs("button",{onClick:()=>m("study"),style:{padding:"8px 16px",backgroundColor:f==="study"?"#9b59b6":"rgba(255, 255, 255, 0.1)",color:"#fff",border:"none",borderRadius:6,cursor:"pointer",fontSize:14},children:["Edit Study-Specific Logic",T.study&&e.jsxs("span",{style:{fontSize:10,opacity:.7,marginLeft:8},children:["(Updated: ",new Date(T.study).toLocaleDateString(),")"]})]}),e.jsx("button",{onClick:()=>m("preview"),style:{padding:"8px 16px",backgroundColor:f==="preview"?"#27ae60":"rgba(255, 255, 255, 0.1)",color:"#fff",border:"none",borderRadius:6,cursor:"pointer",fontSize:14},children:"Preview Merged Logic"}),f==="study"&&v&&Object.keys(v).length>0&&e.jsx("button",{onClick:()=>pe(!se),style:{padding:"8px 16px",backgroundColor:se?"#e67e22":"rgba(255, 255, 255, 0.1)",color:"#fff",border:"none",borderRadius:6,cursor:"pointer",fontSize:14},children:se?"Hide Diff":"Show Diff"}),e.jsx("div",{style:{flex:1}}),e.jsxs("button",{onClick:l>=4?()=>qe(!0):void 0,disabled:l<4,title:l<4?"Requires Developer tier":"Preview AI Prompt",style:{padding:"8px 16px",backgroundColor:l<4?"#666":"#8e44ad",color:l<4?"#999":"#fff",border:"none",borderRadius:6,cursor:l<4?"not-allowed":"pointer",fontSize:14,fontWeight:500,display:"flex",alignItems:"center",gap:6,opacity:l<4?.6:1},children:[e.jsx("span",{style:{fontSize:16},children:l<4?"ðŸ”’":"ðŸ¤–"}),"Preview AI Prompt ",l<4&&"(Dev Only)"]})]})]}),e.jsxs("div",{style:{padding:"12px 20px",backgroundColor:f==="base"?"rgba(52, 152, 219, 0.1)":f==="study"?"rgba(155, 89, 182, 0.1)":"rgba(39, 174, 96, 0.1)",borderBottom:"1px solid rgba(255, 255, 255, 0.05)"},children:[e.jsxs("p",{style:{color:"#ccc",fontSize:13,margin:0},children:[f==="base"&&"Base logic applies to ALL study types. Changes here affect all templates.",f==="study"&&`Study-specific logic for ${a}. Overrides base logic settings.`,f==="preview"&&"Preview shows the final merged logic that will be used for report generation."]}),se&&f==="study"&&e.jsxs("div",{style:{marginTop:8},children:[e.jsx("strong",{style:{color:"#e67e22",fontSize:12},children:"Differences from base:"}),e.jsx("ul",{style:{margin:"4px 0",paddingLeft:20,fontSize:11,color:"#aaa"},children:fo(k||he(),v).map((h,E)=>e.jsx("li",{children:h},E))})]})]}),e.jsxs("div",{style:{flex:1,overflowY:"auto",padding:20,backgroundColor:"rgba(0, 0, 0, 0.2)"},children:[f!=="preview"&&e.jsxs("div",{style:{marginBottom:20,display:"flex",gap:8},children:[e.jsx("button",{onClick:()=>Le(!0),style:{padding:"8px 16px",backgroundColor:"#27ae60",color:"#fff",border:"none",borderRadius:6,cursor:"pointer",fontSize:14},children:"+ Add Section"}),e.jsx("button",{onClick:()=>we(!0),style:{padding:"8px 16px",backgroundColor:"#3498db",color:"#fff",border:"none",borderRadius:6,cursor:"pointer",fontSize:14},children:"+ Add Custom Instruction"})]}),Te&&e.jsxs("div",{style:{marginBottom:20,padding:16,backgroundColor:"rgba(255, 255, 255, 0.05)",borderRadius:8},children:[e.jsx("input",{type:"text",value:Ge,onChange:h=>it(h.target.value),placeholder:"Enter section name...",style:{padding:"8px 12px",backgroundColor:"rgba(255, 255, 255, 0.1)",color:"#fff",border:"1px solid rgba(255, 255, 255, 0.2)",borderRadius:4,marginRight:8,width:250},onKeyPress:h=>h.key==="Enter"&&ae()}),e.jsx("button",{onClick:ae,style:{padding:"8px 16px",backgroundColor:"#27ae60",color:"#fff",border:"none",borderRadius:4,cursor:"pointer",marginRight:8},children:"Add Section"}),e.jsx("button",{onClick:()=>{Le(!1),it("")},style:{padding:"8px 16px",backgroundColor:"rgba(255, 255, 255, 0.1)",color:"#fff",border:"none",borderRadius:4,cursor:"pointer"},children:"Cancel"})]}),Qe&&e.jsxs("div",{style:{marginBottom:20,padding:16,backgroundColor:"rgba(52, 152, 219, 0.05)",borderRadius:8,border:"1px solid rgba(52, 152, 219, 0.2)"},children:[e.jsx("h5",{style:{color:"#3498db",fontSize:13,marginBottom:10,fontWeight:500},children:"Add a New Custom Instruction"}),e.jsx("p",{style:{color:"#aaa",fontSize:11,marginBottom:12},children:"Enter a single, specific instruction for the AI to follow when generating reports."}),e.jsx("textarea",{value:Be,onChange:h=>je(h.target.value),placeholder:"Example: Always mention comparison to prior studies if available...",style:{padding:"10px 12px",backgroundColor:"rgba(255, 255, 255, 0.08)",color:"#fff",border:"1px solid rgba(52, 152, 219, 0.3)",borderRadius:4,marginBottom:12,width:"100%",minHeight:80,resize:"vertical",fontSize:12,fontFamily:"inherit"},onKeyDown:h=>{h.key==="Enter"&&h.ctrlKey?lt():h.key==="Escape"&&(we(!1),je(""))}}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{style:{color:"#888",fontSize:10},children:"Tip: Press Ctrl+Enter to add, Esc to cancel"}),e.jsxs("div",{children:[e.jsx("button",{onClick:lt,disabled:!Be.trim(),style:{padding:"8px 16px",backgroundColor:Be.trim()?"#3498db":"rgba(52, 152, 219, 0.3)",color:"#fff",border:"none",borderRadius:4,cursor:Be.trim()?"pointer":"not-allowed",marginRight:8,fontSize:13},children:"Add Instruction"}),e.jsx("button",{onClick:()=>{we(!1),je("")},style:{padding:"8px 16px",backgroundColor:"rgba(255, 255, 255, 0.1)",color:"#fff",border:"none",borderRadius:4,cursor:"pointer",fontSize:13},children:"Cancel"})]})]})]}),(_==null?void 0:_.custom_instructions)&&_.custom_instructions.length>0&&e.jsxs("div",{style:{marginBottom:20,padding:16,backgroundColor:"rgba(58, 188, 150, 0.05)",borderRadius:8,border:"1px solid rgba(58, 188, 150, 0.2)"},children:[e.jsxs("h4",{style:{color:"#3ABC96",fontSize:14,marginBottom:12,fontWeight:600},children:["Custom Instructions (",_.custom_instructions.length,")"]}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:8},children:_.custom_instructions.map((h,E)=>e.jsxs("div",{style:{padding:12,backgroundColor:"rgba(255, 255, 255, 0.05)",borderRadius:6,border:"1px solid rgba(255, 255, 255, 0.1)",display:"flex",alignItems:"flex-start",gap:12},children:[e.jsx("div",{style:{minWidth:24,height:24,backgroundColor:"rgba(58, 188, 150, 0.2)",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",fontSize:11,color:"#3ABC96",fontWeight:600,flexShrink:0},children:E+1}),($==null?void 0:$.index)===E?e.jsxs("div",{style:{flex:1,display:"flex",gap:8},children:[e.jsx("textarea",{value:$.value,onChange:X=>Ye({index:E,value:X.target.value}),style:{flex:1,padding:"6px 10px",backgroundColor:"rgba(255, 255, 255, 0.08)",color:"#fff",border:"1px solid rgba(58, 188, 150, 0.4)",borderRadius:4,fontSize:12,minHeight:60,resize:"vertical",fontFamily:"inherit"},autoFocus:!0,onKeyDown:X=>{X.key==="Escape"?Ye(null):X.key==="Enter"&&X.ctrlKey&&ht(E,$.value)}}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:4},children:[e.jsx("button",{onClick:()=>ht(E,$.value),style:{padding:"4px 8px",fontSize:10,backgroundColor:"#27ae60",color:"#fff",border:"none",borderRadius:3,cursor:"pointer"},children:"Save"}),e.jsx("button",{onClick:()=>Ye(null),style:{padding:"4px 8px",fontSize:10,backgroundColor:"rgba(255, 255, 255, 0.1)",color:"#fff",border:"none",borderRadius:3,cursor:"pointer"},children:"Cancel"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{flex:1,color:"#fff",fontSize:12,lineHeight:1.5,wordBreak:"break-word"},children:h}),f!=="preview"&&e.jsxs("div",{style:{display:"flex",gap:4,flexShrink:0},children:[e.jsx("button",{onClick:()=>Ye({index:E,value:h}),style:{padding:"4px 8px",fontSize:10,backgroundColor:"#3498db",color:"#fff",border:"none",borderRadius:3,cursor:"pointer"},children:"Edit"}),e.jsx("button",{onClick:()=>Ke(E),style:{padding:"4px 8px",fontSize:10,backgroundColor:"#e74c3c",color:"#fff",border:"none",borderRadius:3,cursor:"pointer"},children:"Delete"})]})]})]},E))})]}),c?e.jsx("div",{style:{color:"#ccc",textAlign:"center",padding:40},children:"Loading logic configuration..."}):_?yt(_,[],f==="preview"):e.jsx("div",{style:{color:"#888",textAlign:"center",padding:40},children:f==="study"?"No study-specific overrides defined. Using base logic.":"No logic loaded"})]}),e.jsxs("div",{style:{padding:"16px 20px",borderTop:"1px solid rgba(255, 255, 255, 0.1)",backgroundColor:"rgba(0, 0, 0, 0.3)",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("div",{style:{display:"flex",gap:8},children:f!=="preview"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:Ie,disabled:!R||c,style:{padding:"8px 20px",backgroundColor:R?"#27ae60":"rgba(255, 255, 255, 0.05)",color:R?"#fff":"#888",border:"none",borderRadius:6,cursor:R?"pointer":"not-allowed",fontWeight:500},children:c?"Saving...":"Save Changes"}),e.jsx("button",{onClick:()=>K(!0),style:{padding:"8px 20px",backgroundColor:"rgba(231, 76, 60, 0.8)",color:"#fff",border:"none",borderRadius:6,cursor:"pointer"},children:"Reset to Default"})]})}),n&&e.jsx("span",{style:{color:"#f39c12",fontSize:12},children:"âš  Offline Mode - Changes saved locally"})]}),D&&e.jsxs("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",backgroundColor:"rgb(40, 44, 52)",padding:20,borderRadius:8,boxShadow:"0 4px 20px rgba(0, 0, 0, 0.5)",zIndex:10001},children:[e.jsxs("p",{style:{color:"#fff",marginBottom:16},children:["Are you sure you want to delete this ",D.type,"?"]}),e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{onClick:()=>at(null),style:{padding:"6px 16px",backgroundColor:"rgba(255, 255, 255, 0.1)",color:"#fff",border:"none",borderRadius:4,cursor:"pointer"},children:"Cancel"}),e.jsx("button",{onClick:mt,style:{padding:"6px 16px",backgroundColor:"#e74c3c",color:"#fff",border:"none",borderRadius:4,cursor:"pointer"},children:"Delete"})]})]}),ne&&e.jsxs("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",backgroundColor:"rgb(40, 44, 52)",padding:20,borderRadius:8,boxShadow:"0 4px 20px rgba(0, 0, 0, 0.5)",zIndex:10001},children:[e.jsxs("p",{style:{color:"#fff",marginBottom:16},children:["Reset ",f==="base"?"base":"study-specific"," logic to default?"]}),e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{onClick:()=>K(!1),style:{padding:"6px 16px",backgroundColor:"rgba(255, 255, 255, 0.1)",color:"#fff",border:"none",borderRadius:4,cursor:"pointer"},children:"Cancel"}),e.jsx("button",{onClick:bt,style:{padding:"6px 16px",backgroundColor:"#e74c3c",color:"#fff",border:"none",borderRadius:4,cursor:"pointer"},children:"Reset"})]})]}),B&&e.jsx("div",{style:{position:"absolute",bottom:20,right:20,padding:"12px 20px",backgroundColor:B.type==="success"?"#27ae60":"#e74c3c",color:"#fff",borderRadius:6,boxShadow:"0 2px 10px rgba(0, 0, 0, 0.3)",fontSize:14},children:B.text}),gt&&e.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10002},children:e.jsxs("div",{style:{width:"80%",maxWidth:900,height:"80%",backgroundColor:"rgb(30, 30, 35)",borderRadius:12,display:"flex",flexDirection:"column",boxShadow:"0 10px 40px rgba(0, 0, 0, 0.5)"},children:[e.jsxs("div",{style:{padding:"16px 20px",borderBottom:"1px solid rgba(255, 255, 255, 0.1)",backgroundColor:"rgba(142, 68, 173, 0.1)",borderRadius:"12px 12px 0 0",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10},children:[e.jsx("span",{style:{fontSize:20},children:"ðŸ¤–"}),e.jsx("h3",{style:{color:"#fff",margin:0,fontSize:16,fontWeight:600},children:"AI Prompt Preview"}),e.jsx("span",{style:{color:"#aaa",fontSize:12,backgroundColor:"rgba(255, 255, 255, 0.1)",padding:"2px 8px",borderRadius:4},children:f==="base"?"Base Logic":f==="study"?`Study: ${a}`:"Merged"})]}),e.jsx("button",{onClick:()=>qe(!1),style:{padding:"6px 12px",backgroundColor:"rgba(255, 255, 255, 0.1)",color:"#fff",border:"none",borderRadius:6,cursor:"pointer",fontSize:14},children:"Close"})]}),e.jsx("div",{style:{flex:1,padding:20,overflowY:"auto",backgroundColor:"rgba(0, 0, 0, 0.3)"},children:e.jsx("pre",{style:{margin:0,padding:16,backgroundColor:"rgba(0, 0, 0, 0.5)",border:"1px solid rgba(142, 68, 173, 0.3)",borderRadius:8,color:"#fff",fontSize:12,lineHeight:1.6,fontFamily:'Consolas, Monaco, "Courier New", monospace',whiteSpace:"pre-wrap",wordWrap:"break-word"},children:ct()})}),e.jsxs("div",{style:{padding:"12px 20px",borderTop:"1px solid rgba(255, 255, 255, 0.1)",backgroundColor:"rgba(0, 0, 0, 0.2)",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{style:{color:"#888",fontSize:11},children:"This preview shows how your logic settings will be translated into AI instructions"}),e.jsx("button",{onClick:()=>{navigator.clipboard.writeText(ct()),ie("success","Prompt copied to clipboard!")},style:{padding:"6px 16px",backgroundColor:"#8e44ad",color:"#fff",border:"none",borderRadius:4,cursor:"pointer",fontSize:12},children:"Copy to Clipboard"})]})]})})]})})}const Mt=p.forwardRef(({value:i,onChange:s,placeholder:t,style:r,className:n},l)=>{const a=p.useRef(null),g=p.useRef(!1),f=p.useRef(""),m=p.useRef(null),c=p.useCallback(b=>{const F={zero:"0",one:"1",two:"2",three:"3",four:"4",five:"5",six:"6",seven:"7",eight:"8",nine:"9",ten:"10",eleven:"11",twelve:"12",thirteen:"13",fourteen:"14",fifteen:"15",sixteen:"16",seventeen:"17",eighteen:"18",nineteen:"19",twenty:"20",thirty:"30",forty:"40",fifty:"50",sixty:"60",seventy:"70",eighty:"80",ninety:"90",hundred:"100",thousand:"1000"};let _=b;_=_.replace(/\b(zero|one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve|thirteen|fourteen|fifteen|sixteen|seventeen|eighteen|nineteen|twenty|thirty|forty|fifty|sixty|seventy|eighty|ninety)\s+point\s+(zero|one|two|three|four|five|six|seven|eight|nine)/gi,(U,R,W)=>(F[R.toLowerCase()]||R)+"."+(F[W.toLowerCase()]||W)),_=_.replace(/\b(twenty|thirty|forty|fifty|sixty|seventy|eighty|ninety)[- ](one|two|three|four|five|six|seven|eight|nine)\b/gi,(U,R,W)=>{const ne=parseInt(F[R.toLowerCase()]||"0"),K=parseInt(F[W.toLowerCase()]||"0");return(ne+K).toString()});for(const[U,R]of Object.entries(F)){const W=new RegExp(`\\b${U}\\b`,"gi");_=_.replace(W,R)}return _},[]),y=p.useCallback(b=>b?b.replace(/\n/g,"<br>"):"",[]),k=p.useCallback(()=>{const b=window.getSelection();if(console.log("ðŸ” saveCursorPosition called, selection:",b==null?void 0:b.rangeCount),b&&b.rangeCount>0&&a.current){const F=b.getRangeAt(0);a.current.contains(F.commonAncestorContainer)?(m.current=F.cloneRange(),console.log("ðŸ’¾ Saved cursor position from saveCursorPosition, savedRange:",m.current)):console.log("âš ï¸ Selection not in editor")}else console.log("âš ï¸ No selection to save")},[]);p.useCallback(()=>{if(m.current&&a.current){const b=window.getSelection();b&&(b.removeAllRanges(),b.addRange(m.current))}},[]);const C=p.useCallback(()=>{if(a.current&&!g.current){const b=a.current.innerHTML;f.current=b,s(b)}},[s]),v=p.useCallback(b=>{b.preventDefault();const F=b.clipboardData.getData("text/plain");document.execCommand("insertText",!1,F)},[]);p.useEffect(()=>{if(a.current&&!f.current){const b=i||"";a.current.innerHTML=b,f.current=b}},[i]),p.useEffect(()=>{if(a.current&&!g.current){const b=i||"";a.current.innerHTML!==b&&(a.current.innerHTML=b,f.current=b)}},[i]),p.useEffect(()=>{const b=()=>{const _=window.getSelection();if(_&&_.rangeCount>0&&a.current){const U=_.getRangeAt(0);a.current.contains(U.commonAncestorContainer)&&(m.current=U.cloneRange(),console.log("ðŸ’¾ Saved cursor position on user interaction, range:",m.current))}};if(!a.current)return;const F=a.current;return F.addEventListener("click",b),F.addEventListener("keyup",b),F.addEventListener("focus",b),()=>{F&&(F.removeEventListener("click",b),F.removeEventListener("keyup",b),F.removeEventListener("focus",b))}},[]);const I=p.useCallback(b=>{if(!a.current)return;console.log("ðŸŽ¤ RichTextEditor.insertDictation called with:",b);const F=b.trim().toLowerCase();if(F==="delete that"||F==="scratch that"){const B=window.getSelection();if(B&&B.rangeCount>0){const T=B.getRangeAt(0);if(!T.collapsed)T.deleteContents();else{const Y=a.current.textContent||"",se=Y.lastIndexOf(" ");se>0&&(a.current.textContent=Y.substring(0,se))}}g.current=!0;const re=a.current.innerHTML;f.current=re,s(re),setTimeout(()=>{g.current=!1},10);return}let _=c(b.trim());F==="new line"?_=`
`:(F==="paragraph"||F==="new paragraph")&&(_=`

`);const U=a.current.textContent||"";(U.length===0||/[.!?]\s*$/.test(U))&&_.length>0&&/[a-z]/.test(_[0])&&(_=_.charAt(0).toUpperCase()+_.slice(1)),g.current=!0,a.current.focus();const R=window.getSelection();let W=!1;if(console.log("ðŸ” Checking selection state:",{hasSelection:R&&R.rangeCount>0,hasSavedRange:!!m.current,savedRangeValid:m.current?a.current.contains(m.current.commonAncestorContainer):!1}),R&&R.rangeCount>0){const B=R.getRangeAt(0);a.current.contains(B.commonAncestorContainer)&&(W=!0,console.log("ðŸ“ Using current selection"))}if(!W&&m.current)try{a.current.contains(m.current.commonAncestorContainer)?(R==null||R.removeAllRanges(),R==null||R.addRange(m.current),console.log("âœ… Restored saved cursor position"),W=!0):(console.log("âš ï¸ Saved cursor no longer valid - container not in editor"),m.current=null)}catch(B){console.log("âš ï¸ Could not restore saved cursor:",B),m.current=null}else W||console.log("âš ï¸ No saved range to restore");let ne=!1;if(W&&R&&R.rangeCount>0){const B=R.getRangeAt(0);if(a.current.contains(B.commonAncestorContainer)){if(console.log("ðŸ“ Inserting at cursor/selection position"),B.deleteContents(),_===`
`||_===`

`){const re=_===`

`?[document.createElement("br"),document.createElement("br")]:[document.createElement("br")];re.forEach(T=>B.insertNode(T)),B.setStartAfter(re[re.length-1])}else{const T=(B.startContainer.textContent||"")[B.startOffset-1]||"";T&&/[A-Za-z0-9]/.test(T)&&/[A-Za-z0-9]/.test(_[0])&&(_=" "+_);const Y=document.createTextNode(_);B.insertNode(Y),B.setStartAfter(Y)}B.collapse(!0),R.removeAllRanges(),R.addRange(B),m.current=B.cloneRange(),ne=!0}}ne||(console.log("âš ï¸ Fallback: appending to end"),_===`
`||_===`

`?(_===`

`?[document.createElement("br"),document.createElement("br")]:[document.createElement("br")]).forEach(re=>a.current.appendChild(re)):(U.length>0&&/[A-Za-z0-9]$/.test(U)&&/^[A-Za-z0-9]/.test(_)&&(_=" "+_),a.current.appendChild(document.createTextNode(_))));const K=a.current.innerHTML;f.current=K,s(K),setTimeout(()=>{g.current=!1},10)},[s,c]);return p.useImperativeHandle(l,()=>({insertDictation:I,getValue:()=>{var b;return((b=a.current)==null?void 0:b.innerHTML)||f.current||""},getPlainText:()=>{var b;return((b=a.current)==null?void 0:b.innerText)||""},setValue:b=>{if(a.current){g.current=!0;const F=y(b);a.current.innerHTML=F,f.current=F,s(F),setTimeout(()=>{g.current=!1},100)}},focus:()=>{var b;return(b=a.current)==null?void 0:b.focus()},getElement:()=>a.current,saveCursor:()=>{console.log("ðŸŽ¯ saveCursor called explicitly from App.tsx"),k()}}),[I,y,s,k]),e.jsx("div",{className:n,style:{border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:8,padding:"12px",backgroundColor:"rgba(255, 255, 255, 0.02)",...r},children:e.jsx("div",{ref:a,contentEditable:!0,onInput:C,onPaste:v,placeholder:t,style:{width:"100%",height:"100%",outline:"none",fontSize:14,lineHeight:1.6,fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',color:"#e0e0e0",backgroundColor:"transparent",whiteSpace:"pre-wrap",wordBreak:"break-word",overflowY:"auto"},"data-placeholder":t,suppressContentEditableWarning:!0})})});Mt.displayName="RichTextEditor";function bo(i,s){let t=null;const r=(...n)=>{t&&clearTimeout(t),t=setTimeout(()=>{i(...n)},s)};return r.cancel=()=>{t&&(clearTimeout(t),t=null)},r}const rt=new Map,Xe={getItem(i){if(rt.has(i))return rt.get(i)||null;const s=localStorage.getItem(i);return rt.set(i,s),s},setItem(i,s){rt.set(i,s),"requestIdleCallback"in window?requestIdleCallback(()=>{localStorage.setItem(i,s)}):setTimeout(()=>{localStorage.setItem(i,s)},0)},removeItem(i){rt.delete(i),"requestIdleCallback"in window?requestIdleCallback(()=>{localStorage.removeItem(i)}):setTimeout(()=>{localStorage.removeItem(i)},0)},clear(){rt.clear()}},z={DELETE_THAT:/\b(?:delete\s*(?:that|this|it|those|these|all|a|at|the|dad|bad)?|clear\s*(?:that|this|it|all|the|at|a)?|remove\s*(?:that|this|it|all|the|a)?|erase\s*(?:that|this|it|all)?|dolita|dalita|dilita|delita)\b/gi,UNDO_THAT:/\b(?:undo that|undo)\b/gi,REDO_THAT:/\b(?:redo that|redo)\b/gi,NEW_PARAGRAPH:/\b(?:new paragraph|paragraph)\b/gi,NEW_LINE:/\b(?:new line|line break)\b/gi,COLON:/\b(?:colon)\b/gi,SEMICOLON:/\b(?:semicolon|semi colon)\b/gi,OPEN_PAREN:/\b(?:open paren(?:th|thesis|theses)?|left paren(?:th|thesis|theses)?|opening paren(?:th|thesis|theses)?)\b/gi,CLOSE_PAREN:/\b(?:close paren(?:th|thesis|theses)?|closed paren(?:th|thesis|theses)?|closing paren(?:th|thesis|theses)?|right paren(?:th|thesis|theses)?)\b/gi,OPEN_BRACKET:/\b(?:open bracket|left bracket)\b/gi,CLOSE_BRACKET:/\b(?:close bracket|right bracket)\b/gi,PERIOD:/\b(?:period|dot|full stop)\b/gi,COMMA:/\b(?:comma)\b/gi,QUESTION_MARK:/\b(?:question mark)\b/gi,EXCLAMATION:/\b(?:exclamation point|exclamation mark)\b/gi,ZERO:/\b(?:zero)\b/gi,ONE:/\b(?:one)\b/gi,TWO:/\b(?:two)\b/gi,THREE:/\b(?:three)\b/gi,FOUR:/\b(?:four)\b/gi,FIVE:/\b(?:five)\b/gi,SIX:/\b(?:six)\b/gi,SEVEN:/\b(?:seven)\b/gi,EIGHT:/\b(?:eight)\b/gi,NINE:/\b(?:nine)\b/gi,TEN:/\b(?:ten)\b/gi,ELEVEN:/\b(?:eleven)\b/gi,TWELVE:/\b(?:twelve)\b/gi,THIRTEEN:/\b(?:thirteen)\b/gi,FOURTEEN:/\b(?:fourteen)\b/gi,FIFTEEN:/\b(?:fifteen)\b/gi,SIXTEEN:/\b(?:sixteen)\b/gi,SEVENTEEN:/\b(?:seventeen)\b/gi,EIGHTEEN:/\b(?:eighteen)\b/gi,NINETEEN:/\b(?:nineteen)\b/gi,TWENTY:/\b(?:twenty)\b/gi,THIRTY:/\b(?:thirty)\b/gi,FORTY:/\b(?:forty)\b/gi,FIFTY:/\b(?:fifty)\b/gi,SIXTY:/\b(?:sixty)\b/gi,SEVENTY:/\b(?:seventy)\b/gi,EIGHTY:/\b(?:eighty)\b/gi,NINETY:/\b(?:ninety)\b/gi,HUNDRED:/\b(?:hundred)\b/gi,THOUSAND:/\b(?:thousand)\b/gi,POINT:/\b(?:point|decimal)\b/gi,CENTIMETERS:/\b(?:centimeters|centimeter|cm)\b/gi,MILLIMETERS:/\b(?:millimeters|millimeter|mm)\b/gi,METERS:/\b(?:meters|meter|m)\b/gi,INCHES:/\b(?:inches|inch|in)\b/gi,FEET:/\b(?:feet|foot|ft)\b/gi,BY:/\b(?:by)\b/gi};function ce(i){return/[a-zA-Z0-9]/.test(i)}function cn(i){return/[.,;:!?]/.test(i)}function yo(i,s,t){return i}function xo(i){let s=i.trim();const t=[/^\s*dolita\s*$/i,/^\s*dalita\s*$/i,/^\s*dilita\s*$/i,/^\s*delita\s*$/i,/^\s*delete\s+a\s*$/i,/^\s*delete\s+at\s*$/i,/^\s*delete\s+the\s*$/i,/^\s*delete\s+dad\s*$/i,/^\s*delete\s+bad\s*$/i,/^\s*clear\s+the\s*$/i,/^\s*clear\s+at\s*$/i,/^\s*clear\s+a\s*$/i,/^\s*remove\s+the\s*$/i,/^\s*remove\s+a\s*$/i];for(const a of t)if(a.test(s))return{type:"DELETE_THAT",action:"delete"};if(z.DELETE_THAT.test(s))return{type:"DELETE_THAT",action:"delete"};if(z.UNDO_THAT.test(s))return{type:"UNDO_THAT",action:"undo"};if(z.REDO_THAT.test(s))return{type:"REDO_THAT",action:"redo"};if(z.NEW_PARAGRAPH.test(s))return{type:"NEW_PARAGRAPH",action:"newParagraph"};if(z.NEW_LINE.test(s))return{type:"NEW_LINE",action:"newLine"};let r=i,n=!1;const l=Bt(r);return l!==r&&(r=l,n=!0),r=r.replace(z.PERIOD,".").replace(z.COMMA,","),r=r.replace(z.COLON,":").replace(z.SEMICOLON,";").replace(z.OPEN_PAREN,"(").replace(z.CLOSE_PAREN,")").replace(z.OPEN_BRACKET,"[").replace(z.CLOSE_BRACKET,"]").replace(z.QUESTION_MARK,"?").replace(z.EXCLAMATION,"!"),r=r.replace(z.CENTIMETERS,"cm").replace(z.MILLIMETERS,"mm").replace(z.METERS,"m").replace(z.INCHES,"in").replace(z.FEET,"ft"),n=n||r!==i,{type:n?"PUNCTUATION":"TEXT",remainingText:r}}function wo(i){const s=i.selectionStart,t=i.selectionEnd;if(s===t){if(s>0){let n=s-1;for(;n>0&&/\s/.test(i.value[n]);)n--;for(;n>0&&/\S/.test(i.value[n-1]);)n--;return i.setRangeText("",n,s,"start"),!0}return!1}i.setRangeText("",s,t,"start");const r=new Event("input",{bubbles:!0});return i.dispatchEvent(r),!0}function So(i){if(i instanceof HTMLTextAreaElement||i.isContentEditable)try{i.focus();const s=document.execCommand("undo");if(s){const t=new Event("input",{bubbles:!0});i.dispatchEvent(t)}return s}catch(s){return console.warn("Undo command failed:",s),!1}return!1}function Co(i){if(i instanceof HTMLTextAreaElement||i.isContentEditable)try{i.focus();const s=document.execCommand("redo");if(s){const t=new Event("input",{bubbles:!0});i.dispatchEvent(t)}return s}catch(s){return console.warn("Redo command failed:",s),!1}return!1}function vo(i){if(i instanceof HTMLTextAreaElement){const s=i.selectionStart;i.value.substring(0,s),i.value.substring(i.selectionEnd);const t=`

`;return i.setRangeText(t,s,i.selectionEnd,"end"),!0}if(i.isContentEditable){const s=window.getSelection();if(s&&s.rangeCount>0){const t=s.getRangeAt(0);t.deleteContents();const r=document.createElement("br"),n=document.createElement("br");return t.insertNode(n),t.insertNode(r),t.setStartAfter(n),t.setEndAfter(n),s.removeAllRanges(),s.addRange(t),!0}}return!1}function Io(i){if(i instanceof HTMLTextAreaElement){const s=i.selectionStart;return i.setRangeText(`
`,s,i.selectionEnd,"end"),!0}if(i.isContentEditable){const s=window.getSelection();if(s&&s.rangeCount>0){const t=s.getRangeAt(0);t.deleteContents();const r=document.createElement("br");return t.insertNode(r),t.setStartAfter(r),t.setEndAfter(r),s.removeAllRanges(),s.addRange(t),!0}}return!1}function bn(i){let s=i.replace(/\b(one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve)\s+o['']?\s*clock\b/gi,(t,r)=>`${We(r)}:00`);return s=s.replace(/\b(\d{1,2})\s+o['']?\s*clock\b/gi,"$1:00"),s}function ko(i){return i.replace(/\b(\d+(?:\.\d+)?|zero|one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve|thirteen|fourteen|fifteen|sixteen|seventeen|eighteen|nineteen|twenty|thirty|forty|fifty|sixty|seventy|eighty|ninety|hundred|thousand)\s+by\s+(\d+(?:\.\d+)?|zero|one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve|thirteen|fourteen|fifteen|sixteen|seventeen|eighteen|nineteen|twenty|thirty|forty|fifty|sixty|seventy|eighty|ninety|hundred|thousand)(?:\s+by\s+(\d+(?:\.\d+)?|zero|one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve|thirteen|fourteen|fifteen|sixteen|seventeen|eighteen|nineteen|twenty|thirty|forty|fifty|sixty|seventy|eighty|ninety|hundred|thousand))*/gi,s=>s.replace(/\s+by\s+/gi," x "))}function Bt(i){let s=i;return s=ko(s),s=s.replace(/\b(zero|one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve|thirteen|fourteen|fifteen|sixteen|seventeen|eighteen|nineteen|twenty|thirty|forty|fifty|sixty|seventy|eighty|ninety)\s+(?:point|decimal)\s+(zero|one|two|three|four|five|six|seven|eight|nine)\b/gi,(t,r,n)=>{const l=We(r),a=We(n);return`${l}.${a}`}),s=s.replace(/\b(twenty|thirty|forty|fifty|sixty|seventy|eighty|ninety)\s+(one|two|three|four|five|six|seven|eight|nine)\b/gi,(t,r,n)=>{const l=We(r),a=We(n);return(l+a).toString()}),s=s.replace(/\b(one|two|three|four|five|six|seven|eight|nine)\s+hundred(?:\s+(twenty|thirty|forty|fifty|sixty|seventy|eighty|ninety)(?:\s+(one|two|three|four|five|six|seven|eight|nine))?)?\b/gi,(t,r,n,l)=>{let a=We(r)*100;return n&&(a+=We(n)),l&&(a+=We(l)),a.toString()}),s=s.replace(z.ZERO,"0").replace(z.ONE,"1").replace(z.TWO,"2").replace(z.THREE,"3").replace(z.FOUR,"4").replace(z.FIVE,"5").replace(z.SIX,"6").replace(z.SEVEN,"7").replace(z.EIGHT,"8").replace(z.NINE,"9").replace(z.TEN,"10").replace(z.ELEVEN,"11").replace(z.TWELVE,"12").replace(z.THIRTEEN,"13").replace(z.FOURTEEN,"14").replace(z.FIFTEEN,"15").replace(z.SIXTEEN,"16").replace(z.SEVENTEEN,"17").replace(z.EIGHTEEN,"18").replace(z.NINETEEN,"19").replace(z.TWENTY,"20").replace(z.THIRTY,"30").replace(z.FORTY,"40").replace(z.FIFTY,"50").replace(z.SIXTY,"60").replace(z.SEVENTY,"70").replace(z.EIGHTY,"80").replace(z.NINETY,"90").replace(z.HUNDRED,"100").replace(z.THOUSAND,"1000"),s}function We(i){switch(i.toLowerCase()){case"zero":return 0;case"one":return 1;case"two":return 2;case"three":return 3;case"four":return 4;case"five":return 5;case"six":return 6;case"seven":return 7;case"eight":return 8;case"nine":return 9;case"ten":return 10;case"eleven":return 11;case"twelve":return 12;case"thirteen":return 13;case"fourteen":return 14;case"fifteen":return 15;case"sixteen":return 16;case"seventeen":return 17;case"eighteen":return 18;case"nineteen":return 19;case"twenty":return 20;case"thirty":return 30;case"forty":return 40;case"fifty":return 50;case"sixty":return 60;case"seventy":return 70;case"eighty":return 80;case"ninety":return 90;default:return 0}}function yn(i){return i.replace(/\bslash\b/gi,"/")}function Eo(i,s,t,r){if(i.length===0||r.length===0)return{text:i,caretOffset:0};let n=i,l=0;const a=s>0?i[s-1]:"",g=t<i.length?i[t]:"",f=r[0],m=r[r.length-1];if(a&&f){const k=ce(a)&&ce(f)&&a!=="/"&&f!=="/"||cn(a)&&!["(","[","{"].includes(a)&&ce(f),C=a===" ";if(k&&!C)n=n.substring(0,s)+" "+n.substring(s),l+=1,t+=1;else if(!k&&C&&s>1){const v=i[s-2];(!ce(v)||v==="/"||f==="/"||["(","[","{"].includes(f))&&(n=n.substring(0,s-1)+n.substring(s),l-=1,t-=1)}}if(g&&m){const k=t+l,C=k<n.length?n[k]:"",v=ce(m)&&ce(C)&&m!=="/"&&C!=="/"||cn(m)&&ce(C),I=C===" ";v&&!I?n=n.substring(0,k)+" "+n.substring(k):!v&&I&&!ce(C)&&(n=n.substring(0,k)+n.substring(k+1))}const c=Math.max(0,s-2),y=Math.min(n.length,t+l+2);if(y>c){const k=n.substring(0,c),C=n.substring(c,y),v=n.substring(y),I=C.replace(/\s*\/\s*/g,"/");n=k+I+v;const b=C.length-I.length;if(b>0&&s>=c){const F=Math.max(0,s-c);F>0&&(l-=Math.min(b,F))}}return n=yo(n),{text:n,caretOffset:l}}function To(i,s){if(!i)return{success:!1,newCaretPos:0};const t=xo(s);switch(t.type){case"DELETE_THAT":if(i instanceof HTMLTextAreaElement)return{success:wo(i),newCaretPos:i.selectionStart,commandExecuted:"delete"};if(i.isContentEditable){const f=window.getSelection();if(f&&f.rangeCount>0){const m=f.getRangeAt(0);if(m.collapsed){const c=m.startContainer;if(c.nodeType===Node.TEXT_NODE&&m.startOffset>0){const y=c.textContent||"";let k=m.startOffset-1;for(;k>0&&/\s/.test(y[k]);)k--;for(;k>0&&/\S/.test(y[k-1]);)k--;c.deleteData(k,m.startOffset-k),m.setStart(c,k),m.setEnd(c,k),f.removeAllRanges(),f.addRange(m);const C=new Event("input",{bubbles:!0});return i.dispatchEvent(C),{success:!0,newCaretPos:0,commandExecuted:"delete"}}}else{m.deleteContents();const c=new Event("input",{bubbles:!0});return i.dispatchEvent(c),{success:!0,newCaretPos:0,commandExecuted:"delete"}}}}return{success:!1,newCaretPos:0};case"UNDO_THAT":return{success:So(i),newCaretPos:0,commandExecuted:"undo"};case"REDO_THAT":return{success:Co(i),newCaretPos:0,commandExecuted:"redo"};case"NEW_PARAGRAPH":return{success:vo(i),newCaretPos:0,commandExecuted:"newParagraph"};case"NEW_LINE":return{success:Io(i),newCaretPos:0,commandExecuted:"newLine"};case"PUNCTUATION":case"TEXT":const g=t.remainingText||s;return i instanceof HTMLTextAreaElement?_o(i,g):i.isContentEditable?jo(i,g):{success:!1,newCaretPos:0};default:return{success:!1,newCaretPos:0}}}function Ao(i,s,t){if(s===t)return{start:s,end:t};let r=s,n=t;for(;r>0&&ce(i[r-1]);)r--;for(;n<i.length&&ce(i[n]);)n++;return{start:r,end:n}}function _o(i,s){if(!i)return{success:!1,newCaretPos:0};let t=Bt(s);t=bn(t),t=yn(t);let r=i.selectionStart,n=i.selectionEnd;const l=i.value;if(r!==n){const y=Ao(l,r,n);r=y.start,n=y.end}let a=t;if(r===n&&r>0&&r<l.length){const y=l[r-1],k=l[r];ce(y)&&ce(k)&&(t.startsWith(" ")||(a=" "+a),t.endsWith(" ")||(a=a+" "))}i.setRangeText(a,r,n,"end");const g=i.value,f=r+a.length,{text:m,caretOffset:c}=Eo(g,r,f,a);if(m!==g){const y=i.selectionStart;i.value=m;const k=y+c;i.setSelectionRange(k,k)}return{success:!0,newCaretPos:i.selectionStart}}function Ro(i){const s=i.startContainer,t=i.endContainer,r=i.startOffset,n=i.endOffset;if(!i.collapsed){if(s.nodeType===Node.TEXT_NODE){const l=s.data;let a=r;for(;a>0&&ce(l[a-1]);)a--;a!==r&&i.setStart(s,a)}if(t.nodeType===Node.TEXT_NODE){const l=t.data;let a=n;for(;a<l.length&&ce(l[a]);)a++;a!==n&&i.setEnd(t,a)}}}function jo(i,s){if(!i)return{success:!1,newCaretPos:0};const t=window.getSelection();if(!t||t.rangeCount===0)return{success:!1,newCaretPos:0};const r=t.getRangeAt(0);r.collapsed||Ro(r);let n=Bt(s);n=bn(n),n=yn(n);const l=r.startContainer,a=r.startOffset,g=r.endContainer,f=r.endOffset;let m="",c="";l.nodeType===Node.TEXT_NODE&&(m=a>0?l.data[a-1]:""),g.nodeType===Node.TEXT_NODE&&(c=f<g.data.length?g.data[f]:"");let y=n;const k=r.collapsed;k&&m&&c&&ce(m)&&ce(c)?(n.startsWith(" ")||(y=" "+y),n.endsWith(" ")||(y=y+" ")):k||(m&&ce(m)&&ce(y[0])&&(y=" "+y),c&&ce(c)&&ce(y[y.length-1])&&(y=y+" ")),r.deleteContents();const C=document.createTextNode(y);r.insertNode(C),r.setStartAfter(C),r.setEndAfter(C),t.removeAllRanges(),t.addRange(r);const v=n[0],I=n[n.length-1];if(m&&v){const _=ce(m)&&ce(v)&&m!=="/"&&v!=="/",U=C.previousSibling;if(U&&U.nodeType===Node.TEXT_NODE){const R=U.data,ne=R[R.length-1]===" ";if(_&&!ne)U.data=R+" ";else if(!_&&ne&&R.length>1){const K=R[R.length-2];(!ce(K)||K==="/"||v==="/")&&(U.data=R.slice(0,-1))}}}if(c&&I){const _=ce(I)&&ce(c)&&I!=="/"&&c!=="/",U=C.nextSibling;if(U&&U.nodeType===Node.TEXT_NODE){const R=U.data,ne=R[0]===" ";_&&!ne?U.data=" "+R:!_&&ne&&(U.data=R.slice(1))}}let b=C.previousSibling,F=[C];for(;b&&b.nodeType===Node.TEXT_NODE&&F.length<3;)F.unshift(b),b=b.previousSibling;for(b=C.nextSibling;b&&b.nodeType===Node.TEXT_NODE&&F.length<5;)F.push(b),b=b.nextSibling;return F.forEach(_=>{if(_.nodeType===Node.TEXT_NODE){const U=_.data,R=U.replace(/\s*\/\s*/g,"/");R!==U&&(_.data=R)}}),{success:!0,newCaretPos:0}}function dn(i,s){return To(i,s)}const Po="RadPalMacros",Fo=1,Ee="macros";class No{constructor(){this.db=null,this.userId=null,this.isOffline=!1,this.initIndexedDB(),this.setupOfflineListener()}async initIndexedDB(){if(!(typeof window>"u"||!window.indexedDB))return new Promise((s,t)=>{const r=window.indexedDB.open(Po,Fo);r.onerror=()=>t(r.error),r.onsuccess=()=>{this.db=r.result,s()},r.onupgradeneeded=n=>{const l=n.target.result;if(!l.objectStoreNames.contains(Ee)){const a=l.createObjectStore(Ee,{keyPath:"id"});a.createIndex("userId","userId",{unique:!1}),a.createIndex("name","name",{unique:!1}),a.createIndex("scope","scope",{unique:!1}),a.createIndex("userIdName",["userId","name"],{unique:!1})}}})}setupOfflineListener(){typeof window>"u"||(window.addEventListener("online",()=>{this.isOffline=!1,this.syncWithSupabase()}),window.addEventListener("offline",()=>{this.isOffline=!0}),this.isOffline=!navigator.onLine)}setUserId(s){this.userId=s}async listMacros(s){if(!this.userId)return console.warn("No user ID set for macro store"),[];if(!this.isOffline)try{let t=ut.from("macros").select("*").eq("userId",this.userId).order("name");s&&(t=t.or(`scope.eq.${s},scope.eq.global,scope.is.null`));const{data:r,error:n}=await t;if(n)throw n;return r&&this.db&&await this.cacheToIndexedDB(r),r||[]}catch(t){console.error("Error fetching macros from Supabase:",t)}return this.db||await this.initIndexedDB(),this.getMacrosFromIndexedDB(s)}async getMacroByName(s,t){if(!this.userId)return console.warn("No user ID set for macro store"),null;const r=s.toLowerCase().trim();if(!this.isOffline)try{let n=ut.from("macros").select("*").eq("userId",this.userId).ilike("name",r);t&&(n=n.or(`scope.eq.${t},scope.eq.global,scope.is.null`));const{data:l,error:a}=await n;if(a)throw a;if(l&&l.length>0){if(t){const g=l.find(f=>f.scope===t);if(g)return g}return l[0]}return null}catch(n){console.error("Error fetching macro from Supabase:",n)}return this.getMacroFromIndexedDB(r,t)}async saveMacro(s){if(!this.userId)throw new Error("No user ID set for macro store");const t=new Date().toISOString(),r={...s,id:s.id||crypto.randomUUID(),userId:this.userId,createdAt:t,updatedAt:t,scope:s.scope||"global"};if(!this.isOffline)try{const{data:n,error:l}=await ut.from("macros").upsert(r).select().single();if(l)throw l;return n&&this.db&&await this.saveMacroToIndexedDB(n),n}catch(n){console.error("Error saving macro to Supabase:",n)}return await this.saveMacroToIndexedDB(r),r}async updateMacro(s,t){if(!this.userId)throw new Error("No user ID set for macro store");const r=await this.getMacroById(s);if(!r)throw new Error("Macro not found");const n={...r,...t,updatedAt:new Date().toISOString()};if(!this.isOffline)try{const{data:l,error:a}=await ut.from("macros").update(n).eq("id",s).eq("userId",this.userId).select().single();if(a)throw a;return l&&this.db&&await this.saveMacroToIndexedDB(l),l}catch(l){console.error("Error updating macro in Supabase:",l)}return await this.saveMacroToIndexedDB(n),n}async deleteMacro(s){if(!this.userId)throw new Error("No user ID set for macro store");if(!this.isOffline)try{const{error:t}=await ut.from("macros").delete().eq("id",s).eq("userId",this.userId);if(t)throw t;this.db&&await this.deleteMacroFromIndexedDB(s);return}catch(t){console.error("Error deleting macro from Supabase:",t)}await this.deleteMacroFromIndexedDB(s)}async getMacrosFromIndexedDB(s){return!this.db||!this.userId?[]:new Promise((t,r)=>{const g=this.db.transaction([Ee],"readonly").objectStore(Ee).index("userId").getAll(this.userId);g.onsuccess=()=>{let f=g.result||[];s&&(f=f.filter(m=>m.scope===s||m.scope==="global"||!m.scope)),t(f)},g.onerror=()=>r(g.error)})}async getMacroFromIndexedDB(s,t){const r=await this.getMacrosFromIndexedDB(t),n=s.toLowerCase().trim();let l=r.find(a=>a.name.toLowerCase()===n);if(l){if(t){const a=r.find(g=>g.name.toLowerCase()===n&&g.scope===t);if(a)return a}return l}return null}async getMacroById(s){return this.db?new Promise((t,r)=>{const a=this.db.transaction([Ee],"readonly").objectStore(Ee).get(s);a.onsuccess=()=>t(a.result||null),a.onerror=()=>r(a.error)}):null}async saveMacroToIndexedDB(s){if(this.db)return new Promise((t,r)=>{const a=this.db.transaction([Ee],"readwrite").objectStore(Ee).put(s);a.onsuccess=()=>t(),a.onerror=()=>r(a.error)})}async deleteMacroFromIndexedDB(s){if(this.db)return new Promise((t,r)=>{const a=this.db.transaction([Ee],"readwrite").objectStore(Ee).delete(s);a.onsuccess=()=>t(),a.onerror=()=>r(a.error)})}async cacheToIndexedDB(s){if(!this.db||!this.userId)return;const r=this.db.transaction([Ee],"readwrite").objectStore(Ee),l=r.index("userId").openCursor(IDBKeyRange.only(this.userId));l.onsuccess=()=>{const a=l.result;a?(a.delete(),a.continue()):s.forEach(g=>r.add(g))}}async syncWithSupabase(){console.log("Back online - ready to sync with Supabase")}async exportMacros(){const s=await this.listMacros();return JSON.stringify(s,null,2)}async importMacros(s){try{const t=JSON.parse(s);for(const r of t){const{id:n,...l}=r;await this.saveMacro(l)}}catch{throw new Error("Invalid macro JSON format")}}}const $e=new No,Ot={enabled:!0,triggerWord:"macro",fuzzyVoiceMatches:!1,insertLiteralOnNotFound:!1};function Mo(i,s=Ot){if(!s.enabled)return{isMacro:!1};const t=s.triggerWord||"macro",r=new RegExp(`^\\s*${It(t)}\\s+([a-zA-Z0-9_-]+)\\s*$`,"i"),n=new RegExp(`(.*)\\s+${It(t)}\\s+([a-zA-Z0-9_-]+)\\s*$`,"i");let l=[r,n];s.fuzzyVoiceMatches&&Oo(t).forEach(g=>{l.push(new RegExp(`^\\s*${It(g)}\\s+([a-zA-Z0-9_-]+)\\s*$`,"i"),new RegExp(`(.*)\\s+${It(g)}\\s+([a-zA-Z0-9_-]+)\\s*$`,"i"))});for(const a of l){const g=i.match(a);if(g){if(g[1]&&g[2])return{isMacro:!0,macroName:g[2],remainingText:g[1].trim()};if(g[1])return{isMacro:!0,macroName:g[1],remainingText:void 0}}}return{isMacro:!1}}function Oo(i){const s=[];return i.toLowerCase()==="macro"&&s.push("micro","mackerel","macaroni","mccrow","macrow","makro"),s}function It(i){return i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function xn(){var r;const i=document.activeElement;if(!i)return"global";const s=((r=i.id)==null?void 0:r.toLowerCase())||"",t=i.getAttribute("data-macro-scope");return t||(s.includes("findings")||i.closest('[data-editor="findings"]')?"findings":s.includes("impression")||i.closest('[data-editor="impression"]')?"impression":"global")}async function Do(i,s){try{const t=s||xn(),r=await $e.getMacroByName(i,t);return r?{success:!0,macro:r}:{success:!1,error:`Macro "${i}" not found`}}catch(t){return console.error("Error executing macro:",t),{success:!1,error:"Failed to execute macro"}}}function Rt(i,s){i instanceof HTMLTextAreaElement?Lo(i,s):i.isContentEditable&&Bo(i,s)}function Lo(i,s){const t=i.selectionStart,r=i.selectionEnd,n=i.value,l=n.substring(0,t),a=n.substring(r);let g=s;if(l.length>0&&!l.endsWith(" ")&&!l.endsWith(`
`)){const c=l[l.length-1],y=s[0];(/[a-zA-Z0-9]/.test(c)&&/[a-zA-Z]/.test(y)||/[.,:;!?]/.test(c)&&/[a-zA-Z]/.test(y))&&(g=" "+g)}if(a.length>0&&!a.startsWith(" ")&&!a.startsWith(`
`)){const c=g[g.length-1],y=a[0];/[a-zA-Z0-9]/.test(c)&&/[a-zA-Z]/.test(y)&&(g=g+" ")}i.value=l+g+a;const f=t+g.length;i.setSelectionRange(f,f);const m=new Event("input",{bubbles:!0});i.dispatchEvent(m)}function Bo(i,s){const t=window.getSelection();if(!t||t.rangeCount===0)return;const r=t.getRangeAt(0);r.collapsed||r.deleteContents();const n=r.startContainer;let l=s;if(n.nodeType===Node.TEXT_NODE){const f=n,m=r.startOffset,c=f.textContent||"";if(m>0){const y=c[m-1],k=s[0];(/[a-zA-Z0-9]/.test(y)&&/[a-zA-Z]/.test(k)||/[.,:;!?]/.test(y)&&/[a-zA-Z]/.test(k))&&(l=" "+l)}if(m<c.length){const y=c[m],k=l[l.length-1];/[a-zA-Z0-9]/.test(k)&&/[a-zA-Z]/.test(y)&&(l=l+" ")}}const a=document.createTextNode(l);r.insertNode(a),r.setStartAfter(a),r.setEndAfter(a),t.removeAllRanges(),t.addRange(r);const g=new Event("input",{bubbles:!0});i.dispatchEvent(g)}function zo(i){return i instanceof HTMLTextAreaElement?Uo(i):i.isContentEditable?Wo():null}function Uo(i){const s=document.createElement("div"),t=window.getComputedStyle(i);s.style.position="absolute",s.style.visibility="hidden",s.style.whiteSpace="pre-wrap",s.style.wordWrap="break-word",s.style.overflow="hidden",["fontFamily","fontSize","fontWeight","fontStyle","letterSpacing","textTransform","wordSpacing","textIndent","padding","border","boxSizing","lineHeight"].forEach(g=>{s.style[g]=t[g]}),s.style.width=i.offsetWidth+"px";const r=i.value.substring(0,i.selectionStart);s.textContent=r;const n=document.createElement("span");n.textContent="|",s.appendChild(n),document.body.appendChild(s);const l=i.getBoundingClientRect(),a=n.getBoundingClientRect();return document.body.removeChild(s),{x:l.left+(a.left-s.getBoundingClientRect().left),y:l.top+(a.top-s.getBoundingClientRect().top)}}function Wo(){const i=window.getSelection();if(!i||i.rangeCount===0)return null;const t=i.getRangeAt(0).getBoundingClientRect();return{x:t.left,y:t.top}}const $o=({options:i,position:s,onSelect:t,onCancel:r})=>{const[n,l]=p.useState(0),[a,g]=p.useState(""),f=p.useRef(null),m=p.useRef(null),c=i.filter(I=>I.toLowerCase().includes(a.toLowerCase()));p.useEffect(()=>{l(0)},[a]),p.useEffect(()=>{var I;(I=m.current)==null||I.focus()},[]);const y=p.useCallback(I=>{switch(I.key){case"ArrowDown":I.preventDefault(),l(b=>b<c.length-1?b+1:b);break;case"ArrowUp":I.preventDefault(),l(b=>b>0?b-1:b);break;case"Enter":I.preventDefault(),c[n]&&t(c[n]);break;case"Escape":I.preventDefault(),r();break;case"Tab":I.preventDefault(),I.shiftKey?l(b=>b>0?b-1:c.length-1):l(b=>b<c.length-1?b+1:0);break}},[c,n,t,r]);p.useEffect(()=>(window.addEventListener("keydown",y),()=>window.removeEventListener("keydown",y)),[y]),p.useEffect(()=>{const I=b=>{f.current&&!f.current.contains(b.target)&&r()};return setTimeout(()=>{document.addEventListener("mousedown",I)},100),()=>document.removeEventListener("mousedown",I)},[r]);const k={...s},C=250,v=200;return s.y+C>window.innerHeight&&(k.y=s.y-C),s.x+v>window.innerWidth&&(k.x=window.innerWidth-v-10),p.useEffect(()=>{var b;const I=(b=f.current)==null?void 0:b.querySelector(".macro-picklist-item.selected");I&&I.scrollIntoView({block:"nearest",behavior:"smooth"})},[n]),e.jsxs("div",{ref:f,className:"macro-picklist-container",style:{left:`${k.x}px`,top:`${k.y}px`},children:[i.length>5&&e.jsx("div",{className:"macro-picklist-search",children:e.jsx("input",{ref:m,type:"text",placeholder:"Type to filter...",value:a,onChange:I=>g(I.target.value),onClick:I=>I.stopPropagation()})}),e.jsx("div",{className:"macro-picklist-options",children:c.length===0?e.jsx("div",{className:"macro-picklist-empty",children:"No options match"}):c.map((I,b)=>e.jsx("div",{className:`macro-picklist-item ${b===n?"selected":""}`,onClick:()=>t(I),onMouseEnter:()=>l(b),children:I},b))}),e.jsx("div",{className:"macro-picklist-footer",children:e.jsx("span",{className:"macro-picklist-hint",children:"â†‘â†“ Navigate â€¢ Enter Select â€¢ Esc Cancel"})})]})};const Go=({isOpen:i,onClose:s})=>{const[t,r]=p.useState([]),[n,l]=p.useState(""),[a,g]=p.useState(null),[f,m]=p.useState(!1),[c,y]=p.useState(!1),[k,C]=p.useState(null),[v,I]=p.useState({name:"",type:"text",valueText:"",options:[],scope:"global"});p.useEffect(()=>{i&&b()},[i]);const b=async()=>{y(!0);try{const T=await $e.listMacros();r(T)}catch(T){C("Failed to load macros"),console.error("Error loading macros:",T)}finally{y(!1)}},F=()=>{m(!0),g(null),I({name:"",type:"text",valueText:"",options:[],scope:"global"})},_=T=>{g(T),m(!1),I({name:T.name,type:T.type,valueText:T.valueText||"",options:T.options||[],scope:T.scope||"global"})},U=async()=>{if(!v.name.trim()){C("Macro name is required");return}if(v.type==="text"&&!v.valueText.trim()){C("Text value is required for text macros");return}if(v.type==="picklist"&&v.options.length===0){C("At least one option is required for picklist macros");return}y(!0);try{const T={name:v.name.trim(),type:v.type,scope:v.scope};v.type==="text"?T.valueText=v.valueText:T.options=v.options.filter(Y=>Y.trim()),a!=null&&a.id?await $e.updateMacro(a.id,T):await $e.saveMacro(T),await b(),g(null),m(!1),C(null)}catch(T){C("Failed to save macro"),console.error("Error saving macro:",T)}finally{y(!1)}},R=async T=>{if(confirm("Are you sure you want to delete this macro?")){y(!0);try{await $e.deleteMacro(T),await b()}catch(Y){C("Failed to delete macro"),console.error("Error deleting macro:",Y)}finally{y(!1)}}},W=()=>{g(null),m(!1),I({name:"",type:"text",valueText:"",options:[],scope:"global"})},ne=T=>{const Y=T.split(/[,\n]/).map(se=>se.trim()).filter(se=>se);I(se=>({...se,options:Y}))},K=async()=>{try{const T=await $e.exportMacros(),Y=new Blob([T],{type:"application/json"}),se=URL.createObjectURL(Y),pe=document.createElement("a");pe.href=se,pe.download=`radpal-macros-${new Date().toISOString().split("T")[0]}.json`,pe.click(),URL.revokeObjectURL(se)}catch(T){C("Failed to export macros"),console.error("Error exporting macros:",T)}},B=async T=>{var se;const Y=(se=T.target.files)==null?void 0:se[0];if(Y)try{const pe=await Y.text();await $e.importMacros(pe),await b(),C(null)}catch(pe){C("Failed to import macros - invalid format"),console.error("Error importing macros:",pe)}},re=t.filter(T=>T.name.toLowerCase().includes(n.toLowerCase())||T.valueText&&T.valueText.toLowerCase().includes(n.toLowerCase())||T.options&&T.options.some(Y=>Y.toLowerCase().includes(n.toLowerCase())));return i?e.jsx("div",{className:"macro-manager-overlay",children:e.jsxs("div",{className:"macro-manager-modal",children:[e.jsxs("div",{className:"macro-manager-header",children:[e.jsx("h2",{children:"Macro Manager"}),e.jsx("button",{className:"macro-manager-close",onClick:s,children:"Ã—"})]}),k&&e.jsxs("div",{className:"macro-manager-error",children:[k,e.jsx("button",{onClick:()=>C(null),children:"Ã—"})]}),e.jsxs("div",{className:"macro-manager-toolbar",children:[e.jsx("input",{type:"text",className:"macro-manager-search",placeholder:"Search macros...",value:n,onChange:T=>l(T.target.value)}),e.jsx("button",{className:"macro-manager-btn primary",onClick:F,children:"+ New Macro"}),e.jsx("button",{className:"macro-manager-btn",onClick:K,children:"Export"}),e.jsxs("label",{className:"macro-manager-btn",children:["Import",e.jsx("input",{type:"file",accept:".json",style:{display:"none"},onChange:B})]})]}),f||a?e.jsxs("div",{className:"macro-manager-form",children:[e.jsx("h3",{children:f?"Create New Macro":"Edit Macro"}),e.jsxs("div",{className:"macro-form-group",children:[e.jsx("label",{children:"Name (spoken after trigger word)"}),e.jsx("input",{type:"text",value:v.name,onChange:T=>I(Y=>({...Y,name:T.target.value})),placeholder:"e.g., knee, severity, normal"})]}),e.jsxs("div",{className:"macro-form-group",children:[e.jsx("label",{children:"Type"}),e.jsxs("select",{value:v.type,onChange:T=>I(Y=>({...Y,type:T.target.value})),children:[e.jsx("option",{value:"text",children:"Text"}),e.jsx("option",{value:"picklist",children:"Picklist"})]})]}),e.jsxs("div",{className:"macro-form-group",children:[e.jsx("label",{children:"Scope"}),e.jsxs("select",{value:v.scope,onChange:T=>I(Y=>({...Y,scope:T.target.value})),children:[e.jsx("option",{value:"global",children:"Global (All editors)"}),e.jsx("option",{value:"findings",children:"Findings only"}),e.jsx("option",{value:"impression",children:"Impression only"})]})]}),v.type==="text"?e.jsxs("div",{className:"macro-form-group",children:[e.jsx("label",{children:"Text Value"}),e.jsx("textarea",{value:v.valueText,onChange:T=>I(Y=>({...Y,valueText:T.target.value})),placeholder:"The text to insert when this macro is triggered",rows:4})]}):e.jsxs("div",{className:"macro-form-group",children:[e.jsx("label",{children:"Options (comma or newline separated)"}),e.jsx("textarea",{value:v.options.join(`
`),onChange:T=>ne(T.target.value),placeholder:`mild
moderate
severe`,rows:4}),v.options.length>0&&e.jsxs("div",{className:"macro-options-preview",children:["Preview: ",v.options.map((T,Y)=>e.jsx("span",{className:"macro-option-chip",children:T},Y))]})]}),e.jsxs("div",{className:"macro-form-actions",children:[e.jsx("button",{className:"macro-manager-btn primary",onClick:U,disabled:c,children:c?"Saving...":"Save"}),e.jsx("button",{className:"macro-manager-btn",onClick:W,disabled:c,children:"Cancel"})]})]}):e.jsx("div",{className:"macro-manager-list",children:c?e.jsx("div",{className:"macro-manager-loading",children:"Loading macros..."}):re.length===0?e.jsx("div",{className:"macro-manager-empty",children:n?"No macros match your search":'No macros yet. Click "New Macro" to create one.'}):e.jsxs("table",{className:"macro-manager-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Value/Options"}),e.jsx("th",{children:"Scope"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:re.map(T=>{var Y;return e.jsxs("tr",{children:[e.jsx("td",{className:"macro-name",children:T.name}),e.jsx("td",{className:"macro-type",children:e.jsx("span",{className:`type-badge ${T.type}`,children:T.type})}),e.jsx("td",{className:"macro-value",children:T.type==="text"?(T.valueText||"").substring(0,50)+((T.valueText||"").length>50?"...":""):(Y=T.options)==null?void 0:Y.join(", ")}),e.jsx("td",{className:"macro-scope",children:e.jsx("span",{className:`scope-badge ${T.scope||"global"}`,children:T.scope||"global"})}),e.jsxs("td",{className:"macro-actions",children:[e.jsx("button",{className:"macro-action-btn edit",onClick:()=>_(T),title:"Edit",children:"âœï¸"}),e.jsx("button",{className:"macro-action-btn delete",onClick:()=>R(T.id),title:"Delete",children:"ðŸ—‘ï¸"})]})]},T.id)})})]})})]})}):null},wn="radpal_macro_settings";function Ho(){try{const i=localStorage.getItem(wn);if(i){const s=JSON.parse(i);return{...Ot,...s}}}catch(i){console.error("Error loading macro settings:",i)}return Ot}function Yo(i){try{localStorage.setItem(wn,JSON.stringify(i))}catch(s){console.error("Error saving macro settings:",s)}}const Vo=jt.memo(function(){var Jt,Zt,Qt,en,tn,nn;p.useEffect(()=>{if(console.log("ðŸš€ MAIN APP MOUNTED - App component mounted successfully!"),!document.getElementById("llama-pulse-animation")){const o=document.createElement("style");o.id="llama-pulse-animation",o.textContent=`
        @keyframes pulse {
          0% { opacity: 1; }
          50% { opacity: 0.5; }
          100% { opacity: 1; }
        }
      `,document.head.appendChild(o)}},[]);const{width:s,isContracted:t}=oo(),r=ro(),[n,l]=p.useState(""),a=p.useCallback((o,d)=>{console.log("ðŸŽ¯ Direct setFindings called with:",{valueType:typeof o,valueLength:typeof o=="string"?o.length:"function",saveToHistory:d}),l(o)},[]),g=()=>{};p.useEffect(()=>{console.log("ðŸ“Š FINDINGS STATE CHANGED:",{length:n.length,preview:n.substring(0,100),timestamp:Date.now(),stackTrace:new Error().stack})},[n]);const f=p.useCallback((o,d=!0)=>{console.log("ðŸŽ¯ setFindings wrapper called - BYPASSING AND CALLING DIRECTLY:",{isFunction:typeof o=="function",saveToHistory:d,valueLength:typeof o=="string"?o.length:"function",actualValue:typeof o=="string"?o.substring(0,100):"function"}),a(o,d)},[a]),m=p.useRef(null),c=p.useRef(null),y=p.useRef(0),k=p.useRef(null),[C,v]=p.useState(!1),[I,b]=p.useState(null),[F,_]=p.useState(null),[U,R]=p.useState(()=>Ho()),[W,ne]=p.useState(!1),[K,B]=p.useState(!1),[re,T]=p.useState(()=>localStorage.getItem("radpal_hardware_mic_enabled")==="true"),Y=p.useRef(null),se=p.useRef(null),pe=p.useRef(null),de=p.useRef({}),[st,Te]=p.useState(null),[Le,Ge]=p.useState(null),it=!0,[kt,Je]=p.useState(!1),[He,Ze]=p.useState(!1),{user:D,signOut:at,loading:Qe}=Dt(),[we,Be]=p.useState(()=>localStorage.getItem("radpal_offline_mode")==="true"),je=ue.getLastSync(),$=p.useCallback(o=>{Ge(o),setTimeout(()=>Ge(null),3e3)},[]),Ye=p.useCallback(()=>{const o=!re;T(o),localStorage.setItem("radpal_hardware_mic_enabled",o.toString()),$(o?"âœ… SpeedMic III hardware button enabled - may conflict with PowerScribe":"âœ… SpeedMic III hardware button disabled - no PowerScribe conflicts")},[re,$]);p.useEffect(()=>{!localStorage.getItem("radpal_shown_hardware_mic_info")&&!re&&setTimeout(()=>{$("ðŸ’¡ SpeedMic III hardware button is disabled by default to prevent PowerScribe conflicts. Click ðŸ”—â›” to enable if needed."),localStorage.setItem("radpal_shown_hardware_mic_info","true")},3e3)},[re,$]);const[ft,Ve]=p.useState(()=>Xe.getItem("dictationTarget")||"PowerScribe"),[Pe,Fe]=p.useState(!1),[gt,qe]=p.useState(!1),[Ne,ze]=p.useState(!1),{templates:G={},loading:ae=!1,saveTemplate:Et=async()=>{},refetchTemplates:mt=async()=>{}}=Pn(D,!0,we)||{},[lt,Ke]=p.useState(!1),[ht,et]=p.useState(!1);p.useState(!1);const[L,ct]=p.useState("openai"),[Ie,bt]=p.useState({running:!1}),[ie,yt]=p.useState({downloading:!1,progress:0}),[h,E]=p.useState({installing:!1,progress:0}),[X,A]=p.useState(!1),[j,J]=p.useState(1),[H,fe]=p.useState({used:0,limit:2e4,percentage:0}),[_e,V]=p.useState("void-black"),[M,xe]=p.useState(""),[dt,ge]=p.useState([]),[qo,me]=p.useState(""),[zt,Ut]=p.useState(!1),[Wt,Me]=p.useState(!1),[ke,Oe]=p.useState(""),[tt,$t]=p.useState(new Set),[q,Ce]=p.useState(null);p.useState(!1);const[Sn,Tt]=p.useState(!1);p.useEffect(()=>{const o=Xe.getItem("favoriteStudyTypes");if(o)try{$t(new Set(JSON.parse(o)))}catch(d){console.error("Failed to parse favorite study types:",d)}},[]);const Gt=o=>{$t(d=>{const u=new Set(d);return u.has(o)?u.delete(o):u.add(o),Xe.setItem("favoriteStudyTypes",JSON.stringify(Array.from(u))),u})};p.useEffect(()=>{var o;(o=window.electronAPI)!=null&&o.getApiProvider&&window.electronAPI.getApiProvider().then(d=>{ct(d)})},[]),p.useEffect(()=>{console.log("ðŸ” modelDownloadStatus changed:",ie),console.log("ðŸ” Should show modal?",ie.downloading===!0)},[ie]),p.useEffect(()=>{var o,d,u,x;if((o=window.electronAPI)!=null&&o.onLlamaServerStatus&&((d=window.electronAPI)!=null&&d.onModelDownloadStatus)){const w=window.electronAPI.onLlamaServerStatus(P=>{console.log("llama.cpp server status:",P),bt(P)}),S=window.electronAPI.onModelDownloadStatus(P=>{console.log("ðŸ“¥ Model download status received:",P),console.log("ðŸ“¥ Setting modelDownloadStatus.downloading to:",P.downloading),yt(P)}),N=window.electronAPI.onCudaInstallProgress?window.electronAPI.onCudaInstallProgress(P=>{console.log("ðŸŽ® CUDA install progress:",P),E({installing:P.progress<100&&!P.error,progress:P.progress,status:P.status,error:P.error})}):null;return(u=window.electronAPI)!=null&&u.getLlamaServerStatus&&window.electronAPI.getLlamaServerStatus().then(P=>{bt(P)}).catch(console.error),(x=window.electronAPI)!=null&&x.checkCudaSupport&&window.electronAPI.checkCudaSupport().then(P=>{A(P)}).catch(console.error),()=>{w&&w(),S&&S(),N&&N()}}else console.log("Llama server status methods not available in electronAPI")},[]),p.useEffect(()=>{var w,S,N,P;if(!window.electronAPI)return;const o=O=>{var ee;console.log("ðŸš« Llama.cpp not installed:",O),window.confirm(O.message)&&(ee=window.electronAPI)!=null&&ee.installCudaBinary&&(E({installing:!0,progress:0,status:"Starting download...",error:!1}),window.electronAPI.installCudaBinary(O.downloadUrl).then(te=>{$(te?"âœ… Llama.cpp installed successfully!":"âŒ Failed to install llama.cpp"),E({installing:!1,progress:0,status:"",error:!te})}).catch(te=>{console.error("Failed to install llama.cpp:",te),$("âŒ Failed to install llama.cpp"),E({installing:!1,progress:0,status:"",error:!0})}))},d=O=>{var te;console.log("ðŸ”„ Llama.cpp update available:",O);const oe=`A newer version of llama.cpp (${O.currentVersion}) is available. Update for better performance?`;window.confirm(oe)&&(te=window.electronAPI)!=null&&te.installCudaBinary&&(E({installing:!0,progress:0,status:"Downloading update...",error:!1}),window.electronAPI.installCudaBinary(O.downloadUrl).then(le=>{$(le?"âœ… Llama.cpp updated successfully!":"âŒ Failed to update llama.cpp"),E({installing:!1,progress:0,status:"",error:!le})}).catch(le=>{console.error("Failed to update llama.cpp:",le),$("âŒ Failed to update llama.cpp"),E({installing:!1,progress:0,status:"",error:!0})}))},u=(S=(w=window.electronAPI).onLlamaNotInstalled)==null?void 0:S.call(w,o),x=(P=(N=window.electronAPI).onLlamaUpdateAvailable)==null?void 0:P.call(N,d);return()=>{u==null||u(),x==null||x()}},[$]),p.useEffect(()=>{const o=Xe.getItem("colorScheme");o&&(o==="venice-blue"||o==="dark-ocean"||o==="lawrencium"||o==="deep-space"||o==="void-black"||o==="yoda")&&V(o)},[]),p.useEffect(()=>{document.body.className=document.body.className.replace(/color-scheme-[\w-]+/g,""),document.body.classList.add(`color-scheme-${_e}`)},[_e]),p.useEffect(()=>{const o=d=>{if(Ne){const u=d.target,x=document.querySelector(".settings-sidebar"),w=document.querySelector("[data-settings-trigger]");x&&!x.contains(u)&&w&&!w.contains(u)&&ze(!1)}};return document.addEventListener("mousedown",o),()=>document.removeEventListener("mousedown",o)},[Ne]),p.useEffect(()=>{var o,d,u;if((o=window.electronAPI)!=null&&o.getTokenUsage){window.electronAPI.getTokenUsage().then(w=>{fe(w)});const x=w=>{fe(w)};(u=(d=window.electronAPI).onTokenUsageUpdated)==null||u.call(d,x)}},[]),p.useEffect(()=>{D&&window.electronAPI&&setTimeout(async()=>{if(window.electronAPI.getTokenUsage){const o=await window.electronAPI.getTokenUsage();console.log("ðŸ”„ Refreshing token usage after user login:",o),fe(o)}if(window.electronAPI.getUserTier&&D.id){const o=await window.electronAPI.getUserTier(D.id);console.log("ðŸŽ¯ User subscription tier:",o),J(o||1)}},1e3)},[D]);const ve={gemini:1,kimi:1,openai:2,"gpt-5":2,"claude-sonnet":2,"claude-opus":3,"claude-opus-4.1":3,"mistral-local":4},Z=o=>{const d=ve[o]||3;return j>=d},Se=o=>{switch(o){case 1:return"Free";case 2:return"Pro";case 3:return"Premium";case 4:return"Developer";default:return"Free"}},be=async o=>{var d;if(!Z(o)){const u=ve[o]||3,x=`ðŸ”’ ${Se(u)} subscription required (Tier ${u}). You're on ${Se(j)}.`;$(x),setTimeout(()=>{const w=document.querySelector('[contenteditable="true"]');w&&w.focus()},100);return}ct(o),(d=window.electronAPI)!=null&&d.setApiProvider&&await window.electronAPI.setApiProvider(o)},Cn=()=>{var o;(o=window.electronAPI)!=null&&o.contractWindow?window.electronAPI.contractWindow():console.error("Electron IPC not available")},Ht=()=>{var o,d;(d=(o=window.electronAPI)==null?void 0:o.minimizePopup)==null||d.call(o)},Yt=()=>{var o,d;(d=(o=window.electronAPI)==null?void 0:o.closePopup)==null||d.call(o)},vn=()=>{var o,d;(d=(o=window.electronAPI)==null?void 0:o.expandWindow)==null||d.call(o)},Ue=p.useCallback(async()=>{var o,d;if(C){if(v(!1),b(null),(o=window.electronAPI)!=null&&o.stopDictation)try{await window.electronAPI.stopDictation()}catch(u){console.error("Failed to stop dictation:",u)}}else if(b(null),(d=window.electronAPI)!=null&&d.startDictation)try{const u=await window.electronAPI.startDictation();u.success?v(!0):b(u.error||"Failed to start dictation")}catch(u){b("Failed to start dictation: "+u.message)}},[C]),Vt=p.useCallback(async()=>{var o,d;try{console.log("ðŸŽ¤ Starting Web Audio API capture...");const u=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,channelCount:1,echoCancellation:!0,noiseSuppression:!0}});pe.current=u;const x=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3});se.current=x;const w=x.createMediaStreamSource(u);de.current.source=w;try{const S="/audio-worklet-processor.js";await x.audioWorklet.addModule(S);const N=new AudioWorkletNode(x,"audio-processor");de.current.workletNode=N,N.port.onmessage=P=>{var O,oe,ee,te;if(P.data.type==="audioData")try{(oe=(O=window.electronAPI)==null?void 0:O.sendAudioData)==null||oe.call(O,P.data.buffer)}catch(le){console.error("Failed to send audio data:",le),(te=(ee=window.electronAPI)==null?void 0:ee.sendAudioError)==null||te.call(ee,"Audio data transmission failed")}},w.connect(N),console.log("âœ… Using modern AudioWorkletNode")}catch(S){console.warn("AudioWorklet failed, falling back to ScriptProcessor:",S);const N=x.createScriptProcessor(4096,1,1);de.current.scriptProcessor=N,N.onaudioprocess=P=>{var te,le,Ae,Re;const oe=P.inputBuffer.getChannelData(0),ee=new Int16Array(oe.length);for(let ot=0;ot<oe.length;ot++)ee[ot]=Math.max(-32768,Math.min(32767,oe[ot]*32767));try{(le=(te=window.electronAPI)==null?void 0:te.sendAudioData)==null||le.call(te,ee.buffer)}catch(ot){console.error("Failed to send audio data via ScriptProcessor:",ot),(Re=(Ae=window.electronAPI)==null?void 0:Ae.sendAudioError)==null||Re.call(Ae,"Audio data transmission failed")}},w.connect(N),N.connect(x.destination),console.log("âœ… Using fallback ScriptProcessorNode")}console.log("âœ… Web Audio API capture started")}catch(u){console.error("âŒ Failed to start audio capture:",u),(d=(o=window.electronAPI)==null?void 0:o.sendAudioError)==null||d.call(o,u.message)}},[]),nt=p.useCallback(async()=>{try{if(console.log("ðŸ›‘ Stopping Web Audio API capture..."),de.current.workletNode)try{de.current.workletNode.port.onmessage=null,de.current.workletNode.port.close(),de.current.workletNode.disconnect(),de.current.workletNode=void 0}catch(o){console.error("Error disconnecting AudioWorkletNode:",o)}if(de.current.scriptProcessor)try{de.current.scriptProcessor.onaudioprocess=null,de.current.scriptProcessor.disconnect(),de.current.scriptProcessor=void 0}catch(o){console.error("Error disconnecting ScriptProcessorNode:",o)}if(de.current.source)try{de.current.source.disconnect(),de.current.source=void 0}catch(o){console.error("Error disconnecting MediaStreamAudioSourceNode:",o)}if(pe.current&&(pe.current.getTracks().forEach(o=>{try{o.stop(),o.enabled=!1,o.onended=null}catch(d){console.log("Track stop error:",d)}}),pe.current=null),se.current){try{se.current.state!=="closed"&&await se.current.close()}catch(o){console.error("Error closing AudioContext:",o)}se.current=null}de.current={},console.log("âœ… Web Audio API capture stopped and cleaned up")}catch(o){console.error("âŒ Error stopping audio capture:",o)}},[]),In=p.useCallback(async()=>{var o,d;console.log("ðŸ”„ Resetting microphone system..."),C&&v(!1),b(null),Te(null),await nt();try{const x=(await navigator.mediaDevices.enumerateDevices()).filter(w=>w.kind==="audioinput");if(console.log(`Found ${x.length} audio input devices to reset`),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)try{(await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}})).getTracks().forEach(S=>{S.stop(),S.enabled=!1}),console.log("âœ… Temporary stream created and stopped to reset device")}catch(w){console.log("Could not create temp stream:",w)}}catch(u){console.error("Browser-level cleanup error:",u)}if((o=window.electronAPI)!=null&&o.forceResetDictation)try{console.log("ðŸ”§ Performing deep dictation system reset...");const u=await window.electronAPI.forceResetDictation();u.success?console.log("âœ… Deep dictation reset completed successfully"):console.error("âŒ Deep dictation reset failed:",u.error)}catch(u){console.error("âŒ Failed to perform deep dictation reset:",u)}if((d=window.electronAPI)!=null&&d.stopDictation)try{await window.electronAPI.stopDictation()}catch(u){console.error("Failed to stop dictation during reset:",u)}if(await new Promise(u=>setTimeout(u,1500)),se.current)try{await se.current.close(),se.current=null}catch(u){console.error("Error closing AudioContext during reset:",u)}if(pe.current&&(pe.current.getTracks().forEach(u=>u.stop()),pe.current=null),Y.current)try{Y.current.state!=="inactive"&&Y.current.stop(),Y.current=null}catch(u){console.error("Error stopping MediaRecorder during reset:",u)}de.current={},$("ðŸŽ¤ Microphone system fully reset - accuracy restored"),console.log("âœ… Microphone reset complete")},[C,nt]);p.useEffect(()=>{var d,u,x,w;const o=[];if((d=window.electronAPI)!=null&&d.onStartAudioCapture){const S=window.electronAPI.onStartAudioCapture(()=>{console.log("ðŸ“¡ Received start-audio-capture from main process"),Vt()});o.push(S)}if((u=window.electronAPI)!=null&&u.onStopAudioCapture){const S=window.electronAPI.onStopAudioCapture(()=>{console.log("ðŸ“¡ Received stop-audio-capture from main process"),nt()});o.push(S)}if((x=window.electronAPI)!=null&&x.onResetAudioSystem){const S=window.electronAPI.onResetAudioSystem(async()=>{console.log("ðŸ“¡ Received reset-audio-system from main process"),await nt(),de.current={},pe.current=null,se.current=null});o.push(S)}if((w=window.electronAPI)!=null&&w.onCriticalAudioError){const S=window.electronAPI.onCriticalAudioError(N=>{console.error("ðŸš¨ Critical audio error:",N),b(`Critical error: ${N}. Please use Reset Microphone button.`),v(!1),nt()});o.push(S)}return()=>{o.forEach(S=>S())}},[Vt,nt]);const xt=p.useCallback(async o=>{const d=Mo(o,U);if(d.isMacro&&d.macroName){let S=null;if(c.current&&(S=c.current.getElement()),S||(S=m.current),!S){const O=document.querySelectorAll('[contenteditable="true"]');for(const oe of O){const ee=oe;if(ee.style.width==="100%"&&ee.style.height==="100%"){S=ee;break}}}if(!S)return;d.remainingText&&Rt(S,d.remainingText);const N=xn(),P=await Do(d.macroName,N);if(P.success&&P.macro){if(P.macro.type==="text"&&P.macro.valueText)Rt(S,P.macro.valueText),S.focus();else if(P.macro.type==="picklist"&&P.macro.options){const O=zo(S);O&&_({options:P.macro.options,position:O})}}else if(console.warn("Macro not found:",d.macroName),!U.insertLiteralOnNotFound)return;return}if(o.trim().toLowerCase()==="delete that"){let S=null;if(c.current&&(S=c.current.getElement()),S||(S=m.current),!S){const N=document.querySelectorAll('[contenteditable="true"]');for(const P of N){const O=P;if(O.style.width==="100%"&&O.style.height==="100%"){S=O;break}}}if(S&&dn(S,o).commandExecuted==="delete")return}if(c.current){console.log("ðŸŽ¤ insertDictation: Before inserting, current findings from ref:",{currentHtml:c.current.getValue(),currentHtmlLength:c.current.getValue().length}),c.current.insertDictation(o);const S=c.current.getValue(),N=c.current.getPlainText();console.log("ðŸŽ¤ insertDictation: After inserting, new HTML from ref:",{newHtml:S,newHtmlLength:S.length,plainText:N,plainTextLength:N.length,preview:S.substring(0,100)}),S&&S.length>0&&a(S,!0);return}let u=m.current;if(!u){const S=document.querySelectorAll('[contenteditable="true"]');for(const N of S){const P=N;if(P.style.width==="100%"&&P.style.height==="100%"){u=P;break}}}if(!u)return;let x=o;if(u instanceof HTMLTextAreaElement){const S=u.selectionStart;if(S>0){const N=u.value[S-1],P=o[0];N&&P&&P!==" "&&N!==" "&&(/[a-zA-Z0-9]/.test(N)&&/[a-zA-Z]/.test(P)||/[.,:;!?]/.test(N)&&/[a-zA-Z]/.test(P))&&(x=" "+o),N===" "&&P===" "&&(x=o.trimStart())}}else if(u.isContentEditable){const S=window.getSelection();if(S&&S.rangeCount>0){const N=S.getRangeAt(0),P=N.startContainer;if(P.nodeType===Node.TEXT_NODE){const O=P.textContent||"",oe=N.startOffset;if(oe>0){const ee=O[oe-1],te=o[0];ee&&te&&te!==" "&&ee!==" "&&(/[a-zA-Z0-9]/.test(ee)&&/[a-zA-Z]/.test(te)||/[.,:;!?]/.test(ee)&&/[a-zA-Z]/.test(te))&&(x=" "+o),ee===" "&&te===" "&&(x=o.trimStart())}}}}const w=dn(u,x);if(w.success&&(u instanceof HTMLTextAreaElement?f(u.value):u.isContentEditable&&f(u.textContent||""),u.focus(),w.commandExecuted))switch(w.commandExecuted){case"delete":break;case"undo":$("â†¶ Undo completed"),setTimeout(()=>{u instanceof HTMLTextAreaElement?f(u.value):u&&u.isContentEditable&&f(u.textContent||"")},50);break;case"redo":$("â†· Redo completed"),setTimeout(()=>{u instanceof HTMLTextAreaElement?f(u.value):u&&u.isContentEditable&&f(u.textContent||"")},50);break;case"newParagraph":$("Â¶ New paragraph created");break;case"newLine":$("â†µ New line created");break}},[$,U,f,n]);p.useEffect(()=>{k.current={insertDictation:xt,getValue:()=>{var o;return((o=m.current)==null?void 0:o.value)||""},focus:()=>{var o;return(o=m.current)==null?void 0:o.focus()}}},[xt]),p.useEffect(()=>{var o;if((o=window.electronAPI)!=null&&o.onDictationText)return window.electronAPI.onDictationText(u=>{console.log("ðŸŽ™ï¸ Received dictation text from main process:",u),c.current&&c.current.saveCursor(),xt(u)})},[xt]),p.useEffect(()=>{var o;if((o=window.electronAPI)!=null&&o.onDictationError)return window.electronAPI.onDictationError(u=>{console.error("Dictation error:",u),v(!1),b(u)})},[]),p.useEffect(()=>{if(!window.electronAPI)return;const o=[];return window.electronAPI.onPowerMicRecordPressed&&o.push(window.electronAPI.onPowerMicRecordPressed(()=>{if(!re){console.log("ðŸŽ¤ Power Mic III: Hardware mic disabled, ignoring button press");return}console.log("ðŸŽ¤ Power Mic III: Record button pressed - triggering dictation"),C||Ue()})),window.electronAPI.onPowerMicRecordReleased&&o.push(window.electronAPI.onPowerMicRecordReleased(()=>{if(!re){console.log("ðŸŽ¤ Power Mic III: Hardware mic disabled, ignoring button release");return}console.log("ðŸŽ¤ Power Mic III: Record button released - stopping dictation"),C&&Ue()})),window.electronAPI.onTriggerDictationToggle&&o.push(window.electronAPI.onTriggerDictationToggle(()=>{console.log("ðŸŽ¤ Dictation toggle triggered"),Ue()})),()=>{o.forEach(d=>d())}},[Ue,C,re]),p.useEffect(()=>{var o;if((o=window.electronAPI)!=null&&o.onCleanupResult)return window.electronAPI.onCleanupResult(u=>{f(u),B(!1),Te(null)})},[]),p.useEffect(()=>{var u;if(!((u=window.electronAPI)!=null&&u.onTemplatesUpdated))return;const o=x=>{console.log("ðŸ”„ Templates updated event received:",x),D&&x.userId===D.id&&(console.log("ðŸ”„ Refreshing templates for current user"),mt())};return window.electronAPI.onTemplatesUpdated(o)},[D,mt]),p.useEffect(()=>{var o;if((o=window.electronAPI)!=null&&o.onCleanupError)return window.electronAPI.onCleanupError(u=>{console.error("Cleanup error:",u),B(!1),Te(u)})},[]),p.useEffect(()=>{var o;if((o=window.electronAPI)!=null&&o.onDictationChunkComplete)return window.electronAPI.onDictationChunkComplete(async u=>{var x;if(u&&u.trim().length>0){console.log("ðŸ”„ Processing chunk in real-time:",u),Je(!0);try{if((x=window.electronAPI)!=null&&x.autoCleanupText){const w=await window.electronAPI.autoCleanupText(u);w.success&&w.cleanedText?(console.log("ðŸ§  Chunk processed:",u,"â†’",w.cleanedText),f(S=>{const N=S.lastIndexOf(u.trim());return N!==-1?S.slice(0,N)+w.cleanedText+S.slice(N+u.trim().length):S+(S?" ":"")+w.cleanedText})):console.warn("ðŸ§  Chunk processing failed, keeping original")}}catch(w){console.error("ðŸ§  Chunk processing error:",w)}finally{Je(!1)}}})},[it]),p.useCallback(async()=>{var o;if(!n||n.trim().length===0){Te("No text to clean up");return}if(!K)try{if(B(!0),Te(null),(o=window.electronAPI)!=null&&o.cleanupText){const d=await window.electronAPI.cleanupText(n);d.success||(Te(d.error||"Failed to clean up text"),B(!1))}else Te("Cleanup functionality not available"),B(!1)}catch(d){console.error("Failed to cleanup text:",d),Te("Failed to clean up text: "+d.message),B(!1)}},[n,K]),p.useEffect(()=>{const o=d=>{const u=gn(),x=ao(u);lo(d,x)&&(d.preventDefault(),Ue())};return window.addEventListener("keydown",o),()=>window.removeEventListener("keydown",o)},[Ue]);const kn=()=>{try{const o={...ue.exportOfflineData(),exportDate:new Date().toISOString(),version:"1.0"},d=JSON.stringify(o,null,2),u=new Blob([d],{type:"application/json"}),x=URL.createObjectURL(u),w=document.createElement("a");w.href=x,w.download=`radpal-backup-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(x),$("âœ… Backup exported successfully!")}catch(o){console.error("Backup failed:",o),$("âŒ Backup export failed")}},En=()=>{try{const o=document.createElement("input");o.type="file",o.accept=".json",o.onchange=d=>{var w;const u=(w=d.target.files)==null?void 0:w[0];if(!u)return;const x=new FileReader;x.onload=S=>{var N;try{const P=JSON.parse((N=S.target)==null?void 0:N.result);if(!P.version||!P.exportDate)throw new Error("Invalid backup file format");ue.importOfflineData(P),$("âœ… Backup restored successfully! Please restart the app to see changes.")}catch(P){console.error("Restore failed:",P),$("âŒ Backup restore failed - invalid file format")}},x.readAsText(u)},o.click()}catch(o){console.error("Restore failed:",o),$("âŒ Backup restore failed")}},Tn=()=>{et(!0),ze(!1)},An=o=>{var d,u,x,w,S,N,P;o==="edit"?(u=(d=window.electron)==null?void 0:d.ipcRenderer)==null||u.send("open-popup-templates",{isOfflineMode:we}):o==="edit-logic"?(w=(x=window.electron)==null?void 0:x.ipcRenderer)==null||w.send("open-popup-logic",{isOfflineMode:we}):o==="debug"?window.dispatchEvent(new CustomEvent("toggle-debug")):o==="shortcuts"?qe(!0):o==="logout"&&((N=(S=window.electron)==null?void 0:S.ipcRenderer)==null||N.send("resize-window",{width:600,height:900}),(P=window.electronAPI)==null||P.authSignOut().then(()=>{setTimeout(()=>{window.location.reload()},300)}).catch(O=>{console.error("âŒ Logout failed:",O),setTimeout(()=>{window.location.reload()},300)}))};p.useEffect(()=>{var o,d;!D&&!Qe?(console.log("ðŸ”„ Switching to login mode, user:",D,"authLoading:",Qe),document.body.classList.add("login-mode"),document.body.classList.remove("main-mode"),(o=window.electronAPI)!=null&&o.resizeForLoginMode?(console.log("ðŸ“ Calling resizeForLoginMode"),window.electronAPI.resizeForLoginMode(),setTimeout(()=>{console.log("ðŸ“ Fallback resizeForLoginMode call"),window.electronAPI.resizeForLoginMode()},200)):console.log("âŒ resizeForLoginMode not available")):D&&(console.log("ðŸ”„ Switching to main UI mode, user:",D==null?void 0:D.email),document.body.classList.add("main-mode"),document.body.classList.remove("login-mode"),setTimeout(()=>{var u;(u=window.electronAPI)!=null&&u.resizeForMainMode?(console.log("ðŸ“ Delayed resizeForMainMode call"),window.electronAPI.resizeForMainMode()):console.log("âŒ resizeForMainMode not available")},500),setTimeout(()=>{var u;(u=window.electronAPI)!=null&&u.resizeForMainMode&&(console.log("ðŸ“ Second delayed resizeForMainMode call"),window.electronAPI.resizeForMainMode())},1e3),(d=window.electronAPI)==null||d.send("launch-autofill-hotkeys"))},[D,Qe]),p.useEffect(()=>{D&&(async()=>{var u,x,w,S;const d=await((u=window.electronAPI)==null?void 0:u.authGetSession());(x=d==null?void 0:d.data)!=null&&x.session&&((S=(w=window.electron)==null?void 0:w.ipcRenderer)==null||S.invoke("set-supabase-session",d.data.session))})()},[D]),p.useEffect(()=>{var d,u;const o=(u=(d=window.electronAPI)==null?void 0:d.onPopupContent)==null?void 0:u.call(d,x=>{(x==null?void 0:x.type)==="toggle-debug"&&Ze(w=>!w)});return()=>{o&&typeof o=="function"&&o()}},[]),p.useEffect(()=>{const o=()=>Ze(d=>!d);return window.addEventListener("toggle-debug",o),()=>window.removeEventListener("toggle-debug",o)},[]),p.useEffect(()=>{var o,d;D&&((d=(o=window.electron)==null?void 0:o.ipcRenderer)==null||d.invoke("set-current-user",D).then(()=>{}).catch(()=>{}))},[D]),p.useEffect(()=>{var S;console.log("ðŸ”§ IPC useEffect running, checking electron availability...");const o=(S=window==null?void 0:window.electron)==null?void 0:S.ipcRenderer;if(console.log("ðŸ”§ IPC object:",!!o,"has on function:",typeof(o==null?void 0:o.on)),console.log("ðŸ”§ IPC properties:",Object.keys(o||{})),console.log("ðŸ”§ Full electron object:",window==null?void 0:window.electron),console.log("ðŸ”§ window.electron keys:",Object.keys((window==null?void 0:window.electron)||{})),!o||typeof o.on!="function"){console.log("âŒ IPC not available, returning early");return}console.log("âœ… IPC available, setting up listeners...");const d=()=>{St()},u=()=>{Ct()},x=(N,P)=>{const oe=JSON.parse(Xe.getItem("globalShortcuts")||"[]").find(ee=>ee.action===P);oe!=null&&oe.text&&(navigator.clipboard.writeText(oe.text),setTimeout(()=>document.execCommand("paste"),100))},w=N=>{console.log("ðŸŽ¯ Logic editor handler received:",N);const{userId:P,studyType:O}=N;P&&O?(console.log("âœ… Setting selectedStudyType to:",O),xe(O),Ke(!0),console.log("âœ… Logic editor should now be visible")):console.error("âŒ Missing userId or studyType:",{userId:P,studyType:O})};return o.on("trigger-generate-report",d),o.on("trigger-generate-impression",u),o.on("trigger-auto-text-fill",x),console.log("ðŸ”§ Setting up open-logic-editor event listener"),o.on("open-logic-editor",w),()=>{o.removeListener("trigger-generate-report",d),o.removeListener("trigger-generate-impression",u),o.removeListener("trigger-auto-text-fill",x),o.removeListener("open-logic-editor",w)}},[]),p.useEffect(()=>{var d;if(console.log("ðŸ”§ Setting up logic editor listener..."),!((d=window.electronAPI)!=null&&d.onOpenLogicEditor)){console.log("âŒ onOpenLogicEditor not available");return}return console.log("âœ… Setting up open-logic-editor event listener"),window.electronAPI.onOpenLogicEditor(u=>{console.log("ðŸŽ¯ Logic editor handler received:",u);const{userId:x,studyType:w}=u;x&&w?(console.log("âœ… Setting selectedStudyType to:",w),xe(w),Ke(!0),console.log("âœ… Logic editor should now be visible")):console.error("âŒ Missing userId or studyType:",{userId:x,studyType:w})})},[]);const{generateReport:Ko,generateReportFromTemplates:Xo,generateImpressionFromTemplates:Jo,loading:Q,debugPrompt:_n,debugResult:Rn}=Mn(),{generateReportWithAgent:At,generateImpressionWithAgent:qt,loading:De,error:Zo}=no(),Kt=p.useCallback(o=>{if(!o.trim()||o.length<10||M){ge([]),me("");return}Ut(!0);try{const d=o.toLowerCase(),u=[];console.log("ðŸ” Auto-suggest running with findings:",o.substring(0,50)),console.log("ðŸ” Templates loaded:",G?Object.keys(G).length:0);const x={"MRI Ankle":["ankle","talus","calcaneus","fibula","tibia","malleolus","posterior talus","tibiotalar","tibiotalar joint","subtalar","subtalar joint","midfoot joints","anterior talofibular ligament","atfl","talofibular ligament","talofibular","posterior talofibular ligament","ptfl","calcaneofibular ligament","cfl","tibiofibular ligament","syndesmosis","anterior tibiofibular ligament","posterior tibiofibular ligament","interosseous ligament","deltoid ligament","deltoid","deltoid ligament superficial","deltoid ligament deep","spring ligament","bifurcate ligament","posterior tibial tendon","flexor digitorum longus","flexor hallucis longus","fhl","peroneus longus","peroneus brevis","peroneal tendon","peroneus","anterior tibial tendon","extensor hallucis longus","ehl","extensor digitorum longus","achilles tendon","achilles","plantar fascia","tarsal tunnel","sinus tarsi","ankle sprain","lateral ankle sprain","medial ankle sprain","high ankle sprain","ankle instability","ankle impingement"],"MRI Foot":["foot","forefoot","midfoot","hindfoot","rearfoot","metatarsal","metatarsals","phalanx","phalanges","navicular","cuboid","cuneiform","tarsals","first ray","second ray","third ray","fourth ray","fifth ray","toe","big toe","great toe","hallux","lesser toes","hallux-sesamoid complex","sesamoid","metatarsophalangeal joint","mtp joint","1st mtp","2nd mtp","3rd mtp","4th mtp","5th mtp","lisfranc ligament","lisfranc injury","lisfranc joint","chopart joint","plantar fascia","plantar plate","morton neuroma","morton","interdigital neuroma","flexor tendons","extensor tendons","flexor tendons of toes","extensor tendons of toes","hallux valgus","bunion","hammer toe","claw toe","mallet toe","jones fracture","rays"],"MRI Knee":["knee","patella","patellar","femoral condyle","tibial plateau","intercondylar notch","anterior cruciate ligament","acl","posterior cruciate ligament","pcl","medial collateral ligament","mcl","lateral collateral ligament","lcl","llc","cruciate","collateral ligament","patellar ligament","quadriceps tendon","patellar tendon","popliteus tendon","popliteofibular ligament","meniscus","medial meniscus","lateral meniscus","meniscal tear","meniscal","proximal tibiofibular joint","trochlea cartilage","plica","baker cyst","popliteal","patellofemoral","chondromalacia","runner knee","jumper knee","iliotibial band","itb","pes anserine","hoffa fat pad","intercondylar","compartments"],"MRI Hip":["hip","hip joint","femoral head","femoral neck","acetabulum","acetabular","femoroacetabular impingement","fai","cam lesion","pincer lesion","cam impingement","pincer impingement","os acetabulare","dysplasia","acetabular retroversion","head-neck angle","labrum","labral","labral tear","femoral cartilage","acetabular cartilage","capsule","gluteus maximus","hamstring origin","abductors","adductors","short external rotators","iliopsoas","psoas","gluteal","gluteus","piriformis","piriformis syndrome","sciatic nerve","femoral nerve","sacroiliac joint","pubic symphysis","trochanter","greater trochanter","lesser trochanter","trochanteric","trochanteric bursitis","fibrocystic lesion","hip dysplasia","avascular necrosis","avn","osteonecrosis","snapping hip"],"MRI Shoulder":["shoulder","glenohumeral","glenohumeral joint","glenoid","humeral head","rotator cuff","supraspinatus","infraspinatus","subscapularis","teres minor","rotator cuff tear","cuff tear","impingement","subacromial impingement","labrum","labral","slap tear","bankart lesion","hill sachs lesion","glenohumeral ligaments","acromion","subacromial spur","lateral downsloping","acromial arch","acromioclavicular","acromioclavicular joint","ac joint","biceps tendon","long head biceps","long head of biceps tendon","bicipital anchor","subacromial-subdeltoid bursa","subdeltoid bursa","humeral head cartilage","frozen shoulder","adhesive capsulitis","shoulder instability","dislocation"],"MRI Elbow":["elbow","elbow joint","humerus","radius","ulna","lateral epicondyle","medial epicondyle","olecranon","radial head","ulnar collateral ligament","ucl","radial collateral ligament","lateral ulnar collateral ligament","common flexor tendon","common extensor tendon","triceps tendon","biceps tendon","brachialis","radio-capitellar joint","ulno-humeral joint","proximal radioulnar joint","bicipitoradial bursa","ulnar nerve","cubital tunnel","cubital tunnel syndrome","tennis elbow","lateral epicondylitis","golfer elbow","medial epicondylitis","intra-articular bodies"],"MRI Wrist":["wrist","wrist joint","radiocarpal","midcarpal","distal radioulnar joint","druj","pisiform-triquetral joint","scaphotrapezotrapezoidal joint","stt joint","thumb carpometacarpal joint","carpal","carpus","carpal bones","scaphoid","lunate","triquetrum","pisiform","hamate","capitate","trapezoid","trapezium","tfcc","triangular fibrocartilage","triangular fibrocartilage complex","scapholunate ligament","lunotriquetral ligament","extensor compartments","extensor compartment i","extensor compartment ii","extensor compartment iii","extensor compartment iv","extensor compartment v","extensor compartment vi","flexor tendons","flexor retinaculum","carpal tunnel","carpal tunnel syndrome","median nerve","guyon canal","de quervain","kienbock disease","scaphoid fracture"],"MRI Hand":["hand","finger","thumb","digits","metacarpal","phalanges","phalanx","proximal phalanx","middle phalanx","distal phalanx","mcp joint","pip joint","dip joint","metacarpophalangeal","interphalangeal","flexor tendon","extensor tendon","trigger finger","trigger thumb","mallet finger","swan neck deformity","boutonniere deformity","dupuytren contracture","ganglion cyst"],"MRI Cervical Spine":["cervical","cervical spine","c-spine","c spine","neck","c1","c2","c3","c4","c5","c6","c7","atlas","axis","cervical disc","cervical stenosis","cervical radiculopathy","cervical myelopathy","neck pain","whiplash","torticollis","cervical spondylosis"],"MRI Thoracic Spine":["thoracic","thoracic spine","t-spine","t spine","mid back","middle back","t1","t2","t3","t4","t5","t6","t7","t8","t9","t10","t11","t12","thoracic disc","thoracic stenosis","thoracic radiculopathy","thoracolumbar","kyphosis","thoracic kyphosis"],"MRI Lumbar Spine":["lumbar","lumbar spine","l-spine","l spine","lower back","low back","l1","l2","l3","l4","l5","s1","lumbosacral","lumbar disc","disc herniation","herniated disc","bulging disc","disc protrusion","lumbar stenosis","spinal stenosis","canal stenosis","foraminal stenosis","sciatica","radiculopathy","nerve root","nerve root compression","facet joint","facet arthropathy","spondylolisthesis","spondylolysis","lumbar spondylosis","degenerative disc disease","ddd"],"MRI Total Spine":["total spine","whole spine","entire spine","full spine","complete spine"],"CT Abdomen Pelvis":["liver","hepatic","biliary","intrahepatic ductal dilatation","gallbladder","gallstones","common bile duct","spleen","splenic","pancreas","peripancreatic","adrenal glands","kidneys","renal","ureters","hydronephrosis","nephrolithiasis","bladder","bowel","small bowel","large bowel","obstruction","abdominal aorta","aneurysm","dissection","retroperitoneum","lymph nodes","lymphadenopathy","lungs (bases)","consolidation","effusion","nodule","abdomen","pelvis","appendix","ovary","uterus","prostate","colon","intestine"],"CT Chest":["lungs","pulmonary","airways","consolidation","pneumothorax","pulmonary nodule","bronchial obstruction","endobronchial lesion","pleural effusion","pleura","chest wall","heart","great vessels","aorta","dissection","aneurysm","pulmonary embolism","mediastinum","hilar lymph nodes","mediastinal lymphadenopathy","upper abdomen (visualized)","fracture","dislocation","aggressive osseous lesion","subcutaneous tissues","chest","lung","pleural","thorax","bronchi","pneumonia","nodule","embolism"],"CT Head":["brain parenchyma","hemorrhage","intracranial hemorrhage","mass effect","herniation","gray-white differentiation","white matter","ventricles","extra-axial","hydrocephalus","fluid collections","extracranial structures","fracture","paranasal sinuses","mastoids","large territorial infarct","head","brain","skull","intracranial","stroke","subdural","subarachnoid","ventricle","sinuses"],"CT Pulmonary Embolism":["pulmonary arteries","main pulmonary artery","pulmonary embolism","pe","lungs","consolidation","pneumothorax","pulmonary nodule","bronchial obstruction","endobronchial lesion","pleural effusion","pleura","chest wall","heart","aorta","dissection","aneurysm","mediastinum","hilar lymph nodes","upper abdomen (visualized)","fracture","dislocation","aggressive osseous lesion","subcutaneous tissues","pe protocol","pulmonary artery","embolus","thrombosis","ctpa"],DEXA:["dexa","bone density","osteoporosis","osteopenia","t-score","z-score","bmd","fracture risk"],"MRI Generic":["mri","magnetic resonance"],"CT Generic":["ct","computed tomography","cat scan"],"MSK MRI Generic":["fracture","traumatic malalignment","bone marrow edema","marrow signal","osteoarthritis","joint effusion","ligaments","tendons","muscles","atrophy","muscle atrophy","neurovascular structures","neurovascular structures intact","subcutaneous tissues","soft tissues","unremarkable"]};for(const[S,N]of Object.entries(x)){if(G&&Object.keys(G).length>0&&!G[S])continue;let P=0,O=0;for(const oe of N)if(d.includes(oe)){const ee=oe.split(" ").length>1?3:1;P+=ee,O++,console.log(`  âœ“ Matched "${oe}" for ${S} (weight: ${ee})`)}if(P>0){const oe=O/Math.min(3,N.length)*60,ee=Math.min(35,P*10),te=Math.min(95,Math.round(oe+ee));console.log(`  â†’ ${S}: ${O} matches, score ${P}, confidence ${te}%`),u.push({type:S,confidence:te})}}if(G&&Object.keys(G).length>0){const S=Object.keys(G),N=Object.keys(x),P=S.filter(O=>!N.includes(O));console.log("ðŸ” Templates without patterns:",P);for(const O of P){const oe=O.toLowerCase().split(/[\s_-]+/).filter(le=>le.length>2);let ee=0,te=0;for(const le of oe)d.includes(le)&&(ee+=le.length,te++);if(te>0){const le=te/Math.min(2,oe.length)*40,Ae=Math.min(15,ee*2),Re=Math.min(60,Math.round(le+Ae));console.log(`  â†’ ${O} (name-based): ${te} matches, score ${ee}, confidence ${Re}%`),u.push({type:O,confidence:Re})}}}u.sort((S,N)=>N.confidence-S.confidence);const w=u.slice(0,3).filter(S=>S.confidence>=20);console.log("ðŸ” Local suggestions:",w),w.length>0?(ge(w),me(w[0].type)):(ge([]),me(""))}catch(d){console.error("Auto-suggest error:",d),ge([]),me("")}finally{setTimeout(()=>{Ut(!1)},100)}},[M,G]),wt=p.useMemo(()=>bo(Kt,1e3),[Kt]),Xt=p.useCallback(o=>{if(console.log("ðŸ“ App: RichTextEditor onChange called:",{length:(o==null?void 0:o.length)||0,preview:o==null?void 0:o.substring(0,50),currentFindings:n.substring(0,50),currentLength:n.length,typeOfNewFindings:typeof o,isNull:o===null,isUndefined:o===void 0,actualNewFindings:o}),o!=null){a(o,!0);const d=document.createElement("div");d.innerHTML=o;const u=d.textContent||d.innerText||"";if(console.log("ðŸ“ Plain text for suggestions:",{html:o,length:u.length,preview:u.substring(0,50),fullText:u}),u.trim().length<10){ge([]),me("");return}if(u.trim().length>20)try{console.log("ðŸ” Triggering study type suggestion from handleRichTextChange with text:",u),wt(u)}catch(x){console.log("Auto-suggest error:",x)}}},[n,a,wt,ge,me]),_t=o=>{const d=document.createElement("div");return d.innerHTML=o,d.textContent||d.innerText||""};p.useEffect(()=>{if(console.log("ðŸ“ Findings changed, length:",(n==null?void 0:n.length)||0),!n){ge([]),me("");return}const o=_t(n);if(console.log("ðŸ“ Plain text extracted, length:",o.length,"preview:",o.substring(0,50)),o.trim().length<10){ge([]),me("");return}if(o.trim().length>20)try{console.log("ðŸ” Triggering study type suggestion..."),wt(o)}catch(d){console.log("Auto-suggest error from dictation:",d)}},[n,wt]);const St=p.useCallback(async()=>{var o,d;try{if(console.log("ðŸ” handleGenerate called"),console.log("ðŸ” selectedStudyType:",M),console.log("ðŸ” templates keys:",Object.keys(G)),console.log("ðŸ” generateReportWithAgent available:",!!At),!M){console.log("âŒ No study type selected"),$("Please select a study type before generating report");return}if(!G[M]){console.log("âŒ Study type not found in templates:",M),console.log("âŒ Available templates:",Object.keys(G)),$(`Invalid study type: "${M}". Please select from the available options.`);return}let u=n;(!u||u.trim().length===0)&&c.current&&(u=c.current.getValue(),console.log("ðŸ“ Retrieved findings directly from RichTextEditor:",{html:u,length:u.length,preview:u.substring(0,100),plainText:c.current.getPlainText()}));let x=_t(u);if((!x||x.trim().length===0)&&c.current&&(x=c.current.getPlainText(),console.log("ðŸ“ Using plain text directly from editor:",x)),!x||x.trim().length===0){console.error("âŒ No findings to generate report from"),$("Please enter findings before generating a report");return}console.log("ðŸ“‹ Findings for report generation:",{rawFindings:n,htmlLength:(n==null?void 0:n.length)||0,plainTextLength:(x==null?void 0:x.length)||0,preview:(x==null?void 0:x.substring(0,100))||"No findings",extractedText:x}),console.log("ðŸ” Starting generation"),Ce(null);try{console.log("ðŸ” Starting report generation with agent");const w=sn(L),S=Date.now(),N=await At(x,M,w);console.log("ðŸ” Agent result:",N);const P=((Date.now()-S)/1e3).toFixed(1),O=((o=G[M])==null?void 0:o.template)||"",oe=N.text||"âŒ Report generation failed.";console.log("ðŸ” DIFF DEBUG - Template text preview:",O.trim().substring(0,200)),console.log("ðŸ” DIFF DEBUG - Generated text preview:",oe.trim().substring(0,200));const ee=on(O.trim(),oe.trim());console.log("ðŸ” DIFF DEBUG - Raw diff parts count:",ee.length);const te=ee.filter((Ae,Re)=>!0);console.log("ðŸ” DIFF DEBUG - Filtered diff parts count:",te.length),Ce({type:"report",originalFindings:x,templateText:O,generatedText:oe,generationTime:P,tokens:N.tokens,showDiff:!0,diffParts:te});let le="";te&&te.forEach(Ae=>{let Re=Ae.value.replace(/\b(FINDINGS?:)/gi,"<strong>$1</strong>").replace(/\b(IMPRESSION:)/gi,"<strong>$1</strong>").replace(/\b(LEFT|RIGHT)\b/g,"<strong>$1</strong>").replace(/\n/g,"<br>");Ae.added?le+=`<span style="background-color: rgba(58, 188, 150, 0.3); color: #3ABC96; padding: 1px 2px; border-radius: 2px;">${Re}</span>`:Ae.removed?le+=`<span style="background-color: rgba(227, 103, 86, 0.3); color: #E36756; text-decoration: line-through; padding: 1px 2px; border-radius: 2px;">${Re}</span>`:le+=Re}),g(),c.current&&le?(c.current.setValue(le),f(le)):le&&f(le)}catch(w){console.error("Agent report generation failed:",w);const S=`âŒ Report generation failed: ${w.message||"Unknown error"}`,N=((d=G[M])==null?void 0:d.template)||"",P=on(N.trim(),S.trim()).filter((O,oe)=>!0);Ce({type:"report",originalFindings:x,templateText:N,generatedText:S,generationTime:"0.0",tokens:{input:0,output:0,total:0},showDiff:!0,diffParts:P}),f(S,!1)}}catch(u){console.error("âŒ handleGenerate error:",u),$(`Generation failed: ${u.message||"Unknown error"}`)}},[G,At,n,M,L,$,g]),Ct=p.useCallback(async()=>{if(!M){$("Please select a study type before generating impression");return}if(!G[M]){$(`Invalid study type: "${M}". Please select from the available options.`);return}let o=n;(!o||o.trim().length===0)&&c.current&&(o=c.current.getValue(),console.log("ðŸ“ Retrieved findings directly from RichTextEditor for impression:",{html:o,length:o.length,preview:o.substring(0,100),plainText:c.current.getPlainText()}));let d=_t(o);if((!d||d.trim().length===0)&&c.current&&(d=c.current.getPlainText(),console.log("ðŸ“ Using plain text directly from editor for impression:",d)),console.log("ðŸ“‹ Findings for impression generation:",{htmlLength:(o==null?void 0:o.length)||0,plainTextLength:(d==null?void 0:d.length)||0,preview:(d==null?void 0:d.substring(0,100))||"No findings"}),!d||d.trim().length===0){console.error("âŒ No findings to generate impression from"),$("Please enter findings before generating an impression");return}Ce(null);try{const u=sn(L),x=Date.now(),w=await qt(d,M,u),S=((Date.now()-x)/1e3).toFixed(1),N=w.text||"âŒ Impression generation failed.";g();const P=N.replace(/\b(FINDINGS?:)/gi,"<strong>$1</strong>").replace(/\b(IMPRESSION:)/gi,"<strong>$1</strong>").replace(/\b(LEFT|RIGHT)\b/g,"<strong>$1</strong>").replace(/\n/g,"<br>");c.current&&c.current.setValue(P),f(P),Ce({type:"impression",originalFindings:d,templateText:"",generatedText:N,generationTime:S,tokens:w.tokens,showDiff:!1})}catch(u){console.error("Agent impression generation failed:",u);const x=`âŒ Impression generation failed: ${u.message||"Unknown error"}`;Ce({type:"impression",originalFindings:d,templateText:"",generatedText:x,generationTime:"0.0",tokens:{input:0,output:0,total:0},showDiff:!1}),f(x,!1)}},[G,qt,n,M,L,$,g]),jn=p.useCallback(o=>{let d=m.current;if(!d){const u=document.querySelectorAll('[contenteditable="true"]');for(const x of u){const w=x;if(w.style.width==="100%"&&w.style.height==="100%"){d=w;break}}}d&&(Rt(d,o),d.focus()),_(null)},[]);return p.useEffect(()=>{D!=null&&D.id&&$e.setUserId(D.id)},[D==null?void 0:D.id]),p.useEffect(()=>{Yo(U)},[U]),Qe?e.jsx("div",{style:{padding:40},children:"ðŸ” Loading user..."}):D?e.jsxs(e.Fragment,{children:[h.installing&&e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e4,backdropFilter:"blur(10px)"},children:e.jsxs("div",{style:{background:"linear-gradient(135deg, #2a2d31 0%, #1e2023 100%)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:16,padding:32,width:"90%",maxWidth:500,boxShadow:"0 20px 60px rgba(0, 0, 0, 0.5)"},children:[e.jsx("h2",{style:{margin:"0 0 8px 0",fontSize:24,fontWeight:600,color:"#fff",fontFamily:"SF Pro Display, -apple-system, BlinkMacSystemFont, sans-serif"},children:"ðŸŽ® Installing GPU Acceleration"}),e.jsx("p",{style:{margin:"0 0 24px 0",fontSize:14,color:"rgba(255, 255, 255, 0.7)",lineHeight:1.5},children:"Installing CUDA-enabled binaries to accelerate offline AI generation with your NVIDIA GPU."}),e.jsx("div",{style:{background:"rgba(0, 0, 0, 0.3)",borderRadius:8,height:8,overflow:"hidden",marginBottom:16},children:e.jsx("div",{style:{background:"linear-gradient(90deg, #4CAF50, #8BC34A)",height:"100%",width:`${h.progress||0}%`,transition:"width 0.3s ease",boxShadow:"0 0 10px rgba(76, 175, 80, 0.5)"}})}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[e.jsx("span",{style:{fontSize:13,color:"rgba(255, 255, 255, 0.6)"},children:h.status||"Starting installation..."}),e.jsxs("span",{style:{fontSize:13,color:"#4CAF50",fontWeight:500},children:[h.progress||0,"%"]})]}),h.error&&e.jsx("div",{style:{marginTop:16,padding:12,background:"rgba(244, 67, 54, 0.1)",border:"1px solid rgba(244, 67, 54, 0.2)",borderRadius:8},children:e.jsxs("p",{style:{margin:0,fontSize:12,color:"rgba(244, 67, 54, 0.9)",lineHeight:1.4},children:["Error: ",h.error]})}),e.jsx("div",{style:{marginTop:24,padding:12,background:"rgba(76, 175, 80, 0.1)",border:"1px solid rgba(76, 175, 80, 0.2)",borderRadius:8},children:e.jsx("p",{style:{margin:0,fontSize:12,color:"rgba(76, 175, 80, 0.9)",lineHeight:1.4},children:"âš¡ GPU acceleration will provide significantly faster offline generation (typically 10x speed improvement)."})})]})}),ie.downloading&&e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e4,backdropFilter:"blur(10px)"},children:e.jsxs("div",{style:{background:"linear-gradient(135deg, #2a2d31 0%, #1e2023 100%)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:16,padding:32,width:"90%",maxWidth:500,boxShadow:"0 20px 60px rgba(0, 0, 0, 0.5)"},children:[e.jsx("h2",{style:{margin:"0 0 8px 0",fontSize:24,fontWeight:600,color:"#fff",fontFamily:"SF Pro Display, -apple-system, BlinkMacSystemFont, sans-serif"},children:"Setting up Local AI"}),e.jsx("p",{style:{margin:"0 0 24px 0",fontSize:14,color:"rgba(255, 255, 255, 0.7)",lineHeight:1.5},children:(Jt=ie.status)!=null&&Jt.includes("server")?"Setting up local AI server. This is a one-time setup.":"Downloading Mistral AI model for offline use. This is a one-time download."}),e.jsx("div",{style:{background:"rgba(0, 0, 0, 0.3)",borderRadius:8,height:8,overflow:"hidden",marginBottom:16},children:e.jsx("div",{style:{background:"linear-gradient(90deg, #FF6B35, #FF8E53)",height:"100%",width:`${ie.progress||0}%`,transition:"width 0.3s ease",boxShadow:"0 0 10px rgba(255, 107, 53, 0.5)"}})}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[e.jsx("span",{style:{fontSize:13,color:"rgba(255, 255, 255, 0.6)"},children:ie.status||"Starting download..."}),e.jsxs("span",{style:{fontSize:13,color:"#FF6B35",fontWeight:500},children:[ie.progress||0,"%"]})]}),ie.bytesTotal&&e.jsxs("div",{style:{fontSize:12,color:"rgba(255, 255, 255, 0.5)",textAlign:"center",marginTop:8},children:[Math.round((ie.bytesDownloaded||0)/1024/1024)," MB / ",Math.round(ie.bytesTotal/1024/1024)," MB"]}),e.jsx("div",{style:{marginTop:24,padding:12,background:"rgba(255, 165, 0, 0.1)",border:"1px solid rgba(255, 165, 0, 0.2)",borderRadius:8},children:e.jsx("p",{style:{margin:0,fontSize:12,color:"rgba(255, 165, 0, 0.9)",lineHeight:1.4},children:"â„¹ï¸ This 4.4GB model enables completely offline AI processing. After this download, RadPal will work without internet."})})]})}),e.jsx("div",{className:"radpal-outer-frame",style:t?{overflow:"visible"}:{},children:e.jsxs("div",{className:"window-frame",style:t?{overflow:"visible"}:{},children:[!t&&e.jsxs("div",{className:"radpal-root dark",style:{padding:"12px",minHeight:"100vh",boxSizing:"border-box",display:"flex",flexDirection:"column"},children:[e.jsxs("div",{style:{position:"fixed",top:0,left:0,right:0,height:50,background:"rgba(42, 45, 49, 0.95)",backdropFilter:"blur(12px) saturate(120%)",WebkitBackdropFilter:"blur(12px) saturate(120%)",borderBottom:"1px solid rgba(255, 255, 255, 0.1)",display:"flex",alignItems:"center",padding:"0 16px",zIndex:1e3,gap:12},children:[e.jsx("div",{style:{position:"absolute",top:0,left:"30%",right:"30%",height:"100%",WebkitAppRegion:"drag",pointerEvents:"none",zIndex:-1}}),e.jsxs("div",{style:{display:"flex",gap:12,position:"relative",zIndex:10},children:[e.jsx("button",{onMouseDown:o=>o.preventDefault(),onPointerDown:o=>o.preventDefault(),onClick:Ue,disabled:Q,style:{padding:"8px 12px",background:C?"linear-gradient(135deg, #E36756 0%, #c7564a 100%)":"rgba(108, 117, 125, 0.1)",border:C?"1px solid rgba(227, 103, 86, 0.5)":"1px solid rgba(108, 117, 125, 0.3)",borderRadius:8,color:C?"#fff":"#6C757D",fontSize:14,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:Q?"not-allowed":"pointer",opacity:Q?.5:1,transition:"all 0.2s ease",WebkitAppRegion:"no-drag",display:"flex",alignItems:"center",gap:6},children:C?"â¸ Recording...":"ðŸŽ™ Dictate"}),e.jsx("button",{onMouseDown:o=>o.preventDefault(),onPointerDown:o=>o.preventDefault(),onClick:In,title:"Reset microphone system (fixes accuracy issues)",style:{padding:"8px 10px",background:"rgba(108, 117, 125, 0.1)",border:"1px solid rgba(108, 117, 125, 0.3)",borderRadius:8,color:"#6C757D",fontSize:12,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:"pointer",transition:"all 0.2s ease",WebkitAppRegion:"no-drag"},children:"ðŸ”„"}),e.jsx("button",{onMouseDown:o=>o.preventDefault(),onPointerDown:o=>o.preventDefault(),onClick:Ye,title:re?"Disable SpeedMic III hardware button (prevents conflicts with PowerScribe)":"Enable SpeedMic III hardware button",style:{padding:"8px 10px",background:re?"rgba(58, 188, 150, 0.1)":"rgba(108, 117, 125, 0.1)",border:re?"1px solid rgba(58, 188, 150, 0.3)":"1px solid rgba(108, 117, 125, 0.3)",borderRadius:8,color:re?"#3ABC96":"#6C757D",fontSize:12,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:"pointer",transition:"all 0.2s ease",WebkitAppRegion:"no-drag"},children:re?"ðŸ”—":"ðŸ”—â›”"}),e.jsx("button",{onClick:()=>{c.current?(c.current.setValue(n),c.current.focus()):m.current&&m.current.focus()},title:"Undo (or say 'undo that')",style:{padding:"8px 10px",background:"rgba(108, 117, 125, 0.1)",border:"1px solid rgba(108, 117, 125, 0.3)",borderRadius:8,color:"#6C757D",fontSize:14,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:"pointer",transition:"all 0.2s ease",WebkitAppRegion:"no-drag"},onMouseEnter:o=>{o.currentTarget.style.color="#3ABC96"},onMouseLeave:o=>{o.currentTarget.style.color="#6C757D"},children:"â†¶"}),e.jsx("button",{onClick:()=>{c.current?(c.current.setValue(n),c.current.focus()):m.current&&m.current.focus()},title:"Redo (or say 'redo that')",style:{padding:"8px 10px",background:"rgba(108, 117, 125, 0.1)",border:"1px solid rgba(108, 117, 125, 0.3)",borderRadius:8,color:"#6C757D",fontSize:14,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:"pointer",transition:"all 0.2s ease",WebkitAppRegion:"no-drag"},onMouseEnter:o=>{o.currentTarget.style.color="#3ABC96"},onMouseLeave:o=>{o.currentTarget.style.color="#6C757D"},children:"â†·"}),e.jsx("button",{onClick:()=>{if(xe(""),ge([]),me(""),Ce(null),c.current)c.current.setValue(""),c.current.focus(),f("");else{const o=m.current;if(o)o.focus(),o.select(),o.setRangeText("",0,o.value.length,"end"),f("");else{const d=document.querySelectorAll('[contenteditable="true"]');for(const u of d){const x=u;if(x.style.width==="100%"&&x.style.height==="100%"){x.focus(),document.execCommand("selectAll"),document.execCommand("delete"),f("");break}}}}},style:{padding:"8px 12px",background:"rgba(227, 103, 86, 0.1)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:8,color:"#E36756",fontSize:14,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:"pointer",transition:"all 0.2s ease",WebkitAppRegion:"no-drag"},children:"ðŸ—‘ Clear All"})]}),e.jsx("div",{style:{flex:1}}),e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"center",alignItems:"center",position:"relative",zIndex:10},children:[e.jsx("button",{onClick:St,disabled:Q||ae,style:{padding:"8px 16px",background:"linear-gradient(135deg, #3ABC96 0%, #2a9b7a 100%)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:8,color:"#fff",fontSize:14,fontWeight:500,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:Q||ae?"not-allowed":"pointer",opacity:Q||ae?.5:1,transition:"all 0.2s ease",WebkitAppRegion:"no-drag",minWidth:"90px",textAlign:"center"},children:"ðŸ“„ Report"}),e.jsx("button",{onClick:Ct,disabled:Q||ae,style:{padding:"8px 16px",background:"linear-gradient(135deg, #3ABC96 0%, #2a9b7a 100%)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:8,color:"#fff",fontSize:14,fontWeight:500,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:Q||ae?"not-allowed":"pointer",opacity:Q||ae?.5:1,transition:"all 0.2s ease",WebkitAppRegion:"no-drag",minWidth:"110px",textAlign:"center"},children:"ðŸ’­ Impression"})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginLeft:"auto",position:"relative",zIndex:10},children:[e.jsx("button",{style:{padding:"8px 12px",background:"rgba(42, 45, 49, 0.8)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:8,color:"#fff",fontSize:14,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:"pointer",transition:"all 0.2s ease",WebkitAppRegion:"no-drag"},onClick:()=>ze(!0),"data-settings-trigger":!0,children:"âš™ï¸"}),we&&e.jsxs("div",{style:{padding:"6px 10px",background:"rgba(255, 165, 0, 0.9)",border:"1px solid rgba(255, 165, 0, 0.3)",borderRadius:6,color:"#fff",fontSize:11,fontWeight:500,display:"flex",alignItems:"center",gap:"4px"},title:`Offline mode active${je?`. Last sync: ${je.toLocaleString()}`:". No previous sync found."}`,children:["ðŸ”Œ Offline",je&&e.jsxs("span",{style:{fontSize:9,opacity:.8},children:["(",Math.floor((Date.now()-je.getTime())/(1e3*60)),"m)"]})]}),e.jsxs("div",{style:{display:"flex",gap:4},children:[e.jsx("button",{onClick:Cn,style:{padding:"4px 8px",background:"rgba(255, 255, 255, 0.05)",border:"1px solid rgba(255, 255, 255, 0.08)",borderRadius:12,color:"#ccc",WebkitAppRegion:"no-drag",fontSize:10,cursor:"pointer",transition:"all 0.2s ease"},children:"â–¶"}),e.jsx("button",{onClick:Ht,style:{padding:"4px 8px",background:"rgba(255, 255, 255, 0.05)",border:"1px solid rgba(255, 255, 255, 0.08)",borderRadius:12,color:"#ccc",WebkitAppRegion:"no-drag",fontSize:10,cursor:"pointer",transition:"all 0.2s ease"},children:"ï¼"}),e.jsx("button",{onClick:Yt,style:{padding:"4px 8px",background:"rgba(227, 103, 86, 0.1)",border:"1px solid rgba(227, 103, 86, 0.2)",borderRadius:12,color:"#E36756",WebkitAppRegion:"no-drag",fontSize:10,cursor:"pointer",transition:"all 0.2s ease"},children:"Ã—"})]})]})]}),e.jsxs("div",{style:{display:"flex",marginTop:50,height:"calc(100vh - 50px)",width:"100%"},children:[e.jsxs("div",{style:{width:"25.5%",padding:"20px",background:"rgba(30, 32, 35, 0.5)",borderRight:"1px solid rgba(255, 255, 255, 0.1)",display:"flex",flexDirection:"column",gap:20,overflowY:"auto"},children:[e.jsx("div",{style:{width:"100%"},children:e.jsxs(ye,{style:{display:"flex",flexDirection:"column",padding:8,position:"relative",width:"100%",gap:6},children:[e.jsx("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4},children:e.jsxs("span",{style:{fontSize:11,color:j===3?"#FFD700":j===2?"#C0C0C0":"#CD7F32",fontWeight:500,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",textTransform:"uppercase",letterSpacing:"0.5px"},children:[Se(j)," â€¢ Tier ",j]})}),e.jsxs("div",{style:{fontSize:12,color:"#aaa",textAlign:"center",fontWeight:300,textShadow:"none",userSelect:"none",fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif"},children:["Daily tokens: ",((Zt=H==null?void 0:H.used)==null?void 0:Zt.toLocaleString())||0," / ",j===4?"Unlimited":((Qt=H==null?void 0:H.limit)==null?void 0:Qt.toLocaleString())||2e4]}),e.jsx("div",{style:{width:"100%",height:12,backgroundColor:"rgba(20, 22, 25, 0.8)",borderRadius:6,border:"1px solid rgba(255, 255, 255, 0.15)",overflow:"hidden",position:"relative",boxShadow:"inset 0 2px 4px rgba(0, 0, 0, 0.4), 0 1px 2px rgba(0, 0, 0, 0.2)"},children:e.jsx("div",{style:{width:j===4?"0%":`${Math.min((H==null?void 0:H.percentage)||0,100)}%`,height:"100%",backgroundColor:j===4?"#9b59b6":((H==null?void 0:H.percentage)||0)>90?"#E36756":((H==null?void 0:H.percentage)||0)>75?"#E1865D":"#3ABC96",transition:"all 0.3s ease",borderRadius:"6px 0 0 6px",boxShadow:j===4?"none":"0 0 12px rgba(58, 188, 150, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2)"}})})]})}),e.jsxs("div",{style:{width:"100%"},children:[e.jsx("div",{style:{fontSize:12,color:"#aaa",marginBottom:8,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif"},children:"AI Model"}),e.jsxs(ye,{style:{display:"flex",flexDirection:"column",padding:2,gap:2},children:[e.jsxs("button",{onClick:()=>be("openai"),title:Z("openai")?"GPT-4o":`Requires ${Se(ve.openai)} subscription`,style:{padding:"8px 12px",backgroundColor:L==="openai"?"#5F33FF":"transparent",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:8,color:L==="openai"?"#fff":Z("openai")?"#aaa":"#666",fontSize:13,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:Z("openai")?"pointer":"not-allowed",transition:"all 0.2s ease",textAlign:"left",opacity:Z("openai")?1:.5,position:"relative"},children:["GPT-4o ",!Z("openai")&&e.jsx("span",{style:{float:"right"},children:"ðŸ”’"})]}),e.jsxs("button",{onClick:()=>be("gpt-5"),title:Z("gpt-5")?"GPT-5":`Requires ${Se(ve["gpt-5"])} subscription`,style:{padding:"8px 12px",backgroundColor:L==="gpt-5"?"#5F33FF":"transparent",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:8,color:L==="gpt-5"?"#fff":Z("gpt-5")?"#aaa":"#666",fontSize:13,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:Z("gpt-5")?"pointer":"not-allowed",transition:"all 0.2s ease",textAlign:"left",opacity:Z("gpt-5")?1:.5,position:"relative"},children:["GPT-5 ",!Z("gpt-5")&&e.jsx("span",{style:{float:"right"},children:"ðŸ”’"})]}),e.jsx("button",{onClick:()=>be("gemini"),style:{padding:"8px 12px",backgroundColor:L==="gemini"?"#5F33FF":"transparent",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:8,color:L==="gemini"?"#fff":"#aaa",fontSize:13,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:"pointer",transition:"all 0.2s ease",textAlign:"left"},children:"Gemini 2.5 Flash"}),e.jsxs("button",{onClick:()=>be("claude-sonnet"),title:Z("claude-sonnet")?"Claude 4 Sonnet":`Requires ${Se(ve["claude-sonnet"])} subscription`,style:{padding:"8px 12px",backgroundColor:L==="claude-sonnet"?"#5F33FF":"transparent",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:8,color:L==="claude-sonnet"?"#fff":Z("claude-sonnet")?"#aaa":"#666",fontSize:13,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:Z("claude-sonnet")?"pointer":"not-allowed",transition:"all 0.2s ease",textAlign:"left",opacity:Z("claude-sonnet")?1:.5,position:"relative"},children:["Claude 4 Sonnet ",!Z("claude-sonnet")&&e.jsx("span",{style:{float:"right"},children:"ðŸ”’"})]}),e.jsxs("button",{onClick:()=>be("claude-opus"),title:Z("claude-opus")?"Claude 4 Opus":`Requires ${Se(ve["claude-opus"])} subscription`,style:{padding:"8px 12px",backgroundColor:L==="claude-opus"?"#5F33FF":"transparent",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:8,color:L==="claude-opus"?"#fff":Z("claude-opus")?"#aaa":"#666",fontSize:13,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:Z("claude-opus")?"pointer":"not-allowed",transition:"all 0.2s ease",textAlign:"left",opacity:Z("claude-opus")?1:.5,position:"relative"},children:["Claude 4 Opus ",!Z("claude-opus")&&e.jsx("span",{style:{float:"right"},children:"ðŸ”’"})]}),e.jsxs("button",{onClick:()=>be("claude-opus-4.1"),title:Z("claude-opus-4.1")?"Claude 4.1 Opus":`Requires ${Se(ve["claude-opus-4.1"])} subscription`,style:{padding:"8px 12px",backgroundColor:L==="claude-opus-4.1"?"#5F33FF":"transparent",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:8,color:L==="claude-opus-4.1"?"#fff":Z("claude-opus-4.1")?"#aaa":"#666",fontSize:13,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:Z("claude-opus-4.1")?"pointer":"not-allowed",transition:"all 0.2s ease",textAlign:"left",opacity:Z("claude-opus-4.1")?1:.5,position:"relative"},children:["Claude 4.1 Opus ",!Z("claude-opus-4.1")&&e.jsx("span",{style:{float:"right"},children:"ðŸ”’"})]}),e.jsx("button",{onClick:()=>be("kimi"),style:{padding:"8px 12px",backgroundColor:L==="kimi"?"#5F33FF":"transparent",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:8,color:L==="kimi"?"#fff":"#aaa",fontSize:13,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:"pointer",transition:"all 0.2s ease",textAlign:"left"},children:"Kimi v2"}),e.jsx("button",{onClick:()=>be("mistral-local"),title:Z("mistral-local")?"Mistral (Local)":`Requires ${Se(ve["mistral-local"])} subscription`,style:{padding:"8px 12px",backgroundColor:L==="mistral-local"?"#FF6B35":"transparent",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:8,color:L==="mistral-local"?"#fff":Z("mistral-local")?"#aaa":"#666",fontSize:13,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:Z("mistral-local")?"pointer":"not-allowed",transition:"all 0.2s ease",textAlign:"left",opacity:Z("mistral-local")?1:.5,position:"relative"},children:e.jsxs("span",{style:{display:"flex",alignItems:"center",gap:6,justifyContent:"space-between",width:"100%"},children:[e.jsxs("span",{style:{display:"flex",alignItems:"center",gap:6},children:["Mistral (Local)",!Z("mistral-local")&&e.jsx("span",{children:"ðŸ”’"})]}),L==="mistral-local"&&e.jsxs(e.Fragment,{children:[e.jsx("span",{style:{width:8,height:8,borderRadius:"50%",backgroundColor:Ie.running?"#4CAF50":"#f44336",display:"inline-block",animation:Ie.running?void 0:"pulse 1.5s infinite"},title:Ie.running?"Server running":Ie.error||"Server not running"}),Ie.modelMissing&&e.jsx("button",{onClick:async o=>{if(o.stopPropagation(),window.confirm(`Download Mistral model?

Size: 4.07 GB
This will download the model to enable local AI generation.

Continue?`)){console.log("Starting model download...");const u=await window.electronAPI.invoke("download-mistral-model");alert(u?"Model downloaded successfully! Local AI is now ready.":"Download failed. Please check your internet connection.")}},style:{marginLeft:4,padding:"2px 8px",fontSize:11,backgroundColor:"#ff9800",color:"white",border:"none",borderRadius:3,cursor:"pointer"},children:"Download Model (4GB)"}),L==="mistral-local"&&!X&&!h.installing&&e.jsx("button",{onClick:async o=>{o.stopPropagation(),window.confirm(`Enable GPU Acceleration for Offline AI?

Downloads CUDA binaries (~30MB) to accelerate local Mistral generation.
Makes offline AI 10x faster with NVIDIA GPU.

Continue?`)&&(console.log("Starting CUDA binary installation..."),await window.electronAPI.installCudaBinary()?(A(!0),alert("GPU acceleration installed! Offline AI will now use your GPU for faster generation.")):alert("Installation failed. Please check the console for details."))},style:{marginLeft:4,padding:"2px 8px",fontSize:11,backgroundColor:"#4CAF50",color:"white",border:"none",borderRadius:3,cursor:"pointer"},title:"Enable GPU acceleration for 10x faster generation",children:"ðŸš€ Enable GPU"})]})]})})]})]}),e.jsx("div",{style:{width:"100%",marginTop:10},children:e.jsxs("button",{onClick:()=>ne(!0),style:{width:"100%",padding:"10px 12px",backgroundColor:"rgba(58, 188, 150, 0.1)",border:"1px solid rgba(58, 188, 150, 0.3)",borderRadius:8,color:"#3ABC96",fontSize:13,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:"pointer",transition:"all 0.2s ease",display:"flex",alignItems:"center",justifyContent:"center",gap:8},onMouseEnter:o=>{o.currentTarget.style.backgroundColor="rgba(58, 188, 150, 0.2)",o.currentTarget.style.borderColor="rgba(58, 188, 150, 0.5)"},onMouseLeave:o=>{o.currentTarget.style.backgroundColor="rgba(58, 188, 150, 0.1)",o.currentTarget.style.borderColor="rgba(58, 188, 150, 0.3)"},children:[e.jsx("span",{style:{fontSize:16},children:"ðŸ“"}),"Voice Macros"]})}),e.jsxs("div",{style:{width:"100%",marginTop:10},children:[e.jsx("div",{style:{fontSize:12,color:"#aaa",marginBottom:8,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif"},children:"Study Type"}),e.jsxs("div",{style:{position:"relative"},children:[e.jsx("input",{value:ke||M,onChange:o=>{const d=o.target.value;Oe(d),Me(!0),G&&G[d]&&(xe(d),ge([]),me(""))},onFocus:()=>{Me(!0),Oe("")},onBlur:o=>{setTimeout(()=>{Me(!1),Oe("")},200)},placeholder:"Select or search study type...",style:{width:"100%",padding:"10px 12px",backgroundColor:"rgba(42, 45, 49, 0.95)",color:ke||M?"#fff":"#999",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:8,fontSize:13,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",outline:"none",cursor:"text"}}),Wt&&G&&e.jsx("div",{style:{position:"absolute",top:"100%",left:0,right:0,marginTop:4,maxHeight:200,overflowY:"auto",backgroundColor:"rgba(42, 45, 49, 0.98)",border:"1px solid rgba(255, 255, 255, 0.2)",borderRadius:8,backdropFilter:"blur(20px)",WebkitBackdropFilter:"blur(20px)",boxShadow:"0 8px 24px rgba(0, 0, 0, 0.4)",zIndex:100},children:(()=>{const o=Object.keys(G).filter(x=>!ke||x.toLowerCase().includes(ke.toLowerCase())),d=o.filter(x=>tt.has(x)).sort(),u=o.filter(x=>!tt.has(x)).sort();return[...d,...u].map(x=>{const w=tt.has(x);return e.jsxs("div",{style:{display:"flex",alignItems:"center",padding:"8px 12px",color:x===M?"#3ABC96":"#fff",backgroundColor:x===M?"rgba(58, 188, 150, 0.1)":"transparent",fontSize:12,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:"pointer",transition:"background-color 0.2s ease"},onMouseEnter:S=>{x!==M&&(S.currentTarget.style.backgroundColor="rgba(255, 255, 255, 0.05)")},onMouseLeave:S=>{x!==M&&(S.currentTarget.style.backgroundColor="transparent")},children:[e.jsx("div",{onClick:()=>{xe(x),Me(!1),Oe("")},style:{flex:1,display:"flex",alignItems:"center"},children:x}),e.jsx("div",{onClick:S=>{S.stopPropagation(),Gt(x)},style:{marginLeft:8,color:w?"#FFD700":"#666",cursor:"pointer",fontSize:14,transition:"color 0.2s ease"},children:w?"â˜…":"â˜†"})]},x)})})()})]})]}),M&&G&&G[M]&&e.jsxs("div",{style:{width:"100%",marginTop:16,flex:1,display:"flex",flexDirection:"column",minHeight:0},children:[e.jsx("div",{style:{fontSize:12,color:"#aaa",marginBottom:8,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",flexShrink:0},children:"Template Preview"}),e.jsx("div",{style:{flex:1,overflowY:"auto",backgroundColor:"rgba(42, 45, 49, 0.95)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:8,padding:12,fontSize:11,fontFamily:"JetBrains Mono, Monaco, Cascadia Code, Roboto Mono, Consolas, Courier New, monospace",color:"#ccc",lineHeight:1.4,whiteSpace:"pre-wrap",minHeight:0},children:G[M].template})]})]}),e.jsxs("div",{style:{width:"74.5%",padding:"20px",display:"flex",flexDirection:"column",gap:20},children:[e.jsx("div",{style:{height:"85%",position:"relative"},children:e.jsx("div",{style:{height:"100%",background:"rgba(42, 45, 49, 0.95)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:16,overflow:"hidden"},children:e.jsxs("div",{style:{position:"relative",height:"100%"},children:[e.jsx(Mt,{ref:c,value:n,onChange:Xt,placeholder:"Enter findings here...",style:{width:"100%",height:"100%",backgroundColor:"transparent",color:"#fff",border:"none",fontSize:14,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif"}}),q&&(q.showDiff&&q.diffParts||q.type==="impression")&&e.jsxs("div",{style:{position:"absolute",top:"8px",right:"8px",display:"flex",gap:"6px",zIndex:10},children:[e.jsx("button",{onClick:()=>{var x;const o=((x=c.current)==null?void 0:x.getValue())||n,d=document.createElement("div");d.innerHTML=o.replace(/<br\s*\/?>/gi,`
`).replace(/<\/p>/gi,`

`).replace(/<\/div>/gi,`
`);const u=d.textContent||d.innerText||"";navigator.clipboard.writeText(u)},style:{background:"rgba(58, 188, 150, 0.2)",border:"1px solid rgba(58, 188, 150, 0.3)",borderRadius:"6px",color:"#3ABC96",cursor:"pointer",padding:"4px 8px",fontSize:"11px",fontWeight:500},children:"ðŸ“‹ Copy"}),e.jsx("button",{onClick:()=>Tt(!0),style:{background:"rgba(59, 130, 246, 0.2)",border:"1px solid rgba(59, 130, 246, 0.3)",borderRadius:"6px",color:"#3B82F6",cursor:"pointer",padding:"4px 8px",fontSize:"11px",fontWeight:500},children:"ðŸ’¬ Ask AI"}),q.showDiff&&q.diffParts&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{var u,x;if(!q)return;let o="";(u=q.diffParts)==null||u.forEach(w=>{if(!w.removed){let S=w.value.replace(/\b(FINDINGS?:)/gi,"<strong>$1</strong>").replace(/\b(IMPRESSION:)/gi,"<strong>$1</strong>").replace(/\b(LEFT|RIGHT)\b/g,"<strong>$1</strong>").replace(/\n/g,"<br>");w.added?o+=`<span style="background-color: rgba(58, 188, 150, 0.3); color: #3ABC96; padding: 1px 2px; border-radius: 2px;">${S}</span>`:o+=S}}),f(o),c.current&&c.current.setValue(o);const d=((x=q.diffParts)==null?void 0:x.filter(w=>!w.removed))||[];Ce({...q,diffParts:d})},style:{background:"rgba(227, 103, 86, 0.2)",border:"1px solid rgba(227, 103, 86, 0.3)",borderRadius:"6px",color:"#E36756",cursor:"pointer",padding:"4px 8px",fontSize:"11px",fontWeight:500},children:"âœ‚ Remove Strikeout"}),e.jsx("button",{onClick:()=>{var u;const d=(((u=q.diffParts)==null?void 0:u.filter(x=>!x.removed).map(x=>x.value).join("").trim())||"").replace(/\b(FINDINGS?:)/gi,"<strong>$1</strong>").replace(/\b(IMPRESSION:)/gi,"<strong>$1</strong>").replace(/\b(LEFT|RIGHT)\b/g,"<strong>$1</strong>").replace(/\n/g,"<br>");f(d),Ce(null),setTimeout(()=>{c.current&&c.current.setValue(d)},0)},style:{background:"rgba(58, 188, 150, 0.2)",border:"1px solid rgba(58, 188, 150, 0.3)",borderRadius:"6px",color:"#3ABC96",cursor:"pointer",padding:"4px 8px",fontSize:"11px",fontWeight:500,marginLeft:"8px"},children:"âœ“ Accept Clean"})]})]})]})})}),e.jsxs("div",{style:{height:"12%",minHeight:"80px",background:"rgba(42, 45, 49, 0.95)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:16,padding:"12px 16px",overflowY:"auto",display:"flex",flexDirection:"column",gap:8},children:[(De||Q||q)&&e.jsx("div",{style:{marginBottom:"12px",padding:"8px",backgroundColor:De||Q?"rgba(88, 166, 255, 0.1)":"rgba(58, 188, 150, 0.1)",border:De||Q?"1px solid rgba(88, 166, 255, 0.2)":"1px solid rgba(58, 188, 150, 0.2)",borderRadius:"8px",fontSize:"12px",color:De||Q?"#58A6FF":"#3ABC96",textAlign:"center",fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif"},children:De?"ðŸ”„ Generating Report...":Q?"ðŸ’­ Generating Impression...":q?`âœ… ${q.type==="report"?"Report":"Impression"} Generated${q.tokens?` â€¢ ${q.tokens.input}â†’${q.tokens.output} tokens â€¢ ${q.generationTime}s`:""}`:"âš¡ Ready"}),dt.length>0&&e.jsxs("div",{style:{padding:"8px 12px",backgroundColor:"rgba(95, 51, 255, 0.1)",border:"1px solid rgba(95, 51, 255, 0.3)",borderRadius:"8px",fontSize:"12px",color:"#7C5AFF",fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:dt.length>1?"8px":0},children:[e.jsx("span",{children:"ðŸŽ¯ Suggested Study Types:"}),e.jsx("button",{onClick:()=>{me(""),ge([])},style:{background:"transparent",border:"none",color:"#7C5AFF",fontSize:"14px",cursor:"pointer",padding:"0 4px"},children:"Ã—"})]}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"4px"},children:dt.slice(0,3).map((o,d)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"4px 8px",background:d===0?"rgba(95, 51, 255, 0.15)":"rgba(95, 51, 255, 0.08)",borderRadius:"4px",border:d===0?"1px solid rgba(95, 51, 255, 0.3)":"1px solid rgba(95, 51, 255, 0.15)"},children:[e.jsxs("span",{style:{flex:1},children:[e.jsxs("strong",{children:[d+1,". ",o.type]}),e.jsxs("span",{style:{opacity:.7,marginLeft:"8px",fontSize:"11px"},children:["(",o.confidence,"% match)"]})]}),e.jsx("button",{onClick:()=>{xe(o.type),me(""),ge([])},style:{background:"rgba(95, 51, 255, 0.2)",border:"1px solid rgba(95, 51, 255, 0.4)",borderRadius:"4px",color:"#7C5AFF",padding:"2px 6px",fontSize:"10px",cursor:"pointer",fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif"},children:"Apply"})]},o.type))})]}),Le&&e.jsx("div",{style:{padding:"8px",backgroundColor:"rgba(58, 188, 150, 0.1)",border:"1px solid rgba(58, 188, 150, 0.2)",borderRadius:"8px",fontSize:"12px",color:"#3ABC96",fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif"},children:Le})]})]})]}),e.jsxs("div",{style:{display:"none"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",paddingLeft:"7.5%",paddingRight:"7.5%",width:"90%",margin:"0 auto",marginTop:60,marginBottom:15},children:[e.jsx("div",{style:{display:"flex",alignItems:"center",gap:10}}),e.jsx("div",{style:{width:"100%"},children:e.jsxs(ye,{style:{display:"flex",flexDirection:"column",padding:8,position:"relative",width:"100%",gap:6},children:[e.jsxs("div",{style:{fontSize:12,color:"#aaa",textAlign:"center",fontWeight:300,textShadow:"none",userSelect:"none",fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif"},children:["Daily tokens: ",((en=H==null?void 0:H.used)==null?void 0:en.toLocaleString())||0," / ",j===4?"Unlimited":((tn=H==null?void 0:H.limit)==null?void 0:tn.toLocaleString())||125e3]}),e.jsx("div",{style:{width:"100%",height:s<600?8:s<800?10:12,backgroundColor:"rgba(20, 22, 25, 0.8)",borderRadius:(s<600?8:s<800?10:12)/2,border:"1px solid rgba(255, 255, 255, 0.15)",overflow:"hidden",position:"relative",boxShadow:"inset 0 2px 4px rgba(0, 0, 0, 0.4), 0 1px 2px rgba(0, 0, 0, 0.2)"},children:e.jsx("div",{style:{width:`${Math.min((H==null?void 0:H.percentage)||0,100)}%`,height:"100%",backgroundColor:((H==null?void 0:H.percentage)||0)>90?"#E36756":((H==null?void 0:H.percentage)||0)>75?"#E1865D":"#3ABC96",transition:"all 0.3s ease",borderRadius:`${(s<600?8:s<800?10:12)/2}px 0 0 ${(s<600?8:s<800?10:12)/2}px`,boxShadow:"0 0 12px rgba(58, 188, 150, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2)"}})})]})})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",paddingLeft:"7.5%",paddingRight:"7.5%",width:"90%",margin:"0 auto",marginBottom:10},children:[e.jsx("div",{style:{display:"flex",alignItems:"center",gap:10,WebkitAppRegion:"no-drag",zIndex:1,position:"relative"}}),e.jsx("div",{style:{display:"flex",alignItems:"center",gap:10},children:e.jsxs(ye,{style:{display:"flex",padding:2},children:[e.jsx("button",{onClick:()=>be("openai"),style:{padding:"6px 12px",backgroundColor:L==="openai"?"#5F33FF":"transparent",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.1)",boxShadow:L==="openai"?"0 4px 12px rgba(95, 51, 255, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15)":"0 2px 6px rgba(0, 0, 0, 0.1)",...L==="openai"?{background:"linear-gradient(135deg, #5F33FF 0%, #4a28cc 100%)",color:"#fff",textShadow:"none"}:{background:"linear-gradient(to bottom, #ffffff, #999999, #333333)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",textShadow:"none"},borderRadius:16,fontSize:14,fontWeight:300,transition:"all 0.2s ease"},children:"GPT-4o"}),e.jsx("button",{onClick:()=>be("gpt-5"),title:Z("gpt-5")?"GPT-5":`Requires ${Se(ve["gpt-5"])} subscription`,style:{padding:"6px 12px",backgroundColor:L==="gpt-5"?"#5F33FF":"transparent",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.1)",boxShadow:L==="gpt-5"?"0 4px 12px rgba(95, 51, 255, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15)":"0 2px 6px rgba(0, 0, 0, 0.1)",...L==="gpt-5"?{background:"linear-gradient(135deg, #5F33FF 0%, #4a28cc 100%)",color:"#fff",textShadow:"none"}:{background:"linear-gradient(to bottom, #ffffff, #999999, #333333)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",textShadow:"none"},borderRadius:16,fontSize:14,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",transition:"all 0.2s ease"},children:"GPT-5"}),e.jsx("button",{onClick:()=>be("gemini"),style:{padding:"6px 12px",backgroundColor:L==="gemini"?"#5F33FF":"transparent",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.1)",boxShadow:L==="gemini"?"0 4px 12px rgba(95, 51, 255, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15)":"0 2px 6px rgba(0, 0, 0, 0.1)",...L==="gemini"?{background:"linear-gradient(135deg, #5F33FF 0%, #4a28cc 100%)",color:"#fff",textShadow:"none"}:{background:"linear-gradient(to bottom, #ffffff, #999999, #333333)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",textShadow:"none"},borderRadius:16,fontSize:14,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",transition:"all 0.2s ease"},children:"Gemini 2.5 Flash"}),e.jsx("button",{onClick:()=>be("claude-sonnet"),title:Z("claude-sonnet")?"Claude 4 Sonnet":`Requires ${Se(ve["claude-sonnet"])} subscription`,style:{padding:"6px 12px",backgroundColor:L==="claude-sonnet"?"#5F33FF":"transparent",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.1)",boxShadow:L==="claude-sonnet"?"0 4px 12px rgba(95, 51, 255, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15)":"0 2px 6px rgba(0, 0, 0, 0.1)",...L==="claude-sonnet"?{background:"linear-gradient(135deg, #5F33FF 0%, #4a28cc 100%)",color:"#fff",textShadow:"none"}:{background:"linear-gradient(to bottom, #ffffff, #999999, #333333)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",textShadow:"none"},borderRadius:16,fontSize:14,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",transition:"all 0.2s ease"},children:"Claude 4 Sonnet"}),e.jsx("button",{onClick:()=>be("claude-opus"),title:Z("claude-opus")?"Claude 4 Opus":`Requires ${Se(ve["claude-opus"])} subscription`,style:{padding:"6px 12px",backgroundColor:L==="claude-opus"?"#5F33FF":"transparent",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.1)",boxShadow:L==="claude-opus"?"0 4px 12px rgba(95, 51, 255, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15)":"0 2px 6px rgba(0, 0, 0, 0.1)",...L==="claude-opus"?{background:"linear-gradient(135deg, #5F33FF 0%, #4a28cc 100%)",color:"#fff",textShadow:"none"}:{background:"linear-gradient(to bottom, #ffffff, #999999, #333333)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",textShadow:"none"},borderRadius:16,fontSize:14,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",transition:"all 0.2s ease"},children:"Claude 4 Opus"}),e.jsx("button",{onClick:()=>be("claude-opus-4.1"),title:Z("claude-opus-4.1")?"Claude 4.1 Opus":`Requires ${Se(ve["claude-opus-4.1"])} subscription`,style:{padding:"6px 12px",backgroundColor:L==="claude-opus-4.1"?"#5F33FF":"transparent",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.1)",boxShadow:L==="claude-opus-4.1"?"0 4px 12px rgba(95, 51, 255, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15)":"0 2px 6px rgba(0, 0, 0, 0.1)",...L==="claude-opus-4.1"?{background:"linear-gradient(135deg, #5F33FF 0%, #4a28cc 100%)",color:"#fff",textShadow:"none"}:{background:"linear-gradient(to bottom, #ffffff, #999999, #333333)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",textShadow:"none"},borderRadius:16,fontSize:14,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",transition:"all 0.2s ease"},children:"Claude 4.1 Opus"}),e.jsx("button",{onClick:()=>be("kimi"),style:{padding:"6px 12px",backgroundColor:L==="kimi"?"#5F33FF":"transparent",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.1)",boxShadow:L==="kimi"?"0 4px 12px rgba(95, 51, 255, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15)":"0 2px 6px rgba(0, 0, 0, 0.1)",...L==="kimi"?{background:"linear-gradient(135deg, #5F33FF 0%, #4a28cc 100%)",color:"#fff",textShadow:"none"}:{background:"linear-gradient(to bottom, #ffffff, #999999, #333333)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",textShadow:"none"},borderRadius:16,fontSize:14,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",transition:"all 0.2s ease"},children:"Kimi v2"}),e.jsx("button",{onClick:()=>be("mistral-local"),title:Z("mistral-local")?"Mistral (Local)":`Requires ${Se(ve["mistral-local"])} subscription`,style:{padding:"6px 12px",backgroundColor:L==="mistral-local"?"#FF6B35":"transparent",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.1)",boxShadow:L==="mistral-local"?"0 4px 12px rgba(255, 107, 53, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15)":"0 2px 6px rgba(0, 0, 0, 0.1)",...L==="mistral-local"?{background:"linear-gradient(135deg, #FF6B35 0%, #cc5529 100%)",color:"#fff",textShadow:"none"}:{background:"linear-gradient(to bottom, #ffffff, #999999, #333333)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",textShadow:"none"},borderRadius:16,fontSize:14,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",transition:"all 0.2s ease"},children:e.jsxs("span",{style:{display:"flex",alignItems:"center",gap:6},children:["Mistral (Local)",L==="mistral-local"&&e.jsxs(e.Fragment,{children:[e.jsx("span",{style:{width:8,height:8,borderRadius:"50%",backgroundColor:Ie.running?"#4CAF50":"#f44336",display:"inline-block",animation:Ie.running?void 0:"pulse 1.5s infinite"},title:Ie.running?"Server running":Ie.error||"Server not running"}),Ie.modelMissing&&e.jsx("button",{onClick:async o=>{if(o.stopPropagation(),window.confirm(`Download Mistral model?

Size: 4.07 GB
This will download the model to enable local AI generation.

Continue?`)){console.log("Starting model download...");const u=await window.electronAPI.invoke("download-mistral-model");alert(u?"Model downloaded successfully! Local AI is now ready.":"Download failed. Please check your internet connection.")}},style:{marginLeft:4,padding:"2px 8px",fontSize:11,backgroundColor:"#ff9800",color:"white",border:"none",borderRadius:3,cursor:"pointer"},children:"Download Model (4GB)"}),L==="mistral-local"&&!X&&!h.installing&&e.jsx("button",{onClick:async o=>{o.stopPropagation(),window.confirm(`Enable GPU Acceleration for Offline AI?

Downloads CUDA binaries (~30MB) to accelerate local Mistral generation.
Makes offline AI 10x faster with NVIDIA GPU.

Continue?`)&&(console.log("Starting CUDA binary installation..."),await window.electronAPI.installCudaBinary()?(A(!0),alert("GPU acceleration installed! Offline AI will now use your GPU for faster generation.")):alert("Installation failed. Please check the console for details."))},style:{marginLeft:4,padding:"2px 8px",fontSize:11,backgroundColor:"#4CAF50",color:"white",border:"none",borderRadius:3,cursor:"pointer"},title:"Enable GPU acceleration for 10x faster generation",children:"ðŸš€ Enable GPU"})]})]})})]})}),e.jsx("div",{style:{display:"flex",justifyContent:"center",marginTop:12,marginBottom:12},children:e.jsxs("button",{onClick:()=>ne(!0),style:{padding:"8px 16px",backgroundColor:"rgba(58, 188, 150, 0.1)",border:"1px solid rgba(58, 188, 150, 0.3)",borderRadius:16,color:"#3ABC96",fontSize:14,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:"pointer",transition:"all 0.2s ease",display:"flex",alignItems:"center",gap:8,backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)"},onMouseEnter:o=>{o.currentTarget.style.backgroundColor="rgba(58, 188, 150, 0.2)",o.currentTarget.style.borderColor="rgba(58, 188, 150, 0.5)"},onMouseLeave:o=>{o.currentTarget.style.backgroundColor="rgba(58, 188, 150, 0.1)",o.currentTarget.style.borderColor="rgba(58, 188, 150, 0.3)"},children:[e.jsx("span",{style:{fontSize:16},children:"ðŸ“"}),"Voice Macros"]})}),e.jsx("div",{style:{display:"flex",justifyContent:"center",gap:8,marginTop:0},children:e.jsx("button",{onClick:()=>{xe(""),c.current&&c.current.setValue(""),f(""),ge([]),me(""),Ce(null)},style:{padding:"6px 12px",backgroundColor:!M&&!n?"transparent":"rgba(227, 103, 86, 0.1)",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.1)",boxShadow:!M&&!n?"0 2px 6px rgba(0, 0, 0, 0.1)":"0 4px 12px rgba(227, 103, 86, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.15)",borderRadius:16,fontSize:14,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",transition:"all 0.2s ease",color:!M&&!n?"#666":"#E36756",cursor:!M&&!n?"not-allowed":"pointer",opacity:!M&&!n?.4:1},onMouseEnter:o=>{(M||n)&&(o.currentTarget.style.backgroundColor="rgba(227, 103, 86, 0.2)",o.currentTarget.style.boxShadow="0 4px 12px rgba(227, 103, 86, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15)")},onMouseLeave:o=>{(M||n)&&(o.currentTarget.style.backgroundColor="rgba(227, 103, 86, 0.1)",o.currentTarget.style.boxShadow="0 4px 12px rgba(227, 103, 86, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.15)")},disabled:!M&&!n,title:"Clear both study type and findings",children:"Clear All"})})]}),e.jsxs("div",{style:{position:"relative",width:"90%",margin:"0 auto 20px auto",opacity:1,maxHeight:100,overflow:"visible",transition:"all 0.3s ease",pointerEvents:"auto"},children:[e.jsx("input",{value:ke||M,onChange:o=>{const d=o.target.value;Oe(d),Me(!0),G&&G[d]&&(xe(d),ge([]),me(""))},onFocus:()=>{Me(!0),Oe("")},onBlur:o=>{setTimeout(()=>{Me(!1),Oe("")},200)},placeholder:"Select or search study type...",style:{width:"100%",padding:"12px 70px 12px 16px",backgroundColor:"rgba(42, 45, 49, 0.95)",color:ke||M?"#fff":"#999",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:12,fontSize:14,fontFamily:"DM Sans, sans-serif",outline:"none",cursor:"text",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)"}}),Wt&&G&&e.jsxs("div",{style:{position:"absolute",top:"100%",left:0,right:0,marginTop:4,maxHeight:300,overflowY:"auto",backgroundColor:"rgba(42, 45, 49, 0.98)",border:"1px solid rgba(255, 255, 255, 0.2)",borderRadius:8,backdropFilter:"blur(20px)",WebkitBackdropFilter:"blur(20px)",boxShadow:"0 8px 24px rgba(0, 0, 0, 0.4)",zIndex:100},children:[(()=>{const o=Object.keys(G).filter(w=>!ke||w.toLowerCase().includes(ke.toLowerCase())),d=o.filter(w=>tt.has(w)).sort(),u=o.filter(w=>!tt.has(w)).sort(),x=[...d,...u];return e.jsxs(e.Fragment,{children:[d.length>0&&!ke&&e.jsx("div",{style:{padding:"6px 16px",color:"#FFA500",fontSize:12,fontWeight:600,borderBottom:"1px solid rgba(255, 165, 0, 0.2)",backgroundColor:"rgba(255, 165, 0, 0.05)"},children:"â˜… FAVORITES"}),x.map((w,S)=>{const N=tt.has(w),P=!ke&&N&&S===d.length-1&&u.length>0;return e.jsxs(jt.Fragment,{children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",padding:"10px 16px",color:w===M?"#3ABC96":"#fff",backgroundColor:w===M?"rgba(58, 188, 150, 0.1)":"transparent",fontSize:14,fontFamily:"DM Sans, sans-serif",transition:"background-color 0.2s ease",borderBottom:"1px solid rgba(255, 255, 255, 0.05)",cursor:"pointer"},onMouseEnter:O=>{w!==M&&(O.currentTarget.style.backgroundColor="rgba(255, 255, 255, 0.05)")},onMouseLeave:O=>{w!==M&&(O.currentTarget.style.backgroundColor="transparent")},children:[e.jsx("button",{onClick:O=>{O.stopPropagation(),Gt(w)},style:{background:"none",border:"none",color:N?"#FFA500":"#666",fontSize:16,cursor:"pointer",padding:"0 8px 0 0",transition:"color 0.2s ease",display:"flex",alignItems:"center"},onMouseEnter:O=>{O.currentTarget.style.color=N?"#FFB833":"#FFA500"},onMouseLeave:O=>{O.currentTarget.style.color=N?"#FFA500":"#666"},title:N?"Remove from favorites":"Add to favorites",children:N?"â˜…":"â˜†"}),e.jsxs("div",{style:{flex:1},onClick:()=>{xe(w),Oe(""),Me(!1),ge([]),me(""),y.current=Date.now()},children:[w,w===M&&e.jsx("span",{style:{marginLeft:8,color:"#3ABC96"},children:"âœ“"})]})]}),P&&e.jsx("div",{style:{padding:"6px 16px",color:"#999",fontSize:12,fontWeight:600,borderBottom:"1px solid rgba(255, 255, 255, 0.1)",backgroundColor:"rgba(255, 255, 255, 0.02)"},children:"ALL STUDY TYPES"})]},w)})]})})(),Object.keys(G).filter(o=>!ke||o.toLowerCase().includes(ke.toLowerCase())).length===0&&e.jsx("div",{style:{padding:"12px 16px",color:"#999",fontSize:14,fontStyle:"italic",textAlign:"center"},children:"No matching study types"})]}),M&&G[M]&&e.jsx("button",{onClick:()=>{var d,u;const o=G[M];(u=(d=window.electron)==null?void 0:d.ipcRenderer)==null||u.invoke("open-template-viewer",{studyType:M,template:o.template||""})},style:{position:"absolute",top:"50%",right:40,transform:"translateY(-50%)",background:"none",border:"none",color:"#3ABC96",fontSize:18,cursor:"pointer",padding:"4px 8px",lineHeight:1,transition:"all 0.2s ease",zIndex:2},onMouseEnter:o=>{o.currentTarget.style.color="#4ACC96",o.currentTarget.style.transform="translateY(-50%) scale(1.1)"},onMouseLeave:o=>{o.currentTarget.style.color="#3ABC96",o.currentTarget.style.transform="translateY(-50%) scale(1)"},title:"View Template","aria-label":"View template for selected study type",children:"ðŸ“„"}),M&&e.jsx("button",{onClick:()=>{xe(""),Oe(""),Me(!1),ge([]),me("")},style:{position:"absolute",top:"50%",right:12,transform:"translateY(-50%)",background:"none",border:"none",color:"#999",fontSize:20,fontWeight:300,cursor:"pointer",padding:"4px 8px",lineHeight:1,transition:"color 0.2s ease",zIndex:2},onMouseEnter:o=>{o.currentTarget.style.color="#fff"},onMouseLeave:o=>{o.currentTarget.style.color="#999"},className:r.clearButton,"aria-label":"Clear study type",children:"Ã—"})]}),e.jsx("div",{style:{maxHeight:500,opacity:1,overflow:"visible",transition:"all 0.3s ease",marginBottom:20,pointerEvents:"auto",width:"90%",margin:"0 auto"},children:e.jsxs("div",{style:{position:"relative",background:"rgba(42, 45, 49, 0.95)",backdropFilter:"none",WebkitBackdropFilter:"none",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:16,overflow:"hidden"},children:[(dt.length>0||zt)&&!M&&e.jsx("div",{style:{position:"absolute",top:10,right:10,maxWidth:300,background:"rgba(58, 188, 150, 0.1)",border:"1px solid rgba(58, 188, 150, 0.3)",borderRadius:8,padding:"8px 12px",color:"#3ABC96",fontSize:12,fontWeight:500,backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",zIndex:10},children:zt?e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("div",{style:{width:12,height:12,border:"2px solid rgba(58, 188, 150, 0.3)",borderTop:"2px solid #3ABC96",borderRadius:"50%"},className:r.spin}),"Analyzing findings..."]}):e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"6px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"4px"},children:[e.jsx("span",{children:"ðŸ¤– AI Suggestions:"}),e.jsx("button",{onClick:()=>{ge([]),me("")},style:{background:"transparent",border:"none",color:"rgba(58, 188, 150, 0.7)",fontSize:10,cursor:"pointer",padding:"2px"},children:"Ã—"})]}),dt.map((o,d)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"4px 6px",background:d===0?"rgba(58, 188, 150, 0.15)":"rgba(58, 188, 150, 0.05)",borderRadius:"4px",fontSize:"11px"},children:[e.jsxs("span",{style:{flex:1},children:[e.jsx("strong",{children:o.type}),e.jsxs("span",{style:{opacity:.7,marginLeft:"6px"},children:["(",o.confidence,"%)"]})]}),e.jsx("button",{onClick:()=>{xe(o.type),ge([]),me("")},style:{background:"rgba(58, 188, 150, 0.2)",border:"1px solid rgba(58, 188, 150, 0.3)",borderRadius:3,color:"#3ABC96",fontSize:9,padding:"2px 5px",cursor:"pointer",marginLeft:"8px"},children:"Use"})]},o.type))]})}),e.jsx(Mt,{ref:c,value:n,onChange:Xt,style:{width:"100%",height:"40vh",minHeight:200,maxHeight:"50vh",padding:"16px 40px 16px 16px",backgroundColor:"transparent",color:"#fff",border:"none",borderRadius:16,fontSize:14,fontFamily:"DM Sans, sans-serif"},placeholder:"Enter findings here..."}),e.jsx("button",{onMouseDown:o=>o.preventDefault(),onPointerDown:o=>o.preventDefault(),onClick:Ue,style:{position:"absolute",top:n?54:16,right:16,background:C?"rgba(227, 103, 86, 0.2)":"rgba(58, 188, 150, 0.1)",backdropFilter:"blur(6px)",WebkitBackdropFilter:"blur(6px)",color:C?"#E36756":"#3ABC96",border:`1px solid ${C?"rgba(227, 103, 86, 0.3)":"rgba(58, 188, 150, 0.2)"}`,borderRadius:"50%",width:32,height:32,fontSize:16,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",display:"flex",alignItems:"center",justifyContent:"center",lineHeight:1,transition:"all 0.2s ease",cursor:"pointer",boxShadow:C?"0 2px 6px rgba(227, 103, 86, 0.3), 0 0 10px rgba(227, 103, 86, 0.2)":"0 1px 3px rgba(58, 188, 150, 0.2)",animation:C?"pulse 1.5s infinite":"none"},onMouseEnter:o=>{C?(o.currentTarget.style.background="rgba(227, 103, 86, 0.3)",o.currentTarget.style.borderColor="rgba(227, 103, 86, 0.4)",o.currentTarget.style.boxShadow="0 3px 8px rgba(227, 103, 86, 0.4), 0 0 15px rgba(227, 103, 86, 0.3)"):(o.currentTarget.style.background="rgba(58, 188, 150, 0.2)",o.currentTarget.style.borderColor="rgba(58, 188, 150, 0.3)",o.currentTarget.style.boxShadow="0 2px 6px rgba(58, 188, 150, 0.3)"),o.currentTarget.style.transform="scale(1.1)"},onMouseLeave:o=>{o.currentTarget.style.background=C?"rgba(227, 103, 86, 0.2)":"rgba(58, 188, 150, 0.1)",o.currentTarget.style.borderColor=C?"rgba(227, 103, 86, 0.3)":"rgba(58, 188, 150, 0.2)",o.currentTarget.style.transform="scale(1)",o.currentTarget.style.boxShadow=C?"0 2px 6px rgba(227, 103, 86, 0.3), 0 0 10px rgba(227, 103, 86, 0.2)":"0 1px 3px rgba(58, 188, 150, 0.2)"},"aria-label":C?"Stop dictation":"Start dictation",title:C?"Stop dictation":"Start dictation",children:"ðŸŽ™ï¸"}),n&&e.jsx("button",{onClick:()=>{c.current&&c.current.setValue(""),f(""),Ce(null)},style:{position:"absolute",top:16,right:16,background:"transparent",color:"#E36756",border:"none",fontSize:14,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",padding:0,lineHeight:1,transition:"transform 0.2s ease"},className:r.clearButton,"aria-label":"Clear findings",children:"Ã—"})]})}),I&&e.jsxs("div",{style:{padding:"8px 12px",margin:"8px 0",backgroundColor:"rgba(227, 103, 86, 0.1)",border:"1px solid rgba(227, 103, 86, 0.3)",borderRadius:"8px",color:"#E36756",fontSize:"12px",fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",textAlign:"center"},children:["âš ï¸ ",I,e.jsx("button",{onClick:()=>b(null),style:{marginLeft:"8px",background:"none",border:"none",color:"#E36756",fontSize:"12px",padding:0},children:"âœ•"})]}),st&&e.jsxs("div",{style:{padding:"8px 12px",margin:"8px 0",backgroundColor:"rgba(227, 103, 86, 0.1)",border:"1px solid rgba(227, 103, 86, 0.3)",borderRadius:"8px",color:"#E36756",fontSize:"12px",fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",textAlign:"center"},children:["ðŸ§  ",st,e.jsx("button",{onClick:()=>Te(null),style:{marginLeft:"8px",background:"none",border:"none",color:"#E36756",cursor:"pointer",fontSize:"12px",padding:"2px 4px",borderRadius:"4px"},children:"âœ•"})]}),kt&&e.jsx("div",{style:{padding:"8px 12px",margin:"8px 0",backgroundColor:"rgba(95, 51, 255, 0.1)",border:"1px solid rgba(95, 51, 255, 0.3)",borderRadius:"8px",color:"#7C5AFF",fontSize:"12px",fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",textAlign:"center",animation:"pulse 1.5s infinite"},children:"ðŸ§  Auto-cleaning up text..."}),q&&(q.type==="report"||q.type==="impression")&&e.jsxs("div",{style:{display:"flex",gap:"8px",marginBottom:"16px",justifyContent:"center",flexWrap:"wrap"},children:[e.jsx(ye,{children:e.jsx("button",{onClick:()=>{var x;const o=((x=c.current)==null?void 0:x.getValue())||n,d=document.createElement("div");d.innerHTML=o.replace(/<br\s*\/?>/gi,`
`).replace(/<\/p>/gi,`

`).replace(/<\/div>/gi,`
`);const u=d.textContent||d.innerText||"";navigator.clipboard.writeText(u)},style:{background:"rgba(58, 188, 150, 0.2)",border:"1px solid rgba(58, 188, 150, 0.3)",borderRadius:"8px",color:"#3ABC96",cursor:"pointer",padding:"8px 16px",fontSize:"12px",fontWeight:500},children:"â†— Copy to Clipboard"})}),e.jsx(ye,{children:e.jsx("button",{onClick:()=>Tt(!0),style:{background:"rgba(59, 130, 246, 0.2)",border:"1px solid rgba(59, 130, 246, 0.3)",borderRadius:"8px",color:"#3B82F6",cursor:"pointer",padding:"8px 16px",fontSize:"12px",fontWeight:500},children:"ðŸ’¬ Ask AI"})}),q&&q.showDiff&&q.diffParts&&e.jsxs(ye,{children:[e.jsx("button",{onClick:()=>{var u,x;if(!q){console.log("âŒ No generation result for strikeout removal");return}let o="";(u=q.diffParts)==null||u.forEach(w=>{if(!w.removed){let S=w.value.replace(/\b(FINDINGS?:)/gi,"<strong>$1</strong>").replace(/\b(IMPRESSION:)/gi,"<strong>$1</strong>").replace(/\b(LEFT|RIGHT)\b/g,"<strong>$1</strong>").replace(/\n/g,"<br>");w.added?o+=`<span style="background-color: rgba(58, 188, 150, 0.3); color: #3ABC96; padding: 1px 2px; border-radius: 2px;">${S}</span>`:o+=S}}),f(o),c.current&&c.current.setValue(o);const d=((x=q.diffParts)==null?void 0:x.filter(w=>!w.removed))||[];Ce({...q,diffParts:d})},style:{background:"rgba(227, 103, 86, 0.2)",border:"1px solid rgba(227, 103, 86, 0.3)",borderRadius:"8px",color:"#E36756",cursor:"pointer",padding:"8px 16px",fontSize:"12px",fontWeight:500},children:"âœ‚ Remove Strikeout"}),e.jsx("button",{onClick:()=>{var u;const d=(((u=q.diffParts)==null?void 0:u.filter(x=>!x.removed).map(x=>x.value).join("").trim())||"").replace(/\b(FINDINGS?:)/gi,"<strong>$1</strong>").replace(/\b(IMPRESSION:)/gi,"<strong>$1</strong>").replace(/\b(LEFT|RIGHT)\b/g,"<strong>$1</strong>").replace(/\n/g,"<br>");f(d),Ce(null),setTimeout(()=>{c.current&&c.current.setValue(d)},0)},style:{background:"rgba(58, 188, 150, 0.2)",border:"1px solid rgba(58, 188, 150, 0.3)",borderRadius:"8px",color:"#3ABC96",cursor:"pointer",padding:"8px 16px",fontSize:"12px",fontWeight:500,marginLeft:"8px"},children:"âœ“ Accept Clean"})]})]}),e.jsx("div",{style:{marginBottom:"16px",padding:"12px",backgroundColor:De||Q?"rgba(88, 166, 255, 0.1)":q?"rgba(58, 188, 150, 0.1)":"rgba(255, 255, 255, 0.05)",border:De||Q?"1px solid rgba(88, 166, 255, 0.2)":q?"1px solid rgba(58, 188, 150, 0.2)":"1px solid rgba(255, 255, 255, 0.1)",borderRadius:"8px",fontSize:"12px",color:De||Q?"#58A6FF":q?"#3ABC96":"#999",textAlign:"center",fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",transition:"all 0.3s ease"},children:De?e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:"4px"},children:e.jsx("strong",{children:"ðŸ”„ Generating Report..."})}),e.jsx("div",{style:{opacity:.8},children:"Processing findings with AI logic"})]}):Q?e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:"4px"},children:e.jsx("strong",{children:"ðŸ’­ Generating Impression..."})}),e.jsx("div",{style:{opacity:.8},children:"Creating clinical impression"})]}):q?e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:"4px"},children:e.jsxs("strong",{children:[q.type==="report"?"ðŸ“„ Report":"ðŸ’­ Impression"," Generated"]})}),e.jsxs("div",{style:{opacity:.8},children:["â± ",q.generationTime,"s â€¢ ðŸŽ¯ ",q.tokens.total," tokens (",q.tokens.input," in, ",q.tokens.output," out)"]})]}):e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:"4px"},children:e.jsx("strong",{children:"âš¡ Ready to Generate"})}),e.jsx("div",{style:{opacity:.8},children:"Click Report or Impression to begin"})]})}),e.jsxs("div",{className:"button-row",style:{marginBottom:0,transition:"margin-bottom 0.3s ease",gap:16},children:[e.jsx("button",{onClick:St,disabled:Q||ae,style:{padding:"10px 20px",background:"linear-gradient(135deg, #3ABC96 0%, #2a9b7a 100%)",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:16,fontSize:14,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",color:"#FFFFFF",boxShadow:"0 4px 12px rgba(58, 188, 150, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.15)",width:120,opacity:Q||ae?.5:1,pointerEvents:Q||ae?"none":"auto",transition:"all 0.2s ease",transform:"translateY(0)",cursor:"pointer"},onMouseEnter:o=>{!Q&&!ae&&(o.currentTarget.style.background="linear-gradient(135deg, #2a9b7a 0%, #238463 100%)",o.currentTarget.style.transform="translateY(-2px) scale(1.02)",o.currentTarget.style.boxShadow="0 6px 16px rgba(58, 188, 150, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2)",o.currentTarget.style.borderColor="rgba(255, 255, 255, 0.2)")},onMouseLeave:o=>{!Q&&!ae&&(o.currentTarget.style.background="linear-gradient(135deg, #3ABC96 0%, #2a9b7a 100%)",o.currentTarget.style.transform="translateY(0)",o.currentTarget.style.boxShadow="0 4px 12px rgba(58, 188, 150, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.15)",o.currentTarget.style.borderColor="rgba(255, 255, 255, 0.1)")},children:"Report"}),e.jsx("button",{onClick:Ct,disabled:Q||ae,style:{padding:"10px 20px",background:"linear-gradient(135deg, #3ABC96 0%, #2a9b7a 100%)",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:16,fontSize:14,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",color:"#FFFFFF",boxShadow:"0 4px 12px rgba(58, 188, 150, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.15)",width:120,opacity:Q||ae?.5:1,pointerEvents:Q||ae?"none":"auto",transition:"all 0.2s ease",transform:"translateY(0)",cursor:"pointer"},onMouseEnter:o=>{!Q&&!ae&&(o.currentTarget.style.background="linear-gradient(135deg, #2a9b7a 0%, #238463 100%)",o.currentTarget.style.transform="translateY(-2px) scale(1.02)",o.currentTarget.style.boxShadow="0 6px 16px rgba(58, 188, 150, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2)",o.currentTarget.style.borderColor="rgba(255, 255, 255, 0.2)")},onMouseLeave:o=>{!Q&&!ae&&(o.currentTarget.style.background="linear-gradient(135deg, #3ABC96 0%, #2a9b7a 100%)",o.currentTarget.style.transform="translateY(0)",o.currentTarget.style.boxShadow="0 4px 12px rgba(58, 188, 150, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.15)",o.currentTarget.style.borderColor="rgba(255, 255, 255, 0.1)")},children:"Impression"})]}),He&&e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"ðŸ§  Prompt Sent to GPT:"}),e.jsx("pre",{children:_n}),e.jsx("h3",{children:"ðŸ“¥ Raw GPT Response:"}),e.jsx("pre",{children:Rn})]}),e.jsx(an,{visible:Pe,selected:ft,onSelect:o=>{var d,u;Ve(o),Xe.setItem("dictationTarget",o),(u=(d=window==null?void 0:window.electron)==null?void 0:d.ipcRenderer)==null||u.invoke("set-dictation-target",o)},onClose:()=>{Fe(!1)},onCancel:()=>{Fe(!1)}})]}),e.jsx(ln,{visible:gt,onClose:()=>qe(!1)})]}),t&&e.jsxs("div",{style:{height:"50px",display:"flex",alignItems:"center",justifyContent:"space-between",padding:"0 16px",boxSizing:"border-box",overflow:"visible",position:"relative"},children:[e.jsx("div",{style:{position:"absolute",top:0,left:80,right:160,height:50,WebkitAppRegion:"drag",pointerEvents:"none",zIndex:-1},onDoubleClick:o=>o.preventDefault()}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",WebkitAppRegion:"no-drag",zIndex:1002},children:[e.jsx("button",{className:"radpal-button-report radpal-button-mini",onClick:St,disabled:Q||ae,style:{padding:"2px 6px",fontSize:11,lineHeight:1.1,color:"#fff",fontFamily:"SF Pro, system-ui, sans-serif",fontWeight:400,opacity:Q||ae?.5:1,pointerEvents:Q||ae?"none":"auto"},children:"Report"}),e.jsx("button",{className:"radpal-button-impression radpal-button-mini",onClick:Ct,disabled:Q||ae,style:{padding:"2px 6px",fontSize:11,lineHeight:1.1,color:"#fff",fontFamily:"SF Pro, system-ui, sans-serif",fontWeight:400,opacity:Q||ae?.5:1,pointerEvents:Q||ae?"none":"auto"},children:"Impression"})]}),e.jsxs("div",{style:{display:"flex",gap:"6px",alignItems:"center",WebkitAppRegion:"no-drag",zIndex:1002},children:[e.jsx("button",{onClick:vn,style:{background:"rgba(255, 255, 255, 0.05)",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",border:"1px solid rgba(255, 255, 255, 0.08)",borderRadius:16,padding:"4px 10px",color:"#ccc",transition:"all 0.2s ease",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.1)",cursor:"pointer"},onMouseEnter:o=>{o.currentTarget.style.background="rgba(255, 255, 255, 0.15)",o.currentTarget.style.borderColor="rgba(255, 255, 255, 0.15)",o.currentTarget.style.color="#fff",o.currentTarget.style.transform="translateY(-1px)",o.currentTarget.style.boxShadow="0 3px 6px rgba(0, 0, 0, 0.15)"},onMouseLeave:o=>{o.currentTarget.style.background="rgba(255, 255, 255, 0.05)",o.currentTarget.style.borderColor="rgba(255, 255, 255, 0.08)",o.currentTarget.style.color="#ccc",o.currentTarget.style.transform="translateY(0)",o.currentTarget.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)"},children:"+"}),e.jsx("button",{onClick:Ht,style:{background:"rgba(255, 255, 255, 0.05)",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",border:"1px solid rgba(255, 255, 255, 0.08)",borderRadius:16,padding:"4px 10px",color:"#ccc",transition:"all 0.2s ease",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.1)",cursor:"pointer"},onMouseEnter:o=>{o.currentTarget.style.background="rgba(255, 255, 255, 0.15)",o.currentTarget.style.borderColor="rgba(255, 255, 255, 0.15)",o.currentTarget.style.color="#fff",o.currentTarget.style.transform="translateY(-1px)",o.currentTarget.style.boxShadow="0 3px 6px rgba(0, 0, 0, 0.15)"},onMouseLeave:o=>{o.currentTarget.style.background="rgba(255, 255, 255, 0.05)",o.currentTarget.style.borderColor="rgba(255, 255, 255, 0.08)",o.currentTarget.style.color="#ccc",o.currentTarget.style.transform="translateY(0)",o.currentTarget.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)"},children:"â€“"}),e.jsx("button",{onClick:Yt,style:{background:"linear-gradient(135deg, #E36756 0%, #c85545 100%)",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:16,padding:"4px 10px",color:"#fff",transition:"all 0.2s ease",boxShadow:"0 2px 6px rgba(227, 103, 86, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1)",cursor:"pointer"},onMouseEnter:o=>{o.currentTarget.style.background="linear-gradient(135deg, #c85545 0%, #b04436 100%)",o.currentTarget.style.transform="translateY(-1px)",o.currentTarget.style.boxShadow="0 4px 8px rgba(227, 103, 86, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.15)",o.currentTarget.style.borderColor="rgba(255, 255, 255, 0.15)"},onMouseLeave:o=>{o.currentTarget.style.background="linear-gradient(135deg, #E36756 0%, #c85545 100%)",o.currentTarget.style.transform="translateY(0)",o.currentTarget.style.boxShadow="0 2px 6px rgba(227, 103, 86, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1)",o.currentTarget.style.borderColor="rgba(255, 255, 255, 0.1)"},children:"Ã—"})]})]}),Ne&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`settings-sidebar-overlay ${Ne?"open":""}`,onClick:()=>ze(!1)}),e.jsxs("div",{className:`settings-sidebar ${Ne?"open":""}`,children:[e.jsxs("div",{className:"settings-sidebar-header",children:[e.jsx("h2",{className:"settings-sidebar-title",children:"Settings"}),e.jsx("button",{className:"settings-sidebar-close",onClick:()=>ze(!1),children:"Ã—"})]}),e.jsxs("div",{className:"settings-sidebar-content",children:[e.jsx("button",{className:"settings-sidebar-item",onClick:()=>{var o,d;(d=(o=window.electron)==null?void 0:o.ipcRenderer)==null||d.send("open-popup-templates",{isOfflineMode:we})},children:"â€» Manage Templates"}),e.jsx("button",{className:"settings-sidebar-item",onClick:()=>{ne(!0)},children:"ðŸ“ Voice Macros"}),e.jsx("button",{className:"settings-sidebar-item",onClick:()=>{Ke(!0),ze(!1)},children:"âš¡ Edit Logic"}),e.jsxs("div",{className:"settings-sidebar-section",style:{marginTop:"20px",marginBottom:"10px"},children:[e.jsx("h3",{className:"settings-sidebar-section-title",style:{margin:"0 0 12px 0",padding:"8px 16px",textAlign:"center",fontSize:"14px",fontWeight:600,color:"#fff",backgroundColor:"rgba(255, 255, 255, 0.1)",borderRadius:"8px",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif"},children:"Backup & Restore"}),e.jsxs("button",{className:`settings-sidebar-item ${j<4?"disabled":""}`,onClick:j>=4?Tn:void 0,disabled:j<4,title:j<4?"Requires Developer tier":"View Offline Data",style:{opacity:j<4?.5:1,cursor:j<4?"not-allowed":"pointer"},children:["ðŸ‘ï¸ View Offline Data ",j<4&&"ðŸ”’"]}),e.jsxs("button",{className:`settings-sidebar-item ${j<4?"disabled":""}`,onClick:j>=4?kn:void 0,disabled:j<4,title:j<4?"Requires Developer tier":"Export Backup",style:{opacity:j<4?.5:1,cursor:j<4?"not-allowed":"pointer"},children:["ðŸ’¾ Export Backup ",j<4&&"ðŸ”’"]}),e.jsxs("button",{className:`settings-sidebar-item ${j<4?"disabled":""}`,onClick:j>=4?En:void 0,disabled:j<4,title:j<4?"Requires Developer tier":"Import Backup",style:{opacity:j<4?.5:1,cursor:j<4?"not-allowed":"pointer"},children:["ðŸ“¥ Import Backup ",j<4&&"ðŸ”’"]})]}),e.jsxs("div",{className:"settings-sidebar-section",children:[e.jsx("button",{className:"settings-sidebar-item",onClick:()=>{qe(!0)},children:"âŒ¨ï¸ Keyboard Shortcuts"}),e.jsxs("button",{className:`settings-sidebar-item ${we?"active":""} ${j<4?"disabled":""}`,onClick:j>=4?()=>{const o=!we;Be(o),localStorage.setItem("radpal_offline_mode",o.toString()),$(o?"ðŸ”Œ Offline mode enabled":"ðŸŒ Online mode enabled")}:void 0,disabled:j<4,title:j<4?"Requires Developer tier":"Toggle offline mode",style:{opacity:j<4?.5:1,cursor:j<4?"not-allowed":"pointer"},children:[we?"ðŸ”Œ Offline Mode":"ðŸŒ Online Mode"," ",j<4&&"ðŸ”’"]}),e.jsx("button",{className:"settings-sidebar-item danger",onClick:()=>{An("logout")},children:"â†’ Log Out"})]})]})]})]}),He&&e.jsxs("div",{style:{position:"fixed",bottom:20,right:20,background:"rgba(20, 20, 20, 0.95)",border:"1px solid #333",borderRadius:8,padding:"12px",color:"#fff",fontSize:12,maxWidth:300,zIndex:1e4},children:[e.jsxs("div",{children:["API Provider: ",L]}),e.jsxs("div",{children:["Window Size: ",s,"px"]}),e.jsxs("div",{children:["User: ",(D==null?void 0:D.email)||"Not logged in"]}),e.jsxs("div",{children:["Templates Loading: ",ae?"Yes":"No"]}),e.jsxs("div",{children:["GPT Loading: ",Q?"Yes":"No"]}),e.jsxs("div",{children:["Contracted: ",t?"Yes":"No"]})]}),!t&&e.jsxs(e.Fragment,{children:[e.jsx(an,{visible:Pe,selected:ft,onSelect:o=>{var d,u;Ve(o),Xe.setItem("dictationTarget",o),(u=(d=window==null?void 0:window.electron)==null?void 0:d.ipcRenderer)==null||u.invoke("set-dictation-target",o)},onClose:()=>{Fe(!1)},onCancel:()=>{Fe(!1)}}),e.jsx(ln,{visible:gt,onClose:()=>qe(!1)}),e.jsx(Go,{isOpen:W,onClose:()=>ne(!1)}),ht&&e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.4)",backdropFilter:"blur(4px)",WebkitBackdropFilter:"blur(4px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:9999},children:e.jsxs("div",{style:{width:"90%",maxWidth:"800px",height:"80%",backgroundColor:"rgba(42, 45, 49, 0.95)",backdropFilter:"blur(12px)",WebkitBackdropFilter:"blur(12px)",borderRadius:16,border:"1px solid rgba(255, 255, 255, 0.1)",display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsxs("div",{style:{padding:"20px 24px",borderBottom:"1px solid rgba(255, 255, 255, 0.1)",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("h2",{style:{margin:0,color:"#fff",fontSize:"20px",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:600},children:"Offline Data Viewer"}),e.jsx("button",{onClick:()=>et(!1),style:{background:"none",border:"none",color:"#fff",fontSize:"24px",cursor:"pointer",padding:"4px",borderRadius:"4px",lineHeight:1},children:"Ã—"})]}),e.jsx("div",{style:{flex:1,padding:"20px 24px",overflow:"auto",color:"#fff",fontFamily:"'JetBrains Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace",fontSize:"13px",lineHeight:"1.5"},children:e.jsx("pre",{style:{margin:0,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:JSON.stringify(ue.exportOfflineData(),null,2)})}),e.jsxs("div",{style:{padding:"16px 24px",borderTop:"1px solid rgba(255, 255, 255, 0.1)",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("span",{style:{color:"rgba(255, 255, 255, 0.7)",fontSize:"12px",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif"},children:["Last sync: ",((nn=ue.getLastSync())==null?void 0:nn.toLocaleString())||"Never"]}),e.jsxs("div",{style:{display:"flex",gap:"12px"},children:[e.jsx("button",{onClick:()=>{navigator.clipboard.writeText(JSON.stringify(ue.exportOfflineData(),null,2)),$("ðŸ“‹ Copied to clipboard!")},style:{padding:"8px 16px",backgroundColor:"#3b82f6",color:"#fff",border:"none",borderRadius:"6px",fontSize:"14px",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:500,cursor:"pointer"},children:"ðŸ“‹ Copy JSON"}),e.jsx("button",{onClick:()=>{ue.clearAll(),$("ðŸ—‘ï¸ All offline data cleared!"),et(!1)},style:{padding:"8px 16px",backgroundColor:"#dc2626",color:"#fff",border:"none",borderRadius:"6px",fontSize:"14px",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:500,cursor:"pointer"},children:"ðŸ—‘ï¸ Clear All"})]})]})]})})]}),lt&&(D==null?void 0:D.id)&&e.jsxs(e.Fragment,{children:[console.log("ðŸŽ¯ Rendering LogicEditorEnhanced with:",{userId:D.id,studyType:M,showLogicEditor:lt}),e.jsx(ho,{userId:D.id,studyType:M||"",templates:G,userTier:j,onClose:()=>{Ke(!1),setTimeout(()=>{const o=document.querySelector('[contenteditable="true"]');o&&(o.focus(),o.click()),document.body.style.pointerEvents="auto"},100)},isOfflineMode:we})]}),Sn&&(D==null?void 0:D.id)&&q&&e.jsx(Fn,{userId:D.id,studyType:M||"",reportText:n,reportId:void 0,sessionId:void 0,onClose:()=>Tt(!1)}),Le&&e.jsx("div",{style:{position:"fixed",bottom:"20px",left:"50%",transform:"translateX(-50%)",background:"rgba(58, 188, 150, 0.9)",color:"white",padding:"12px 20px",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0,0,0,0.2)",zIndex:1e4,fontSize:"14px",fontWeight:"500",maxWidth:"400px",textAlign:"center",pointerEvents:"none",backdropFilter:"blur(12px)",WebkitBackdropFilter:"blur(12px)",border:"1px solid rgba(58, 188, 150, 0.3)"},children:Le}),F&&e.jsx($o,{options:F.options,position:F.position,onSelect:jn,onCancel:()=>_(null)})]})})]}):e.jsx("div",{className:"radpal-outer-frame",children:e.jsx("div",{className:"window-frame",children:e.jsx(io,{})})})});console.log("ðŸ”¥ MAIN.TSX LOADING - Entry point reached!");console.log("ðŸ”¥ MAIN.TSX IMPORTS COMPLETE - About to render App");Nn.createRoot(document.getElementById("root")).render(e.jsx(jt.StrictMode,{children:e.jsx(Vo,{})}));
