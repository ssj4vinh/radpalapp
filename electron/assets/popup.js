import{r as b,j as u,B,g as zr,c as te,a as Nr}from"./BlurCard.js";const Wr="modulepreload",qr=function(s,e){return new URL(s,e).href},Ht={},ye=function(e,t,r){if(!t||t.length===0)return e();const n=document.getElementsByTagName("link");return Promise.all(t.map(i=>{if(i=qr(i,r),i in Ht)return;Ht[i]=!0;const o=i.endsWith(".css"),a=o?'[rel="stylesheet"]':"";if(!!r)for(let c=n.length-1;c>=0;c--){const h=n[c];if(h.href===i&&(!o||h.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${i}"]${a}`))return;const d=document.createElement("link");if(d.rel=o?"stylesheet":Wr,o||(d.as="script",d.crossOrigin=""),d.href=i,document.head.appendChild(d),o)return new Promise((c,h)=>{d.addEventListener("load",c),d.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${i}`)))})})).then(()=>e()).catch(i=>{const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=i,window.dispatchEvent(o),!o.defaultPrevented)throw i})};class Hr{diff(e,t,r={}){let n;typeof r=="function"?(n=r,r={}):"callback"in r&&(n=r.callback);const i=this.castInput(e,r),o=this.castInput(t,r),a=this.removeEmpty(this.tokenize(i,r)),l=this.removeEmpty(this.tokenize(o,r));return this.diffWithOptionsObj(a,l,r,n)}diffWithOptionsObj(e,t,r,n){var i;const o=j=>{if(j=this.postProcess(j,r),n){setTimeout(function(){n(j)},0);return}else return j},a=t.length,l=e.length;let d=1,c=a+l;r.maxEditLength!=null&&(c=Math.min(c,r.maxEditLength));const h=(i=r.timeout)!==null&&i!==void 0?i:1/0,p=Date.now()+h,g=[{oldPos:-1,lastComponent:void 0}];let m=this.extractCommon(g[0],t,e,0,r);if(g[0].oldPos+1>=l&&m+1>=a)return o(this.buildValues(g[0].lastComponent,t,e));let y=-1/0,v=1/0;const C=()=>{for(let j=Math.max(y,-d);j<=Math.min(v,d);j+=2){let w;const S=g[j-1],O=g[j+1];S&&(g[j-1]=void 0);let P=!1;if(O){const ee=O.oldPos-j;P=O&&0<=ee&&ee<a}const D=S&&S.oldPos+1<l;if(!P&&!D){g[j]=void 0;continue}if(!D||P&&S.oldPos<O.oldPos?w=this.addToPath(O,!0,!1,0,r):w=this.addToPath(S,!1,!0,1,r),m=this.extractCommon(w,t,e,j,r),w.oldPos+1>=l&&m+1>=a)return o(this.buildValues(w.lastComponent,t,e))||!0;g[j]=w,w.oldPos+1>=l&&(v=Math.min(v,j-1)),m+1>=a&&(y=Math.max(y,j+1))}d++};if(n)(function j(){setTimeout(function(){if(d>c||Date.now()>p)return n(void 0);C()||j()},0)})();else for(;d<=c&&Date.now()<=p;){const j=C();if(j)return j}}addToPath(e,t,r,n,i){const o=e.lastComponent;return o&&!i.oneChangePerToken&&o.added===t&&o.removed===r?{oldPos:e.oldPos+n,lastComponent:{count:o.count+1,added:t,removed:r,previousComponent:o.previousComponent}}:{oldPos:e.oldPos+n,lastComponent:{count:1,added:t,removed:r,previousComponent:o}}}extractCommon(e,t,r,n,i){const o=t.length,a=r.length;let l=e.oldPos,d=l-n,c=0;for(;d+1<o&&l+1<a&&this.equals(r[l+1],t[d+1],i);)d++,l++,c++,i.oneChangePerToken&&(e.lastComponent={count:1,previousComponent:e.lastComponent,added:!1,removed:!1});return c&&!i.oneChangePerToken&&(e.lastComponent={count:c,previousComponent:e.lastComponent,added:!1,removed:!1}),e.oldPos=l,d}equals(e,t,r){return r.comparator?r.comparator(e,t):e===t||!!r.ignoreCase&&e.toLowerCase()===t.toLowerCase()}removeEmpty(e){const t=[];for(let r=0;r<e.length;r++)e[r]&&t.push(e[r]);return t}castInput(e,t){return e}tokenize(e,t){return Array.from(e)}join(e){return e.join("")}postProcess(e,t){return e}get useLongestToken(){return!1}buildValues(e,t,r){const n=[];let i;for(;e;)n.push(e),i=e.previousComponent,delete e.previousComponent,e=i;n.reverse();const o=n.length;let a=0,l=0,d=0;for(;a<o;a++){const c=n[a];if(c.removed)c.value=this.join(r.slice(d,d+c.count)),d+=c.count;else{if(!c.added&&this.useLongestToken){let h=t.slice(l,l+c.count);h=h.map(function(p,g){const m=r[d+g];return m.length>p.length?m:p}),c.value=this.join(h)}else c.value=this.join(t.slice(l,l+c.count));l+=c.count,c.added||(d+=c.count)}}return n}}const Jt="a-zA-Z0-9_\\u{C0}-\\u{FF}\\u{D8}-\\u{F6}\\u{F8}-\\u{2C6}\\u{2C8}-\\u{2D7}\\u{2DE}-\\u{2FF}\\u{1E00}-\\u{1EFF}";class Jr extends Hr{tokenize(e){const t=new RegExp(`(\\r?\\n)|[${Jt}]+|[^\\S\\n\\r]+|[^${Jt}]`,"ug");return e.match(t)||[]}}const Gr=new Jr;function Kr(s,e,t){return Gr.diff(s,e,t)}const et=["MRI Ankle","MRI Foot","MRI Knee","MRI Hip","MRI Shoulder","MRI Elbow","MRI Wrist","MRI Hand","MRI Cervical Spine","MRI Thoracic Spine","MRI Lumbar Spine","MRI Total Spine","DEXA","CT Generic","MRI Generic","CT Abdomen Pelvis","CT Pulmonary Embolism","CT Chest","CT Head","Knee Test Template"];function Vr({templates:s,onSave:e}){const[t,r]=b.useState(et[0]||""),[n,i]=b.useState(null),[o,a]=b.useState({}),l=b.useRef(null);b.useEffect(()=>{et.length>0&&r(et[0])},[s]);const d=()=>{l.current&&a(m=>({...m,[t]:{template:l.current.value}}))};b.useEffect(()=>{i(null)},[t]),b.useEffect(()=>{a(m=>{const y={...m};let v=!1;return Object.keys(y).forEach(C=>{const j=y[C],w=s[C];w&&j.template===w.template&&(delete y[C],v=!0)}),v?y:m})},[s]);const c=async()=>{var m;try{d(),await new Promise(C=>setTimeout(C,10));const y=o[t]||{},v=s[t]||{};await e(t,y.template??((m=l.current)==null?void 0:m.value)??v.template??"",v.generate_prompt??"",v.generate_impression??"")}catch(y){console.error(y),i("❌ Save failed")}},h=s[t]||{},g={template:(o[t]||{}).template??h.template??""};return u.jsxs("div",{style:{marginTop:20,paddingTop:16,width:"90%",margin:"20px auto 0 auto",paddingLeft:20,paddingRight:20},children:[u.jsxs("p",{style:{fontSize:12,marginBottom:8,color:"#fff"},children:["Loaded ",s?Object.keys(s).length:0," templates."]}),u.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"flex-end",gap:12,marginBottom:16},children:[u.jsx(B,{children:u.jsx("button",{className:"radpal-button radpal-button-impression",onClick:c,style:{border:"none"},children:" Save "})}),n&&u.jsx("span",{style:{fontSize:13,color:"#fff"},children:n})]}),u.jsx("label",{style:{fontSize:"15px",fontWeight:400,marginBottom:6,display:"block",color:"#fff"},children:"Select Study Type:"}),u.jsx(B,{children:u.jsx("select",{value:t,onChange:m=>{d(),r(m.target.value)},style:{width:"100%",fontSize:"16px",padding:"12px 16px",borderRadius:12,backgroundColor:"transparent",color:"#fff",border:"none",outline:"none",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:500},children:et.map(m=>u.jsx("option",{value:m,style:{fontSize:"16px",backgroundColor:"#1a1d23",color:"#fff",padding:"8px 12px",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:400},children:m},m))})}),u.jsx("div",{style:{marginBottom:16}}),u.jsx(B,{children:u.jsx("textarea",{ref:l,value:g.template,onChange:m=>{a(y=>({...y,[t]:{template:m.target.value}}))},style:{width:"100%",height:700,marginBottom:30,fontSize:"16px",fontFamily:"'JetBrains Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace",backgroundColor:"transparent",color:"#fff",border:"none",outline:"none",resize:"none"}})})]})}const tt=["MRI Ankle","MRI Foot","MRI Knee","MRI Hip","MRI Shoulder","MRI Elbow","MRI Wrist","MRI Hand","MRI Cervical Spine","MRI Thoracic Spine","MRI Lumbar Spine","MRI Total Spine","DEXA","CT Generic","MRI Generic","CT Abdomen Pelvis","CT Pulmonary Embolism","CT Chest","CT Head","Knee Test Template"];function Yr({templates:s,onSave:e}){const[t,r]=b.useState(tt[0]||""),[n,i]=b.useState(null),[o,a]=b.useState({}),l=b.useRef(null),d=b.useRef(null);b.useEffect(()=>{tt.length>0&&r(tt[0])},[s]);const c=()=>{l.current&&d.current&&a(y=>({...y,[t]:{generate_prompt:l.current.value,generate_impression:d.current.value}}))};b.useEffect(()=>{a(y=>{const v={...y};let C=!1;return Object.keys(s).forEach(j=>{const w=s[j],S=y[j];(!S||S.generate_prompt!==w.generate_prompt||S.generate_impression!==(w.generate_impression||""))&&(v[j]={generate_prompt:w.generate_prompt||"",generate_impression:w.generate_impression||""},C=!0)}),C?v:y})},[s]);const h=async()=>{var y,v;try{c(),await new Promise(w=>setTimeout(w,10));const C=o[t]||{},j=s[t]||{};await e(t,j.template??"",C.generate_prompt??((y=l.current)==null?void 0:y.value)??j.generate_prompt??"",C.generate_impression??((v=d.current)==null?void 0:v.value)??j.generate_impression??"")}catch(C){console.error(C),i("❌ Save failed")}},p=s[t]||{},g=o[t]||{},m={generate_prompt:g.generate_prompt??p.generate_prompt??"",generate_impression:g.generate_impression??p.generate_impression??""};return u.jsxs("div",{style:{marginTop:20,paddingTop:16,width:"90%",margin:"20px auto 0 auto",paddingLeft:20,paddingRight:20},children:[u.jsxs("p",{style:{fontSize:12,marginBottom:8,color:"#fff"},children:["Loaded ",s?Object.keys(s).length:0," templates."]}),u.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"flex-end",gap:12,marginBottom:16},children:[u.jsx(B,{children:u.jsx("button",{className:"radpal-button radpal-button-impression",onClick:h,style:{border:"none"},children:" Save "})}),n&&u.jsx("span",{style:{fontSize:13,color:"#fff"},children:n})]}),u.jsx("label",{style:{fontSize:"15px",fontWeight:400,marginBottom:6,display:"block",color:"#fff"},children:"Select Study Type:"}),u.jsx(B,{children:u.jsx("select",{value:t,onChange:y=>{c(),r(y.target.value)},style:{width:"100%",fontSize:"16px",padding:"12px 16px",borderRadius:12,backgroundColor:"transparent",color:"#fff",border:"none",outline:"none",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:500},children:tt.map(y=>u.jsx("option",{value:y,style:{fontSize:"16px",backgroundColor:"#1a1d23",color:"#fff",padding:"8px 12px",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:500},children:y},y))})}),u.jsx("div",{style:{marginBottom:16}}),u.jsx(B,{children:u.jsx("textarea",{ref:l,value:m.generate_prompt,onChange:y=>{a(v=>{var C;return{...v,[t]:{...v[t],generate_prompt:y.target.value,generate_impression:((C=v[t])==null?void 0:C.generate_impression)??m.generate_impression}}})},style:{width:"100%",height:600,marginBottom:12,fontSize:"16px",fontFamily:"'JetBrains Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace",backgroundColor:"transparent",color:"#fff",border:"none",outline:"none",resize:"none"},placeholder:"Report Logic"})}),u.jsx("div",{style:{marginBottom:16}}),u.jsx(B,{children:u.jsx("textarea",{ref:d,value:m.generate_impression,onChange:y=>{a(v=>{var C;return{...v,[t]:{...v[t],generate_prompt:((C=v[t])==null?void 0:C.generate_prompt)??m.generate_prompt,generate_impression:y.target.value}}})},style:{width:"100%",height:600,marginBottom:12,fontSize:"16px",fontFamily:"'JetBrains Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace",backgroundColor:"transparent",color:"#fff",border:"none",outline:"none",resize:"none"},placeholder:"Impression Logic"})})]})}function Xr(s,e=!0){const[t,r]=b.useState({}),[n,i]=b.useState(!0),o=b.useRef(!1),a=b.useRef(null);return b.useEffect(()=>{if(!s||!e){r({}),i(!1);return}if(o.current||a.current===(s==null?void 0:s.id))return;(async()=>{var c,h;o.current=!0,a.current=s==null?void 0:s.id,i(!0);try{const p=await((h=(c=window.electron)==null?void 0:c.ipcRenderer)==null?void 0:h.invoke("fetch-templates",s.id,null));r(p||{})}catch{r({})}finally{i(!1),o.current=!1}})()},[s,e]),{templates:t||{},loading:n??!1,saveTemplate:(async(d,c,h,p)=>{var m,y;if(!s)throw new Error("User not set");const g=await((y=(m=window.electron)==null?void 0:m.ipcRenderer)==null?void 0:y.invoke("save-template",{userId:s.id,accessToken:null,studyType:d,template:c,generatePrompt:h,generateImpression:p}));if(!(g!=null&&g.success))throw new Error("Save failed")})||(async()=>{})}}const Qr=s=>{let e;return s?e=s:typeof fetch>"u"?e=(...t)=>ye(()=>Promise.resolve().then(()=>$e),void 0,import.meta.url).then(({default:r})=>r(...t)):e=fetch,(...t)=>e(...t)};class It extends Error{constructor(e,t="FunctionsError",r){super(e),this.name=t,this.context=r}}class Zr extends It{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class es extends It{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class ts extends It{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var St;(function(s){s.Any="any",s.ApNortheast1="ap-northeast-1",s.ApNortheast2="ap-northeast-2",s.ApSouth1="ap-south-1",s.ApSoutheast1="ap-southeast-1",s.ApSoutheast2="ap-southeast-2",s.CaCentral1="ca-central-1",s.EuCentral1="eu-central-1",s.EuWest1="eu-west-1",s.EuWest2="eu-west-2",s.EuWest3="eu-west-3",s.SaEast1="sa-east-1",s.UsEast1="us-east-1",s.UsWest1="us-west-1",s.UsWest2="us-west-2"})(St||(St={}));var rs=globalThis&&globalThis.__awaiter||function(s,e,t,r){function n(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(c){try{d(r.next(c))}catch(h){o(h)}}function l(c){try{d(r.throw(c))}catch(h){o(h)}}function d(c){c.done?i(c.value):n(c.value).then(a,l)}d((r=r.apply(s,e||[])).next())})};class ss{constructor(e,{headers:t={},customFetch:r,region:n=St.Any}={}){this.url=e,this.headers=t,this.region=n,this.fetch=Qr(r)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e,t={}){var r;return rs(this,void 0,void 0,function*(){try{const{headers:n,method:i,body:o}=t;let a={},{region:l}=t;l||(l=this.region),l&&l!=="any"&&(a["x-region"]=l);let d;o&&(n&&!Object.prototype.hasOwnProperty.call(n,"Content-Type")||!n)&&(typeof Blob<"u"&&o instanceof Blob||o instanceof ArrayBuffer?(a["Content-Type"]="application/octet-stream",d=o):typeof o=="string"?(a["Content-Type"]="text/plain",d=o):typeof FormData<"u"&&o instanceof FormData?d=o:(a["Content-Type"]="application/json",d=JSON.stringify(o)));const c=yield this.fetch(`${this.url}/${e}`,{method:i||"POST",headers:Object.assign(Object.assign(Object.assign({},a),this.headers),n),body:d}).catch(m=>{throw new Zr(m)}),h=c.headers.get("x-relay-error");if(h&&h==="true")throw new es(c);if(!c.ok)throw new ts(c);let p=((r=c.headers.get("Content-Type"))!==null&&r!==void 0?r:"text/plain").split(";")[0].trim(),g;return p==="application/json"?g=yield c.json():p==="application/octet-stream"?g=yield c.blob():p==="text/event-stream"?g=c:p==="multipart/form-data"?g=yield c.formData():g=yield c.text(),{data:g,error:null}}catch(n){return{data:null,error:n}}})}}var Q={},$t={},dt={},Ge={},ut={},ht={},ns=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")},Ie=ns();const is=Ie.fetch,ur=Ie.fetch.bind(Ie),hr=Ie.Headers,os=Ie.Request,as=Ie.Response,$e=Object.freeze(Object.defineProperty({__proto__:null,Headers:hr,Request:os,Response:as,default:ur,fetch:is},Symbol.toStringTag,{value:"Module"})),ls=zr($e);var ft={};Object.defineProperty(ft,"__esModule",{value:!0});let cs=class extends Error{constructor(e){super(e.message),this.name="PostgrestError",this.details=e.details,this.hint=e.hint,this.code=e.code}};ft.default=cs;var fr=te&&te.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(ht,"__esModule",{value:!0});const ds=fr(ls),us=fr(ft);let hs=class{constructor(e){this.shouldThrowOnError=!1,this.method=e.method,this.url=e.url,this.headers=e.headers,this.schema=e.schema,this.body=e.body,this.shouldThrowOnError=e.shouldThrowOnError,this.signal=e.signal,this.isMaybeSingle=e.isMaybeSingle,e.fetch?this.fetch=e.fetch:typeof fetch>"u"?this.fetch=ds.default:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(e,t){return this.headers=Object.assign({},this.headers),this.headers[e]=t,this}then(e,t){this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers["Accept-Profile"]=this.schema:this.headers["Content-Profile"]=this.schema),this.method!=="GET"&&this.method!=="HEAD"&&(this.headers["Content-Type"]="application/json");const r=this.fetch;let n=r(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async i=>{var o,a,l;let d=null,c=null,h=null,p=i.status,g=i.statusText;if(i.ok){if(this.method!=="HEAD"){const C=await i.text();C===""||(this.headers.Accept==="text/csv"||this.headers.Accept&&this.headers.Accept.includes("application/vnd.pgrst.plan+text")?c=C:c=JSON.parse(C))}const y=(o=this.headers.Prefer)===null||o===void 0?void 0:o.match(/count=(exact|planned|estimated)/),v=(a=i.headers.get("content-range"))===null||a===void 0?void 0:a.split("/");y&&v&&v.length>1&&(h=parseInt(v[1])),this.isMaybeSingle&&this.method==="GET"&&Array.isArray(c)&&(c.length>1?(d={code:"PGRST116",details:`Results contain ${c.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},c=null,h=null,p=406,g="Not Acceptable"):c.length===1?c=c[0]:c=null)}else{const y=await i.text();try{d=JSON.parse(y),Array.isArray(d)&&i.status===404&&(c=[],d=null,p=200,g="OK")}catch{i.status===404&&y===""?(p=204,g="No Content"):d={message:y}}if(d&&this.isMaybeSingle&&(!((l=d==null?void 0:d.details)===null||l===void 0)&&l.includes("0 rows"))&&(d=null,p=200,g="OK"),d&&this.shouldThrowOnError)throw new us.default(d)}return{error:d,data:c,count:h,status:p,statusText:g}});return this.shouldThrowOnError||(n=n.catch(i=>{var o,a,l;return{error:{message:`${(o=i==null?void 0:i.name)!==null&&o!==void 0?o:"FetchError"}: ${i==null?void 0:i.message}`,details:`${(a=i==null?void 0:i.stack)!==null&&a!==void 0?a:""}`,hint:"",code:`${(l=i==null?void 0:i.code)!==null&&l!==void 0?l:""}`},data:null,count:null,status:0,statusText:""}})),n.then(e,t)}returns(){return this}overrideTypes(){return this}};ht.default=hs;var fs=te&&te.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(ut,"__esModule",{value:!0});const ps=fs(ht);let gs=class extends ps.default{select(e){let t=!1;const r=(e??"*").split("").map(n=>/\s/.test(n)&&!t?"":(n==='"'&&(t=!t),n)).join("");return this.url.searchParams.set("select",r),this.headers.Prefer&&(this.headers.Prefer+=","),this.headers.Prefer+="return=representation",this}order(e,{ascending:t=!0,nullsFirst:r,foreignTable:n,referencedTable:i=n}={}){const o=i?`${i}.order`:"order",a=this.url.searchParams.get(o);return this.url.searchParams.set(o,`${a?`${a},`:""}${e}.${t?"asc":"desc"}${r===void 0?"":r?".nullsfirst":".nullslast"}`),this}limit(e,{foreignTable:t,referencedTable:r=t}={}){const n=typeof r>"u"?"limit":`${r}.limit`;return this.url.searchParams.set(n,`${e}`),this}range(e,t,{foreignTable:r,referencedTable:n=r}={}){const i=typeof n>"u"?"offset":`${n}.offset`,o=typeof n>"u"?"limit":`${n}.limit`;return this.url.searchParams.set(i,`${e}`),this.url.searchParams.set(o,`${t-e+1}`),this}abortSignal(e){return this.signal=e,this}single(){return this.headers.Accept="application/vnd.pgrst.object+json",this}maybeSingle(){return this.method==="GET"?this.headers.Accept="application/json":this.headers.Accept="application/vnd.pgrst.object+json",this.isMaybeSingle=!0,this}csv(){return this.headers.Accept="text/csv",this}geojson(){return this.headers.Accept="application/geo+json",this}explain({analyze:e=!1,verbose:t=!1,settings:r=!1,buffers:n=!1,wal:i=!1,format:o="text"}={}){var a;const l=[e?"analyze":null,t?"verbose":null,r?"settings":null,n?"buffers":null,i?"wal":null].filter(Boolean).join("|"),d=(a=this.headers.Accept)!==null&&a!==void 0?a:"application/json";return this.headers.Accept=`application/vnd.pgrst.plan+${o}; for="${d}"; options=${l};`,o==="json"?this:this}rollback(){var e;return((e=this.headers.Prefer)!==null&&e!==void 0?e:"").trim().length>0?this.headers.Prefer+=",tx=rollback":this.headers.Prefer="tx=rollback",this}returns(){return this}};ut.default=gs;var ms=te&&te.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(Ge,"__esModule",{value:!0});const ys=ms(ut);let vs=class extends ys.default{eq(e,t){return this.url.searchParams.append(e,`eq.${t}`),this}neq(e,t){return this.url.searchParams.append(e,`neq.${t}`),this}gt(e,t){return this.url.searchParams.append(e,`gt.${t}`),this}gte(e,t){return this.url.searchParams.append(e,`gte.${t}`),this}lt(e,t){return this.url.searchParams.append(e,`lt.${t}`),this}lte(e,t){return this.url.searchParams.append(e,`lte.${t}`),this}like(e,t){return this.url.searchParams.append(e,`like.${t}`),this}likeAllOf(e,t){return this.url.searchParams.append(e,`like(all).{${t.join(",")}}`),this}likeAnyOf(e,t){return this.url.searchParams.append(e,`like(any).{${t.join(",")}}`),this}ilike(e,t){return this.url.searchParams.append(e,`ilike.${t}`),this}ilikeAllOf(e,t){return this.url.searchParams.append(e,`ilike(all).{${t.join(",")}}`),this}ilikeAnyOf(e,t){return this.url.searchParams.append(e,`ilike(any).{${t.join(",")}}`),this}is(e,t){return this.url.searchParams.append(e,`is.${t}`),this}in(e,t){const r=Array.from(new Set(t)).map(n=>typeof n=="string"&&new RegExp("[,()]").test(n)?`"${n}"`:`${n}`).join(",");return this.url.searchParams.append(e,`in.(${r})`),this}contains(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cs.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cs.{${t.join(",")}}`):this.url.searchParams.append(e,`cs.${JSON.stringify(t)}`),this}containedBy(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cd.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cd.{${t.join(",")}}`):this.url.searchParams.append(e,`cd.${JSON.stringify(t)}`),this}rangeGt(e,t){return this.url.searchParams.append(e,`sr.${t}`),this}rangeGte(e,t){return this.url.searchParams.append(e,`nxl.${t}`),this}rangeLt(e,t){return this.url.searchParams.append(e,`sl.${t}`),this}rangeLte(e,t){return this.url.searchParams.append(e,`nxr.${t}`),this}rangeAdjacent(e,t){return this.url.searchParams.append(e,`adj.${t}`),this}overlaps(e,t){return typeof t=="string"?this.url.searchParams.append(e,`ov.${t}`):this.url.searchParams.append(e,`ov.{${t.join(",")}}`),this}textSearch(e,t,{config:r,type:n}={}){let i="";n==="plain"?i="pl":n==="phrase"?i="ph":n==="websearch"&&(i="w");const o=r===void 0?"":`(${r})`;return this.url.searchParams.append(e,`${i}fts${o}.${t}`),this}match(e){return Object.entries(e).forEach(([t,r])=>{this.url.searchParams.append(t,`eq.${r}`)}),this}not(e,t,r){return this.url.searchParams.append(e,`not.${t}.${r}`),this}or(e,{foreignTable:t,referencedTable:r=t}={}){const n=r?`${r}.or`:"or";return this.url.searchParams.append(n,`(${e})`),this}filter(e,t,r){return this.url.searchParams.append(e,`${t}.${r}`),this}};Ge.default=vs;var ws=te&&te.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(dt,"__esModule",{value:!0});const Fe=ws(Ge);let bs=class{constructor(e,{headers:t={},schema:r,fetch:n}){this.url=e,this.headers=t,this.schema=r,this.fetch=n}select(e,{head:t=!1,count:r}={}){const n=t?"HEAD":"GET";let i=!1;const o=(e??"*").split("").map(a=>/\s/.test(a)&&!i?"":(a==='"'&&(i=!i),a)).join("");return this.url.searchParams.set("select",o),r&&(this.headers.Prefer=`count=${r}`),new Fe.default({method:n,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}insert(e,{count:t,defaultToNull:r=!0}={}){const n="POST",i=[];if(this.headers.Prefer&&i.push(this.headers.Prefer),t&&i.push(`count=${t}`),r||i.push("missing=default"),this.headers.Prefer=i.join(","),Array.isArray(e)){const o=e.reduce((a,l)=>a.concat(Object.keys(l)),[]);if(o.length>0){const a=[...new Set(o)].map(l=>`"${l}"`);this.url.searchParams.set("columns",a.join(","))}}return new Fe.default({method:n,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}upsert(e,{onConflict:t,ignoreDuplicates:r=!1,count:n,defaultToNull:i=!0}={}){const o="POST",a=[`resolution=${r?"ignore":"merge"}-duplicates`];if(t!==void 0&&this.url.searchParams.set("on_conflict",t),this.headers.Prefer&&a.push(this.headers.Prefer),n&&a.push(`count=${n}`),i||a.push("missing=default"),this.headers.Prefer=a.join(","),Array.isArray(e)){const l=e.reduce((d,c)=>d.concat(Object.keys(c)),[]);if(l.length>0){const d=[...new Set(l)].map(c=>`"${c}"`);this.url.searchParams.set("columns",d.join(","))}}return new Fe.default({method:o,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}update(e,{count:t}={}){const r="PATCH",n=[];return this.headers.Prefer&&n.push(this.headers.Prefer),t&&n.push(`count=${t}`),this.headers.Prefer=n.join(","),new Fe.default({method:r,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}delete({count:e}={}){const t="DELETE",r=[];return e&&r.push(`count=${e}`),this.headers.Prefer&&r.unshift(this.headers.Prefer),this.headers.Prefer=r.join(","),new Fe.default({method:t,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}};dt.default=bs;var pt={},gt={};Object.defineProperty(gt,"__esModule",{value:!0});gt.version=void 0;gt.version="0.0.0-automated";Object.defineProperty(pt,"__esModule",{value:!0});pt.DEFAULT_HEADERS=void 0;const _s=gt;pt.DEFAULT_HEADERS={"X-Client-Info":`postgrest-js/${_s.version}`};var pr=te&&te.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty($t,"__esModule",{value:!0});const xs=pr(dt),ks=pr(Ge),Ss=pt;let js=class gr{constructor(e,{headers:t={},schema:r,fetch:n}={}){this.url=e,this.headers=Object.assign(Object.assign({},Ss.DEFAULT_HEADERS),t),this.schemaName=r,this.fetch=n}from(e){const t=new URL(`${this.url}/${e}`);return new xs.default(t,{headers:Object.assign({},this.headers),schema:this.schemaName,fetch:this.fetch})}schema(e){return new gr(this.url,{headers:this.headers,schema:e,fetch:this.fetch})}rpc(e,t={},{head:r=!1,get:n=!1,count:i}={}){let o;const a=new URL(`${this.url}/rpc/${e}`);let l;r||n?(o=r?"HEAD":"GET",Object.entries(t).filter(([c,h])=>h!==void 0).map(([c,h])=>[c,Array.isArray(h)?`{${h.join(",")}}`:`${h}`]).forEach(([c,h])=>{a.searchParams.append(c,h)})):(o="POST",l=t);const d=Object.assign({},this.headers);return i&&(d.Prefer=`count=${i}`),new ks.default({method:o,url:a,headers:d,schema:this.schemaName,body:l,fetch:this.fetch,allowEmpty:!1})}};$t.default=js;var Oe=te&&te.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(Q,"__esModule",{value:!0});Q.PostgrestError=Q.PostgrestBuilder=Q.PostgrestTransformBuilder=Q.PostgrestFilterBuilder=Q.PostgrestQueryBuilder=Q.PostgrestClient=void 0;const mr=Oe($t);Q.PostgrestClient=mr.default;const yr=Oe(dt);Q.PostgrestQueryBuilder=yr.default;const vr=Oe(Ge);Q.PostgrestFilterBuilder=vr.default;const wr=Oe(ut);Q.PostgrestTransformBuilder=wr.default;const br=Oe(ht);Q.PostgrestBuilder=br.default;const _r=Oe(ft);Q.PostgrestError=_r.default;var Ts=Q.default={PostgrestClient:mr.default,PostgrestQueryBuilder:yr.default,PostgrestFilterBuilder:vr.default,PostgrestTransformBuilder:wr.default,PostgrestBuilder:br.default,PostgrestError:_r.default};const{PostgrestClient:Cs,PostgrestQueryBuilder:Bi,PostgrestFilterBuilder:Fi,PostgrestTransformBuilder:zi,PostgrestBuilder:Ni,PostgrestError:Wi}=Ts;function Es(){if(typeof WebSocket<"u")return WebSocket;if(typeof global.WebSocket<"u")return global.WebSocket;if(typeof window.WebSocket<"u")return window.WebSocket;if(typeof self.WebSocket<"u")return self.WebSocket;throw new Error("`WebSocket` is not supported in this environment")}const Rs=Es(),As="2.11.13",Ps={"X-Client-Info":`realtime-js/${As}`},Is="1.0.0",xr=1e4,$s=1e3;var Ne;(function(s){s[s.connecting=0]="connecting",s[s.open=1]="open",s[s.closing=2]="closing",s[s.closed=3]="closed"})(Ne||(Ne={}));var K;(function(s){s.closed="closed",s.errored="errored",s.joined="joined",s.joining="joining",s.leaving="leaving"})(K||(K={}));var ie;(function(s){s.close="phx_close",s.error="phx_error",s.join="phx_join",s.reply="phx_reply",s.leave="phx_leave",s.access_token="access_token"})(ie||(ie={}));var jt;(function(s){s.websocket="websocket"})(jt||(jt={}));var ke;(function(s){s.Connecting="connecting",s.Open="open",s.Closing="closing",s.Closed="closed"})(ke||(ke={}));class Os{constructor(){this.HEADER_LENGTH=1}decode(e,t){return e.constructor===ArrayBuffer?t(this._binaryDecode(e)):t(typeof e=="string"?JSON.parse(e):{})}_binaryDecode(e){const t=new DataView(e),r=new TextDecoder;return this._decodeBroadcast(e,t,r)}_decodeBroadcast(e,t,r){const n=t.getUint8(1),i=t.getUint8(2);let o=this.HEADER_LENGTH+2;const a=r.decode(e.slice(o,o+n));o=o+n;const l=r.decode(e.slice(o,o+i));o=o+i;const d=JSON.parse(r.decode(e.slice(o,e.byteLength)));return{ref:null,topic:a,event:l,payload:d}}}class kr{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer)}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var U;(function(s){s.abstime="abstime",s.bool="bool",s.date="date",s.daterange="daterange",s.float4="float4",s.float8="float8",s.int2="int2",s.int4="int4",s.int4range="int4range",s.int8="int8",s.int8range="int8range",s.json="json",s.jsonb="jsonb",s.money="money",s.numeric="numeric",s.oid="oid",s.reltime="reltime",s.text="text",s.time="time",s.timestamp="timestamp",s.timestamptz="timestamptz",s.timetz="timetz",s.tsrange="tsrange",s.tstzrange="tstzrange"})(U||(U={}));const Gt=(s,e,t={})=>{var r;const n=(r=t.skipTypes)!==null&&r!==void 0?r:[];return Object.keys(e).reduce((i,o)=>(i[o]=Ls(o,s,e,n),i),{})},Ls=(s,e,t,r)=>{const n=e.find(a=>a.name===s),i=n==null?void 0:n.type,o=t[s];return i&&!r.includes(i)?Sr(i,o):Tt(o)},Sr=(s,e)=>{if(s.charAt(0)==="_"){const t=s.slice(1,s.length);return Bs(e,t)}switch(s){case U.bool:return Us(e);case U.float4:case U.float8:case U.int2:case U.int4:case U.int8:case U.numeric:case U.oid:return Ds(e);case U.json:case U.jsonb:return Ms(e);case U.timestamp:return Fs(e);case U.abstime:case U.date:case U.daterange:case U.int4range:case U.int8range:case U.money:case U.reltime:case U.text:case U.time:case U.timestamptz:case U.timetz:case U.tsrange:case U.tstzrange:return Tt(e);default:return Tt(e)}},Tt=s=>s,Us=s=>{switch(s){case"t":return!0;case"f":return!1;default:return s}},Ds=s=>{if(typeof s=="string"){const e=parseFloat(s);if(!Number.isNaN(e))return e}return s},Ms=s=>{if(typeof s=="string")try{return JSON.parse(s)}catch(e){return console.log(`JSON parse error: ${e}`),s}return s},Bs=(s,e)=>{if(typeof s!="string")return s;const t=s.length-1,r=s[t];if(s[0]==="{"&&r==="}"){let i;const o=s.slice(1,t);try{i=JSON.parse("["+o+"]")}catch{i=o?o.split(","):[]}return i.map(a=>Sr(e,a))}return s},Fs=s=>typeof s=="string"?s.replace(" ","T"):s,jr=s=>{let e=s;return e=e.replace(/^ws/i,"http"),e=e.replace(/(\/socket\/websocket|\/socket|\/websocket)\/?$/i,""),e.replace(/\/+$/,"")};class vt{constructor(e,t,r={},n=xr){this.channel=e,this.event=t,this.payload=r,this.timeout=n,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var r;return this._hasReceived(e)&&t((r=this.receivedResp)===null||r===void 0?void 0:r.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(r=>r.status===e).forEach(r=>r.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var Kt;(function(s){s.SYNC="sync",s.JOIN="join",s.LEAVE="leave"})(Kt||(Kt={}));class We{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const r=(t==null?void 0:t.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(r.state,{},n=>{const{onJoin:i,onLeave:o,onSync:a}=this.caller;this.joinRef=this.channel._joinRef(),this.state=We.syncState(this.state,n,i,o),this.pendingDiffs.forEach(l=>{this.state=We.syncDiff(this.state,l,i,o)}),this.pendingDiffs=[],a()}),this.channel._on(r.diff,{},n=>{const{onJoin:i,onLeave:o,onSync:a}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(n):(this.state=We.syncDiff(this.state,n,i,o),a())}),this.onJoin((n,i,o)=>{this.channel._trigger("presence",{event:"join",key:n,currentPresences:i,newPresences:o})}),this.onLeave((n,i,o)=>{this.channel._trigger("presence",{event:"leave",key:n,currentPresences:i,leftPresences:o})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,r,n){const i=this.cloneDeep(e),o=this.transformState(t),a={},l={};return this.map(i,(d,c)=>{o[d]||(l[d]=c)}),this.map(o,(d,c)=>{const h=i[d];if(h){const p=c.map(v=>v.presence_ref),g=h.map(v=>v.presence_ref),m=c.filter(v=>g.indexOf(v.presence_ref)<0),y=h.filter(v=>p.indexOf(v.presence_ref)<0);m.length>0&&(a[d]=m),y.length>0&&(l[d]=y)}else a[d]=c}),this.syncDiff(i,{joins:a,leaves:l},r,n)}static syncDiff(e,t,r,n){const{joins:i,leaves:o}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return r||(r=()=>{}),n||(n=()=>{}),this.map(i,(a,l)=>{var d;const c=(d=e[a])!==null&&d!==void 0?d:[];if(e[a]=this.cloneDeep(l),c.length>0){const h=e[a].map(g=>g.presence_ref),p=c.filter(g=>h.indexOf(g.presence_ref)<0);e[a].unshift(...p)}r(a,c,l)}),this.map(o,(a,l)=>{let d=e[a];if(!d)return;const c=l.map(h=>h.presence_ref);d=d.filter(h=>c.indexOf(h.presence_ref)<0),e[a]=d,n(a,d,l),d.length===0&&delete e[a]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(r=>t(r,e[r]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,r)=>{const n=e[r];return"metas"in n?t[r]=n.metas.map(i=>(i.presence_ref=i.phx_ref,delete i.phx_ref,delete i.phx_ref_prev,i)):t[r]=n,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var Vt;(function(s){s.ALL="*",s.INSERT="INSERT",s.UPDATE="UPDATE",s.DELETE="DELETE"})(Vt||(Vt={}));var Yt;(function(s){s.BROADCAST="broadcast",s.PRESENCE="presence",s.POSTGRES_CHANGES="postgres_changes",s.SYSTEM="system"})(Yt||(Yt={}));var de;(function(s){s.SUBSCRIBED="SUBSCRIBED",s.TIMED_OUT="TIMED_OUT",s.CLOSED="CLOSED",s.CHANNEL_ERROR="CHANNEL_ERROR"})(de||(de={}));class Ot{constructor(e,t={config:{}},r){this.topic=e,this.params=t,this.socket=r,this.bindings={},this.state=K.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:""},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new vt(this,ie.join,this.params,this.timeout),this.rejoinTimer=new kr(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=K.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(n=>n.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=K.closed,this.socket._remove(this)}),this._onError(n=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,n),this.state=K.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=K.errored,this.rejoinTimer.scheduleTimeout())}),this._on(ie.reply,{},(n,i)=>{this._trigger(this._replyEventName(i),n)}),this.presence=new We(this),this.broadcastEndpointURL=jr(this.socket.endPoint)+"/api/broadcast",this.private=this.params.config.private||!1}subscribe(e,t=this.timeout){var r,n;if(this.socket.isConnected()||this.socket.connect(),this.state==K.closed){const{config:{broadcast:i,presence:o,private:a}}=this.params;this._onError(c=>e==null?void 0:e(de.CHANNEL_ERROR,c)),this._onClose(()=>e==null?void 0:e(de.CLOSED));const l={},d={broadcast:i,presence:o,postgres_changes:(n=(r=this.bindings.postgres_changes)===null||r===void 0?void 0:r.map(c=>c.filter))!==null&&n!==void 0?n:[],private:a};this.socket.accessTokenValue&&(l.access_token=this.socket.accessTokenValue),this.updateJoinPayload(Object.assign({config:d},l)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",async({postgres_changes:c})=>{var h;if(this.socket.setAuth(),c===void 0){e==null||e(de.SUBSCRIBED);return}else{const p=this.bindings.postgres_changes,g=(h=p==null?void 0:p.length)!==null&&h!==void 0?h:0,m=[];for(let y=0;y<g;y++){const v=p[y],{filter:{event:C,schema:j,table:w,filter:S}}=v,O=c&&c[y];if(O&&O.event===C&&O.schema===j&&O.table===w&&O.filter===S)m.push(Object.assign(Object.assign({},v),{id:O.id}));else{this.unsubscribe(),this.state=K.errored,e==null||e(de.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=m,e&&e(de.SUBSCRIBED);return}}).receive("error",c=>{this.state=K.errored,e==null||e(de.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(c).join(", ")||"error")))}).receive("timeout",()=>{e==null||e(de.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,r){return this._on(e,t,r)}async send(e,t={}){var r,n;if(!this._canPush()&&e.type==="broadcast"){const{event:i,payload:o}=e,l={method:"POST",headers:{Authorization:this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"",apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:i,payload:o,private:this.private}]})};try{const d=await this._fetchWithTimeout(this.broadcastEndpointURL,l,(r=t.timeout)!==null&&r!==void 0?r:this.timeout);return await((n=d.body)===null||n===void 0?void 0:n.cancel()),d.ok?"ok":"error"}catch(d){return d.name==="AbortError"?"timed out":"error"}}else return new Promise(i=>{var o,a,l;const d=this._push(e.type,e,t.timeout||this.timeout);e.type==="broadcast"&&!(!((l=(a=(o=this.params)===null||o===void 0?void 0:o.config)===null||a===void 0?void 0:a.broadcast)===null||l===void 0)&&l.ack)&&i("ok"),d.receive("ok",()=>i("ok")),d.receive("error",()=>i("error")),d.receive("timeout",()=>i("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=K.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(ie.close,"leave",this._joinRef())};this.joinPush.destroy();let r=null;return new Promise(n=>{r=new vt(this,ie.leave,{},e),r.receive("ok",()=>{t(),n("ok")}).receive("timeout",()=>{t(),n("timed out")}).receive("error",()=>{n("error")}),r.send(),this._canPush()||r.trigger("ok",{})}).finally(()=>{r==null||r.destroy()})}teardown(){this.pushBuffer.forEach(e=>e.destroy()),this.rejoinTimer&&clearTimeout(this.rejoinTimer.timer),this.joinPush.destroy()}async _fetchWithTimeout(e,t,r){const n=new AbortController,i=setTimeout(()=>n.abort(),r),o=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:n.signal}));return clearTimeout(i),o}_push(e,t,r=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let n=new vt(this,e,t,r);return this._canPush()?n.send():(n.startTimeout(),this.pushBuffer.push(n)),n}_onMessage(e,t,r){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,r){var n,i;const o=e.toLocaleLowerCase(),{close:a,error:l,leave:d,join:c}=ie;if(r&&[a,l,d,c].indexOf(o)>=0&&r!==this._joinRef())return;let p=this._onMessage(o,t,r);if(t&&!p)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(o)?(n=this.bindings.postgres_changes)===null||n===void 0||n.filter(g=>{var m,y,v;return((m=g.filter)===null||m===void 0?void 0:m.event)==="*"||((v=(y=g.filter)===null||y===void 0?void 0:y.event)===null||v===void 0?void 0:v.toLocaleLowerCase())===o}).map(g=>g.callback(p,r)):(i=this.bindings[o])===null||i===void 0||i.filter(g=>{var m,y,v,C,j,w;if(["broadcast","presence","postgres_changes"].includes(o))if("id"in g){const S=g.id,O=(m=g.filter)===null||m===void 0?void 0:m.event;return S&&((y=t.ids)===null||y===void 0?void 0:y.includes(S))&&(O==="*"||(O==null?void 0:O.toLocaleLowerCase())===((v=t.data)===null||v===void 0?void 0:v.type.toLocaleLowerCase()))}else{const S=(j=(C=g==null?void 0:g.filter)===null||C===void 0?void 0:C.event)===null||j===void 0?void 0:j.toLocaleLowerCase();return S==="*"||S===((w=t==null?void 0:t.event)===null||w===void 0?void 0:w.toLocaleLowerCase())}else return g.type.toLocaleLowerCase()===o}).map(g=>{if(typeof p=="object"&&"ids"in p){const m=p.data,{schema:y,table:v,commit_timestamp:C,type:j,errors:w}=m;p=Object.assign(Object.assign({},{schema:y,table:v,commit_timestamp:C,eventType:j,new:{},old:{},errors:w}),this._getPayloadRecords(m))}g.callback(p,r)})}_isClosed(){return this.state===K.closed}_isJoined(){return this.state===K.joined}_isJoining(){return this.state===K.joining}_isLeaving(){return this.state===K.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,r){const n=e.toLocaleLowerCase(),i={type:n,filter:t,callback:r};return this.bindings[n]?this.bindings[n].push(i):this.bindings[n]=[i],this}_off(e,t){const r=e.toLocaleLowerCase();return this.bindings[r]=this.bindings[r].filter(n=>{var i;return!(((i=n.type)===null||i===void 0?void 0:i.toLocaleLowerCase())===r&&Ot.isEqual(n.filter,t))}),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const r in e)if(e[r]!==t[r])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(ie.close,{},e)}_onError(e){this._on(ie.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=K.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=Gt(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=Gt(e.columns,e.old_record)),t}}const Xt=()=>{},zs=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class Ns{constructor(e,t){var r;this.accessTokenValue=null,this.apiKey=null,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers=Ps,this.params={},this.timeout=xr,this.heartbeatIntervalMs=25e3,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=Xt,this.ref=0,this.logger=Xt,this.conn=null,this.sendBuffer=[],this.serializer=new Os,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._resolveFetch=i=>{let o;return i?o=i:typeof fetch>"u"?o=(...a)=>ye(()=>Promise.resolve().then(()=>$e),void 0,import.meta.url).then(({default:l})=>l(...a)):o=fetch,(...a)=>o(...a)},this.endPoint=`${e}/${jt.websocket}`,this.httpEndpoint=jr(e),t!=null&&t.transport?this.transport=t.transport:this.transport=null,t!=null&&t.params&&(this.params=t.params),t!=null&&t.headers&&(this.headers=Object.assign(Object.assign({},this.headers),t.headers)),t!=null&&t.timeout&&(this.timeout=t.timeout),t!=null&&t.logger&&(this.logger=t.logger),(t!=null&&t.logLevel||t!=null&&t.log_level)&&(this.logLevel=t.logLevel||t.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),t!=null&&t.heartbeatIntervalMs&&(this.heartbeatIntervalMs=t.heartbeatIntervalMs);const n=(r=t==null?void 0:t.params)===null||r===void 0?void 0:r.apikey;if(n&&(this.accessTokenValue=n,this.apiKey=n),this.reconnectAfterMs=t!=null&&t.reconnectAfterMs?t.reconnectAfterMs:i=>[1e3,2e3,5e3,1e4][i-1]||1e4,this.encode=t!=null&&t.encode?t.encode:(i,o)=>o(JSON.stringify(i)),this.decode=t!=null&&t.decode?t.decode:this.serializer.decode.bind(this.serializer),this.reconnectTimer=new kr(async()=>{this.disconnect(),this.connect()},this.reconnectAfterMs),this.fetch=this._resolveFetch(t==null?void 0:t.fetch),t!=null&&t.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.worker=(t==null?void 0:t.worker)||!1,this.workerUrl=t==null?void 0:t.workerUrl}this.accessToken=(t==null?void 0:t.accessToken)||null}connect(){this.conn||(this.transport||(this.transport=Rs),this.conn=new this.transport(this.endpointURL(),void 0,{headers:this.headers}),this.setupConnection())}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:Is}))}disconnect(e,t){this.conn&&(this.conn.onclose=function(){},e?this.conn.close(e,t??""):this.conn.close(),this.conn=null,this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.reset(),this.channels.forEach(r=>r.teardown()))}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.channels=[],this.disconnect(),e}log(e,t,r){this.logger(e,t,r)}connectionState(){switch(this.conn&&this.conn.readyState){case Ne.connecting:return ke.Connecting;case Ne.open:return ke.Open;case Ne.closing:return ke.Closing;default:return ke.Closed}}isConnected(){return this.connectionState()===ke.Open}channel(e,t={config:{}}){const r=`realtime:${e}`,n=this.getChannels().find(i=>i.topic===r);if(n)return n;{const i=new Ot(`realtime:${e}`,t,this);return this.channels.push(i),i}}push(e){const{topic:t,event:r,payload:n,ref:i}=e,o=()=>{this.encode(e,a=>{var l;(l=this.conn)===null||l===void 0||l.send(a)})};this.log("push",`${t} ${r} (${i})`,n),this.isConnected()?o():this.sendBuffer.push(o)}async setAuth(e=null){let t=e||this.accessToken&&await this.accessToken()||this.accessTokenValue;this.accessTokenValue!=t&&(this.accessTokenValue=t,this.channels.forEach(r=>{t&&r.updateJoinPayload({access_token:t,version:this.headers&&this.headers["X-Client-Info"]}),r.joinedOnce&&r._isJoined()&&r._push(ie.access_token,{access_token:t})}))}async sendHeartbeat(){var e;if(!this.isConnected()){this.heartbeatCallback("disconnected");return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection"),this.heartbeatCallback("timeout"),(e=this.conn)===null||e===void 0||e.close($s,"hearbeat timeout");return}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.heartbeatCallback("sent"),await this.setAuth()}onHeartbeat(e){this.heartbeatCallback=e}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(r=>r.topic===e&&(r._isJoined()||r._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t.topic!==e.topic)}setupConnection(){this.conn&&(this.conn.binaryType="arraybuffer",this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e))}_onConnMessage(e){this.decode(e.data,t=>{let{topic:r,event:n,payload:i,ref:o}=t;r==="phoenix"&&n==="phx_reply"&&this.heartbeatCallback(t.payload.status=="ok"?"ok":"error"),o&&o===this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null),this.log("receive",`${i.status||""} ${r} ${n} ${o&&"("+o+")"||""}`,i),Array.from(this.channels).filter(a=>a._isMember(r)).forEach(a=>a._trigger(n,i,o)),this.stateChangeCallbacks.message.forEach(a=>a(t))})}_onConnOpen(){this.log("transport",`connected to ${this.endpointURL()}`),this.flushSendBuffer(),this.reconnectTimer.reset(),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this.stateChangeCallbacks.open.forEach(e=>e())}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=t=>{this.log("worker","worker error",t.message),this.workerRef.terminate()},this.workerRef.onmessage=t=>{t.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_onConnClose(e){this.log("transport","close",e),this._triggerChanError(),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach(t=>t(e))}_onConnError(e){this.log("transport",`${e}`),this._triggerChanError(),this.stateChangeCallbacks.error.forEach(t=>t(e))}_triggerChanError(){this.channels.forEach(e=>e._trigger(ie.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;const r=e.match(/\?/)?"&":"?",n=new URLSearchParams(t);return`${e}${r}${n}`}_workerObjectUrl(e){let t;if(e)t=e;else{const r=new Blob([zs],{type:"application/javascript"});t=URL.createObjectURL(r)}return t}}class Lt extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}}function N(s){return typeof s=="object"&&s!==null&&"__isStorageError"in s}class Ws extends Lt{constructor(e,t){super(e),this.name="StorageApiError",this.status=t}toJSON(){return{name:this.name,message:this.message,status:this.status}}}class Ct extends Lt{constructor(e,t){super(e),this.name="StorageUnknownError",this.originalError=t}}var qs=globalThis&&globalThis.__awaiter||function(s,e,t,r){function n(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(c){try{d(r.next(c))}catch(h){o(h)}}function l(c){try{d(r.throw(c))}catch(h){o(h)}}function d(c){c.done?i(c.value):n(c.value).then(a,l)}d((r=r.apply(s,e||[])).next())})};const Tr=s=>{let e;return s?e=s:typeof fetch>"u"?e=(...t)=>ye(()=>Promise.resolve().then(()=>$e),void 0,import.meta.url).then(({default:r})=>r(...t)):e=fetch,(...t)=>e(...t)},Hs=()=>qs(void 0,void 0,void 0,function*(){return typeof Response>"u"?(yield ye(()=>Promise.resolve().then(()=>$e),void 0,import.meta.url)).Response:Response}),Et=s=>{if(Array.isArray(s))return s.map(t=>Et(t));if(typeof s=="function"||s!==Object(s))return s;const e={};return Object.entries(s).forEach(([t,r])=>{const n=t.replace(/([-_][a-z])/gi,i=>i.toUpperCase().replace(/[-_]/g,""));e[n]=Et(r)}),e};var Se=globalThis&&globalThis.__awaiter||function(s,e,t,r){function n(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(c){try{d(r.next(c))}catch(h){o(h)}}function l(c){try{d(r.throw(c))}catch(h){o(h)}}function d(c){c.done?i(c.value):n(c.value).then(a,l)}d((r=r.apply(s,e||[])).next())})};const wt=s=>s.msg||s.message||s.error_description||s.error||JSON.stringify(s),Js=(s,e,t)=>Se(void 0,void 0,void 0,function*(){const r=yield Hs();s instanceof r&&!(t!=null&&t.noResolveJson)?s.json().then(n=>{e(new Ws(wt(n),s.status||500))}).catch(n=>{e(new Ct(wt(n),n))}):e(new Ct(wt(s),s))}),Gs=(s,e,t,r)=>{const n={method:s,headers:(e==null?void 0:e.headers)||{}};return s==="GET"?n:(n.headers=Object.assign({"Content-Type":"application/json"},e==null?void 0:e.headers),r&&(n.body=JSON.stringify(r)),Object.assign(Object.assign({},n),t))};function Ke(s,e,t,r,n,i){return Se(this,void 0,void 0,function*(){return new Promise((o,a)=>{s(t,Gs(e,r,n,i)).then(l=>{if(!l.ok)throw l;return r!=null&&r.noResolveJson?l:l.json()}).then(l=>o(l)).catch(l=>Js(l,a,r))})})}function lt(s,e,t,r){return Se(this,void 0,void 0,function*(){return Ke(s,"GET",e,t,r)})}function ge(s,e,t,r,n){return Se(this,void 0,void 0,function*(){return Ke(s,"POST",e,r,n,t)})}function Ks(s,e,t,r,n){return Se(this,void 0,void 0,function*(){return Ke(s,"PUT",e,r,n,t)})}function Vs(s,e,t,r){return Se(this,void 0,void 0,function*(){return Ke(s,"HEAD",e,Object.assign(Object.assign({},t),{noResolveJson:!0}),r)})}function Cr(s,e,t,r,n){return Se(this,void 0,void 0,function*(){return Ke(s,"DELETE",e,r,n,t)})}var X=globalThis&&globalThis.__awaiter||function(s,e,t,r){function n(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(c){try{d(r.next(c))}catch(h){o(h)}}function l(c){try{d(r.throw(c))}catch(h){o(h)}}function d(c){c.done?i(c.value):n(c.value).then(a,l)}d((r=r.apply(s,e||[])).next())})};const Ys={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},Qt={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class Xs{constructor(e,t={},r,n){this.url=e,this.headers=t,this.bucketId=r,this.fetch=Tr(n)}uploadOrUpdate(e,t,r,n){return X(this,void 0,void 0,function*(){try{let i;const o=Object.assign(Object.assign({},Qt),n);let a=Object.assign(Object.assign({},this.headers),e==="POST"&&{"x-upsert":String(o.upsert)});const l=o.metadata;typeof Blob<"u"&&r instanceof Blob?(i=new FormData,i.append("cacheControl",o.cacheControl),l&&i.append("metadata",this.encodeMetadata(l)),i.append("",r)):typeof FormData<"u"&&r instanceof FormData?(i=r,i.append("cacheControl",o.cacheControl),l&&i.append("metadata",this.encodeMetadata(l))):(i=r,a["cache-control"]=`max-age=${o.cacheControl}`,a["content-type"]=o.contentType,l&&(a["x-metadata"]=this.toBase64(this.encodeMetadata(l)))),n!=null&&n.headers&&(a=Object.assign(Object.assign({},a),n.headers));const d=this._removeEmptyFolders(t),c=this._getFinalPath(d),h=yield this.fetch(`${this.url}/object/${c}`,Object.assign({method:e,body:i,headers:a},o!=null&&o.duplex?{duplex:o.duplex}:{})),p=yield h.json();return h.ok?{data:{path:d,id:p.Id,fullPath:p.Key},error:null}:{data:null,error:p}}catch(i){if(N(i))return{data:null,error:i};throw i}})}upload(e,t,r){return X(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",e,t,r)})}uploadToSignedUrl(e,t,r,n){return X(this,void 0,void 0,function*(){const i=this._removeEmptyFolders(e),o=this._getFinalPath(i),a=new URL(this.url+`/object/upload/sign/${o}`);a.searchParams.set("token",t);try{let l;const d=Object.assign({upsert:Qt.upsert},n),c=Object.assign(Object.assign({},this.headers),{"x-upsert":String(d.upsert)});typeof Blob<"u"&&r instanceof Blob?(l=new FormData,l.append("cacheControl",d.cacheControl),l.append("",r)):typeof FormData<"u"&&r instanceof FormData?(l=r,l.append("cacheControl",d.cacheControl)):(l=r,c["cache-control"]=`max-age=${d.cacheControl}`,c["content-type"]=d.contentType);const h=yield this.fetch(a.toString(),{method:"PUT",body:l,headers:c}),p=yield h.json();return h.ok?{data:{path:i,fullPath:p.Key},error:null}:{data:null,error:p}}catch(l){if(N(l))return{data:null,error:l};throw l}})}createSignedUploadUrl(e,t){return X(this,void 0,void 0,function*(){try{let r=this._getFinalPath(e);const n=Object.assign({},this.headers);t!=null&&t.upsert&&(n["x-upsert"]="true");const i=yield ge(this.fetch,`${this.url}/object/upload/sign/${r}`,{},{headers:n}),o=new URL(this.url+i.url),a=o.searchParams.get("token");if(!a)throw new Lt("No token returned by API");return{data:{signedUrl:o.toString(),path:e,token:a},error:null}}catch(r){if(N(r))return{data:null,error:r};throw r}})}update(e,t,r){return X(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",e,t,r)})}move(e,t,r){return X(this,void 0,void 0,function*(){try{return{data:yield ge(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:r==null?void 0:r.destinationBucket},{headers:this.headers}),error:null}}catch(n){if(N(n))return{data:null,error:n};throw n}})}copy(e,t,r){return X(this,void 0,void 0,function*(){try{return{data:{path:(yield ge(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:r==null?void 0:r.destinationBucket},{headers:this.headers})).Key},error:null}}catch(n){if(N(n))return{data:null,error:n};throw n}})}createSignedUrl(e,t,r){return X(this,void 0,void 0,function*(){try{let n=this._getFinalPath(e),i=yield ge(this.fetch,`${this.url}/object/sign/${n}`,Object.assign({expiresIn:t},r!=null&&r.transform?{transform:r.transform}:{}),{headers:this.headers});const o=r!=null&&r.download?`&download=${r.download===!0?"":r.download}`:"";return i={signedUrl:encodeURI(`${this.url}${i.signedURL}${o}`)},{data:i,error:null}}catch(n){if(N(n))return{data:null,error:n};throw n}})}createSignedUrls(e,t,r){return X(this,void 0,void 0,function*(){try{const n=yield ge(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:t,paths:e},{headers:this.headers}),i=r!=null&&r.download?`&download=${r.download===!0?"":r.download}`:"";return{data:n.map(o=>Object.assign(Object.assign({},o),{signedUrl:o.signedURL?encodeURI(`${this.url}${o.signedURL}${i}`):null})),error:null}}catch(n){if(N(n))return{data:null,error:n};throw n}})}download(e,t){return X(this,void 0,void 0,function*(){const n=typeof(t==null?void 0:t.transform)<"u"?"render/image/authenticated":"object",i=this.transformOptsToQueryString((t==null?void 0:t.transform)||{}),o=i?`?${i}`:"";try{const a=this._getFinalPath(e);return{data:yield(yield lt(this.fetch,`${this.url}/${n}/${a}${o}`,{headers:this.headers,noResolveJson:!0})).blob(),error:null}}catch(a){if(N(a))return{data:null,error:a};throw a}})}info(e){return X(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{const r=yield lt(this.fetch,`${this.url}/object/info/${t}`,{headers:this.headers});return{data:Et(r),error:null}}catch(r){if(N(r))return{data:null,error:r};throw r}})}exists(e){return X(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{return yield Vs(this.fetch,`${this.url}/object/${t}`,{headers:this.headers}),{data:!0,error:null}}catch(r){if(N(r)&&r instanceof Ct){const n=r.originalError;if([400,404].includes(n==null?void 0:n.status))return{data:!1,error:r}}throw r}})}getPublicUrl(e,t){const r=this._getFinalPath(e),n=[],i=t!=null&&t.download?`download=${t.download===!0?"":t.download}`:"";i!==""&&n.push(i);const a=typeof(t==null?void 0:t.transform)<"u"?"render/image":"object",l=this.transformOptsToQueryString((t==null?void 0:t.transform)||{});l!==""&&n.push(l);let d=n.join("&");return d!==""&&(d=`?${d}`),{data:{publicUrl:encodeURI(`${this.url}/${a}/public/${r}${d}`)}}}remove(e){return X(this,void 0,void 0,function*(){try{return{data:yield Cr(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(t){if(N(t))return{data:null,error:t};throw t}})}list(e,t,r){return X(this,void 0,void 0,function*(){try{const n=Object.assign(Object.assign(Object.assign({},Ys),t),{prefix:e||""});return{data:yield ge(this.fetch,`${this.url}/object/list/${this.bucketId}`,n,{headers:this.headers},r),error:null}}catch(n){if(N(n))return{data:null,error:n};throw n}})}encodeMetadata(e){return JSON.stringify(e)}toBase64(e){return typeof Buffer<"u"?Buffer.from(e).toString("base64"):btoa(e)}_getFinalPath(e){return`${this.bucketId}/${e}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}}const Qs="2.7.1",Zs={"X-Client-Info":`storage-js/${Qs}`};var Ce=globalThis&&globalThis.__awaiter||function(s,e,t,r){function n(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(c){try{d(r.next(c))}catch(h){o(h)}}function l(c){try{d(r.throw(c))}catch(h){o(h)}}function d(c){c.done?i(c.value):n(c.value).then(a,l)}d((r=r.apply(s,e||[])).next())})};class en{constructor(e,t={},r){this.url=e,this.headers=Object.assign(Object.assign({},Zs),t),this.fetch=Tr(r)}listBuckets(){return Ce(this,void 0,void 0,function*(){try{return{data:yield lt(this.fetch,`${this.url}/bucket`,{headers:this.headers}),error:null}}catch(e){if(N(e))return{data:null,error:e};throw e}})}getBucket(e){return Ce(this,void 0,void 0,function*(){try{return{data:yield lt(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(t){if(N(t))return{data:null,error:t};throw t}})}createBucket(e,t={public:!1}){return Ce(this,void 0,void 0,function*(){try{return{data:yield ge(this.fetch,`${this.url}/bucket`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(r){if(N(r))return{data:null,error:r};throw r}})}updateBucket(e,t){return Ce(this,void 0,void 0,function*(){try{return{data:yield Ks(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(r){if(N(r))return{data:null,error:r};throw r}})}emptyBucket(e){return Ce(this,void 0,void 0,function*(){try{return{data:yield ge(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(t){if(N(t))return{data:null,error:t};throw t}})}deleteBucket(e){return Ce(this,void 0,void 0,function*(){try{return{data:yield Cr(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(N(t))return{data:null,error:t};throw t}})}}class tn extends en{constructor(e,t={},r){super(e,t,r)}from(e){return new Xs(this.url,this.headers,e,this.fetch)}}const rn="2.50.1";let ze="";typeof Deno<"u"?ze="deno":typeof document<"u"?ze="web":typeof navigator<"u"&&navigator.product==="ReactNative"?ze="react-native":ze="node";const sn={"X-Client-Info":`supabase-js-${ze}/${rn}`},nn={headers:sn},on={schema:"public"},an={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},ln={};var cn=globalThis&&globalThis.__awaiter||function(s,e,t,r){function n(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(c){try{d(r.next(c))}catch(h){o(h)}}function l(c){try{d(r.throw(c))}catch(h){o(h)}}function d(c){c.done?i(c.value):n(c.value).then(a,l)}d((r=r.apply(s,e||[])).next())})};const dn=s=>{let e;return s?e=s:typeof fetch>"u"?e=ur:e=fetch,(...t)=>e(...t)},un=()=>typeof Headers>"u"?hr:Headers,hn=(s,e,t)=>{const r=dn(t),n=un();return(i,o)=>cn(void 0,void 0,void 0,function*(){var a;const l=(a=yield e())!==null&&a!==void 0?a:s;let d=new n(o==null?void 0:o.headers);return d.has("apikey")||d.set("apikey",s),d.has("Authorization")||d.set("Authorization",`Bearer ${l}`),r(i,Object.assign(Object.assign({},o),{headers:d}))})};var fn=globalThis&&globalThis.__awaiter||function(s,e,t,r){function n(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(c){try{d(r.next(c))}catch(h){o(h)}}function l(c){try{d(r.throw(c))}catch(h){o(h)}}function d(c){c.done?i(c.value):n(c.value).then(a,l)}d((r=r.apply(s,e||[])).next())})};function pn(s){return s.endsWith("/")?s:s+"/"}function gn(s,e){var t,r;const{db:n,auth:i,realtime:o,global:a}=s,{db:l,auth:d,realtime:c,global:h}=e,p={db:Object.assign(Object.assign({},l),n),auth:Object.assign(Object.assign({},d),i),realtime:Object.assign(Object.assign({},c),o),global:Object.assign(Object.assign(Object.assign({},h),a),{headers:Object.assign(Object.assign({},(t=h==null?void 0:h.headers)!==null&&t!==void 0?t:{}),(r=a==null?void 0:a.headers)!==null&&r!==void 0?r:{})}),accessToken:()=>fn(this,void 0,void 0,function*(){return""})};return s.accessToken?p.accessToken=s.accessToken:delete p.accessToken,p}const Er="2.70.0",Pe=30*1e3,Rt=3,bt=Rt*Pe,mn="http://localhost:9999",yn="supabase.auth.token",vn={"X-Client-Info":`gotrue-js/${Er}`},At="X-Supabase-Api-Version",Rr={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},wn=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,bn=6e5;class Ut extends Error{constructor(e,t,r){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=r}}function R(s){return typeof s=="object"&&s!==null&&"__isAuthError"in s}class _n extends Ut{constructor(e,t,r){super(e,t,r),this.name="AuthApiError",this.status=t,this.code=r}}function xn(s){return R(s)&&s.name==="AuthApiError"}class Ar extends Ut{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class ve extends Ut{constructor(e,t,r,n){super(e,r,n),this.name=t,this.status=r}}class pe extends ve{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function kn(s){return R(s)&&s.name==="AuthSessionMissingError"}class rt extends ve{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class st extends ve{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class nt extends ve{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function Sn(s){return R(s)&&s.name==="AuthImplicitGrantRedirectError"}class Zt extends ve{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class Pt extends ve{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}}function _t(s){return R(s)&&s.name==="AuthRetryableFetchError"}class er extends ve{constructor(e,t,r){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=r}}class qe extends ve{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const ct="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),tr=` 	
\r=`.split(""),jn=(()=>{const s=new Array(128);for(let e=0;e<s.length;e+=1)s[e]=-1;for(let e=0;e<tr.length;e+=1)s[tr[e].charCodeAt(0)]=-2;for(let e=0;e<ct.length;e+=1)s[ct[e].charCodeAt(0)]=e;return s})();function rr(s,e,t){if(s!==null)for(e.queue=e.queue<<8|s,e.queuedBits+=8;e.queuedBits>=6;){const r=e.queue>>e.queuedBits-6&63;t(ct[r]),e.queuedBits-=6}else if(e.queuedBits>0)for(e.queue=e.queue<<6-e.queuedBits,e.queuedBits=6;e.queuedBits>=6;){const r=e.queue>>e.queuedBits-6&63;t(ct[r]),e.queuedBits-=6}}function Pr(s,e,t){const r=jn[s];if(r>-1)for(e.queue=e.queue<<6|r,e.queuedBits+=6;e.queuedBits>=8;)t(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(r===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(s)}"`)}}function sr(s){const e=[],t=o=>{e.push(String.fromCodePoint(o))},r={utf8seq:0,codepoint:0},n={queue:0,queuedBits:0},i=o=>{En(o,r,t)};for(let o=0;o<s.length;o+=1)Pr(s.charCodeAt(o),n,i);return e.join("")}function Tn(s,e){if(s<=127){e(s);return}else if(s<=2047){e(192|s>>6),e(128|s&63);return}else if(s<=65535){e(224|s>>12),e(128|s>>6&63),e(128|s&63);return}else if(s<=1114111){e(240|s>>18),e(128|s>>12&63),e(128|s>>6&63),e(128|s&63);return}throw new Error(`Unrecognized Unicode codepoint: ${s.toString(16)}`)}function Cn(s,e){for(let t=0;t<s.length;t+=1){let r=s.charCodeAt(t);if(r>55295&&r<=56319){const n=(r-55296)*1024&65535;r=(s.charCodeAt(t+1)-56320&65535|n)+65536,t+=1}Tn(r,e)}}function En(s,e,t){if(e.utf8seq===0){if(s<=127){t(s);return}for(let r=1;r<6;r+=1)if(!(s>>7-r&1)){e.utf8seq=r;break}if(e.utf8seq===2)e.codepoint=s&31;else if(e.utf8seq===3)e.codepoint=s&15;else if(e.utf8seq===4)e.codepoint=s&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(s<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|s&63,e.utf8seq-=1,e.utf8seq===0&&t(e.codepoint)}}function Rn(s){const e=[],t={queue:0,queuedBits:0},r=n=>{e.push(n)};for(let n=0;n<s.length;n+=1)Pr(s.charCodeAt(n),t,r);return new Uint8Array(e)}function An(s){const e=[];return Cn(s,t=>e.push(t)),new Uint8Array(e)}function Pn(s){const e=[],t={queue:0,queuedBits:0},r=n=>{e.push(n)};return s.forEach(n=>rr(n,t,r)),rr(null,t,r),e.join("")}function In(s){return Math.round(Date.now()/1e3)+s}function $n(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(s){const e=Math.random()*16|0;return(s=="x"?e:e&3|8).toString(16)})}const ne=()=>typeof window<"u"&&typeof document<"u",_e={tested:!1,writable:!1},He=()=>{if(!ne())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(_e.tested)return _e.writable;const s=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(s,s),globalThis.localStorage.removeItem(s),_e.tested=!0,_e.writable=!0}catch{_e.tested=!0,_e.writable=!1}return _e.writable};function On(s){const e={},t=new URL(s);if(t.hash&&t.hash[0]==="#")try{new URLSearchParams(t.hash.substring(1)).forEach((n,i)=>{e[i]=n})}catch{}return t.searchParams.forEach((r,n)=>{e[n]=r}),e}const Ir=s=>{let e;return s?e=s:typeof fetch>"u"?e=(...t)=>ye(()=>Promise.resolve().then(()=>$e),void 0,import.meta.url).then(({default:r})=>r(...t)):e=fetch,(...t)=>e(...t)},Ln=s=>typeof s=="object"&&s!==null&&"status"in s&&"ok"in s&&"json"in s&&typeof s.json=="function",$r=async(s,e,t)=>{await s.setItem(e,JSON.stringify(t))},it=async(s,e)=>{const t=await s.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}},ot=async(s,e)=>{await s.removeItem(e)};class mt{constructor(){this.promise=new mt.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}mt.promiseConstructor=Promise;function xt(s){const e=s.split(".");if(e.length!==3)throw new qe("Invalid JWT structure");for(let r=0;r<e.length;r++)if(!wn.test(e[r]))throw new qe("JWT not in base64url format");return{header:JSON.parse(sr(e[0])),payload:JSON.parse(sr(e[1])),signature:Rn(e[2]),raw:{header:e[0],payload:e[1]}}}async function Un(s){return await new Promise(e=>{setTimeout(()=>e(null),s)})}function Dn(s,e){return new Promise((r,n)=>{(async()=>{for(let i=0;i<1/0;i++)try{const o=await s(i);if(!e(i,null,o)){r(o);return}}catch(o){if(!e(i,o)){n(o);return}}})()})}function Mn(s){return("0"+s.toString(16)).substr(-2)}function Bn(){const e=new Uint32Array(56);if(typeof crypto>"u"){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",r=t.length;let n="";for(let i=0;i<56;i++)n+=t.charAt(Math.floor(Math.random()*r));return n}return crypto.getRandomValues(e),Array.from(e,Mn).join("")}async function Fn(s){const t=new TextEncoder().encode(s),r=await crypto.subtle.digest("SHA-256",t),n=new Uint8Array(r);return Array.from(n).map(i=>String.fromCharCode(i)).join("")}async function zn(s){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),s;const t=await Fn(s);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function Ee(s,e,t=!1){const r=Bn();let n=r;t&&(n+="/PASSWORD_RECOVERY"),await $r(s,`${e}-code-verifier`,n);const i=await zn(r);return[i,r===i?"plain":"s256"]}const Nn=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function Wn(s){const e=s.headers.get(At);if(!e||!e.match(Nn))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function qn(s){if(!s)throw new Error("Missing exp claim");const e=Math.floor(Date.now()/1e3);if(s<=e)throw new Error("JWT has expired")}function Hn(s){switch(s){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}const Jn=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function Re(s){if(!Jn.test(s))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}var Gn=globalThis&&globalThis.__rest||function(s,e){var t={};for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&e.indexOf(r)<0&&(t[r]=s[r]);if(s!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,r=Object.getOwnPropertySymbols(s);n<r.length;n++)e.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(s,r[n])&&(t[r[n]]=s[r[n]]);return t};const xe=s=>s.msg||s.message||s.error_description||s.error||JSON.stringify(s),Kn=[502,503,504];async function nr(s){var e;if(!Ln(s))throw new Pt(xe(s),0);if(Kn.includes(s.status))throw new Pt(xe(s),s.status);let t;try{t=await s.json()}catch(i){throw new Ar(xe(i),i)}let r;const n=Wn(s);if(n&&n.getTime()>=Rr["2024-01-01"].timestamp&&typeof t=="object"&&t&&typeof t.code=="string"?r=t.code:typeof t=="object"&&t&&typeof t.error_code=="string"&&(r=t.error_code),r){if(r==="weak_password")throw new er(xe(t),s.status,((e=t.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(r==="session_not_found")throw new pe}else if(typeof t=="object"&&t&&typeof t.weak_password=="object"&&t.weak_password&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.reasons.reduce((i,o)=>i&&typeof o=="string",!0))throw new er(xe(t),s.status,t.weak_password.reasons);throw new _n(xe(t),s.status||500,r)}const Vn=(s,e,t,r)=>{const n={method:s,headers:(e==null?void 0:e.headers)||{}};return s==="GET"?n:(n.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e==null?void 0:e.headers),n.body=JSON.stringify(r),Object.assign(Object.assign({},n),t))};async function I(s,e,t,r){var n;const i=Object.assign({},r==null?void 0:r.headers);i[At]||(i[At]=Rr["2024-01-01"].name),r!=null&&r.jwt&&(i.Authorization=`Bearer ${r.jwt}`);const o=(n=r==null?void 0:r.query)!==null&&n!==void 0?n:{};r!=null&&r.redirectTo&&(o.redirect_to=r.redirectTo);const a=Object.keys(o).length?"?"+new URLSearchParams(o).toString():"",l=await Yn(s,e,t+a,{headers:i,noResolveJson:r==null?void 0:r.noResolveJson},{},r==null?void 0:r.body);return r!=null&&r.xform?r==null?void 0:r.xform(l):{data:Object.assign({},l),error:null}}async function Yn(s,e,t,r,n,i){const o=Vn(e,r,n,i);let a;try{a=await s(t,Object.assign({},o))}catch(l){throw console.error(l),new Pt(xe(l),0)}if(a.ok||await nr(a),r!=null&&r.noResolveJson)return a;try{return await a.json()}catch(l){await nr(l)}}function ce(s){var e;let t=null;ei(s)&&(t=Object.assign({},s),s.expires_at||(t.expires_at=In(s.expires_in)));const r=(e=s.user)!==null&&e!==void 0?e:s;return{data:{session:t,user:r},error:null}}function ir(s){const e=ce(s);return!e.error&&s.weak_password&&typeof s.weak_password=="object"&&Array.isArray(s.weak_password.reasons)&&s.weak_password.reasons.length&&s.weak_password.message&&typeof s.weak_password.message=="string"&&s.weak_password.reasons.reduce((t,r)=>t&&typeof r=="string",!0)&&(e.data.weak_password=s.weak_password),e}function me(s){var e;return{data:{user:(e=s.user)!==null&&e!==void 0?e:s},error:null}}function Xn(s){return{data:s,error:null}}function Qn(s){const{action_link:e,email_otp:t,hashed_token:r,redirect_to:n,verification_type:i}=s,o=Gn(s,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),a={action_link:e,email_otp:t,hashed_token:r,redirect_to:n,verification_type:i},l=Object.assign({},o);return{data:{properties:a,user:l},error:null}}function Zn(s){return s}function ei(s){return s.access_token&&s.refresh_token&&s.expires_in}const kt=["global","local","others"];var ti=globalThis&&globalThis.__rest||function(s,e){var t={};for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&e.indexOf(r)<0&&(t[r]=s[r]);if(s!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,r=Object.getOwnPropertySymbols(s);n<r.length;n++)e.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(s,r[n])&&(t[r[n]]=s[r[n]]);return t};class ri{constructor({url:e="",headers:t={},fetch:r}){this.url=e,this.headers=t,this.fetch=Ir(r),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)}}async signOut(e,t=kt[0]){if(kt.indexOf(t)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${kt.join(", ")}`);try{return await I(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(r){if(R(r))return{data:null,error:r};throw r}}async inviteUserByEmail(e,t={}){try{return await I(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:me})}catch(r){if(R(r))return{data:{user:null},error:r};throw r}}async generateLink(e){try{const{options:t}=e,r=ti(e,["options"]),n=Object.assign(Object.assign({},r),t);return"newEmail"in r&&(n.new_email=r==null?void 0:r.newEmail,delete n.newEmail),await I(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:n,headers:this.headers,xform:Qn,redirectTo:t==null?void 0:t.redirectTo})}catch(t){if(R(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(e){try{return await I(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:me})}catch(t){if(R(t))return{data:{user:null},error:t};throw t}}async listUsers(e){var t,r,n,i,o,a,l;try{const d={nextPage:null,lastPage:0,total:0},c=await I(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(r=(t=e==null?void 0:e.page)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:"",per_page:(i=(n=e==null?void 0:e.perPage)===null||n===void 0?void 0:n.toString())!==null&&i!==void 0?i:""},xform:Zn});if(c.error)throw c.error;const h=await c.json(),p=(o=c.headers.get("x-total-count"))!==null&&o!==void 0?o:0,g=(l=(a=c.headers.get("link"))===null||a===void 0?void 0:a.split(","))!==null&&l!==void 0?l:[];return g.length>0&&(g.forEach(m=>{const y=parseInt(m.split(";")[0].split("=")[1].substring(0,1)),v=JSON.parse(m.split(";")[1].split("=")[1]);d[`${v}Page`]=y}),d.total=parseInt(p)),{data:Object.assign(Object.assign({},h),d),error:null}}catch(d){if(R(d))return{data:{users:[]},error:d};throw d}}async getUserById(e){Re(e);try{return await I(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:me})}catch(t){if(R(t))return{data:{user:null},error:t};throw t}}async updateUserById(e,t){Re(e);try{return await I(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:me})}catch(r){if(R(r))return{data:{user:null},error:r};throw r}}async deleteUser(e,t=!1){Re(e);try{return await I(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:me})}catch(r){if(R(r))return{data:{user:null},error:r};throw r}}async _listFactors(e){Re(e.userId);try{const{data:t,error:r}=await I(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:n=>({data:{factors:n},error:null})});return{data:t,error:r}}catch(t){if(R(t))return{data:null,error:t};throw t}}async _deleteFactor(e){Re(e.userId),Re(e.id);try{return{data:await I(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if(R(t))return{data:null,error:t};throw t}}}const si={getItem:s=>He()?globalThis.localStorage.getItem(s):null,setItem:(s,e)=>{He()&&globalThis.localStorage.setItem(s,e)},removeItem:s=>{He()&&globalThis.localStorage.removeItem(s)}};function or(s={}){return{getItem:e=>s[e]||null,setItem:(e,t)=>{s[e]=t},removeItem:e=>{delete s[e]}}}function ni(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}const Ae={debug:!!(globalThis&&He()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class Or extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class ii extends Or{}async function oi(s,e,t){Ae.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",s,e);const r=new globalThis.AbortController;return e>0&&setTimeout(()=>{r.abort(),Ae.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",s)},e),await Promise.resolve().then(()=>globalThis.navigator.locks.request(s,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:r.signal},async n=>{if(n){Ae.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",s,n.name);try{return await t()}finally{Ae.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",s,n.name)}}else{if(e===0)throw Ae.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",s),new ii(`Acquiring an exclusive Navigator LockManager lock "${s}" immediately failed`);if(Ae.debug)try{const i=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(i,null,"  "))}catch(i){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",i)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await t()}}))}ni();const ai={url:mn,storageKey:yn,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:vn,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1};async function ar(s,e,t){return await t()}class Je{constructor(e){var t,r;this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log,this.instanceID=Je.nextInstanceID,Je.nextInstanceID+=1,this.instanceID>0&&ne()&&console.warn("Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.");const n=Object.assign(Object.assign({},ai),e);if(this.logDebugMessages=!!n.debug,typeof n.debug=="function"&&(this.logger=n.debug),this.persistSession=n.persistSession,this.storageKey=n.storageKey,this.autoRefreshToken=n.autoRefreshToken,this.admin=new ri({url:n.url,headers:n.headers,fetch:n.fetch}),this.url=n.url,this.headers=n.headers,this.fetch=Ir(n.fetch),this.lock=n.lock||ar,this.detectSessionInUrl=n.detectSessionInUrl,this.flowType=n.flowType,this.hasCustomAuthorizationHeader=n.hasCustomAuthorizationHeader,n.lock?this.lock=n.lock:ne()&&(!((t=globalThis==null?void 0:globalThis.navigator)===null||t===void 0)&&t.locks)?this.lock=oi:this.lock=ar,this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER,this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this)},this.persistSession?n.storage?this.storage=n.storage:He()?this.storage=si:(this.memoryStorage={},this.storage=or(this.memoryStorage)):(this.memoryStorage={},this.storage=or(this.memoryStorage)),ne()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(i){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",i)}(r=this.broadcastChannel)===null||r===void 0||r.addEventListener("message",async i=>{this._debug("received broadcast notification from other tab or client",i),await this._notifyAllSubscribers(i.data.event,i.data.session,!1)})}this.initialize()}_debug(...e){return this.logDebugMessages&&this.logger(`GoTrueClient@${this.instanceID} (${Er}) ${new Date().toISOString()}`,...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(-1,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{const t=On(window.location.href);let r="none";if(this._isImplicitGrantCallback(t)?r="implicit":await this._isPKCECallback(t)&&(r="pkce"),ne()&&this.detectSessionInUrl&&r!=="none"){const{data:n,error:i}=await this._getSessionFromURL(t,r);if(i){if(this._debug("#_initialize()","error detecting session from URL",i),Sn(i)){const l=(e=i.details)===null||e===void 0?void 0:e.code;if(l==="identity_already_exists"||l==="identity_not_found"||l==="single_identity_not_deletable")return{error:i}}return await this._removeSession(),{error:i}}const{session:o,redirectType:a}=n;return this._debug("#_initialize()","detected session in URL",o,"redirect type",a),await this._saveSession(o),setTimeout(async()=>{a==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",o):await this._notifyAllSubscribers("SIGNED_IN",o)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(t){return R(t)?{error:t}:{error:new Ar("Unexpected error during initialization",t)}}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var t,r,n;try{const i=await I(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(r=(t=e==null?void 0:e.options)===null||t===void 0?void 0:t.data)!==null&&r!==void 0?r:{},gotrue_meta_security:{captcha_token:(n=e==null?void 0:e.options)===null||n===void 0?void 0:n.captchaToken}},xform:ce}),{data:o,error:a}=i;if(a||!o)return{data:{user:null,session:null},error:a};const l=o.session,d=o.user;return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",l)),{data:{user:d,session:l},error:null}}catch(i){if(R(i))return{data:{user:null,session:null},error:i};throw i}}async signUp(e){var t,r,n;try{let i;if("email"in e){const{email:c,password:h,options:p}=e;let g=null,m=null;this.flowType==="pkce"&&([g,m]=await Ee(this.storage,this.storageKey)),i=await I(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:p==null?void 0:p.emailRedirectTo,body:{email:c,password:h,data:(t=p==null?void 0:p.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:p==null?void 0:p.captchaToken},code_challenge:g,code_challenge_method:m},xform:ce})}else if("phone"in e){const{phone:c,password:h,options:p}=e;i=await I(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:c,password:h,data:(r=p==null?void 0:p.data)!==null&&r!==void 0?r:{},channel:(n=p==null?void 0:p.channel)!==null&&n!==void 0?n:"sms",gotrue_meta_security:{captcha_token:p==null?void 0:p.captchaToken}},xform:ce})}else throw new st("You must provide either an email or phone number and a password");const{data:o,error:a}=i;if(a||!o)return{data:{user:null,session:null},error:a};const l=o.session,d=o.user;return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",l)),{data:{user:d,session:l},error:null}}catch(i){if(R(i))return{data:{user:null,session:null},error:i};throw i}}async signInWithPassword(e){try{let t;if("email"in e){const{email:i,password:o,options:a}=e;t=await I(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:i,password:o,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}},xform:ir})}else if("phone"in e){const{phone:i,password:o,options:a}=e;t=await I(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:i,password:o,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}},xform:ir})}else throw new st("You must provide either an email or phone number and a password");const{data:r,error:n}=t;return n?{data:{user:null,session:null},error:n}:!r||!r.session||!r.user?{data:{user:null,session:null},error:new rt}:(r.session&&(await this._saveSession(r.session),await this._notifyAllSubscribers("SIGNED_IN",r.session)),{data:Object.assign({user:r.user,session:r.session},r.weak_password?{weakPassword:r.weak_password}:null),error:n})}catch(t){if(R(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOAuth(e){var t,r,n,i;return await this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(r=e.options)===null||r===void 0?void 0:r.scopes,queryParams:(n=e.options)===null||n===void 0?void 0:n.queryParams,skipBrowserRedirect:(i=e.options)===null||i===void 0?void 0:i.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(-1,async()=>this._exchangeCodeForSession(e))}async signInWithWeb3(e){const{chain:t}=e;if(t==="solana")return await this.signInWithSolana(e);throw new Error(`@supabase/auth-js: Unsupported chain "${t}"`)}async signInWithSolana(e){var t,r,n,i,o,a,l,d,c,h,p,g;let m,y;if("message"in e)m=e.message,y=e.signature;else{const{chain:v,wallet:C,statement:j,options:w}=e;let S;if(ne())if(typeof C=="object")S=C;else{const P=window;if("solana"in P&&typeof P.solana=="object"&&("signIn"in P.solana&&typeof P.solana.signIn=="function"||"signMessage"in P.solana&&typeof P.solana.signMessage=="function"))S=P.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof C!="object"||!(w!=null&&w.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");S=C}const O=new URL((t=w==null?void 0:w.url)!==null&&t!==void 0?t:window.location.href);if("signIn"in S&&S.signIn){const P=await S.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},w==null?void 0:w.signInWithSolana),{version:"1",domain:O.host,uri:O.href}),j?{statement:j}:null));let D;if(Array.isArray(P)&&P[0]&&typeof P[0]=="object")D=P[0];else if(P&&typeof P=="object"&&"signedMessage"in P&&"signature"in P)D=P;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in D&&"signature"in D&&(typeof D.signedMessage=="string"||D.signedMessage instanceof Uint8Array)&&D.signature instanceof Uint8Array)m=typeof D.signedMessage=="string"?D.signedMessage:new TextDecoder().decode(D.signedMessage),y=D.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in S)||typeof S.signMessage!="function"||!("publicKey"in S)||typeof S!="object"||!S.publicKey||!("toBase58"in S.publicKey)||typeof S.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");m=[`${O.host} wants you to sign in with your Solana account:`,S.publicKey.toBase58(),...j?["",j,""]:[""],"Version: 1",`URI: ${O.href}`,`Issued At: ${(n=(r=w==null?void 0:w.signInWithSolana)===null||r===void 0?void 0:r.issuedAt)!==null&&n!==void 0?n:new Date().toISOString()}`,...!((i=w==null?void 0:w.signInWithSolana)===null||i===void 0)&&i.notBefore?[`Not Before: ${w.signInWithSolana.notBefore}`]:[],...!((o=w==null?void 0:w.signInWithSolana)===null||o===void 0)&&o.expirationTime?[`Expiration Time: ${w.signInWithSolana.expirationTime}`]:[],...!((a=w==null?void 0:w.signInWithSolana)===null||a===void 0)&&a.chainId?[`Chain ID: ${w.signInWithSolana.chainId}`]:[],...!((l=w==null?void 0:w.signInWithSolana)===null||l===void 0)&&l.nonce?[`Nonce: ${w.signInWithSolana.nonce}`]:[],...!((d=w==null?void 0:w.signInWithSolana)===null||d===void 0)&&d.requestId?[`Request ID: ${w.signInWithSolana.requestId}`]:[],...!((h=(c=w==null?void 0:w.signInWithSolana)===null||c===void 0?void 0:c.resources)===null||h===void 0)&&h.length?["Resources",...w.signInWithSolana.resources.map(D=>`- ${D}`)]:[]].join(`
`);const P=await S.signMessage(new TextEncoder().encode(m),"utf8");if(!P||!(P instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");y=P}}try{const{data:v,error:C}=await I(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:m,signature:Pn(y)},!((p=e.options)===null||p===void 0)&&p.captchaToken?{gotrue_meta_security:{captcha_token:(g=e.options)===null||g===void 0?void 0:g.captchaToken}}:null),xform:ce});if(C)throw C;return!v||!v.session||!v.user?{data:{user:null,session:null},error:new rt}:(v.session&&(await this._saveSession(v.session),await this._notifyAllSubscribers("SIGNED_IN",v.session)),{data:Object.assign({},v),error:C})}catch(v){if(R(v))return{data:{user:null,session:null},error:v};throw v}}async _exchangeCodeForSession(e){const t=await it(this.storage,`${this.storageKey}-code-verifier`),[r,n]=(t??"").split("/");try{const{data:i,error:o}=await I(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:r},xform:ce});if(await ot(this.storage,`${this.storageKey}-code-verifier`),o)throw o;return!i||!i.session||!i.user?{data:{user:null,session:null,redirectType:null},error:new rt}:(i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",i.session)),{data:Object.assign(Object.assign({},i),{redirectType:n??null}),error:o})}catch(i){if(R(i))return{data:{user:null,session:null,redirectType:null},error:i};throw i}}async signInWithIdToken(e){try{const{options:t,provider:r,token:n,access_token:i,nonce:o}=e,a=await I(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:r,id_token:n,access_token:i,nonce:o,gotrue_meta_security:{captcha_token:t==null?void 0:t.captchaToken}},xform:ce}),{data:l,error:d}=a;return d?{data:{user:null,session:null},error:d}:!l||!l.session||!l.user?{data:{user:null,session:null},error:new rt}:(l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",l.session)),{data:l,error:d})}catch(t){if(R(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOtp(e){var t,r,n,i,o;try{if("email"in e){const{email:a,options:l}=e;let d=null,c=null;this.flowType==="pkce"&&([d,c]=await Ee(this.storage,this.storageKey));const{error:h}=await I(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:a,data:(t=l==null?void 0:l.data)!==null&&t!==void 0?t:{},create_user:(r=l==null?void 0:l.shouldCreateUser)!==null&&r!==void 0?r:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},code_challenge:d,code_challenge_method:c},redirectTo:l==null?void 0:l.emailRedirectTo});return{data:{user:null,session:null},error:h}}if("phone"in e){const{phone:a,options:l}=e,{data:d,error:c}=await I(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:a,data:(n=l==null?void 0:l.data)!==null&&n!==void 0?n:{},create_user:(i=l==null?void 0:l.shouldCreateUser)!==null&&i!==void 0?i:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},channel:(o=l==null?void 0:l.channel)!==null&&o!==void 0?o:"sms"}});return{data:{user:null,session:null,messageId:d==null?void 0:d.message_id},error:c}}throw new st("You must provide either an email or phone number.")}catch(a){if(R(a))return{data:{user:null,session:null},error:a};throw a}}async verifyOtp(e){var t,r;try{let n,i;"options"in e&&(n=(t=e.options)===null||t===void 0?void 0:t.redirectTo,i=(r=e.options)===null||r===void 0?void 0:r.captchaToken);const{data:o,error:a}=await I(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:i}}),redirectTo:n,xform:ce});if(a)throw a;if(!o)throw new Error("An error occurred on token verification.");const l=o.session,d=o.user;return l!=null&&l.access_token&&(await this._saveSession(l),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",l)),{data:{user:d,session:l},error:null}}catch(n){if(R(n))return{data:{user:null,session:null},error:n};throw n}}async signInWithSSO(e){var t,r,n;try{let i=null,o=null;return this.flowType==="pkce"&&([i,o]=await Ee(this.storage,this.storageKey)),await I(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(r=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&r!==void 0?r:void 0}),!((n=e==null?void 0:e.options)===null||n===void 0)&&n.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:i,code_challenge_method:o}),headers:this.headers,xform:Xn})}catch(i){if(R(i))return{data:null,error:i};throw i}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:r}=e;if(r)throw r;if(!t)throw new pe;const{error:n}=await I(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return{data:{user:null,session:null},error:n}})}catch(e){if(R(e))return{data:{user:null,session:null},error:e};throw e}}async resend(e){try{const t=`${this.url}/resend`;if("email"in e){const{email:r,type:n,options:i}=e,{error:o}=await I(this.fetch,"POST",t,{headers:this.headers,body:{email:r,type:n,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}},redirectTo:i==null?void 0:i.emailRedirectTo});return{data:{user:null,session:null},error:o}}else if("phone"in e){const{phone:r,type:n,options:i}=e,{data:o,error:a}=await I(this.fetch,"POST",t,{headers:this.headers,body:{phone:r,type:n,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}}});return{data:{user:null,session:null,messageId:o==null?void 0:o.message_id},error:a}}throw new st("You must provide either an email or phone number and a type")}catch(t){if(R(t))return{data:{user:null,session:null},error:t};throw t}}async getSession(){return await this.initializePromise,await this._acquireLock(-1,async()=>this._useSession(async t=>t))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const r=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),n=(async()=>(await r,await t()))();return this.pendingInLock.push((async()=>{try{await n}catch{}})()),n}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const r=t();for(this.pendingInLock.push((async()=>{try{await r}catch{}})()),await r;this.pendingInLock.length;){const n=[...this.pendingInLock];await Promise.all(n),this.pendingInLock.splice(0,n.length)}return await r}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const t=await it(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),t!==null&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const r=e.expires_at?e.expires_at*1e3-Date.now()<bt:!1;if(this._debug("#__loadSession()",`session has${r?"":" not"} expired`,"expires_at",e.expires_at),!r){if(this.storage.isServer){let o=this.suppressGetSessionWarning;e=new Proxy(e,{get:(l,d,c)=>(!o&&d==="user"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),o=!0,this.suppressGetSessionWarning=!0),Reflect.get(l,d,c))})}return{data:{session:e},error:null}}const{session:n,error:i}=await this._callRefreshToken(e.refresh_token);return i?{data:{session:null},error:i}:{data:{session:n},error:null}}finally{this._debug("#__loadSession()","end")}}async getUser(e){return e?await this._getUser(e):(await this.initializePromise,await this._acquireLock(-1,async()=>await this._getUser()))}async _getUser(e){try{return e?await I(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:me}):await this._useSession(async t=>{var r,n,i;const{data:o,error:a}=t;if(a)throw a;return!(!((r=o.session)===null||r===void 0)&&r.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new pe}:await I(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(i=(n=o.session)===null||n===void 0?void 0:n.access_token)!==null&&i!==void 0?i:void 0,xform:me})})}catch(t){if(R(t))return kn(t)&&(await this._removeSession(),await ot(this.storage,`${this.storageKey}-code-verifier`)),{data:{user:null},error:t};throw t}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async r=>{const{data:n,error:i}=r;if(i)throw i;if(!n.session)throw new pe;const o=n.session;let a=null,l=null;this.flowType==="pkce"&&e.email!=null&&([a,l]=await Ee(this.storage,this.storageKey));const{data:d,error:c}=await I(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t==null?void 0:t.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:a,code_challenge_method:l}),jwt:o.access_token,xform:me});if(c)throw c;return o.user=d.user,await this._saveSession(o),await this._notifyAllSubscribers("USER_UPDATED",o),{data:{user:o.user},error:null}})}catch(r){if(R(r))return{data:{user:null},error:r};throw r}}async setSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new pe;const t=Date.now()/1e3;let r=t,n=!0,i=null;const{payload:o}=xt(e.access_token);if(o.exp&&(r=o.exp,n=r<=t),n){const{session:a,error:l}=await this._callRefreshToken(e.refresh_token);if(l)return{data:{user:null,session:null},error:l};if(!a)return{data:{user:null,session:null},error:null};i=a}else{const{data:a,error:l}=await this._getUser(e.access_token);if(l)throw l;i={access_token:e.access_token,refresh_token:e.refresh_token,user:a.user,token_type:"bearer",expires_in:r-t,expires_at:r},await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)}return{data:{user:i.user,session:i},error:null}}catch(t){if(R(t))return{data:{session:null,user:null},error:t};throw t}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var r;if(!e){const{data:o,error:a}=t;if(a)throw a;e=(r=o.session)!==null&&r!==void 0?r:void 0}if(!(e!=null&&e.refresh_token))throw new pe;const{session:n,error:i}=await this._callRefreshToken(e.refresh_token);return i?{data:{user:null,session:null},error:i}:n?{data:{user:n.user,session:n},error:null}:{data:{user:null,session:null},error:null}})}catch(t){if(R(t))return{data:{user:null,session:null},error:t};throw t}}async _getSessionFromURL(e,t){try{if(!ne())throw new nt("No browser detected.");if(e.error||e.error_description||e.error_code)throw new nt(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(t){case"implicit":if(this.flowType==="pkce")throw new Zt("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new nt("Not a valid implicit grant flow url.");break;default:}if(t==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new Zt("No code detected.");const{data:j,error:w}=await this._exchangeCodeForSession(e.code);if(w)throw w;const S=new URL(window.location.href);return S.searchParams.delete("code"),window.history.replaceState(window.history.state,"",S.toString()),{data:{session:j.session,redirectType:null},error:null}}const{provider_token:r,provider_refresh_token:n,access_token:i,refresh_token:o,expires_in:a,expires_at:l,token_type:d}=e;if(!i||!a||!o||!d)throw new nt("No session defined in URL");const c=Math.round(Date.now()/1e3),h=parseInt(a);let p=c+h;l&&(p=parseInt(l));const g=p-c;g*1e3<=Pe&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${g}s, should have been closer to ${h}s`);const m=p-h;c-m>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",m,p,c):c-m<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",m,p,c);const{data:y,error:v}=await this._getUser(i);if(v)throw v;const C={provider_token:r,provider_refresh_token:n,access_token:i,expires_in:h,expires_at:p,refresh_token:o,token_type:d,user:y.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),{data:{session:C,redirectType:e.type},error:null}}catch(r){if(R(r))return{data:{session:null,redirectType:null},error:r};throw r}}_isImplicitGrantCallback(e){return!!(e.access_token||e.error_description)}async _isPKCECallback(e){const t=await it(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var r;const{data:n,error:i}=t;if(i)return{error:i};const o=(r=n.session)===null||r===void 0?void 0:r.access_token;if(o){const{error:a}=await this.admin.signOut(o,e);if(a&&!(xn(a)&&(a.status===404||a.status===401||a.status===403)))return{error:a}}return e!=="others"&&(await this._removeSession(),await ot(this.storage,`${this.storageKey}-code-verifier`)),{error:null}})}onAuthStateChange(e){const t=$n(),r={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,r),(async()=>(await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(t)})))(),{data:{subscription:r}}}async _emitInitialSession(e){return await this._useSession(async t=>{var r,n;try{const{data:{session:i},error:o}=t;if(o)throw o;await((r=this.stateChangeEmitters.get(e))===null||r===void 0?void 0:r.callback("INITIAL_SESSION",i)),this._debug("INITIAL_SESSION","callback id",e,"session",i)}catch(i){await((n=this.stateChangeEmitters.get(e))===null||n===void 0?void 0:n.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",i),console.error(i)}})}async resetPasswordForEmail(e,t={}){let r=null,n=null;this.flowType==="pkce"&&([r,n]=await Ee(this.storage,this.storageKey,!0));try{return await I(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:r,code_challenge_method:n,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(i){if(R(i))return{data:null,error:i};throw i}}async getUserIdentities(){var e;try{const{data:t,error:r}=await this.getUser();if(r)throw r;return{data:{identities:(e=t.user.identities)!==null&&e!==void 0?e:[]},error:null}}catch(t){if(R(t))return{data:null,error:t};throw t}}async linkIdentity(e){var t;try{const{data:r,error:n}=await this._useSession(async i=>{var o,a,l,d,c;const{data:h,error:p}=i;if(p)throw p;const g=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(o=e.options)===null||o===void 0?void 0:o.redirectTo,scopes:(a=e.options)===null||a===void 0?void 0:a.scopes,queryParams:(l=e.options)===null||l===void 0?void 0:l.queryParams,skipBrowserRedirect:!0});return await I(this.fetch,"GET",g,{headers:this.headers,jwt:(c=(d=h.session)===null||d===void 0?void 0:d.access_token)!==null&&c!==void 0?c:void 0})});if(n)throw n;return ne()&&!(!((t=e.options)===null||t===void 0)&&t.skipBrowserRedirect)&&window.location.assign(r==null?void 0:r.url),{data:{provider:e.provider,url:r==null?void 0:r.url},error:null}}catch(r){if(R(r))return{data:{provider:e.provider,url:null},error:r};throw r}}async unlinkIdentity(e){try{return await this._useSession(async t=>{var r,n;const{data:i,error:o}=t;if(o)throw o;return await I(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(n=(r=i.session)===null||r===void 0?void 0:r.access_token)!==null&&n!==void 0?n:void 0})})}catch(t){if(R(t))return{data:null,error:t};throw t}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const r=Date.now();return await Dn(async n=>(n>0&&await Un(200*Math.pow(2,n-1)),this._debug(t,"refreshing attempt",n),await I(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:ce})),(n,i)=>{const o=200*Math.pow(2,n);return i&&_t(i)&&Date.now()+o-r<Pe})}catch(r){if(this._debug(t,"error",r),R(r))return{data:{session:null,user:null},error:r};throw r}finally{this._debug(t,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const r=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",r),ne()&&!t.skipBrowserRedirect&&window.location.assign(r),{data:{provider:e,url:r},error:null}}async _recoverAndRefresh(){var e;const t="#_recoverAndRefresh()";this._debug(t,"begin");try{const r=await it(this.storage,this.storageKey);if(this._debug(t,"session from storage",r),!this._isValidSession(r)){this._debug(t,"session is not valid"),r!==null&&await this._removeSession();return}const n=((e=r.expires_at)!==null&&e!==void 0?e:1/0)*1e3-Date.now()<bt;if(this._debug(t,`session has${n?"":" not"} expired with margin of ${bt}s`),n){if(this.autoRefreshToken&&r.refresh_token){const{error:i}=await this._callRefreshToken(r.refresh_token);i&&(console.error(i),_t(i)||(this._debug(t,"refresh failed with a non-retryable error, removing the session",i),await this._removeSession()))}}else await this._notifyAllSubscribers("SIGNED_IN",r)}catch(r){this._debug(t,"error",r),console.error(r);return}finally{this._debug(t,"end")}}async _callRefreshToken(e){var t,r;if(!e)throw new pe;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const n=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(n,"begin");try{this.refreshingDeferred=new mt;const{data:i,error:o}=await this._refreshAccessToken(e);if(o)throw o;if(!i.session)throw new pe;await this._saveSession(i.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",i.session);const a={session:i.session,error:null};return this.refreshingDeferred.resolve(a),a}catch(i){if(this._debug(n,"error",i),R(i)){const o={session:null,error:i};return _t(i)||await this._removeSession(),(t=this.refreshingDeferred)===null||t===void 0||t.resolve(o),o}throw(r=this.refreshingDeferred)===null||r===void 0||r.reject(i),i}finally{this.refreshingDeferred=null,this._debug(n,"end")}}async _notifyAllSubscribers(e,t,r=!0){const n=`#_notifyAllSubscribers(${e})`;this._debug(n,"begin",t,`broadcast = ${r}`);try{this.broadcastChannel&&r&&this.broadcastChannel.postMessage({event:e,session:t});const i=[],o=Array.from(this.stateChangeEmitters.values()).map(async a=>{try{await a.callback(e,t)}catch(l){i.push(l)}});if(await Promise.all(o),i.length>0){for(let a=0;a<i.length;a+=1)console.error(i[a]);throw i[0]}}finally{this._debug(n,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0,await $r(this.storage,this.storageKey,e)}async _removeSession(){this._debug("#_removeSession()"),await ot(this.storage,this.storageKey),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&ne()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),Pe);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async t=>{const{data:{session:r}}=t;if(!r||!r.refresh_token||!r.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const n=Math.floor((r.expires_at*1e3-e)/Pe);this._debug("#_autoRefreshTokenTick()",`access token expires in ${n} ticks, a tick lasts ${Pe}ms, refresh threshold is ${Rt} ticks`),n<=Rt&&await this._callRefreshToken(r.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof Or)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!ne()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(-1,async()=>{if(document.visibilityState!=="visible"){this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,r){const n=[`provider=${encodeURIComponent(t)}`];if(r!=null&&r.redirectTo&&n.push(`redirect_to=${encodeURIComponent(r.redirectTo)}`),r!=null&&r.scopes&&n.push(`scopes=${encodeURIComponent(r.scopes)}`),this.flowType==="pkce"){const[i,o]=await Ee(this.storage,this.storageKey),a=new URLSearchParams({code_challenge:`${encodeURIComponent(i)}`,code_challenge_method:`${encodeURIComponent(o)}`});n.push(a.toString())}if(r!=null&&r.queryParams){const i=new URLSearchParams(r.queryParams);n.push(i.toString())}return r!=null&&r.skipBrowserRedirect&&n.push(`skip_http_redirect=${r.skipBrowserRedirect}`),`${e}?${n.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var r;const{data:n,error:i}=t;return i?{data:null,error:i}:await I(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(r=n==null?void 0:n.session)===null||r===void 0?void 0:r.access_token})})}catch(t){if(R(t))return{data:null,error:t};throw t}}async _enroll(e){try{return await this._useSession(async t=>{var r,n;const{data:i,error:o}=t;if(o)return{data:null,error:o};const a=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:{issuer:e.issuer}),{data:l,error:d}=await I(this.fetch,"POST",`${this.url}/factors`,{body:a,headers:this.headers,jwt:(r=i==null?void 0:i.session)===null||r===void 0?void 0:r.access_token});return d?{data:null,error:d}:(e.factorType==="totp"&&(!((n=l==null?void 0:l.totp)===null||n===void 0)&&n.qr_code)&&(l.totp.qr_code=`data:image/svg+xml;utf-8,${l.totp.qr_code}`),{data:l,error:null})})}catch(t){if(R(t))return{data:null,error:t};throw t}}async _verify(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var r;const{data:n,error:i}=t;if(i)return{data:null,error:i};const{data:o,error:a}=await I(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:{code:e.code,challenge_id:e.challengeId},headers:this.headers,jwt:(r=n==null?void 0:n.session)===null||r===void 0?void 0:r.access_token});return a?{data:null,error:a}:(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+o.expires_in},o)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",o),{data:o,error:a})})}catch(t){if(R(t))return{data:null,error:t};throw t}})}async _challenge(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var r;const{data:n,error:i}=t;return i?{data:null,error:i}:await I(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:{channel:e.channel},headers:this.headers,jwt:(r=n==null?void 0:n.session)===null||r===void 0?void 0:r.access_token})})}catch(t){if(R(t))return{data:null,error:t};throw t}})}async _challengeAndVerify(e){const{data:t,error:r}=await this._challenge({factorId:e.factorId});return r?{data:null,error:r}:await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){const{data:{user:e},error:t}=await this.getUser();if(t)return{data:null,error:t};const r=(e==null?void 0:e.factors)||[],n=r.filter(o=>o.factor_type==="totp"&&o.status==="verified"),i=r.filter(o=>o.factor_type==="phone"&&o.status==="verified");return{data:{all:r,totp:n,phone:i},error:null}}async _getAuthenticatorAssuranceLevel(){return this._acquireLock(-1,async()=>await this._useSession(async e=>{var t,r;const{data:{session:n},error:i}=e;if(i)return{data:null,error:i};if(!n)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:o}=xt(n.access_token);let a=null;o.aal&&(a=o.aal);let l=a;((r=(t=n.user.factors)===null||t===void 0?void 0:t.filter(h=>h.status==="verified"))!==null&&r!==void 0?r:[]).length>0&&(l="aal2");const c=o.amr||[];return{data:{currentLevel:a,nextLevel:l,currentAuthenticationMethods:c},error:null}}))}async fetchJwk(e,t={keys:[]}){let r=t.keys.find(o=>o.kid===e);if(r||(r=this.jwks.keys.find(o=>o.kid===e),r&&this.jwks_cached_at+bn>Date.now()))return r;const{data:n,error:i}=await I(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(i)throw i;if(!n.keys||n.keys.length===0)throw new qe("JWKS is empty");if(this.jwks=n,this.jwks_cached_at=Date.now(),r=n.keys.find(o=>o.kid===e),!r)throw new qe("No matching signing key found in JWKS");return r}async getClaims(e,t={keys:[]}){try{let r=e;if(!r){const{data:g,error:m}=await this.getSession();if(m||!g.session)return{data:null,error:m};r=g.session.access_token}const{header:n,payload:i,signature:o,raw:{header:a,payload:l}}=xt(r);if(qn(i.exp),!n.kid||n.alg==="HS256"||!("crypto"in globalThis&&"subtle"in globalThis.crypto)){const{error:g}=await this.getUser(r);if(g)throw g;return{data:{claims:i,header:n,signature:o},error:null}}const d=Hn(n.alg),c=await this.fetchJwk(n.kid,t),h=await crypto.subtle.importKey("jwk",c,d,!0,["verify"]);if(!await crypto.subtle.verify(d,h,o,An(`${a}.${l}`)))throw new qe("Invalid JWT signature");return{data:{claims:i,header:n,signature:o},error:null}}catch(r){if(R(r))return{data:null,error:r};throw r}}}Je.nextInstanceID=0;const li=Je;class ci extends li{constructor(e){super(e)}}var di=globalThis&&globalThis.__awaiter||function(s,e,t,r){function n(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(c){try{d(r.next(c))}catch(h){o(h)}}function l(c){try{d(r.throw(c))}catch(h){o(h)}}function d(c){c.done?i(c.value):n(c.value).then(a,l)}d((r=r.apply(s,e||[])).next())})};class ui{constructor(e,t,r){var n,i,o;if(this.supabaseUrl=e,this.supabaseKey=t,!e)throw new Error("supabaseUrl is required.");if(!t)throw new Error("supabaseKey is required.");const a=pn(e),l=new URL(a);this.realtimeUrl=new URL("realtime/v1",l),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",l),this.storageUrl=new URL("storage/v1",l),this.functionsUrl=new URL("functions/v1",l);const d=`sb-${l.hostname.split(".")[0]}-auth-token`,c={db:on,realtime:ln,auth:Object.assign(Object.assign({},an),{storageKey:d}),global:nn},h=gn(r??{},c);this.storageKey=(n=h.auth.storageKey)!==null&&n!==void 0?n:"",this.headers=(i=h.global.headers)!==null&&i!==void 0?i:{},h.accessToken?(this.accessToken=h.accessToken,this.auth=new Proxy({},{get:(p,g)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(g)} is not possible`)}})):this.auth=this._initSupabaseAuthClient((o=h.auth)!==null&&o!==void 0?o:{},this.headers,h.global.fetch),this.fetch=hn(t,this._getAccessToken.bind(this),h.global.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers,accessToken:this._getAccessToken.bind(this)},h.realtime)),this.rest=new Cs(new URL("rest/v1",l).href,{headers:this.headers,schema:h.db.schema,fetch:this.fetch}),h.accessToken||this._listenForAuthEvents()}get functions(){return new ss(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}get storage(){return new tn(this.storageUrl.href,this.headers,this.fetch)}from(e){return this.rest.from(e)}schema(e){return this.rest.schema(e)}rpc(e,t={},r={}){return this.rest.rpc(e,t,r)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}_getAccessToken(){var e,t;return di(this,void 0,void 0,function*(){if(this.accessToken)return yield this.accessToken();const{data:r}=yield this.auth.getSession();return(t=(e=r.session)===null||e===void 0?void 0:e.access_token)!==null&&t!==void 0?t:null})}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:r,storage:n,storageKey:i,flowType:o,lock:a,debug:l},d,c){const h={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new ci({url:this.authUrl.href,headers:Object.assign(Object.assign({},h),d),storageKey:i,autoRefreshToken:e,persistSession:t,detectSessionInUrl:r,storage:n,flowType:o,lock:a,debug:l,fetch:c,hasCustomAuthorizationHeader:"Authorization"in this.headers})}_initRealtimeClient(e){return new Ns(this.realtimeUrl.href,Object.assign(Object.assign({},e),{params:Object.assign({apikey:this.supabaseKey},e==null?void 0:e.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((t,r)=>{this._handleTokenChanged(t,"CLIENT",r==null?void 0:r.access_token)})}_handleTokenChanged(e,t,r){(e==="TOKEN_REFRESHED"||e==="SIGNED_IN")&&this.changedAccessToken!==r?this.changedAccessToken=r:e==="SIGNED_OUT"&&(this.realtime.setAuth(),t=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}}const hi=(s,e,t)=>new ui(s,e,t),fi=hi("https://ynzikfmpzhtohwsfniqv.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InluemlrZm1wemh0b2h3c2ZuaXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwNjc5NzYsImV4cCI6MjA2NTY0Mzk3Nn0.uHIXkVvI03vjZ0XdLPkkznME1K0ivDJ6FVU2VeoJdHc",{auth:{persistSession:!1,autoRefreshToken:!1}});function pi(){const[s,e]=b.useState(null),[t,r]=b.useState(!0);return b.useEffect(()=>{var a,l;(async()=>{var d,c;try{const h=await((d=window.electronAPI)==null?void 0:d.authGetUser());e(((c=h==null?void 0:h.data)==null?void 0:c.user)||null)}catch(h){console.error("❌ Failed to get initial user:",h),e(null)}finally{r(!1)}})(),(async()=>{var d;try{await((d=window.electronAPI)==null?void 0:d.authSetupListener())}catch(c){console.error("❌ Failed to setup auth listener:",c)}})();const o=({event:d,session:c})=>{e((c==null?void 0:c.user)??null),r(!1)};return(l=(a=window.electronAPI)==null?void 0:a.onAuthStateChange)==null||l.call(a,o),()=>{}},[]),{user:s,loading:t}}/**
 * @license lucide-react v0.534.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gi=s=>s.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),mi=s=>s.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,t,r)=>r?r.toUpperCase():t.toLowerCase()),lr=s=>{const e=mi(s);return e.charAt(0).toUpperCase()+e.slice(1)},Lr=(...s)=>s.filter((e,t,r)=>!!e&&e.trim()!==""&&r.indexOf(e)===t).join(" ").trim(),yi=s=>{for(const e in s)if(e.startsWith("aria-")||e==="role"||e==="title")return!0};/**
 * @license lucide-react v0.534.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var vi={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.534.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wi=b.forwardRef(({color:s="currentColor",size:e=24,strokeWidth:t=2,absoluteStrokeWidth:r,className:n="",children:i,iconNode:o,...a},l)=>b.createElement("svg",{ref:l,...vi,width:e,height:e,stroke:s,strokeWidth:r?Number(t)*24/Number(e):t,className:Lr("lucide",n),...!i&&!yi(a)&&{"aria-hidden":"true"},...a},[...o.map(([d,c])=>b.createElement(d,c)),...Array.isArray(i)?i:[i]]));/**
 * @license lucide-react v0.534.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=(s,e)=>{const t=b.forwardRef(({className:r,...n},i)=>b.createElement(wi,{ref:i,iconNode:e,className:Lr(`lucide-${gi(lr(s))}`,`lucide-${s}`,r),...n}));return t.displayName=lr(s),t};/**
 * @license lucide-react v0.534.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bi=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],_i=Ve("copy",bi);/**
 * @license lucide-react v0.534.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xi=[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]],cr=Ve("message-circle",xi);/**
 * @license lucide-react v0.534.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ki=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],Si=Ve("refresh-cw",ki);/**
 * @license lucide-react v0.534.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ji=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],Ti=Ve("send",ji);/**
 * @license lucide-react v0.534.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ci=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],Ei=Ve("x",Ci),Ur=`You are a helpful radiology AI assistant. The user will ask you questions about the radiology report or related concepts. You should answer clearly and accurately using the provided report context.

IMPORTANT: You MUST cite sources for all medical information you provide. This is mandatory for maintaining credibility and educational value.

Guidelines:
1. Answer questions based on the provided radiology report context
2. Explain medical terminology and concepts in clear, accessible language
3. ALWAYS cite sources when providing medical information - this is required, not optional
4. Cite specific findings from the report when relevant - quote exact phrases from the report
5. When discussing general radiology concepts, provide accurate medical information WITH sources
6. If asked about treatment or clinical decisions, remind the user to consult with their healthcare provider
7. For references, prefer well-known organizations (ACR, RSNA, peer-reviewed journals like Radiology, AJR, RadioGraphics)
8. If you cannot verify a specific reference, use general but accurate attributions
9. Be honest about limitations - if something is unclear or outside your expertise, say so
10. NEVER fabricate or hallucinate specific citations, article titles, authors, or publication dates

Required Citation Format:
- For every medical claim or fact, include a source
- When citing the report: "As noted in the provided report..."
- For guidelines: "According to ACR guidelines..." or "Per RSNA recommendations..."
- For general principles: "Based on established radiology literature..." or "According to standard radiology practice..."
- For educational information: "As described in radiology textbooks..." or "Per radiologic teaching principles..."
- If uncertain about specific source: "According to widely accepted radiologic practice..." or "Based on consensus in the radiology community..."

Examples of proper citation:
- "The BI-RADS classification system, as defined by the ACR, categorizes breast findings..."
- "According to the Fleischner Society guidelines, pulmonary nodules..."
- "Per standard radiologic anatomy references, the liver segments are..."
- "As noted in the provided report, there is evidence of..."

Remember: You are an educational assistant. Do not attempt to modify the report or make clinical diagnoses. Every piece of medical information must have an appropriate source citation.`;async function dr(s,e="claude-3-sonnet"){var t,r,n;try{const i=s.some(a=>a.role==="system"&&a.content.includes("helpful radiology AI assistant"));let o=s;if(i||(o=[{role:"system",content:Ur},...s]),(t=window.electronAPI)!=null&&t.sendChatMessage){const a=await window.electronAPI.sendChatMessage({messages:o,provider:e});return{text:a.text||a,tokens:a.tokens}}else{const a=await((n=(r=window.electronAPI)==null?void 0:r.generateReport)==null?void 0:n.call(r,JSON.stringify({messages:o,type:"chat",provider:e})));if(typeof a=="string")return{text:a};if(a)return{text:a.text||a,tokens:a.tokens};throw new Error("No response received from API")}}catch(i){return console.error("Chat API error:",i),{text:"",error:i instanceof Error?i.message:"Failed to send chat message"}}}async function Ri(s,e,t){var r,n,i;try{if(!(s!=null&&s.trim()))throw new Error("report_id is required and cannot be empty");console.log("🔐 Creating session via IPC with:",{reportId:s,studyType:e||"null",reportSnapshot:t?`${t.substring(0,50)}...`:"null"});const o=await((n=(r=window.electron)==null?void 0:r.ipcRenderer)==null?void 0:n.invoke("chat-create-session",s,e,t));if(o!=null&&o.error)throw new Error(o.error);return console.log("✅ Session created successfully via IPC:",(i=o.data)==null?void 0:i.id),{data:o.data,error:null}}catch(o){return console.error("❌ createSession failed:",o),{data:null,error:o instanceof Error?o:new Error("Unknown error occurred")}}}async function Ai(s){var e,t;try{if(!(s!=null&&s.trim()))throw new Error("session_id is required");console.log("📖 Getting session via IPC:",s);const r=await((t=(e=window.electron)==null?void 0:e.ipcRenderer)==null?void 0:t.invoke("chat-get-session",s));if(r!=null&&r.error)throw new Error(r.error);return{data:r.data,error:null}}catch(r){return console.error("❌ getSession failed:",r),{data:null,error:r instanceof Error?r:new Error("Unknown error occurred")}}}async function at(s,e){var t,r;try{if(!(s!=null&&s.trim()))throw new Error("session_id is required");if(!e)throw new Error("message is required");console.log("💬 Appending message via IPC to session:",s);const n=await((r=(t=window.electron)==null?void 0:t.ipcRenderer)==null?void 0:r.invoke("chat-append-message",s,e));if(n!=null&&n.error)throw new Error(n.error);return{data:n.data,error:null}}catch(n){return console.error("❌ appendMessage failed:",n),{data:null,error:n instanceof Error?n:new Error("Unknown error occurred")}}}function Pi({userId:s,studyType:e,reportText:t,reportId:r,sessionId:n,onClose:i}){const[o,a]=b.useState([]),[l,d]=b.useState(""),[c,h]=b.useState(!1),[p,g]=b.useState(n||""),[m,y]=b.useState(null),[v,C]=b.useState({x:0,y:0}),[j,w]=b.useState({width:800,height:600}),[S,O]=b.useState(!1),[P,D]=b.useState(!1),[ee,Le]=b.useState({x:0,y:0}),[ue,Ye]=b.useState({x:0,y:0,width:0,height:0}),le=b.useRef(null),Ue=b.useRef(null),Xe=b.useRef(null);b.useEffect(()=>{(async()=>{try{if(p){const{data:A,error:q}=await Ai(p);if(q)throw q;A&&A.messages&&a(A.messages)}else{const A={role:"system",content:`${Ur}

This is the current radiology report for reference:

${t}`,timestamp:new Date},V=r||(()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(H){const Z=Math.random()*16|0;return(H=="x"?Z:Z&3|8).toString(16)}))(),{data:F,error:re}=await Ri(V,e,t);if(re)throw re;F&&(g(F.id),a([A]),await at(F.id,A))}}catch(A){console.error("Failed to initialize session:",{error:A instanceof Error?A.message:A,fullError:JSON.stringify(A,null,2)}),y(`Failed to initialize chat session: ${A instanceof Error?A.message:"Unknown error"}`)}})()},[s,e,t]),b.useEffect(()=>{var T;(T=le.current)==null||T.scrollIntoView({behavior:"smooth"})},[o]);const De=async()=>{var A,q;if(!l.trim()||c)return;const T={role:"user",content:l.trim(),timestamp:new Date};a(V=>[...V,T]),d(""),h(!0),y(null);try{const V=await((q=(A=window.electronAPI)==null?void 0:A.getSelectedModel)==null?void 0:q.call(A))||"claude-3-sonnet",F=o.concat(T).map(({role:H,content:Z})=>({role:H,content:Z})),re=await dr(F,V);if(re.error)throw new Error(re.error);if(re.text){const H={role:"assistant",content:re.text,timestamp:new Date};a(Z=>[...Z,H]),p&&(await at(p,T),await at(p,H))}else throw new Error("No response received")}catch(V){console.error("Failed to send message:",V),y("Failed to get response. Please try again.")}finally{h(!1)}},oe=T=>{T.key==="Enter"&&!T.shiftKey&&(T.preventDefault(),De())},Me=T=>{const A=T.target;A.closest(".drag-handle")&&!A.closest("button")&&!A.closest("input")&&!A.closest("textarea")&&(O(!0),Le({x:T.clientX-v.x,y:T.clientY-v.y}),T.preventDefault())},W=T=>{if(S)C({x:T.clientX-ee.x,y:T.clientY-ee.y});else if(P){const A=Math.max(400,ue.width+(T.clientX-ue.x)),q=Math.max(300,ue.height+(T.clientY-ue.y));w({width:A,height:q})}},Qe=()=>{O(!1),D(!1)},ae=T=>{T.stopPropagation(),T.preventDefault(),D(!0),Ye({x:T.clientX,y:T.clientY,width:j.width,height:j.height})};b.useEffect(()=>{if(S||P)return document.addEventListener("mousemove",W),document.addEventListener("mouseup",Qe),()=>{document.removeEventListener("mousemove",W),document.removeEventListener("mouseup",Qe)}},[S,P,ee,ue]);const Ze=async()=>{var q,V;if(o.length<2||c)return;let T=-1;for(let F=o.length-1;F>=0;F--)if(o[F].role==="user"){T=F;break}if(T===-1)return;const A=o.slice(0,T+1);a(A),o[T],h(!0),y(null);try{const F=await((V=(q=window.electronAPI)==null?void 0:q.getSelectedModel)==null?void 0:V.call(q))||"claude-3-sonnet",re=A.map(({role:Z,content:we})=>({role:Z,content:we})),H=await dr(re,F);if(H.error)throw new Error(H.error);if(H.text){const Z={role:"assistant",content:H.text,timestamp:new Date};a(we=>[...we,Z]),p&&await at(p,Z)}}catch(F){console.error("Failed to regenerate response:",F),y("Failed to regenerate response. Please try again.")}finally{h(!1)}},he=()=>{const T=o.filter(A=>A.role!=="system").map(A=>`${A.role.toUpperCase()}: ${A.content}`).join(`

`);navigator.clipboard.writeText(T)};return u.jsx("div",{ref:Xe,style:{position:"fixed",top:v.y===0?"50%":`${v.y+window.innerHeight/2}px`,left:v.x===0?"50%":`${v.x+window.innerWidth/2}px`,transform:"translate(-50%, -50%)",width:`${j.width}px`,height:`${j.height}px`,minWidth:"400px",minHeight:"300px",maxWidth:"95vw",maxHeight:"95vh",zIndex:1e3,display:"flex",flexDirection:"column",cursor:S?"grabbing":P?"nw-resize":"default"},onMouseDown:Me,children:u.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column",padding:"20px",gap:"16px",backgroundColor:"rgba(30, 30, 30, 0.98)",border:"1px solid rgba(255, 255, 255, 0.2)",borderRadius:"16px",color:"#ffffff",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.5)",position:"relative"},children:[u.jsxs("div",{className:"drag-handle",style:{display:"flex",justifyContent:"space-between",alignItems:"center",paddingBottom:"12px",borderBottom:"1px solid rgba(255, 255, 255, 0.1)",cursor:"grab",userSelect:"none"},children:[u.jsxs("div",{children:[u.jsx("h3",{style:{margin:0,fontSize:"18px",fontWeight:600},children:"Ask AI Assistant"}),u.jsx("p",{style:{margin:"4px 0 0 0",fontSize:"12px",opacity:.7},children:"Assistant will not modify your report"})]}),u.jsxs("div",{style:{display:"flex",gap:"8px"},children:[u.jsx("button",{onClick:he,style:{background:"rgba(255, 255, 255, 0.1)",border:"none",borderRadius:"6px",padding:"6px",cursor:"pointer",opacity:o.length>1?1:.5,pointerEvents:o.length>1?"auto":"none"},title:"Copy conversation",children:u.jsx(_i,{size:16})}),u.jsx("button",{onClick:i,style:{background:"rgba(255, 255, 255, 0.1)",border:"none",borderRadius:"6px",padding:"6px",cursor:"pointer"},children:u.jsx(Ei,{size:16})})]})]}),u.jsxs("div",{style:{flex:1,overflowY:"auto",overflowX:"hidden",padding:"12px",display:"flex",flexDirection:"column",gap:"12px",backgroundColor:"rgba(20, 20, 20, 0.8)",borderRadius:"8px",border:"1px solid rgba(255, 255, 255, 0.1)",minHeight:"0",scrollBehavior:"smooth"},children:[o.filter(T=>T.role!=="system").map((T,A)=>u.jsxs("div",{style:{alignSelf:T.role==="user"?"flex-end":"flex-start",maxWidth:"80%",display:"flex",flexDirection:"column",gap:"4px"},children:[u.jsx("div",{style:{background:T.role==="user"?"rgba(59, 130, 246, 0.8)":"rgba(70, 70, 70, 0.9)",borderRadius:"12px",padding:"12px 16px",wordBreak:"break-word",color:"#ffffff",border:"1px solid rgba(255, 255, 255, 0.1)"},children:u.jsx("div",{style:{whiteSpace:"pre-wrap"},children:T.content})}),T.timestamp&&u.jsx("div",{style:{fontSize:"11px",opacity:.5,paddingX:"8px",alignSelf:T.role==="user"?"flex-end":"flex-start"},children:new Date(T.timestamp).toLocaleTimeString()})]},A)),c&&u.jsx("div",{style:{alignSelf:"flex-start",maxWidth:"80%",background:"rgba(70, 70, 70, 0.9)",borderRadius:"12px",padding:"12px 16px",display:"flex",alignItems:"center",gap:"8px",color:"#ffffff",border:"1px solid rgba(255, 255, 255, 0.1)"},children:u.jsx("div",{className:"loading-dots",children:"Thinking..."})}),m&&u.jsx("div",{style:{background:"rgba(239, 68, 68, 0.8)",borderRadius:"8px",padding:"8px 12px",fontSize:"14px",color:"#ffffff",border:"1px solid rgba(239, 68, 68, 0.5)"},children:m}),u.jsx("div",{ref:le})]}),u.jsxs("div",{style:{display:"flex",gap:"8px",paddingTop:"12px",borderTop:"1px solid rgba(255, 255, 255, 0.1)"},children:[u.jsx("textarea",{ref:Ue,value:l,onChange:T=>d(T.target.value),onKeyDown:oe,placeholder:"Ask a question about the report or radiology concepts...",disabled:c,autoFocus:!0,style:{flex:1,minHeight:"60px",maxHeight:"120px",background:"rgba(40, 40, 40, 0.9)",border:"1px solid rgba(255, 255, 255, 0.3)",borderRadius:"8px",padding:"8px 12px",fontSize:"14px",resize:"vertical",outline:"none",fontFamily:"inherit",color:"#ffffff",pointerEvents:"auto",zIndex:"auto",userSelect:"text",WebkitUserSelect:"text"}}),u.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"8px"},children:[u.jsx("button",{onClick:De,disabled:!l.trim()||c,style:{background:"rgba(59, 130, 246, 0.2)",border:"none",borderRadius:"8px",padding:"12px",cursor:"pointer",opacity:!l.trim()||c?.5:1,transition:"opacity 0.2s"},title:"Send message",children:u.jsx(Ti,{size:18})}),u.jsx("button",{onClick:Ze,disabled:o.filter(T=>T.role==="assistant").length===0||c,style:{background:"rgba(255, 255, 255, 0.1)",border:"none",borderRadius:"8px",padding:"8px",cursor:"pointer",opacity:o.filter(T=>T.role==="assistant").length===0||c?.5:1},title:"Regenerate last response",children:u.jsx(Si,{size:16})})]})]}),u.jsx("div",{onMouseDown:ae,style:{position:"absolute",bottom:"4px",right:"4px",width:"16px",height:"16px",cursor:"se-resize",background:"linear-gradient(-45deg, transparent 30%, rgba(255,255,255,0.5) 30%, rgba(255,255,255,0.5) 35%, transparent 35%, transparent 65%, rgba(255,255,255,0.5) 65%, rgba(255,255,255,0.5) 70%, transparent 70%)",borderRadius:"2px",zIndex:10},title:"Drag to resize"})]})})}function Ii(){const[s,e]=b.useState("unknown"),[t,r]=b.useState(""),[n,i]=b.useState(""),{user:o,loading:a}=pi(),[l,d]=b.useState(!1),[c,h]=b.useState(""),[p,g]=b.useState(null),[m,y]=b.useState(""),[v,C]=b.useState(""),[j,w]=b.useState(""),[S,O]=b.useState(!1),[P,D]=b.useState([]),[ee,Le]=b.useState([]),[ue,Ye]=b.useState(350),[le,Ue]=b.useState(160),[Xe,De]=b.useState(400),[oe,Me]=b.useState(""),[W,Qe]=b.useState(""),[ae,Ze]=b.useState(!1),[he,T]=b.useState(160),[A,q]=b.useState(null),[V,F]=b.useState(null),[re,H]=b.useState(!1),[Z,we]=b.useState(void 0);b.useEffect(()=>{const f=localStorage.getItem("colorScheme");f&&(f==="venice-blue"||f==="dark-ocean"||f==="lawrencium"||f==="deep-space"||f==="void-black"||f==="yoda")?(document.body.className=document.body.className.replace(/color-scheme-[\w-]+/g,""),document.body.classList.add(`color-scheme-${f}`)):(document.body.className=document.body.className.replace(/color-scheme-[\w-]+/g,""),document.body.classList.add("color-scheme-void-black"))},[]);const M=(f,_)=>{g({message:f,type:_}),setTimeout(()=>g(null),3e3)},Dr=f=>f.replace(/~~([^~]+)~~/g,"").replace(/—+/g,"").replace(/\n\s*\n\s*\n/g,`

`).trim(),Dt=async()=>{var f,_,k,E;if(!m.trim()){M("Please enter refinement instructions","error");return}if(!S){O(!0);try{const z=Dr(c||t),J=s==="impression-only",L=await((_=(f=window.electronAPI)==null?void 0:f.readPrompt)==null?void 0:_.call(f,J?"refine_impression":"refine_report"));if(!L||L.trim()===""){M("Could not read refinement template","error"),O(!1);return}const G=L.replace("{{REFINEMENT_INPUT}}",m.trim()).replace(J?"{{IMPRESSION_TEXT}}":"{{REPORT_TEXT}}",z),$=await((E=(k=window.electronAPI)==null?void 0:k.generateReport)==null?void 0:E.call(k,G));if($){const Y=typeof $=="string"?$:$.text,be=typeof $=="string"?null:$.tokens,se=t,Te=v;w(se),Te||C(se),D(fe=>[...fe,se]),Le([]),r(Y),h(Y),be&&F(be),y(""),M("Report refined successfully!","success")}else M("Failed to refine report","error")}catch(z){console.error("Refinement error:",z),M("Error during refinement","error")}finally{O(!1)}}},Mt=()=>{if(P.length===0){M("No refinements to undo","error");return}const f=P[P.length-1];Le(_=>[..._,t]),D(_=>_.slice(0,-1)),setTimeout(()=>{P.length>1?w(P[P.length-2]):w(""),r(f),h(f),M("Refinement undone","success")},10)},Bt=()=>{if(ee.length===0){M("No refinements to redo","error");return}const f=ee[ee.length-1];D(_=>[..._,t]),Le(_=>_.slice(0,-1)),setTimeout(()=>{w(t),r(f),h(f),M("Refinement redone","success")},10)},Ft=async()=>{var f,_;if(!oe.trim()){M("Please enter feedback instructions","error");return}if(!W){M("Study type not available for feedback processing","error");return}if(!(o!=null&&o.id)){M("User authentication required for feedback processing","error");return}Ze(!0);try{const{getCurrentAgentLogic:k}=await ye(()=>import("./updateAgentLogicIPC.js"),[],import.meta.url),E=await k(o.id,W);if(E.error){M(`Failed to load current logic: ${E.error}`,"error");return}const{EDIT_LOGIC_SYSTEM_PROMPT:z}=await ye(()=>import("./editLogicSystemPrompt.js"),[],import.meta.url),J=`${z}

Current logic:
${JSON.stringify(E.logic,null,2)}

User instruction: ${oe.trim()}`,L=await((_=(f=window.electronAPI)==null?void 0:f.generateReportWithProvider)==null?void 0:_.call(f,J,"claude-sonnet"));if(!L){M("Failed to process feedback with Claude","error");return}const G=typeof L=="string"?L:(L==null?void 0:L.text)||"",$=(L==null?void 0:L.tokens)||{input:0,output:0,total:0};$.total>0&&F($);let Y;try{Y=JSON.parse(G)}catch{console.error("Failed to parse JSON response from Claude:",G),M("Invalid response format from AI","error");return}const{updateAgentLogic:be}=await ye(()=>import("./updateAgentLogicIPC.js"),[],import.meta.url),se=await be(o.id,W,Y);if(!se.success){M(`Failed to update logic: ${se.error}`,"error");return}const Te=s==="impression-only"?"impressions":"reports",fe=$.total>0?` (${$.input} + ${$.output} = ${$.total} tokens)`:"";M(`✅ Logic updated successfully! Future ${Te} for ${W} will incorporate your feedback.${fe}`,"success"),Me("")}catch(k){console.error("Feedback processing error:",k),M("Error processing feedback","error")}finally{Ze(!1)}},Mr=(f,_)=>{const k=G=>G.replace(/[ \t]+/g," "),E=k(f),z=k(_),J=Kr(E,z),L=[];for(let G=0;G<J.length;G++){const $=J[G];if(J[G+1],$.value.match(/^[.,:;!?]\s*$/)&&!$.added&&!$.removed&&L.length>0){const Y=L[L.length-1];if(Y.added===$.added&&Y.removed===$.removed){Y.value+=$.value;continue}}if($.value.trim()===""&&$.value.length>1){$.value.includes(`
`)?L.push($):L.push({...$,value:" "});continue}if($.value.includes(`
`)){L.push($);continue}L.push($)}return L},Be=b.useMemo(()=>{if(s!=="gpt-diff"||!t)return null;const f=j||n;if(!f)return null;const _=f.trim(),k=t.trim();return Mr(_,k)},[s,n,t,j]),zt=f=>{const _=f.value.includes(`
`),k=f.value.trim()==="",E={padding:_||k?"0":"2px 4px",margin:_||k?"0":"0 1px",borderRadius:_||k?"0":"3px",display:"inline",lineHeight:"1.4",fontSize:"14px",fontFamily:"monospace",whiteSpace:"pre-wrap",verticalAlign:"baseline"};return f.added?{...E,backgroundColor:_||k?"transparent":"#0d4f2a",color:_||k?"#e5e7eb":"#4ade80",fontWeight:_||k?"normal":"600",border:_||k?"none":"1px solid #16a34a"}:f.removed?{...E,backgroundColor:_||k?"transparent":"#5c1f1f",color:_||k?"#e5e7eb":"#f87171",textDecoration:_||k?"none":"line-through",fontWeight:_||k?"normal":"600",border:_||k?"none":"1px solid #dc2626",opacity:_||k?"1":"0.8"}:{...E,backgroundColor:"transparent",color:"#e5e7eb",border:"none",margin:0,padding:0}},Br=()=>{const f=document.querySelector("[contenteditable]");if(f){f.querySelectorAll('span[style*="line-through"]').forEach(E=>E.remove());let k=f.innerText.replace(/~~([^~]+)~~/g,"").replace(/—+/g,"").replace(/\n\s*\n\s*\n/g,`

`).trim();if(h(k),Be){const z=Be.filter(J=>!J.removed).map((J,L)=>{const G=zt(J);return`<span key="${L}" style="${Object.entries(G).map(([$,Y])=>`${$.replace(/([A-Z])/g,"-$1").toLowerCase()}:${Y}`).join(";")}">${J.value.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</span>`}).join("");f.innerHTML=z}}},Nt=Xr(o,s==="template-manager"||s==="logic-manager"),Wt=l?Nt.templates:{},qt=l?Nt.saveTemplate:()=>{};b.useEffect(()=>{var f,_,k,E,z,J,L,G,$,Y,be,se,Te,fe,yt;(_=(f=window.electronAPI)==null?void 0:f.getTextboxSize)==null||_.call(f,"diffBoxHeight").then(x=>{x&&Ye(x)}),(E=(k=window.electronAPI)==null?void 0:k.getTextboxSize)==null||E.call(k,"refinementBoxHeight").then(x=>{x&&Ue(x)}),(J=(z=window.electronAPI)==null?void 0:z.getTextboxSize)==null||J.call(z,"mainTextareaHeight").then(x=>{x&&De(x)}),(G=(L=window.electronAPI)==null?void 0:L.getTextboxSize)==null||G.call(L,"feedbackBoxHeight").then(x=>{x&&T(x)}),(Y=($=window.electron)==null?void 0:$.ipcRenderer)==null||Y.invoke("get-supabase-session").then(x=>{x?(console.log("🧠 Setting Supabase session in popup"),fi.auth.setSession(x)):console.warn("⚠️ No Supabase session received in popup")}),(be=window.electronAPI)==null||be.onPopupContent(x=>{console.log("📥 popup-content received:",JSON.stringify(x,null,2)),console.log("📥 popup-content data type:",typeof x),console.log("📥 popup-content keys:",x?Object.keys(x):"null/undefined"),x!=null&&x.studyType&&Qe(x.studyType),x!=null&&x.generationTime&&q(x.generationTime),x!=null&&x.totalTokens&&F(x.totalTokens),(x==null?void 0:x.type)==="template-manager"?(d(!0),e("template-manager")):(x==null?void 0:x.type)==="logic-manager"?(d(!0),e("logic-manager")):(x==null?void 0:x.type)==="impression-only"?(e("impression-only"),r(x.result||""),h(x.result||"")):(x==null?void 0:x.type)==="report-only"?(e("report-only"),r(x.result||""),h(x.result||"")):typeof x=="object"&&x.template&&x.result?(e("gpt-diff"),i(x.template),r(x.result),h(x.result)):(x==null?void 0:x.type)==="loading"?e("loading"):e("unknown")}),(Te=(se=window.electronAPI)==null?void 0:se.onPopupTokens)==null||Te.call(se,x=>{console.log("📊 popup-tokens received:",JSON.stringify(x,null,2)),x!=null&&x.generationTime&&q(x.generationTime),x!=null&&x.totalTokens&&F(x.totalTokens)}),(yt=(fe=window.electronAPI)==null?void 0:fe.onWindowFocus)==null||yt.call(fe,x=>{document.body.classList.toggle("radpal-focused",x)})},[]),b.useEffect(()=>{s==="gpt-diff"&&t&&h(t)},[s,t]);const je=u.jsxs("div",{style:{display:"flex",gap:6},children:[u.jsx("button",{onClick:()=>window.electron.ipcRenderer.send("minimize-popup"),style:{fontSize:"13px",width:24,height:24,borderRadius:4,background:"#1c1e23",color:"#ccc",border:"none"},children:"–"}),u.jsx("button",{onClick:()=>window.electron.ipcRenderer.send("close-popup"),style:{fontSize:"13px",width:24,height:24,borderRadius:4,background:"#E36756",color:"#fff",border:"none"},children:"×"})]}),Fr=()=>s==="loading"?u.jsxs("div",{className:"popup-container",style:{height:"100vh",overflowY:"auto"},children:[u.jsx("div",{style:{height:"30px",backgroundColor:"transparent",WebkitAppRegion:"drag",position:"sticky",top:0,zIndex:1e3,display:"flex",justifyContent:"flex-end",alignItems:"center",paddingRight:"10px"},onDoubleClick:f=>f.preventDefault(),children:u.jsx("div",{style:{WebkitAppRegion:"no-drag"},children:je})}),u.jsx("div",{style:{padding:"20px",fontFamily:"Inter, sans-serif",fontWeight:600,fontSize:"16px",color:"#1a202c",textShadow:"none",paddingTop:"10px"},children:u.jsx("div",{style:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",minHeight:"calc(100vh - 70px)"},children:u.jsx("span",{style:{fontSize:14,opacity:.8,fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:400,color:"#1a202c",textShadow:"none"},children:"⟳ Generating..."})})})]}):s==="template-manager"?u.jsx("div",{className:"window-frame",children:u.jsxs("div",{style:{height:"100vh",overflowY:"auto",scrollbarWidth:"none",msOverflowStyle:"none"},children:[u.jsx("div",{style:{height:"30px",backgroundColor:"transparent",WebkitAppRegion:"drag",position:"sticky",top:0,zIndex:1e3,display:"flex",justifyContent:"flex-end",alignItems:"center",paddingRight:"10px"},onDoubleClick:f=>f.preventDefault(),children:u.jsx("div",{style:{WebkitAppRegion:"no-drag"},children:je})}),u.jsx("div",{style:{padding:20,fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:400,fontSize:"16px",color:"#1a202c",textShadow:"none",paddingTop:"10px"},children:u.jsx(Vr,{templates:Wt,onSave:(f,_,k,E)=>{console.log("💾 Attempting to save:",f),qt(f,_,k,E).then(()=>M("✓ Saved!","success")).catch(z=>{console.error("❌ Save failed",z),M("✗ Save failed","error")})}})})]})}):s==="logic-manager"?u.jsx("div",{className:"window-frame",children:u.jsxs("div",{style:{height:"100vh",overflowY:"auto",scrollbarWidth:"none",msOverflowStyle:"none"},children:[u.jsx("div",{style:{height:"30px",backgroundColor:"transparent",WebkitAppRegion:"drag",position:"sticky",top:0,zIndex:1e3,display:"flex",justifyContent:"flex-end",alignItems:"center",paddingRight:"10px"},onDoubleClick:f=>f.preventDefault(),children:u.jsx("div",{style:{WebkitAppRegion:"no-drag"},children:je})}),u.jsx("div",{style:{padding:20,fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:400,fontSize:"16px",color:"#1a202c",textShadow:"none",paddingTop:"10px"},children:u.jsx(Yr,{templates:Wt,onSave:(f,_,k,E)=>{console.log("💾 Attempting to save logic:",f),qt(f,_,k,E).then(()=>M("✓ Saved!","success")).catch(z=>{console.error("❌ Save failed",z),M("✗ Save failed","error")})}})})]})}):s==="gpt-diff"?u.jsxs("div",{className:"popup-container",style:{height:"100vh",overflowY:"auto"},children:[u.jsx("div",{style:{height:"30px",backgroundColor:"transparent",WebkitAppRegion:"drag",position:"sticky",top:0,zIndex:1e3,display:"flex",justifyContent:"flex-end",alignItems:"center",paddingRight:"10px"},onDoubleClick:f=>f.preventDefault(),children:u.jsx("div",{style:{WebkitAppRegion:"no-drag"},children:je})}),u.jsx("div",{style:{padding:"20px",fontFamily:"Inter, sans-serif",fontWeight:600,fontSize:"16px",color:"#1a202c",textShadow:"none",paddingTop:"10px"},children:u.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:12},children:[u.jsx("div",{style:{display:"flex",gap:8,alignItems:"center"},children:u.jsx(B,{children:u.jsx("button",{className:"radpal-button radpal-button-remove",onClick:Br,style:{border:"none"},children:"✖ Remove Strikeouts"})})}),u.jsxs("div",{style:{display:"flex",gap:16,alignItems:"center"},children:[A&&u.jsxs("span",{style:{fontSize:14,color:"#fff",textShadow:"none",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:400},children:["Time: ",A,"s"]}),V&&u.jsxs("span",{style:{fontSize:14,color:"#fff",textShadow:"none",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:400},children:["Tokens: ",V.total.toLocaleString()]}),u.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[u.jsx(B,{children:u.jsx("button",{className:"radpal-button radpal-button-impression",onClick:()=>navigator.clipboard.writeText(c||t),style:{border:"none"},children:"↗ Copy to Clipboard"})}),u.jsx(B,{children:u.jsxs("button",{onClick:()=>{we(void 0),H(!0)},className:"radpal-button",style:{backgroundColor:"#3b82f6",border:"none",width:"100%"},children:[u.jsx(cr,{size:16,style:{verticalAlign:"middle",marginRight:"4px"}}),"Ask AI"]})})]})]})]})}),u.jsx("div",{contentEditable:!0,suppressContentEditableWarning:!0,className:"popup-diff-box",onInput:f=>h(f.currentTarget.innerText),style:{backgroundColor:"#1e1f25",border:"none",borderRadius:"8px",padding:"16px",minHeight:"200px",maxHeight:"600px",height:`${ue}px`,resize:"none",overflowY:"auto",lineHeight:"1.6",fontSize:"14px",fontFamily:"monospace",whiteSpace:"pre-wrap",wordBreak:"break-word"},onMouseUp:()=>{var _,k;const f=document.querySelector(".popup-diff-box");if(f){const E=parseInt(getComputedStyle(f).height);E!==ue&&(Ye(E),(k=(_=window.electronAPI)==null?void 0:_.saveTextboxSize)==null||k.call(_,"diffBoxHeight",E))}},children:u.jsx("div",{style:{display:"inline"},children:S?u.jsx("span",{style:{fontSize:14,opacity:.8,color:"#fff"},children:"⟳ Generating..."}):(Be==null?void 0:Be.map((f,_)=>u.jsx("span",{style:zt(f),children:f.value},`diff-${_}-${f.added?"add":f.removed?"rem":"same"}`)))||u.jsx("span",{children:"No differences to show"})})},`diff-${t.length}-${j.length}`),u.jsx("div",{style:{display:"flex",justifyContent:"center",marginTop:80},children:u.jsxs("div",{style:{width:"95%",position:"relative"},children:[u.jsx("div",{style:{position:"absolute",top:0,left:0,zIndex:10,transform:"translateY(-130%)",marginBottom:20},children:u.jsx(B,{children:u.jsx("button",{onClick:Dt,disabled:S||!m.trim(),className:"radpal-button radpal-button-impression",style:{opacity:S||!m.trim()?.5:1,backgroundColor:"#3ABC96",border:"none",fontSize:"12px",padding:"4px 8px"},children:S?"Refining...":"Refine Report"})})}),u.jsx("textarea",{value:m,onChange:f=>y(f.target.value),placeholder:"Describe how you'd like to improve the report... (e.g., 'make it more concise', 'change tone to more assertive', 'add details about disc desiccation')",disabled:S,className:"popup-output-textarea",style:{width:"95%",minHeight:`${le}px`,height:`${le}px`,resize:"none",padding:"16px",backgroundColor:"#1e1f25",color:"#fff",border:"none",borderRadius:"16px",fontSize:"18px",fontFamily:"monospace",lineHeight:"1.5",whiteSpace:"pre-wrap",margin:"0 auto",display:"block",outline:"none",boxSizing:"border-box"},onFocus:f=>f.currentTarget.style.borderColor="transparent",onBlur:f=>f.currentTarget.style.borderColor="transparent",onMouseUp:f=>{var k,E;const _=parseInt(getComputedStyle(f.currentTarget).height);_!==le&&(Ue(_),(E=(k=window.electronAPI)==null?void 0:k.saveTextboxSize)==null||E.call(k,"refinementBoxHeight",_))}}),u.jsx("div",{style:{display:"flex",justifyContent:"flex-end",alignItems:"center",marginTop:"10px"},children:u.jsxs("div",{style:{display:"flex",gap:"8px"},children:[P.length>0&&u.jsx(B,{children:u.jsx("button",{onClick:Mt,disabled:S,className:"radpal-button radpal-button-remove",style:{opacity:S?.5:1,backgroundColor:"transparent",border:"none"},children:"↶ Undo"})}),ee.length>0&&u.jsx(B,{children:u.jsx("button",{onClick:Bt,disabled:S,className:"radpal-button radpal-button-impression",style:{opacity:S?.5:1,backgroundColor:"transparent",border:"none"},children:"↷ Redo"})})]})})]})}),u.jsx("div",{style:{display:"flex",justifyContent:"center",marginTop:80},children:u.jsxs("div",{style:{width:"95%",position:"relative"},children:[u.jsx("div",{style:{position:"absolute",top:0,left:0,zIndex:10,transform:"translateY(-130%)",marginBottom:20},children:u.jsx(B,{children:u.jsx("button",{onClick:Ft,disabled:ae||!oe.trim()||!W,className:"radpal-button radpal-button-impression",style:{opacity:ae||!oe.trim()||!W?.5:1,backgroundColor:"#3ABC96",border:"none",fontSize:"12px",padding:"4px 8px"},children:ae?"Processing...":"Apply Feedback"})})}),u.jsx("textarea",{value:oe,onChange:f=>Me(f.target.value),placeholder:"Enter feedback to improve future report generation...",disabled:ae,className:"popup-output-textarea",style:{width:"95%",minHeight:`${he}px`,height:`${he}px`,resize:"none",padding:"16px",backgroundColor:"#1e1f25",color:"#fff",border:"none",borderRadius:"16px",fontSize:"18px",fontFamily:"monospace",lineHeight:"1.5",whiteSpace:"pre-wrap",margin:"0 auto",display:"block",outline:"none",boxSizing:"border-box"},onFocus:f=>f.currentTarget.style.borderColor="transparent",onBlur:f=>f.currentTarget.style.borderColor="transparent",onMouseUp:f=>{var k,E;const _=parseInt(getComputedStyle(f.currentTarget).height);_!==he&&(T(_),(E=(k=window.electronAPI)==null?void 0:k.saveTextboxSize)==null||E.call(k,"feedbackBoxHeight",_))}}),u.jsx("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:"20px"},children:u.jsx("div",{style:{fontSize:"16px",color:"#1a202c",textShadow:"none",fontFamily:"Inter, sans-serif",fontWeight:600},children:W?`Study Type: ${W}`:"Study type not detected"})})]})})]}):s==="impression-only"||s==="report-only"?u.jsxs("div",{className:"popup-container",style:{height:"100vh",overflowY:"auto"},children:[u.jsx("div",{style:{height:"30px",backgroundColor:"transparent",WebkitAppRegion:"drag",position:"sticky",top:0,zIndex:1e3,display:"flex",justifyContent:"flex-end",alignItems:"center",paddingRight:"10px"},onDoubleClick:f=>f.preventDefault(),children:u.jsx("div",{style:{WebkitAppRegion:"no-drag"},children:je})}),u.jsxs("div",{style:{padding:"20px",fontFamily:"Inter, sans-serif",fontWeight:600,fontSize:"16px",color:"#1a202c",textShadow:"none",paddingTop:"10px"},children:[u.jsx("div",{style:{display:"flex",justifyContent:"flex-end",alignItems:"center",marginBottom:12},children:u.jsxs("div",{style:{display:"flex",gap:16,alignItems:"center"},children:[A&&u.jsxs("span",{style:{fontSize:14,color:"#fff",textShadow:"none",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:400},children:["Time: ",A,"s"]}),V&&u.jsxs("span",{style:{fontSize:14,color:"#fff",textShadow:"none",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:400},children:["Tokens: ",V.total.toLocaleString()]}),u.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[u.jsx(B,{children:u.jsx("button",{className:"radpal-button radpal-button-impression",onClick:()=>navigator.clipboard.writeText(c),style:{border:"none"},children:"↗ Copy to Clipboard"})}),u.jsx(B,{children:u.jsxs("button",{onClick:()=>{we(void 0),H(!0)},className:"radpal-button",style:{backgroundColor:"#3b82f6",border:"none",width:"100%"},children:[u.jsx(cr,{size:16,style:{verticalAlign:"middle",marginRight:"4px"}}),"Ask AI"]})})]})]})}),u.jsx("textarea",{className:"popup-output-textarea",value:S?"⟳ Generating...":c,onChange:f=>h(f.target.value),disabled:S,style:{marginBottom:"40px",opacity:S?.8:1,height:`${Xe}px`},onMouseUp:f=>{var k,E;const _=parseInt(getComputedStyle(f.currentTarget).height);_!==Xe&&(De(_),(E=(k=window.electronAPI)==null?void 0:k.saveTextboxSize)==null||E.call(k,"mainTextareaHeight",_))}}),u.jsx("div",{style:{display:"flex",justifyContent:"center",marginTop:80},children:u.jsxs("div",{style:{width:"95%",position:"relative"},children:[u.jsx("div",{style:{position:"absolute",top:0,left:0,zIndex:10,transform:"translateY(-130%)",marginBottom:20},children:u.jsx(B,{children:u.jsx("button",{onClick:Dt,disabled:S||!m.trim(),className:"radpal-button radpal-button-impression",style:{opacity:S||!m.trim()?.5:1,backgroundColor:"#3ABC96",border:"none",fontSize:"12px",padding:"4px 8px"},children:S?"Refining...":`Refine ${s==="impression-only"?"Impression":"Report"}`})})}),u.jsx("textarea",{value:m,onChange:f=>y(f.target.value),placeholder:`Describe how you'd like to improve the ${s==="impression-only"?"impression":"report"}... (e.g., 'make it more concise', 'change tone to more assertive', 'add details about disc desiccation')`,disabled:S,className:"popup-output-textarea",style:{backgroundColor:"#1e1f25",color:"#fff",border:"none",borderRadius:"16px",fontSize:"18px",fontFamily:"monospace",lineHeight:"1.5",minHeight:`${le}px`,maxHeight:"200px",height:`${le}px`,resize:"none",padding:"16px",marginBottom:"40px",outline:"none",boxSizing:"border-box"},onFocus:f=>f.currentTarget.style.borderColor="transparent",onBlur:f=>f.currentTarget.style.borderColor="transparent",onMouseUp:f=>{var k,E;const _=parseInt(getComputedStyle(f.currentTarget).height);_!==le&&(Ue(_),(E=(k=window.electronAPI)==null?void 0:k.saveTextboxSize)==null||E.call(k,"refinementBoxHeight",_))}}),u.jsx("div",{style:{display:"flex",justifyContent:"flex-end",alignItems:"center"},children:u.jsxs("div",{style:{display:"flex",gap:"8px"},children:[P.length>0&&u.jsx(B,{children:u.jsx("button",{onClick:Mt,disabled:S,className:"radpal-button radpal-button-remove",style:{opacity:S?.5:1,backgroundColor:"transparent",border:"none"},children:"↶ Undo"})}),ee.length>0&&u.jsx(B,{children:u.jsx("button",{onClick:Bt,disabled:S,className:"radpal-button radpal-button-impression",style:{opacity:S?.5:1,backgroundColor:"transparent",border:"none"},children:"↷ Redo"})})]})})]})}),u.jsx("div",{style:{display:"flex",justifyContent:"center",marginTop:80},children:u.jsxs("div",{style:{width:"95%",position:"relative"},children:[u.jsx("div",{style:{position:"absolute",top:0,left:0,zIndex:10,transform:"translateY(-130%)",marginBottom:20},children:u.jsx(B,{children:u.jsx("button",{onClick:Ft,disabled:ae||!oe.trim()||!W,className:"radpal-button radpal-button-impression",style:{opacity:ae||!oe.trim()||!W?.5:1,backgroundColor:"#3ABC96",border:"none",fontSize:"12px",padding:"4px 8px"},children:ae?"Processing...":"Apply Feedback"})})}),u.jsx("textarea",{value:oe,onChange:f=>Me(f.target.value),placeholder:`Enter feedback to improve future ${s==="impression-only"?"impression":"report"} generation...`,disabled:ae,className:"popup-output-textarea",style:{backgroundColor:"#1e1f25",color:"#fff",border:"none",borderRadius:"16px",fontSize:"18px",fontFamily:"monospace",lineHeight:"1.5",minHeight:`${he}px`,maxHeight:"200px",height:`${he}px`,resize:"none",padding:"16px",outline:"none",boxSizing:"border-box"},onFocus:f=>f.currentTarget.style.borderColor="transparent",onBlur:f=>f.currentTarget.style.borderColor="transparent",onMouseUp:f=>{var k,E;const _=parseInt(getComputedStyle(f.currentTarget).height);_!==he&&(T(_),(E=(k=window.electronAPI)==null?void 0:k.saveTextboxSize)==null||E.call(k,"feedbackBoxHeight",_))}}),u.jsx("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:"20px"},children:u.jsx("div",{style:{fontSize:"16px",color:"#1a202c",textShadow:"none",fontFamily:"Inter, sans-serif",fontWeight:600},children:W?`Study Type: ${W}`:"Study type not detected"})})]})})]})]}):u.jsxs("div",{style:{height:"100vh",overflowY:"auto",scrollbarWidth:"none",msOverflowStyle:"none"},children:[u.jsx("div",{style:{height:"30px",backgroundColor:"transparent",WebkitAppRegion:"drag",position:"sticky",top:0,zIndex:1e3,display:"flex",justifyContent:"flex-end",alignItems:"center",paddingRight:"10px"},children:u.jsx("div",{style:{WebkitAppRegion:"no-drag"},children:je})}),u.jsxs("div",{style:{padding:20,fontFamily:"Inter, sans-serif",fontWeight:600,fontSize:"16px",color:"#1a202c",textShadow:"none",paddingTop:"10px"},children:[u.jsx("h3",{style:{fontFamily:"Inter, sans-serif",fontWeight:600,fontSize:"16px",color:"#1a202c",textShadow:"none"},children:"⚠ Unknown popup content"}),u.jsx("p",{style:{fontFamily:"Inter, sans-serif",fontWeight:600,fontSize:"16px",color:"#1a202c",textShadow:"none"},children:"No matching content handler found."})]})]});return u.jsxs("div",{className:"window-frame",children:[Fr(),p&&u.jsx("div",{style:{position:"fixed",top:"60px",right:"20px",zIndex:10001,backgroundColor:p.type==="success"?"#0d4f2a":"#5c1f1f",color:p.type==="success"?"#4ade80":"#f87171",border:p.type==="success"?"1px solid #16a34a":"1px solid #dc2626",borderRadius:"8px",padding:"12px 16px",fontSize:"16px",fontFamily:"Inter, sans-serif",fontWeight:600,boxShadow:"none",animation:"slideIn 0.3s ease-out",maxWidth:"300px",wordBreak:"break-word"},children:p.message}),re&&(o==null?void 0:o.id)&&u.jsx(Pi,{userId:o.id,studyType:W||"",reportText:c||t,reportId:void 0,sessionId:Z,onClose:()=>H(!1)})]})}Nr.createRoot(document.getElementById("root")).render(u.jsx(Ii,{}));
