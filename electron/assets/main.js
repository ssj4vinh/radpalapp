import{r as d,j as o,B as V,R as Oe,a as Ve}from"./BlurCard.js";import{EDIT_LOGIC_SYSTEM_PROMPT as Xe}from"./editLogicSystemPrompt.js";function me(){const[l,n]=d.useState(null),[t,i]=d.useState(!0);return d.useEffect(()=>{var E;let g=!1;(()=>{try{const S=[];for(let f=0;f<localStorage.length;f++){const T=localStorage.key(f);T&&T.startsWith("sb-")&&S.push(T)}S.forEach(f=>localStorage.removeItem(f))}catch(S){console.warn("âš ï¸ Failed to clear cached session data:",S)}})(),(async()=>{var S,f,T;try{const I=await((S=window.electronAPI)==null?void 0:S.authGetSession()),F=((T=(f=I==null?void 0:I.data)==null?void 0:f.session)==null?void 0:T.user)||null;n(F||null)}catch(I){console.error("âŒ Failed to get initial session:",I),n(null)}})(),(async()=>{var S;try{await((S=window.electronAPI)==null?void 0:S.authSetupListener())}catch(f){console.error("âŒ Failed to setup auth listener:",f)}})();const x=({event:S,session:f})=>{n(S==="INITIAL_SESSION"&&!f?null:(f==null?void 0:f.user)??null),g||(i(!1),g=!0),window.electronAPI&&(window.electronAPI.setCurrentUser(f==null?void 0:f.user),window.electronAPI.setSupabaseSession(f)),S==="SIGNED_OUT"&&window.electronAPI&&(setTimeout(()=>{window.electronAPI.resetWindowSize()},300),setTimeout(()=>{window.electronAPI.resetWindowSize()},1e3))};return(E=window.electronAPI)!=null&&E.onAuthStateChange?window.electronAPI.onAuthStateChange(x):console.error("âŒ onAuthStateChange method not available on window.electronAPI"),()=>{}},[]),{signIn:async(g,h)=>{var m;try{const p=await((m=window.electronAPI)==null?void 0:m.authSignIn(g,h));return p!=null&&p.error?{error:{message:p.error},data:null}:p}catch(p){return console.error("Sign-in error:",p),{error:{message:p.message||"Network error - please check your internet connection"},data:null}}},signUp:async(g,h)=>{var m;try{const p=await((m=window.electronAPI)==null?void 0:m.authSignUp(g,h));return p!=null&&p.error?{error:{message:p.error},data:null}:p}catch(p){return console.error("Sign-up error:",p),{error:{message:p.message||"Network error - please check your internet connection"},data:null}}},signOut:async()=>{var h;const g=await((h=window.electronAPI)==null?void 0:h.authSignOut());if(window.electronAPI)try{setTimeout(()=>{window.electronAPI.resetWindowSize()},100)}catch(m){console.warn("Failed to reset window size:",m)}if(g!=null&&g.error)throw new Error(g.error);return g},user:l,loading:t}}function Qe(){const[l,n]=d.useState(!1),[t,i]=d.useState(""),[r,s]=d.useState(""),c=async p=>{n(!0),i(p);try{console.log("ðŸ” Calling generateReport with prompt:",p.substring(0,100)+"...");const x=await window.electronAPI.generateReport(p);if(console.log("ðŸ” generateReport response:",x),typeof x=="string"){const E={text:x,tokens:{input:0,output:0,total:0}};return s(x),E}else return s(x.text),x}catch(x){throw console.error("ðŸ” generateReport error:",x),x}finally{n(!1)}},g=async p=>await window.electronAPI.readPrompt(p);return{generateReport:c,loading:l,debugPrompt:t,debugResult:r,generateReportFromTemplates:async(p,x,E)=>{const S=Date.now();let f={input:0,output:0,total:0};try{let T=E;if(!T){const k=await g("classify"),z=await c(k.replace("{{FINDINGS}}",p||""));T=z.text.trim(),f.input+=z.tokens.input,f.output+=z.tokens.output,f.total+=z.tokens.total}const I=x[T];if(!I||!I.template||!I.generate_prompt)return{error:!0,message:`âŒ No valid template or prompt found for: ${T}`};const F=I.template||"",_=(I.generate_prompt||"").replace("{{STUDY_TYPE}}",T||"").replace("{{TEMPLATE}}",F||"").replace("{{FINDINGS}}",p||"").replace(/{{[^}]+}}/g,""),C=await c(_);f.input+=C.tokens.input,f.output+=C.tokens.output,f.total+=C.tokens.total;const W=((Date.now()-S)/1e3).toFixed(1);return{template:F,result:C.text,studyType:T,generationTime:W,totalTokens:f}}catch{return{error:!0,message:"âŒ Report generation failed. See console for details."}}},generateImpressionFromTemplates:async(p,x,E)=>{const S=Date.now();let f={input:0,output:0,total:0};try{let T=E;if(!T){const k=await g("classify"),z=await c(k.replace("{{FINDINGS}}",p||""));T=z.text.trim(),f.input+=z.tokens.input,f.output+=z.tokens.output,f.total+=z.tokens.total}const I=x[T];if(!I||!I.template||!I.generate_impression)return{error:!0,message:`âŒ No valid impression template found for: ${T}`};const F=I.template||"",_=(I.generate_impression||"").replace("{{STUDY_TYPE}}",T||"").replace("{{TEMPLATE}}",F||"").replace("{{FINDINGS}}",p||"").replace(/{{[^}]+}}/g,""),C=await c(_);f.input+=C.tokens.input,f.output+=C.tokens.output,f.total+=C.tokens.total;const W=((Date.now()-S)/1e3).toFixed(1);return{template:F,result:C.text,studyType:T,generationTime:W,totalTokens:f}}catch{return{error:!0,message:"âŒ Impression generation failed. See console for details."}}}}}function Ze(l,n,t){console.log("ðŸ” BuildPrompt received agent_logic:",JSON.stringify(t,null,2));let i=`You are an expert radiologist generating a comprehensive radiology report.

`;n&&(i+=`Follow this template:
`,i+=n+`

`),i+=`The following imaging findings have been identified and must be incorporated into the report:
`,i+=l+`

`;const r=[];if(t.formatting&&(t.formatting.preserve_template_punctuation&&r.push("Preserve all punctuation and formatting exactly as shown in the template."),t.formatting.use_bullet_points&&r.push("Use bullet points for listing multiple findings within each section."),t.formatting.capitalize_sections&&r.push("Ensure all section headers are in UPPERCASE.")),t.report&&(t.report.no_hallucinated_findings&&r.push("Do not invent findings. Only report what is explicitly stated in the findings."),t.report.include_technique_section&&r.push("Include a TECHNIQUE section describing the imaging protocol used."),t.report.include_comparison&&r.push("Include a COMPARISON section if prior imaging is mentioned."),t.report.use_medical_abbreviations&&r.push("Use standard medical abbreviations where appropriate."),t.report.expand_lesions&&r.push("For each lesion, describe location, size, morphology, and enhancement characteristics."),t.report.cartilage_placement&&(t.report.cartilage_placement.trochlear_cartilage_in_patellofemoral&&r.push("Ensure trochlear cartilage findings are included in the patellofemoral compartment."),t.report.cartilage_placement.mention_patellar_if_trochlear_defect_present&&r.push("If a trochlear defect is present, confirm that the patellar cartilage is explicitly stated as intact or abnormal.")),t.report.anatomic_routing_rules&&(console.log("ðŸ” Processing anatomic_routing_rules:",t.report.anatomic_routing_rules),t.report.anatomic_routing_rules.loose_bodies==="joints"&&r.push("Describe loose bodies under the joints section."),t.report.anatomic_routing_rules.bone_contusions==="ossea_or_bone_marrow"&&r.push("Describe bone contusions under the osseous structures or bone marrow section."),t.report.anatomic_routing_rules.joint_effusions==="joint_space"&&r.push("Describe joint effusions under the joint space section."))),t.impression){if(t.impression.numerically_itemized&&r.push("Write the impression as a numbered list."),t.impression.omit_minor_or_incidental_findings_unless_relevant&&r.push("In the impression, omit mild or incidental findings unless relevant to the clinical history."),t.impression.concise_summary&&r.push("Keep the impression concise, focusing on clinically significant findings."),t.impression.include_recommendations&&r.push("Include follow-up recommendations when appropriate."),t.impression.differential_diagnosis&&r.push("Provide differential diagnoses for significant findings when appropriate."),t.impression.first_item_should_address_clinical_concern&&r.push("The first impression item should address the clinical concern."),t.impression.exclude_by_default&&Array.isArray(t.impression.exclude_by_default)){console.log("ðŸ” Processing exclude_by_default:",t.impression.exclude_by_default);const s=t.impression.exclude_by_default.join(", ");r.push(`Do not include the following unless clinically relevant: ${s}.`)}t.impression.mention_muscle_atrophy_if&&(console.log("ðŸ” Processing mention_muscle_atrophy_if:",t.impression.mention_muscle_atrophy_if),t.impression.mention_muscle_atrophy_if==="moderate_or_severe"&&r.push("Only mention muscle atrophy if it is moderate or severe."))}return t.anatomy&&(t.anatomy.combine_meniscus_and_cartilage_findings&&r.push("Combine meniscus and cartilage findings in the same section for better organization."),t.anatomy.group_by_anatomic_region&&r.push("Group findings by anatomic region (e.g., anterior, posterior, medial, lateral)."),t.anatomy.describe_bilateral_structures&&r.push("For bilateral structures, describe each side separately and note any asymmetry.")),t.clinical&&(t.clinical.correlate_with_symptoms&&r.push("Correlate findings with clinical symptoms when provided."),t.clinical.mention_clinical_significance&&r.push("Comment on the clinical significance of major findings.")),t.measurements&&(t.measurements.include_all_measurements&&r.push("Include all measurements mentioned in the findings."),t.measurements.use_metric_system&&r.push("Use metric system (mm, cm) for all measurements."),t.measurements.describe_change_from_prior&&r.push("When prior measurements are available, describe interval change.")),t.severity&&(t.severity.use_standard_grading&&r.push("Use standard grading systems (e.g., mild/moderate/severe) consistently."),t.severity.avoid_vague_terms&&r.push('Avoid vague terms like "some" or "several" - be specific.')),t.style&&(t.style.active_voice&&r.push("Use active voice when describing findings."),t.style.avoid_hedging&&r.push("Avoid excessive hedging language unless uncertainty is clinically relevant."),t.style.professional_tone&&r.push("Maintain a professional, objective tone throughout.")),t.custom_instructions&&(Array.isArray(t.custom_instructions)?r.push(...t.custom_instructions):typeof t.custom_instructions=="string"&&r.push(t.custom_instructions)),r.length>0?(console.log(`ðŸ” Generated ${r.length} instructions from agent_logic:`,r),i+=`Instructions:
`,r.forEach((s,c)=>{i+=`${c+1}. ${s}
`}),i+=`
`):console.log("âš ï¸ No instructions generated from agent_logic"),t.examples&&Array.isArray(t.examples)&&(i+=`Examples:
`,t.examples.forEach((s,c)=>{s.context?i+=`Example ${c+1} (${s.context}):
`:i+=`Example ${c+1}:
`,s.input&&(i+=`Input: ${s.input}
`),s.output&&(i+=`Output: ${s.output}
`),i+=`
`})),i+="Generate a complete radiology report based on the template, findings, and instructions provided above.",i}async function Me({prompt:l,model:n="gpt-4"}){var t;try{if(typeof window<"u"&&((t=window.electronAPI)!=null&&t.generateReport)){const i=await window.electronAPI.generateReport(l);if(typeof i=="string")return{text:i,tokens:{input:0,output:0,total:0}};if(i!=null&&i.text)return{text:i.text,tokens:i.tokens||{input:0,output:0,total:0}};throw new Error("Invalid response from model")}else return await et(l,n)}catch(i){throw console.error("Error calling model:",i),i}}async function et(l,n){const t=n.toLowerCase();if(t.includes("gpt")||t.includes("openai"))return await tt(l,n);if(t.includes("claude"))return await rt(l,n);if(t.includes("gemini"))return await ot(l);if(t.includes("kimi"))return await nt(l);throw new Error(`Unsupported model: ${n}. Supported models: GPT-4, GPT-3.5-Turbo, Claude-3-Sonnet, Claude-3-Opus, Gemini, Kimi`)}async function tt(l,n){const t={}.OPENAI_API_KEY;if(!t)throw new Error("OPENAI_API_KEY not found in environment variables");let i="gpt-4o";(n.includes("3.5")||n.includes("turbo"))&&(i="gpt-3.5-turbo");const r=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:i,messages:[{role:"system",content:"You are a helpful radiology assistant."},{role:"user",content:l}],max_tokens:4096,temperature:.7})});if(!r.ok){const c=await r.text();throw new Error(`OpenAI API error: ${r.status} ${r.statusText} - ${c}`)}const s=await r.json();if(!s.choices||s.choices.length===0)throw new Error("No response from OpenAI API");return{text:s.choices[0].message.content||"No content in OpenAI response",tokens:s.usage?{input:s.usage.prompt_tokens||0,output:s.usage.completion_tokens||0,total:s.usage.total_tokens||0}:{input:0,output:0,total:0}}}async function rt(l,n){const t={}.ANTHROPIC_API_KEY;if(!t)throw new Error("ANTHROPIC_API_KEY not found in environment variables");let i="claude-sonnet-4-20250514",r=4096;n.includes("opus")?(i="claude-opus-4-20250514",r=8192):n.includes("sonnet")&&(i="claude-sonnet-4-20250514",r=4096);const s=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":t,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:i,max_tokens:r,messages:[{role:"user",content:l}]})});if(!s.ok){const g=await s.text();throw new Error(`Anthropic API error: ${s.status} ${s.statusText} - ${g}`)}const c=await s.json();if(!c.content||c.content.length===0)throw new Error("No response from Anthropic API");return{text:c.content[0].text||"No content in Anthropic response",tokens:c.usage?{input:c.usage.input_tokens||0,output:c.usage.output_tokens||0,total:(c.usage.input_tokens||0)+(c.usage.output_tokens||0)}:{input:0,output:0,total:0}}}async function ot(l,n){const t={}.GEMINI_API_KEY;if(!t)throw new Error("GEMINI_API_KEY not found in environment variables");const i=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:l}]}],generationConfig:{temperature:.7,maxOutputTokens:4096}})});if(!i.ok){const s=await i.text();throw new Error(`Gemini API error: ${i.status} ${i.statusText} - ${s}`)}const r=await i.json();if(!r.candidates||r.candidates.length===0||!r.candidates[0].content.parts.length)throw new Error("No response from Gemini API");return{text:r.candidates[0].content.parts[0].text||"No content in Gemini response",tokens:r.usageMetadata?{input:r.usageMetadata.promptTokenCount||0,output:r.usageMetadata.candidatesTokenCount||0,total:r.usageMetadata.totalTokenCount||0}:{input:0,output:0,total:0}}}async function nt(l,n){const t={}.MOONSHOT_API_KEY;if(!t)throw new Error("MOONSHOT_API_KEY not found in environment variables");const i=await fetch("https://api.moonshot.ai/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:"kimi-k2-0711-preview",messages:[{role:"system",content:"You are a helpful radiology assistant."},{role:"user",content:l}],temperature:.7,stream:!1})});if(!i.ok){const s=await i.text();throw new Error(`Kimi API error: ${i.status} ${i.statusText} - ${s}`)}const r=await i.json();if(!r.choices||r.choices.length===0)throw new Error("No response from Kimi API");return{text:r.choices[0].message.content||"No content in Kimi response",tokens:r.usage?{input:r.usage.prompt_tokens||0,output:r.usage.completion_tokens||0,total:r.usage.total_tokens||0}:{input:0,output:0,total:0}}}async function it(l,n){var i,r;const t=await((r=(i=window.electron)==null?void 0:i.ipcRenderer)==null?void 0:r.invoke("fetch-template-for-generation",l,n));if(!t||t.error)throw new Error((t==null?void 0:t.error)||`No template found for user ${l} and study type "${n}"`);return t.data}async function st({userId:l,studyType:n,findings:t,model:i}){console.log("ðŸ¤– Agent generateReport called:",{userId:l,studyType:n,findings:t.substring(0,50)+"...",model:i});try{const r=await it(l,n);if(!r)throw new Error(`No template found for user ${l} and study type "${n}"`);const{template:s,agent_logic:c,generate_prompt:g}=r;let h=c;if(!c&&g&&(console.log("ðŸ”„ Using fallback: converting generate_prompt to agent_logic"),h={instructions:g,version:"1.0_fallback"}),!s)throw new Error(`Template is empty for study type "${n}"`);const m=Ze(t,s,h||{});return await Me({prompt:m,model:i})}catch(r){throw console.error("Error generating report:",r),r}}function at(l,n,t){console.log("ðŸ” BuildImpressionPrompt received agent_logic:",JSON.stringify(t,null,2));let i=`You are an expert radiologist generating a concise radiology impression.

`;n&&(i+=`For reference, the full report template is:
`,i+=n+`

`),i+=`The following imaging findings have been identified and must be incorporated into the impression:
`,i+=l+`

`;const r=[];if(r.push("Generate ONLY the IMPRESSION section - do not include findings or other report sections."),t.impression){if(t.impression.numerically_itemized&&r.push("Write the impression as a numbered list."),t.impression.omit_minor_or_incidental_findings_unless_relevant&&r.push("Omit mild or incidental findings unless relevant to the clinical history."),t.impression.concise_summary&&r.push("Keep the impression concise, focusing only on clinically significant findings."),t.impression.include_recommendations&&r.push("Include follow-up recommendations when appropriate."),t.impression.differential_diagnosis&&r.push("Provide differential diagnoses for significant findings when appropriate."),t.impression.severity_classification&&r.push("Classify findings by severity (mild, moderate, severe) when applicable."),t.impression.prioritize_by_urgency&&r.push("List findings in order of clinical urgency, most urgent first."),t.impression.first_item_should_address_clinical_concern&&r.push("The first impression item should address the clinical concern."),t.impression.exclude_by_default&&Array.isArray(t.impression.exclude_by_default)){console.log("ðŸ” Processing exclude_by_default:",t.impression.exclude_by_default);const s=t.impression.exclude_by_default.join(", ");r.push(`Do not include the following unless clinically relevant: ${s}.`)}if(t.impression.mention_muscle_atrophy_if&&(console.log("ðŸ” Processing mention_muscle_atrophy_if:",t.impression.mention_muscle_atrophy_if),t.impression.mention_muscle_atrophy_if==="moderate_or_severe"?r.push("Only mention muscle atrophy if it is moderate or severe."):t.impression.mention_muscle_atrophy_if==="severe"?r.push("Only mention muscle atrophy if it is severe."):t.impression.mention_muscle_atrophy_if==="any"&&r.push("Mention muscle atrophy regardless of severity.")),t.impression.combine_compartments&&r.push("Combine meniscus and cartilage findings by compartment (e.g., medial/lateral) in the impression."),t.impression.exclude_unless_surgical&&Array.isArray(t.impression.exclude_unless_surgical)){console.log("ðŸ” Processing exclude_unless_surgical:",t.impression.exclude_unless_surgical);const s=t.impression.exclude_unless_surgical.join(", ");r.push(`Exclude the following findings unless they require surgical intervention: ${s}.`)}}return t.report&&(t.report.no_hallucinated_findings&&r.push("Do not invent findings. Only summarize what is explicitly stated in the findings."),t.report.cartilage_placement&&(t.report.cartilage_placement.group_cartilage_by_compartment_in_impression&&r.push("Group cartilage findings by compartment (medial, lateral, patellofemoral) in the impression."),t.report.cartilage_placement.mention_grade_in_impression&&r.push("Include cartilage defect grades in the impression when available.")),t.report.anatomic_routing_rules&&(console.log("ðŸ” Processing anatomic_routing_rules for impression:",t.report.anatomic_routing_rules),t.report.anatomic_routing_rules.impression_order&&r.push(`Organize impression findings in this order: ${t.report.anatomic_routing_rules.impression_order}.`),t.report.anatomic_routing_rules.group_pathology_by_type&&r.push("Group similar pathology together in the impression (e.g., all ligament tears, all cartilage defects)."))),t.formatting&&(t.formatting.use_bullet_points&&r.push("Use bullet points when listing multiple diagnoses or findings."),t.formatting.capitalize_diagnoses&&r.push("Capitalize the first letter of each diagnosis or major finding.")),t.clinical&&(t.clinical.correlate_with_symptoms&&r.push("Correlate impression with clinical symptoms when provided."),t.clinical.mention_clinical_significance&&r.push("Comment on the clinical significance of findings."),t.clinical.suggest_follow_up&&r.push("Suggest appropriate follow-up when indicated."),t.clinical.include_acuity&&r.push("Specify whether findings are acute, chronic, or acute-on-chronic when determinable."),t.clinical.management_implications&&r.push("Include management implications for significant findings.")),t.measurements&&(t.measurements.include_key_measurements_only&&r.push("Include only the most clinically relevant measurements in the impression."),t.measurements.describe_change_from_prior&&r.push("When prior studies are mentioned, describe interval change.")),t.severity&&(t.severity.highlight_urgent_findings&&r.push("Highlight any urgent or emergent findings at the beginning of the impression."),t.severity.use_standard_terminology&&r.push("Use standardized terminology for describing severity and urgency.")),t.style&&(t.style.definitive_statements&&r.push("Use definitive statements when findings are clear, avoid excessive hedging."),t.style.active_voice&&r.push("Use active voice when possible."),t.style.professional_tone&&r.push("Maintain a professional, objective tone.")),t.anatomy&&(t.anatomy.group_related_findings&&r.push("Group related anatomical findings together in the impression."),t.anatomy.mention_normal_variants&&r.push("Briefly mention significant normal variants that may cause confusion.")),t.custom_impression_instructions&&(Array.isArray(t.custom_impression_instructions)?r.push(...t.custom_impression_instructions):typeof t.custom_impression_instructions=="string"&&r.push(t.custom_impression_instructions)),r.length>0?(console.log(`ðŸ” Generated ${r.length} impression instructions from agent_logic:`,r),i+=`Instructions:
`,r.forEach((s,c)=>{i+=`${c+1}. ${s}
`}),i+=`
`):console.log("âš ï¸ No impression instructions generated from agent_logic"),t.impression_examples&&Array.isArray(t.impression_examples)&&(i+=`Impression Examples:
`,t.impression_examples.forEach((s,c)=>{i+=`Example ${c+1}:
`,s.findings&&(i+=`Findings: ${s.findings}
`),s.impression&&(i+=`Impression: ${s.impression}
`),i+=`
`})),i+="Generate only the IMPRESSION section based on the findings and instructions provided above.",i}async function lt(l,n){var i,r;const t=await((r=(i=window.electron)==null?void 0:i.ipcRenderer)==null?void 0:r.invoke("fetch-template-for-generation",l,n));if(!t||t.error)throw new Error((t==null?void 0:t.error)||`No template found for user ${l} and study type "${n}"`);return t.data}async function ct({userId:l,studyType:n,findings:t,model:i}){try{const r=await lt(l,n);if(!r)throw new Error(`No template found for user ${l} and study type "${n}"`);const{template:s,agent_logic:c,generate_impression:g}=r;let h=c;!c&&g&&(console.log("ðŸ”„ Using fallback: converting generate_impression to agent_logic"),h={instructions:g,version:"1.0_fallback",impression:{concise_summary:!0}});const m=at(t,s||"",h||{});return await Me({prompt:m,model:i})}catch(r){throw console.error("Error generating impression:",r),r}}function dt(){const[l,n]=d.useState(!1),[t,i]=d.useState(null),{user:r}=me();return{generateReportWithAgent:async(g,h,m)=>{if(!(r!=null&&r.id))throw new Error("User not authenticated");n(!0),i(null);try{const p=await st({userId:r.id,studyType:h,findings:g,model:m});return{text:p.text,tokens:p.tokens||{input:0,output:0,total:0}}}catch(p){const x=p instanceof Error?p.message:"Failed to generate report";throw i(x),p}finally{n(!1)}},generateImpressionWithAgent:async(g,h,m)=>{if(!(r!=null&&r.id))throw new Error("User not authenticated");n(!0),i(null);try{const p=await ct({userId:r.id,studyType:h,findings:g,model:m});return{text:p.text,tokens:p.tokens||{input:0,output:0,total:0}}}catch(p){const x=p instanceof Error?p.message:"Failed to generate impression";throw i(x),p}finally{n(!1)}},loading:l,error:t}}function Re(l){switch(l){case"openai":return"gpt-4";case"claude-sonnet":return"claude-3-sonnet";case"claude-opus":return"claude-3-opus";case"gemini":return"gemini-2.5-flash";case"kimi":return"kimi-k2-0711-preview";default:return"gpt-4"}}const G={USER:"radpal_offline_user",SESSION:"radpal_offline_session",TEMPLATES:"radpal_offline_templates",SETTINGS:"radpal_offline_settings",AGENT_LOGIC:"radpal_offline_agent_logic",LAST_SYNC:"radpal_offline_last_sync"};class pt{saveUser(n){n!=null&&n.id&&localStorage.setItem(G.USER,JSON.stringify(n))}getUser(){const n=localStorage.getItem(G.USER);return n?JSON.parse(n):null}saveSession(n){n&&(localStorage.setItem(G.SESSION,JSON.stringify(n)),n.user&&this.saveUser(n.user))}getSession(){const n=localStorage.getItem(G.SESSION);return n?JSON.parse(n):null}clearSession(){localStorage.removeItem(G.SESSION),localStorage.removeItem(G.USER)}saveTemplates(n){localStorage.setItem(G.TEMPLATES,JSON.stringify(n)),this.updateLastSync()}getTemplates(){const n=localStorage.getItem(G.TEMPLATES);return n?JSON.parse(n):{}}saveSettings(n){localStorage.setItem(G.SETTINGS,JSON.stringify(n)),this.updateLastSync()}getSettings(){const n=localStorage.getItem(G.SETTINGS);return n?JSON.parse(n):null}saveAgentLogic(n,t){const i=this.getAllAgentLogic();i[n]={...t,lastModified:new Date().toISOString()},localStorage.setItem(G.AGENT_LOGIC,JSON.stringify(i))}getAgentLogic(n){return this.getAllAgentLogic()[n]||null}getAllAgentLogic(){const n=localStorage.getItem(G.AGENT_LOGIC);return n?JSON.parse(n):{}}updateLastSync(){localStorage.setItem(G.LAST_SYNC,new Date().toISOString())}getLastSync(){const n=localStorage.getItem(G.LAST_SYNC);return n?new Date(n):null}isOfflineDataAvailable(){return!!(this.getUser()&&this.getTemplates())}clearAll(){Object.values(G).forEach(n=>{localStorage.removeItem(n)})}exportOfflineData(){return{user:this.getUser(),session:this.getSession(),templates:this.getTemplates(),settings:this.getSettings(),agentLogic:this.getAllAgentLogic(),lastSync:this.getLastSync()}}importOfflineData(n){n.user&&this.saveUser(n.user),n.session&&this.saveSession(n.session),n.templates&&this.saveTemplates(n.templates),n.settings&&this.saveSettings(n.settings),n.agentLogic&&localStorage.setItem(G.AGENT_LOGIC,JSON.stringify(n.agentLogic)),n.lastSync&&localStorage.setItem(G.LAST_SYNC,n.lastSync)}setOfflineUser(n){console.log("ðŸ” Legacy setOfflineUser called on storage service with:",n),n&&this.saveUser(n)}}const R=new pt;function ut(l,n=!0,t=!1){const[i,r]=d.useState({}),[s,c]=d.useState(!0),g=d.useRef(!1),h=d.useRef(null);return d.useEffect(()=>{if(!l||!n){r({}),c(!1);return}if(g.current||h.current===(l==null?void 0:l.id))return;(async()=>{var x,E;g.current=!0,h.current=l==null?void 0:l.id,c(!0);try{if(t){console.log("ðŸ“¦ Loading templates from offline storage");const S=R.getTemplates();r(S)}else try{const S=await((E=(x=window.electron)==null?void 0:x.ipcRenderer)==null?void 0:E.invoke("fetch-templates",l.id,null));if(S)r(S),R.saveTemplates(S);else throw new Error("No templates returned")}catch{console.log("âš ï¸ Failed to fetch from Supabase, using offline cache");const f=R.getTemplates();r(f)}}catch(S){console.error("âŒ Failed to fetch templates:",S),r({})}finally{c(!1),g.current=!1}})()},[l,n,t]),{templates:i||{},loading:s??!1,saveTemplate:(async(p,x,E,S)=>{var T,I;if(!l)throw new Error("User not set");const f={template:x,generatePrompt:E,generateImpression:S};if(t){console.log("ðŸ’¾ Saving template to offline storage only");const F=R.getTemplates();return F[p]=f,R.saveTemplates(F),r(F),{success:!0}}try{const F=await((I=(T=window.electron)==null?void 0:T.ipcRenderer)==null?void 0:I.invoke("save-template",{userId:l.id,accessToken:null,studyType:p,template:x,generatePrompt:E,generateImpression:S}));if(!(F!=null&&F.success))throw new Error("Save to Supabase failed");const $=R.getTemplates();$[p]=f,R.saveTemplates($),r($)}catch{console.log("âš ï¸ Failed to save to Supabase, saving to offline storage only");const $=R.getTemplates();$[p]=f,R.saveTemplates($),r($)}})||(async()=>{})}}function gt(){const[l,n]=d.useState({width:window.innerWidth,height:window.innerHeight,isContracted:window.innerHeight<=110}),t=d.useCallback(()=>{n({width:window.innerWidth,height:window.innerHeight,isContracted:window.innerHeight<=110})},[]);return d.useEffect(()=>{let i;const r=()=>{clearTimeout(i),i=setTimeout(t,150)};return t(),window.addEventListener("resize",r),()=>{clearTimeout(i),window.removeEventListener("resize",r)}},[t]),l}function ft(){return d.useMemo(()=>({textareaStyle:{width:"100%",height:"40vh",minHeight:200,maxHeight:"50vh",padding:"16px 40px 16px 16px",backgroundColor:"transparent",color:"#fff",border:"none",borderRadius:16,resize:"none",fontSize:14,outline:"none",fontFamily:"DM Sans, sans-serif"},modalButtonStyle:{padding:"6px 12px",border:"none",borderRadius:16,fontSize:14,fontWeight:300,transition:"all 0.2s ease"},tokenBarStyle:n=>({width:"100%",height:n<600?8:n<800?10:12,backgroundColor:"rgba(42, 45, 49, 0.6)",borderRadius:(n<600?8:n<800?10:12)/2,border:"none",overflow:"hidden",position:"relative"}),tokenFillStyle:(n,t)=>({width:`${Math.min(t||0,100)}%`,height:"100%",backgroundColor:(t||0)>90?"#E36756":(t||0)>75?"#E1865D":"#3ABC96",transition:"all 0.3s ease",borderRadius:`${(n<600?8:n<800?10:12)/2}px 0 0 ${(n<600?8:n<800?10:12)/2}px`})}),[])}const mt=""+new URL("radpal_logo_dev.png",import.meta.url).href;function ht(){const{signIn:l,signUp:n}=me(),[t,i]=d.useState(""),[r,s]=d.useState(""),[c,g]=d.useState(null),[h,m]=d.useState(!0),[p,x]=d.useState(!1),[E,S]=d.useState(""),[f,T]=d.useState(!1),I=d.useRef(null);d.useEffect(()=>{const _=localStorage.getItem("radpal_remember_login")==="1",C=localStorage.getItem("radpal_email")||"",W=localStorage.getItem("radpal_password")||"";_&&(m(!0),i(C),s(W)),I.current&&I.current.focus()},[]);const F=async _=>{var W;let C=0;for(;C<10;){try{const k=await((W=window.electronAPI)==null?void 0:W.checkUserExists(_));if(k!=null&&k.exists)return!0}catch(k){console.error("Error checking user existence:",k)}await new Promise(k=>setTimeout(k,500)),C++}return!1},$=async _=>{var C;try{if(!await F(_))return;const k=await((C=window.electronAPI)==null?void 0:C.triggerTemplateCopy(_));k!=null&&k.success||console.error("Template copy failed:",k==null?void 0:k.error)}catch{}},Q=async()=>{var _,C,W,k;T(!0),g(null);try{if(p){const b=await((_=window.electronAPI)==null?void 0:_.checkInviteCode(E));if(!(b!=null&&b.data)||b!=null&&b.error){g("âŒ Invalid or already used invite code");return}}const z=p?await n(t,r):await l(t,r);if(z.error){g(`âŒ ${z.error.message}`);return}const y=(W=(C=z.data)==null?void 0:C.user)==null?void 0:W.id;if(p&&y){const b=await((k=window.electronAPI)==null?void 0:k.markInviteCodeUsed(E,y));b!=null&&b.success||console.error("Failed to mark invite code as used:",b==null?void 0:b.error),await $(y)}h?(localStorage.setItem("radpal_remember_login","1"),localStorage.setItem("radpal_email",t),localStorage.setItem("radpal_password",r)):(localStorage.removeItem("radpal_remember_login"),localStorage.removeItem("radpal_email"),localStorage.removeItem("radpal_password")),g(p?"âœ… Success! Check your email to confirm your account.":"âœ… Success! You are now signed in.")}catch(z){g(`âŒ Login failed: ${z instanceof Error?z.message:"Unknown error"}`)}finally{T(!1)}};return o.jsxs("div",{className:"radpal-login-wrapper",style:{height:"100vh",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"inherit",WebkitAppRegion:"drag",padding:"60px 32px",textAlign:"center",fontFamily:"SF Pro, system-ui, sans-serif",fontWeight:400,position:"relative"},children:[o.jsx("button",{onClick:()=>{var _;(_=window.electronAPI)!=null&&_.closeApp?window.electronAPI.closeApp():window.close()},style:{position:"absolute",top:20,right:20,background:"rgba(227, 103, 86, 0.2)",border:"1px solid rgba(227, 103, 86, 0.3)",borderRadius:"50%",width:32,height:32,color:"#E36756",fontSize:16,fontWeight:"bold",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",WebkitAppRegion:"no-drag",zIndex:1e3,transition:"all 0.2s ease"},onMouseEnter:_=>{_.currentTarget.style.background="rgba(227, 103, 86, 0.3)",_.currentTarget.style.transform="scale(1.1)"},onMouseLeave:_=>{_.currentTarget.style.background="rgba(227, 103, 86, 0.2)",_.currentTarget.style.transform="scale(1)"},children:"Ã—"}),o.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",WebkitAppRegion:"no-drag",maxWidth:350,width:"100%"},children:[o.jsx("img",{src:mt,alt:"RadPal Logo",className:"radpal-logo",style:{maxWidth:400,marginBottom:32,backgroundColor:"transparent",mixBlendMode:"normal"}}),o.jsxs("form",{onSubmit:_=>{_.preventDefault(),Q()},style:{marginBottom:20,width:"100%",display:"flex",flexDirection:"column",alignItems:"center"},children:[o.jsx(V,{style:{marginBottom:16,width:"100%",maxWidth:280},children:o.jsx("input",{ref:I,type:"email",placeholder:"Email",value:t,onChange:_=>i(_.target.value),style:{padding:14,width:"100%",borderRadius:16,fontSize:14,fontFamily:"DM Sans, sans-serif",fontWeight:400,backgroundColor:"transparent",color:"#fff",border:"none",outline:"none",WebkitAppRegion:"no-drag"}})}),o.jsx(V,{style:{marginBottom:16,width:"100%",maxWidth:280},children:o.jsx("input",{type:"password",placeholder:"Password",value:r,onChange:_=>s(_.target.value),style:{padding:14,width:"100%",borderRadius:16,fontSize:14,fontFamily:"DM Sans, sans-serif",fontWeight:400,backgroundColor:"transparent",color:"#fff",border:"none",outline:"none",WebkitAppRegion:"no-drag"}})}),p&&o.jsx(V,{style:{marginBottom:16,width:"100%",maxWidth:280},children:o.jsx("input",{type:"text",placeholder:"Invite Code",value:E,onChange:_=>S(_.target.value),style:{padding:14,width:"100%",borderRadius:16,fontSize:14,fontFamily:"DM Sans, sans-serif",fontWeight:400,backgroundColor:"transparent",color:"#fff",border:"none",outline:"none",WebkitAppRegion:"no-drag"}})})]}),o.jsx(V,{onClick:Q,style:{marginBottom:20,opacity:f?.5:1,pointerEvents:f?"none":"auto",padding:6},children:o.jsx("button",{disabled:f,style:{padding:"14px 32px",borderRadius:16,fontSize:14,backgroundColor:"transparent",color:"#fff",border:"none",WebkitAppRegion:"no-drag",pointerEvents:"none"},children:f?"Loading...":p?"Sign Up":"Log In"})}),o.jsxs("label",{style:{fontSize:14,display:"flex",alignItems:"center",gap:6,justifyContent:"center",fontFamily:"DM Sans, sans-serif",fontWeight:400,color:"#fff"},children:[o.jsx("input",{type:"checkbox",checked:h,onChange:()=>m(!h),style:{WebkitAppRegion:"no-drag"}}),"Remember Me"]}),c&&o.jsx("p",{className:"login-message-animated",style:{marginTop:20,color:c.startsWith("âœ…")?"green":"red",fontSize:16,fontFamily:"DM Sans, sans-serif",fontWeight:400},children:c}),o.jsxs("p",{style:{marginTop:20,fontSize:14,fontFamily:"DM Sans, sans-serif",fontWeight:400,color:"#fff"},children:[p?"Already have an account?":"Don't have an account?"," ",o.jsx("button",{style:{color:"#7CC2D7",background:"none",border:"none",fontSize:14,fontFamily:"DM Sans, sans-serif",fontWeight:400},onClick:()=>x(!p),children:p?"Log In":"Sign Up"})]})]})]})}const Pe=({visible:l,selected:n,onSelect:t,onClose:i,onCancel:r})=>{const[s,c]=d.useState(""),[g,h]=d.useState(!1);d.useEffect(()=>{if(n!=="Other")c("");else{const p=localStorage.getItem("customDictationWindow")||"";c(p)}},[n]);const m=()=>{var p,x;n==="Other"&&s.trim()&&(localStorage.setItem("customDictationWindow",s.trim()),(x=(p=window==null?void 0:window.electron)==null?void 0:p.ipcRenderer)==null||x.invoke("set-custom-window-name",s.trim())),i()};return l?o.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.4)",backdropFilter:"blur(4px)",WebkitBackdropFilter:"blur(4px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:9999},children:o.jsxs(V,{style:{padding:24,minWidth:300,maxWidth:400,color:"white",backgroundColor:"rgba(42, 45, 49, 0.8)",backdropFilter:"blur(12px)",WebkitBackdropFilter:"blur(12px)",borderRadius:16,border:"none"},children:[o.jsx("h2",{style:{marginTop:0,fontFamily:"SF Pro, system-ui, sans-serif",fontWeight:400},children:"Select Dictation Software"}),o.jsx(V,{style:{marginBottom:16},children:o.jsxs("select",{value:n,onChange:p=>t(p.target.value),style:{width:"100%",padding:"10px",fontSize:"16px",fontFamily:"SF Pro, system-ui, sans-serif",fontWeight:400,borderRadius:16,backgroundColor:"transparent",color:"white",border:"none",outline:"none"},children:[o.jsx("option",{value:"PowerScribe",style:{backgroundColor:"#1a1d23",color:"white"},children:"PowerScribe"}),o.jsx("option",{value:"Fluency",style:{backgroundColor:"#1a1d23",color:"white"},children:"Fluency"}),o.jsx("option",{value:"Dragon",style:{backgroundColor:"#1a1d23",color:"white"},children:"Dragon"}),o.jsx("option",{value:"Other",style:{backgroundColor:"#1a1d23",color:"white"},children:"Other"})]})}),n==="Other"&&o.jsxs(V,{style:{marginBottom:16,padding:8},children:[o.jsx("input",{type:"text",value:s,placeholder:"Enter window title of your dictation software",onChange:p=>c(p.target.value),onFocus:()=>h(!0),onBlur:()=>h(!1),style:{width:"100%",padding:"10px",fontSize:"11px",fontFamily:"DM Sans, sans-serif",fontWeight:400,borderRadius:16,backgroundColor:"transparent",color:"white",border:"none",outline:"none",marginBottom:4}}),g&&o.jsx("div",{style:{fontSize:12,color:"#fff",fontFamily:"DM Sans, sans-serif",fontWeight:400},children:'(Case sensitive. Only partial matching required. e.g. "Dragon" for Dragon Medical One)'})]}),o.jsxs("div",{style:{textAlign:"right",display:"flex",gap:12,justifyContent:"flex-end"},children:[o.jsx(V,{onClick:()=>{r&&r()},style:{color:"white",padding:"8px 16px",backgroundColor:"rgba(108, 117, 125, 0.3)"},children:"Cancel"}),o.jsx(V,{onClick:m,style:{color:"white",padding:"8px 16px",backgroundColor:"#3b82f6"},children:"Confirm"})]})]})}):null},Ne=({visible:l,onClose:n})=>{const t=[{hotkey:"Ctrl+Alt+1",action:"autofill-1",enabled:!0,text:""},{hotkey:"Ctrl+Alt+2",action:"autofill-2",enabled:!0,text:""}],[i,r]=d.useState(t);d.useEffect(()=>{const c=JSON.parse(localStorage.getItem("globalShortcuts")||"[]");Array.isArray(c)&&c.length===t.length&&c.every((h,m)=>h.hotkey===t[m].hotkey)?r(c):(localStorage.setItem("globalShortcuts",JSON.stringify(t)),r(t))},[]);const s=()=>{var g,h;localStorage.setItem("globalShortcuts",JSON.stringify(i));const c=i.map(m=>({hotkey:m.hotkey,action:m.action,text:m.text,enabled:m.enabled}));(h=(g=window.electron)==null?void 0:g.ipcRenderer)==null||h.invoke("compile-autofill-hotkeys",c),n()};return l?o.jsx("div",{className:"modal-overlay",children:o.jsxs("div",{className:"modal-content",children:[o.jsx("h2",{style:{fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:400},children:"Keyboard Shortcut Settings"}),i.map((c,g)=>o.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:30,opacity:c.enabled?1:.4},children:[o.jsx("input",{type:"checkbox",checked:c.enabled,onChange:h=>{const m=[...i];m[g].enabled=h.target.checked,r(m)}}),o.jsx("div",{style:{width:120},children:c.hotkey}),o.jsxs("div",{style:{width:200,fontSize:14,display:"flex",flexDirection:"column",alignItems:"center"},children:[c.action==="autofill-1"&&"Auto Text Fill 1",c.action==="autofill-2"&&"Auto Text Fill 2",c.action.startsWith("autofill")&&o.jsx("input",{type:"password",value:c.text||"",onChange:h=>{const m=[...i];m[g].text=h.target.value,r(m)},placeholder:"Paste text",style:{width:180,marginTop:4,padding:"4px 8px",borderRadius:4,border:"none",backgroundColor:"#2c2c2c",color:"#fff",fontSize:14,fontFamily:"'DM Sans', sans-serif",fontWeight:400}})]})]},g)),o.jsxs("div",{style:{textAlign:"right",marginTop:20,display:"flex",gap:12,justifyContent:"flex-end"},children:[o.jsx("button",{onClick:n,style:{padding:"8px 16px",backgroundColor:"#6c757d",color:"#fff",border:"none",borderRadius:"4px",fontSize:"14px",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:400},children:"Cancel"}),o.jsx("button",{onClick:s,style:{padding:"8px 16px",backgroundColor:"#3ABC96",color:"#fff",border:"none",borderRadius:"4px",fontSize:"14px",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:400},children:"Save"})]})]})}):null};function le(l,n){if(!l||typeof l!="object")return n;if(!n||typeof n!="object")return l;const t={...l};for(const i in n){if(!(i in n))continue;const r=n[i],s=t[i];if(Array.isArray(r))if(Array.isArray(s)){const c=[...s,...r];t[i]=[...new Set(c)]}else t[i]=[...r];else r&&typeof r=="object"&&!Array.isArray(r)?t[i]=le(s||{},r):t[i]=r}return t}function X(){return{version:"2.0",formatting:{preserve_template_punctuation:!0,use_bullet_points:!1,capitalize_sections:!0},report:{no_hallucinated_findings:!0,include_technique_section:!1,expand_lesions:!1},impression:{numerically_itemized:!0,omit_minor_or_incidental_findings_unless_relevant:!1,concise_summary:!1,include_recommendations:!1,first_item_should_address_clinical_concern:!1,exclude_by_default:[],mention_muscle_atrophy_if:"any"},anatomy:{combine_meniscus_and_cartilage_findings:!1,group_by_anatomic_region:!1},clinical:{correlate_with_symptoms:!1,mention_clinical_significance:!1},measurements:{include_all_measurements:!0,use_metric_system:!0},severity:{use_standard_grading:!1,avoid_vague_terms:!1},style:{active_voice:!1,professional_tone:!0},custom_instructions:[]}}async function bt(l,n,t,i=!1){var r;try{let s=X();if(i){console.log("ðŸ’¾ Updating agent logic in offline mode"),s=R.getAgentLogic(n)||X();const c=le(s,t);return R.saveAgentLogic(n,c),{success:!0,finalLogic:c}}try{const{data:c,error:g}=await supabase.from("templates").select("agent_logic").eq("user_id",l).eq("study_type",n.trim());if(g)throw new Error(`Failed to fetch current logic: ${g.message}`);s=c&&c.length>0&&((r=c[0])==null?void 0:r.agent_logic)||X();const h=le(s,t);if(!c||c.length===0)throw new Error(`No template found for study type "${n}". Please create a template for this study type first through the template manager.`);const{error:m}=await supabase.from("templates").update({agent_logic:h}).eq("user_id",l).eq("study_type",n.trim());if(m)throw new Error(`Failed to update logic: ${m.message}`);return R.saveAgentLogic(n,h),{success:!0,finalLogic:h}}catch{console.log("âš ï¸ Failed to update logic online, falling back to offline mode"),s=R.getAgentLogic(n)||X();const g=le(s,t);return R.saveAgentLogic(n,g),{success:!0,finalLogic:g}}}catch(s){return{success:!1,error:`Unexpected error: ${s instanceof Error?s.message:"Unknown error"}`}}}async function xt(l,n,t=!1){try{const i=X();if(t)return console.log("ðŸ’¾ Resetting agent logic to default in offline mode"),R.saveAgentLogic(n,i),{success:!0,finalLogic:i};try{const{data:r,error:s}=await supabase.from("templates").select("id").eq("user_id",l).eq("study_type",n.trim());if(s)throw new Error(`Failed to check template: ${s.message}`);if(!r||r.length===0)throw new Error(`No template found for study type "${n}". Please create a template for this study type first through the template manager.`);const{error:c}=await supabase.from("templates").update({agent_logic:i}).eq("user_id",l).eq("study_type",n.trim());if(c)throw new Error(`Failed to reset logic: ${c.message}`);return R.saveAgentLogic(n,i),{success:!0,finalLogic:i}}catch{return console.log("âš ï¸ Failed to reset logic online, falling back to offline mode"),R.saveAgentLogic(n,i),{success:!0,finalLogic:i}}}catch(i){return{success:!1,error:`Unexpected error: ${i instanceof Error?i.message:"Unknown error"}`}}}async function yt(l,n,t=!1){var i;try{if(!n||!n.trim())return{logic:null,error:"Study type is required"};if(t)return console.log("ðŸ“¦ Getting agent logic from offline storage"),{logic:R.getAgentLogic(n)||X()};try{const{data:r,error:s}=await supabase.from("templates").select("agent_logic").eq("user_id",l).eq("study_type",n.trim());if(s)throw new Error(`Failed to fetch logic: ${s.message}`);let c;return!r||r.length===0?c=X():(r.length>1&&console.warn(`Multiple templates found for user ${l} and study type ${n}. Using the first one.`),c=((i=r[0])==null?void 0:i.agent_logic)||X()),R.saveAgentLogic(n,c),{logic:c}}catch{return console.log("âš ï¸ Failed to fetch logic online, falling back to offline mode"),{logic:R.getAgentLogic(n)||X()}}}catch(r){return{logic:null,error:`Unexpected error: ${r instanceof Error?r.message:"Unknown error"}`}}}function wt({userId:l,studyType:n,templates:t={},onClose:i,isOfflineMode:r=!1}){if(!l||!i)return console.error("LogicEditorChat: Missing essential props (userId or onClose)"),null;const[s,c]=d.useState(n),[g,h]=d.useState([]),[m,p]=d.useState(""),[x,E]=d.useState(!1),[S,f]=d.useState(null),[T,I]=d.useState(!1),[F,$]=d.useState(null);d.useEffect(()=>{if(s&&s.trim()){h([{type:"system",content:`Loading logic for ${s}...`,timestamp:Date.now()}]),f(null);const y=setTimeout(()=>{Q()},800);return()=>clearTimeout(y)}else f(null),h([{type:"system",content:"Please select a study type to edit its logic configuration.",timestamp:Date.now()}])},[s,l]),d.useEffect(()=>{if(F){const y=setTimeout(()=>$(null),3e3);return()=>clearTimeout(y)}},[F]);const Q=async()=>{if(!s||!s.trim())return;const y=Object.keys(t||{});if(y.length>0&&!y.includes(s)){h([{type:"system",content:`Study type "${s}" not found. Please select from available templates or create a new template first.`,timestamp:Date.now()}]),f(null);return}const b=await yt(l,s,r);b.error?(_("error",`Failed to load current logic: ${b.error}`),h([{type:"system",content:`Error loading logic for ${s}: ${b.error}`,timestamp:Date.now()}])):(f(b.logic),h([{type:"system",content:`Current logic loaded for ${s}. You can now give instructions to modify your report generation logic.`,timestamp:Date.now()}]))},_=(y,b)=>{$({type:y,text:b})},C=async()=>{if(!m.trim()||x||!s)return;const y={type:"user",content:m.trim(),timestamp:Date.now()};h(b=>[...b,y]),p(""),E(!0);try{const b=await W(m.trim());if(!b.success)throw new Error(b.error||"Failed to process instruction");let P;try{P=JSON.parse(b.content),console.log("ðŸ§® LogicEditorChat: Parsed delta from Claude:",JSON.stringify(P,null,2))}catch{throw console.error("âŒ LogicEditorChat: Failed to parse JSON response:",b.content),new Error("Invalid JSON response from AI")}console.log("ðŸ’¾ LogicEditorChat: Updating agent logic in Supabase..."),console.log("ðŸ“Š Delta to apply:",JSON.stringify(P,null,2));const Y=await bt(l,s,P,r);if(!Y.success)throw new Error(Y.error||"Failed to update logic");f(Y.finalLogic),console.log("âœ… LogicEditorChat: Logic updated successfully!"),console.log("ðŸŽ¯ Final merged logic:",JSON.stringify(Y.finalLogic,null,2));const O=b.tokens?`

ðŸ“Š Token usage: ${b.tokens.input} input + ${b.tokens.output} output = ${b.tokens.total} total`:"",ee={type:"assistant",content:`âœ… Logic updated successfully! Applied changes: ${JSON.stringify(P,null,2)}${O}`,timestamp:Date.now()};h(q=>[...q,ee]),_("success","Logic updated successfully!")}catch(b){const P={type:"assistant",content:`âŒ Error: ${b instanceof Error?b.message:"Unknown error occurred"}`,timestamp:Date.now()};h(Y=>[...Y,P]),_("error",`Failed to update logic: ${b instanceof Error?b.message:"Unknown error"}`)}finally{E(!1)}},W=async y=>{var b,P;try{const Y=`${Xe}

Current logic:
${JSON.stringify(S,null,2)}

User instruction: ${y}`;console.log("ðŸ” LogicEditorChat: Sending prompt to Claude Sonnet:"),console.log("â”€".repeat(80)),console.log(Y),console.log("â”€".repeat(80)),console.log(`ðŸ“ User instruction: "${y}"`),console.log(`ðŸ§  Current logic keys: ${Object.keys(S||{}).join(", ")}`);const O=await((P=(b=window.electronAPI)==null?void 0:b.generateReportWithProvider)==null?void 0:P.call(b,Y,"claude-sonnet"));if(!O)return console.error("âŒ LogicEditorChat: No response from Claude API"),{success:!1,error:"No response from Claude API"};const ee=typeof O=="string"?O:(O==null?void 0:O.text)||"",q=(O==null?void 0:O.tokens)||{input:0,output:0,total:0};return console.log("ðŸ“¥ LogicEditorChat: Response from Claude:"),console.log("â”€".repeat(80)),console.log(ee),console.log("â”€".repeat(80)),console.log("ðŸŽ¯ Token usage:",q),typeof O=="string"?{success:!0,content:O,tokens:{input:0,output:0,total:0}}:O!=null&&O.text?{success:!0,content:O.text,tokens:q}:(console.error("âŒ LogicEditorChat: Invalid response format:",O),{success:!1,error:"Invalid response format"})}catch(Y){return console.error("âŒ LogicEditorChat: API call failed:",Y),{success:!1,error:Y instanceof Error?Y.message:"API call failed"}}},k=async()=>{if(s){E(!0);try{const y=await xt(l,s,r);if(!y.success)throw new Error(y.error||"Failed to reset logic");f(y.finalLogic),h(b=>[...b,{type:"system",content:"ðŸ”„ Logic reset to default settings.",timestamp:Date.now()}]),_("success","Logic reset to default successfully!")}catch(y){_("error",`Failed to reset logic: ${y instanceof Error?y.message:"Unknown error"}`)}finally{E(!1),I(!1)}}},z=y=>{y.key==="Enter"&&!y.shiftKey&&(y.preventDefault(),C())};return o.jsxs("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:[o.jsxs("div",{style:{width:"90%",maxWidth:800,height:"90%",backgroundColor:"rgba(42, 45, 49, 0.95)",backdropFilter:"blur(20px)",WebkitBackdropFilter:"blur(20px)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:16,display:"flex",flexDirection:"column",overflow:"hidden"},children:[o.jsxs("div",{style:{padding:"20px",borderBottom:"1px solid rgba(255, 255, 255, 0.1)",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[o.jsxs("div",{style:{flex:1},children:[o.jsx("h2",{style:{color:"#fff",margin:"0 0 12px 0",fontSize:20,fontWeight:600},children:"Edit Logic"}),o.jsxs("div",{style:{marginBottom:"8px"},children:[o.jsx("input",{list:"logic-study-types",value:s,onChange:y=>c(y.target.value),placeholder:"Select or search study type...",disabled:!1,style:{width:"100%",maxWidth:"300px",padding:"8px 12px",backgroundColor:"rgba(255, 255, 255, 0.05)",color:s?"#fff":"#999",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:8,fontSize:14,outline:"none",fontFamily:"inherit"}}),o.jsx("datalist",{id:"logic-study-types",children:t&&Object.keys(t).sort().map(y=>o.jsx("option",{value:y},y))})]}),o.jsx("p",{style:{color:"#999",margin:0,fontSize:14},children:s?`Editing logic for ${s}`:"Select a study type to edit its logic"}),o.jsxs("p",{style:{color:"#3ABC96",margin:"4px 0 0 0",fontSize:12,fontWeight:500},children:["ðŸ¤– Powered by Claude 4 Sonnet",r&&" â€¢ ðŸ”Œ Offline Mode"]})]}),o.jsx("button",{onClick:i,style:{background:"transparent",border:"none",color:"#999",fontSize:24,cursor:"pointer",padding:"0 8px",lineHeight:1},children:"Ã—"})]}),o.jsxs("div",{style:{flex:1,padding:"20px",overflowY:"auto",display:"flex",flexDirection:"column",gap:"16px"},children:[g.map((y,b)=>o.jsxs("div",{style:{alignSelf:y.type==="user"?"flex-end":"flex-start",maxWidth:"80%"},children:[o.jsx("div",{style:{padding:"12px 16px",borderRadius:12,backgroundColor:y.type==="user"?"rgba(58, 188, 150, 0.2)":y.type==="system"?"rgba(100, 100, 100, 0.2)":"rgba(255, 255, 255, 0.1)",color:"#fff",fontSize:14,lineHeight:1.4,whiteSpace:"pre-wrap"},children:y.content}),o.jsx("div",{style:{fontSize:11,color:"#666",textAlign:y.type==="user"?"right":"left",marginTop:"4px"},children:new Date(y.timestamp).toLocaleTimeString()})]},b)),x&&o.jsx("div",{style:{alignSelf:"flex-start",maxWidth:"80%"},children:o.jsx("div",{style:{padding:"12px 16px",borderRadius:12,backgroundColor:"rgba(255, 255, 255, 0.1)",color:"#fff",fontSize:14},children:"Processing your instruction..."})})]}),o.jsxs("div",{style:{padding:"20px",borderTop:"1px solid rgba(255, 255, 255, 0.1)",display:"flex",gap:"12px",alignItems:"flex-end"},children:[o.jsx("textarea",{value:m,onChange:y=>p(y.target.value),onKeyPress:z,placeholder:s?"Type your instruction (e.g., 'Make my impression more concise')":"Select a study type first",disabled:x||!s,style:{flex:1,minHeight:60,maxHeight:120,padding:"12px",backgroundColor:"rgba(255, 255, 255, 0.05)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:8,color:"#fff",fontSize:14,fontFamily:"inherit",resize:"vertical",outline:"none",opacity:s?1:.5}}),o.jsx("button",{onClick:C,disabled:!m.trim()||x||!s,style:{padding:"12px 20px",backgroundColor:!m.trim()||x||!s?"rgba(100, 100, 100, 0.3)":"rgba(58, 188, 150, 0.2)",border:"1px solid rgba(58, 188, 150, 0.3)",borderRadius:8,color:!m.trim()||x||!s?"#666":"#3ABC96",fontSize:14,fontWeight:500,cursor:!m.trim()||x||!s?"not-allowed":"pointer",transition:"all 0.2s ease"},children:"Send"}),o.jsx("button",{onClick:()=>I(!0),disabled:x||!s,style:{padding:"12px 16px",backgroundColor:"rgba(227, 103, 86, 0.2)",border:"1px solid rgba(227, 103, 86, 0.3)",borderRadius:8,color:x||!s?"#666":"#E36756",fontSize:14,fontWeight:500,cursor:x||!s?"not-allowed":"pointer",transition:"all 0.2s ease"},children:"Reset"})]}),S&&o.jsxs("div",{style:{padding:"20px",borderTop:"1px solid rgba(255, 255, 255, 0.1)",backgroundColor:"rgba(0, 0, 0, 0.2)",maxHeight:"200px",overflowY:"auto"},children:[o.jsx("h4",{style:{color:"#fff",margin:"0 0 12px 0",fontSize:14},children:"Current Logic:"}),o.jsx("pre",{style:{color:"#999",fontSize:12,fontFamily:"Monaco, monospace",margin:0,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:JSON.stringify(S,null,2)})]})]}),T&&o.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.8)",display:"flex",alignItems:"center",justifyContent:"center"},children:o.jsxs("div",{style:{backgroundColor:"rgba(42, 45, 49, 0.95)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:12,padding:"24px",maxWidth:400},children:[o.jsx("h3",{style:{color:"#fff",margin:"0 0 16px 0",fontSize:18},children:"Reset to Default Logic?"}),o.jsx("p",{style:{color:"#999",margin:"0 0 24px 0",fontSize:14},children:"This will reset all custom logic settings to their default values. This action cannot be undone."}),o.jsxs("div",{style:{display:"flex",gap:"12px",justifyContent:"flex-end"},children:[o.jsx("button",{onClick:()=>I(!1),style:{padding:"8px 16px",backgroundColor:"transparent",border:"1px solid rgba(255, 255, 255, 0.2)",borderRadius:6,color:"#fff",fontSize:14,cursor:"pointer"},children:"Cancel"}),o.jsx("button",{onClick:k,style:{padding:"8px 16px",backgroundColor:"rgba(227, 103, 86, 0.2)",border:"1px solid rgba(227, 103, 86, 0.3)",borderRadius:6,color:"#E36756",fontSize:14,cursor:"pointer"},children:"Reset"})]})]})}),F&&o.jsx("div",{style:{position:"absolute",top:"20px",right:"20px",padding:"12px 16px",backgroundColor:F.type==="success"?"rgba(58, 188, 150, 0.9)":"rgba(227, 103, 86, 0.9)",border:`1px solid ${F.type==="success"?"#3ABC96":"#E36756"}`,borderRadius:8,color:"#fff",fontSize:14,fontWeight:500,backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",zIndex:1001},children:F.text})]})}function St(l,n){let t=null;const i=(...r)=>{t&&clearTimeout(t),t=setTimeout(()=>{l(...r)},n)};return i.cancel=()=>{t&&(clearTimeout(t),t=null)},i}const re=new Map,Z={getItem(l){if(re.has(l))return re.get(l)||null;const n=localStorage.getItem(l);return re.set(l,n),n},setItem(l,n){re.set(l,n),"requestIdleCallback"in window?requestIdleCallback(()=>{localStorage.setItem(l,n)}):setTimeout(()=>{localStorage.setItem(l,n)},0)},removeItem(l){re.delete(l),"requestIdleCallback"in window?requestIdleCallback(()=>{localStorage.removeItem(l)}):setTimeout(()=>{localStorage.removeItem(l)},0)},clear(){re.clear()}},kt=Oe.memo(function(){var Fe,je,Ee;console.log("ðŸš€ MAIN APP STARTING - if you see this, the main app is loading!");const{width:n,isContracted:t}=gt(),i=ft(),[r,s]=d.useState(""),[c,g]=d.useState(!1),[h,m]=d.useState(null),[p,x]=d.useState(!1),[E,S]=d.useState(null),[f,T]=d.useState(null),I=!0,[F,$]=d.useState(!1),[Q,_]=d.useState(!1),[C,W]=d.useState(!1),{user:k,signOut:z,loading:y}=me(),b=!1,P=d.useCallback(e=>{T(e),setTimeout(()=>T(null),3e3)},[]),[Y,O]=d.useState(()=>Z.getItem("dictationTarget")||"PowerScribe"),[ee,q]=d.useState(!1),[he,se]=d.useState(!1),[oe,te]=d.useState(!1),[De,be]=d.useState(!1),[We,ce]=d.useState(!1);d.useState(!1);const[D,xe]=d.useState("openai"),[L,de]=d.useState({used:0,limit:125e3,percentage:0}),[ye,ze]=d.useState("void-black"),[N,we]=d.useState(""),[Se,H]=d.useState([]),[vt,K]=d.useState(""),[ke,ve]=d.useState(!1),ne=d.useRef(0);d.useEffect(()=>{var e;(e=window.electronAPI)!=null&&e.getApiProvider&&window.electronAPI.getApiProvider().then(a=>{xe(a)})},[]),d.useEffect(()=>{const e=Z.getItem("colorScheme");e&&(e==="venice-blue"||e==="dark-ocean"||e==="lawrencium"||e==="deep-space"||e==="void-black"||e==="yoda")&&ze(e)},[]),d.useEffect(()=>{document.body.className=document.body.className.replace(/color-scheme-[\w-]+/g,""),document.body.classList.add(`color-scheme-${ye}`)},[ye]),d.useEffect(()=>{const e=a=>{if(oe){const u=a.target,v=document.querySelector(".settings-sidebar"),w=document.querySelector("[data-settings-trigger]");v&&!v.contains(u)&&w&&!w.contains(u)&&te(!1)}};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[oe]),d.useEffect(()=>{var e,a,u;if((e=window.electronAPI)!=null&&e.getTokenUsage){window.electronAPI.getTokenUsage().then(w=>{de(w)});const v=w=>{de(w)};(u=(a=window.electronAPI).onTokenUsageUpdated)==null||u.call(a,v)}},[]),d.useEffect(()=>{var e;k&&((e=window.electronAPI)!=null&&e.getTokenUsage)&&setTimeout(()=>{window.electronAPI.getTokenUsage().then(a=>{console.log("ðŸ”„ Refreshing token usage after user login:",a),de(a)})},1e3)},[k]);const ie=async e=>{var a;xe(e),(a=window.electronAPI)!=null&&a.setApiProvider&&await window.electronAPI.setApiProvider(e)},Be=()=>{var e;(e=window.electron)!=null&&e.ipcRenderer?window.electron.ipcRenderer.send("contract-window"):console.error("Electron IPC not available")},_e=()=>{var e,a;(a=(e=window.electron)==null?void 0:e.ipcRenderer)==null||a.send("minimize-popup")},Ce=()=>{var e,a;(a=(e=window.electron)==null?void 0:e.ipcRenderer)==null||a.send("close-popup")},$e=()=>{var e,a;(a=(e=window.electron)==null?void 0:e.ipcRenderer)==null||a.send("expand-window")},pe=d.useCallback(async()=>{var e,a;if(c){if(g(!1),m(null),(e=window.electronAPI)!=null&&e.stopDictation)try{await window.electronAPI.stopDictation()}catch(u){console.error("Failed to stop dictation:",u)}}else if(m(null),(a=window.electronAPI)!=null&&a.startDictation)try{const u=await window.electronAPI.startDictation();u.success?g(!0):m(u.error||"Failed to start dictation")}catch(u){m("Failed to start dictation: "+u.message)}},[c]);d.useEffect(()=>{var e;if((e=window.electronAPI)!=null&&e.onDictationText)return window.electronAPI.onDictationText(u=>{s(v=>v+(v?" ":"")+u)})},[]),d.useEffect(()=>{var e;if((e=window.electronAPI)!=null&&e.onDictationError)return window.electronAPI.onDictationError(u=>{console.error("Dictation error:",u),g(!1),m(u)})},[]),d.useEffect(()=>{var e;if((e=window.electronAPI)!=null&&e.onCleanupResult)return window.electronAPI.onCleanupResult(u=>{s(u),x(!1),S(null)})},[]),d.useEffect(()=>{var e;if((e=window.electronAPI)!=null&&e.onCleanupError)return window.electronAPI.onCleanupError(u=>{console.error("Cleanup error:",u),x(!1),S(u)})},[]),d.useEffect(()=>{var e;if((e=window.electronAPI)!=null&&e.onDictationChunkComplete)return window.electronAPI.onDictationChunkComplete(async u=>{var v;if(u&&u.trim().length>0){console.log("ðŸ”„ Processing chunk in real-time:",u),$(!0);try{if((v=window.electronAPI)!=null&&v.autoCleanupText){const w=await window.electronAPI.autoCleanupText(u);w.success&&w.cleanedText?(console.log("ðŸ§  Chunk processed:",u,"â†’",w.cleanedText),s(j=>{const A=j.lastIndexOf(u.trim());return A!==-1?j.slice(0,A)+w.cleanedText+j.slice(A+u.trim().length):j+(j?" ":"")+w.cleanedText})):console.warn("ðŸ§  Chunk processing failed, keeping original")}}catch(w){console.error("ðŸ§  Chunk processing error:",w)}finally{$(!1)}}})},[I]),d.useCallback(async()=>{var e;if(!r||r.trim().length===0){S("No text to clean up");return}if(!p)try{if(x(!0),S(null),(e=window.electronAPI)!=null&&e.cleanupText){const a=await window.electronAPI.cleanupText(r);a.success||(S(a.error||"Failed to clean up text"),x(!1))}else S("Cleanup functionality not available"),x(!1)}catch(a){console.error("Failed to cleanup text:",a),S("Failed to clean up text: "+a.message),x(!1)}},[r,p]),d.useEffect(()=>{const e=a=>{a.key==="F5"&&(a.preventDefault(),pe())};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[pe]);const Ue=()=>{try{const e={...R.exportOfflineData(),exportDate:new Date().toISOString(),version:"1.0"},a=JSON.stringify(e,null,2),u=new Blob([a],{type:"application/json"}),v=URL.createObjectURL(u),w=document.createElement("a");w.href=v,w.download=`radpal-backup-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(v),P("âœ… Backup exported successfully!")}catch(e){console.error("Backup failed:",e),P("âŒ Backup export failed")}},Ge=()=>{try{const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=a=>{var w;const u=(w=a.target.files)==null?void 0:w[0];if(!u)return;const v=new FileReader;v.onload=j=>{var A;try{const M=JSON.parse((A=j.target)==null?void 0:A.result);if(!M.version||!M.exportDate)throw new Error("Invalid backup file format");R.importOfflineData(M),P("âœ… Backup restored successfully! Please restart the app to see changes.")}catch(M){console.error("Restore failed:",M),P("âŒ Backup restore failed - invalid file format")}},v.readAsText(u)},e.click()}catch(e){console.error("Restore failed:",e),P("âŒ Backup restore failed")}},Ye=()=>{ce(!0),te(!1)},Le=e=>{var a,u,v,w,j,A,M;e==="edit"?(u=(a=window.electron)==null?void 0:a.ipcRenderer)==null||u.send("open-popup-templates"):e==="edit-logic"?(w=(v=window.electron)==null?void 0:v.ipcRenderer)==null||w.send("open-popup-logic"):e==="debug"?window.dispatchEvent(new CustomEvent("toggle-debug")):e==="shortcuts"?se(!0):e==="logout"&&((A=(j=window.electron)==null?void 0:j.ipcRenderer)==null||A.send("resize-window",{width:600,height:900}),(M=window.electronAPI)==null||M.authSignOut().then(()=>{Z.setItem("autoFindings","false"),setTimeout(()=>{window.location.reload()},100)}))};d.useEffect(()=>{var e,a,u,v;!k&&!y?(document.body.classList.add("login-mode"),document.body.classList.remove("main-mode")):k&&(document.body.classList.add("main-mode"),document.body.classList.remove("login-mode"),(a=(e=window.electron)==null?void 0:e.ipcRenderer)==null||a.send("resize-window",{width:600,height:900}),(v=(u=window.electron)==null?void 0:u.ipcRenderer)==null||v.invoke("launch-autofill-hotkeys"))},[k,y]),d.useEffect(()=>{k&&(async()=>{var u,v,w,j;const a=await((u=window.electronAPI)==null?void 0:u.authGetSession());(v=a==null?void 0:a.data)!=null&&v.session&&((j=(w=window.electron)==null?void 0:w.ipcRenderer)==null||j.invoke("set-supabase-session",a.data.session))})()},[k]),d.useEffect(()=>{var a,u;const e=(u=(a=window.electronAPI)==null?void 0:a.onPopupContent)==null?void 0:u.call(a,v=>{(v==null?void 0:v.type)==="toggle-debug"&&_(w=>!w)});return()=>{e&&typeof e=="function"&&e()}},[]),d.useEffect(()=>{const e=()=>_(a=>!a);return window.addEventListener("toggle-debug",e),()=>window.removeEventListener("toggle-debug",e)},[]),d.useEffect(()=>{var e,a;k&&((a=(e=window.electron)==null?void 0:e.ipcRenderer)==null||a.invoke("set-current-user",k).then(()=>{}).catch(()=>{}))},[k]),d.useEffect(()=>{const e=window==null?void 0:window.electron;if(!e||typeof e.on!="function")return;const a=()=>{ge()},u=()=>{fe()},v=(w,j)=>{const M=JSON.parse(Z.getItem("globalShortcuts")||"[]").find(qe=>qe.action===j);M!=null&&M.text&&(navigator.clipboard.writeText(M.text),setTimeout(()=>document.execCommand("paste"),100))};return e.on("trigger-generate-report",a),e.on("trigger-generate-impression",u),e.on("trigger-auto-text-fill",v),()=>{e.removeListener("trigger-generate-report",a),e.removeListener("trigger-generate-impression",u),e.removeListener("trigger-auto-text-fill",v)}},[]);const{templates:J={},loading:U=!1,saveTemplate:_t=async()=>{}}=ut(k,!0,b)||{},{generateReport:ae,generateReportFromTemplates:Ct,generateImpressionFromTemplates:Tt,loading:B,debugPrompt:Je,debugResult:He}=Qe(),{generateReportWithAgent:ue,generateImpressionWithAgent:Te,loading:It,error:At}=dt(),Ie=d.useCallback(async e=>{if(!e.trim()||e.length<10||N){H([]),K("");return}if(!ae||typeof ae!="function"||B){console.log("generateReport function not available or loading for auto-suggest");return}const a=Date.now();if(a-ne.current<15e3){console.log("Auto-suggest throttled - too frequent requests");return}ne.current=a,ve(!0);try{const u=`You are a radiology assistant. Based on the following imaging findings, identify the most appropriate study types from this exact list, ranked by confidence:

MRI Ankle, MRI Foot, MRI Knee, MRI Hip, MRI Shoulder, MRI Elbow, MRI Wrist, MRI Hand, MRI Cervical Spine, MRI Thoracic Spine, MRI Lumbar Spine, MRI Total Spine, DEXA, CT Generic, MRI Generic, DEXA, CT Abdomen Pelvis, CT Pulmonary Embolism, CT Chest, CT Head, Knee Test Template

Imaging Findings:
${e}

Respond with up to 3 study types in descending confidence order. Output ONLY valid JSON array (no markdown, no code blocks, no extra text):
[
  {"type": "Most likely study type", "confidence": 95},
  {"type": "Second most likely", "confidence": 75},
  {"type": "Third possibility", "confidence": 50}
]

Only include study types with confidence > 40%. Use exact names from the list above. Return ONLY the JSON array, nothing else.`;let w=(await ae(u)).text.trim();w.includes("```")&&(w=w.replace(/```json\s*/gi,"").replace(/```\s*/g,"").trim());try{const j=JSON.parse(w);if(console.log("ðŸ” Parsed suggestions:",j),Array.isArray(j)&&j.length>0){const A=j.filter(M=>M.type&&M.confidence&&J[M.type]&&M.type!==N).slice(0,3);console.log("ðŸ” Valid suggestions:",A),A.length>0?(H(A),K(A[0].type)):(console.log("ðŸ” No valid suggestions found"),H([]),K(""))}else{const A=w.replace(/[^\w\s]/g,"").trim();A&&J[A]&&A!==N?(H([{type:A,confidence:80}]),K(A)):(H([]),K(""))}}catch(j){if(console.log("ðŸ” JSON parse error:",j),console.log("ðŸ” Response text was:",w),w.includes("token limit exceeded")){console.log("âš ï¸ Token limit exceeded, stopping auto-suggest"),H([]),K("");return}const A=w.replace(/[^\w\s]/g,"").trim();A&&J[A]&&A!==N?(console.log("ðŸ” Fallback suggestion:",A),H([{type:A,confidence:80}]),K(A)):(H([]),K(""))}}catch(u){console.log("Failed to generate study type suggestion:",u),H([]),K("")}finally{ve(!1)}},[N,J,ae,B]),Ke=d.useMemo(()=>St(Ie,2e3),[Ie]),Ae=e=>{var u;const a=(e==null?void 0:e.mode)==="impression-only"?"open-popup-impression":"open-popup";(u=window==null?void 0:window.electron)!=null&&u.ipcRenderer&&window.electron.ipcRenderer.send(a,e)},ge=d.useCallback(async()=>{var e,a;try{if(console.log("ðŸ” handleGenerate called"),console.log("ðŸ” selectedStudyType:",N),console.log("ðŸ” templates keys:",Object.keys(J)),console.log("ðŸ” generateReportWithAgent available:",!!ue),!N){console.log("âŒ No study type selected"),P("Please select a study type before generating report");return}if(!J[N]){console.log("âŒ Study type not found in templates:",N),console.log("âŒ Available templates:",Object.keys(J)),P(`Invalid study type: "${N}". Please select from the available options.`);return}let u=r;C&&((e=window.electronAPI)!=null&&e.getFindings)&&(u=await window.electronAPI.getFindings(),s(u)),console.log("ðŸ” Opening loading popup"),Ae({type:"loading",mode:"gpt-diff"});try{console.log("ðŸ” Starting report generation with agent");const v=Re(D),w=Date.now(),j=await ue(u,N,v);console.log("ðŸ” Agent result:",j);const A=((Date.now()-w)/1e3).toFixed(1),M={template:((a=J[N])==null?void 0:a.template)||"",result:j.text||"âŒ Report generation failed.",studyType:N,generationTime:A,totalTokens:j.tokens};console.log("ðŸ” Sending content to popup:",M),setTimeout(()=>{window.electron.ipcRenderer.send("popup-inject-content",M)},50)}catch(v){console.error("Agent report generation failed:",v),window.electron.ipcRenderer.send("popup-inject-content",{type:"report-only",result:`âŒ Report generation failed: ${v.message||"Unknown error"}`})}}catch(u){console.error("âŒ handleGenerate error:",u),P(`Generation failed: ${u.message||"Unknown error"}`)}},[C,J,ue,r,N,D,P]),fe=d.useCallback(async()=>{var a;if(!N){P("Please select a study type before generating impression");return}if(!J[N]){P(`Invalid study type: "${N}". Please select from the available options.`);return}let e=r;C&&((a=window.electronAPI)!=null&&a.getFindings)&&(e=await window.electronAPI.getFindings(),s(e)),Ae({type:"loading",mode:"impression-only"});try{const u=Re(D),v=Date.now(),w=await Te(e,N,u),j=((Date.now()-v)/1e3).toFixed(1);setTimeout(()=>{window.electron.ipcRenderer.send("popup-inject-content",{type:"impression-only",result:w.text||"âŒ Impression generation failed.",studyType:N,generationTime:j,totalTokens:w.tokens})},50)}catch(u){console.error("Agent impression generation failed:",u),window.electron.ipcRenderer.send("popup-inject-content",{type:"impression-only",result:`âŒ Impression generation failed: ${u.message||"Unknown error"}`})}},[C,J,Te,r,N,D,P]);return y?o.jsx("div",{style:{padding:40},children:"ðŸ” Loading user..."}):k?o.jsx("div",{className:"radpal-outer-frame",style:t?{overflow:"visible"}:{},children:o.jsxs("div",{className:"window-frame",style:t?{overflow:"visible"}:{},children:[!t&&o.jsxs("div",{className:"radpal-root dark",style:{padding:"12px",minHeight:"100vh",boxSizing:"border-box",display:"flex",flexDirection:"column"},children:[o.jsx("div",{style:{position:"absolute",top:5,left:60,right:100,height:30,WebkitAppRegion:"drag",zIndex:999},onDoubleClick:e=>e.preventDefault()}),o.jsx("button",{style:{position:"absolute",top:20,left:16,background:"rgba(42, 45, 49, 0.8)",backdropFilter:"blur(12px) saturate(120%)",WebkitBackdropFilter:"blur(12px) saturate(120%)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:12,padding:"8px 12px",color:"#fff",userSelect:"none",WebkitAppRegion:"no-drag",zIndex:1002,fontSize:14,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",cursor:"pointer",transition:"all 0.2s ease",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.1)"},onMouseEnter:e=>{e.currentTarget.style.background="rgba(58, 61, 65, 0.85)",e.currentTarget.style.borderColor="rgba(255, 255, 255, 0.2)",e.currentTarget.style.transform="translateY(-1px)",e.currentTarget.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.15)"},onMouseLeave:e=>{e.currentTarget.style.background="rgba(42, 45, 49, 0.8)",e.currentTarget.style.borderColor="rgba(255, 255, 255, 0.1)",e.currentTarget.style.transform="translateY(0)",e.currentTarget.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.1)"},onClick:()=>te(!0),"data-settings-trigger":!0,children:"âš™ï¸"}),b,o.jsx("button",{onClick:Be,style:{position:"absolute",top:20,right:90,background:"rgba(255, 255, 255, 0.05)",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",border:"1px solid rgba(255, 255, 255, 0.08)",borderRadius:16,padding:"4px 10px",color:"#ccc",WebkitAppRegion:"no-drag",zIndex:1002,transition:"all 0.2s ease",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.1)",cursor:"pointer"},onMouseEnter:e=>{e.currentTarget.style.background="rgba(255, 255, 255, 0.15)",e.currentTarget.style.borderColor="rgba(255, 255, 255, 0.15)",e.currentTarget.style.color="#fff",e.currentTarget.style.transform="translateY(-1px)",e.currentTarget.style.boxShadow="0 3px 6px rgba(0, 0, 0, 0.15)"},onMouseLeave:e=>{e.currentTarget.style.background="rgba(255, 255, 255, 0.05)",e.currentTarget.style.borderColor="rgba(255, 255, 255, 0.08)",e.currentTarget.style.color="#ccc",e.currentTarget.style.transform="translateY(0)",e.currentTarget.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)"},title:"Contract Window",children:"â¤¢"}),o.jsx("button",{onClick:_e,style:{position:"absolute",top:20,right:50,background:"rgba(255, 255, 255, 0.05)",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",border:"1px solid rgba(255, 255, 255, 0.08)",borderRadius:16,padding:"4px 10px",color:"#ccc",WebkitAppRegion:"no-drag",zIndex:1002,transition:"all 0.2s ease",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.1)",cursor:"pointer"},onMouseEnter:e=>{e.currentTarget.style.background="rgba(255, 255, 255, 0.15)",e.currentTarget.style.borderColor="rgba(255, 255, 255, 0.15)",e.currentTarget.style.color="#fff",e.currentTarget.style.transform="translateY(-1px)",e.currentTarget.style.boxShadow="0 3px 6px rgba(0, 0, 0, 0.15)"},onMouseLeave:e=>{e.currentTarget.style.background="rgba(255, 255, 255, 0.05)",e.currentTarget.style.borderColor="rgba(255, 255, 255, 0.08)",e.currentTarget.style.color="#ccc",e.currentTarget.style.transform="translateY(0)",e.currentTarget.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)"},children:"â€“"}),o.jsx("button",{onClick:Ce,style:{position:"absolute",top:20,right:16,background:"linear-gradient(135deg, #E36756 0%, #c85545 100%)",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:16,padding:"4px 10px",color:"#fff",WebkitAppRegion:"no-drag",zIndex:1002,transition:"all 0.2s ease",boxShadow:"0 2px 6px rgba(227, 103, 86, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1)",cursor:"pointer"},onMouseEnter:e=>{e.currentTarget.style.background="linear-gradient(135deg, #c85545 0%, #b04436 100%)",e.currentTarget.style.transform="translateY(-1px)",e.currentTarget.style.boxShadow="0 4px 8px rgba(227, 103, 86, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.15)",e.currentTarget.style.borderColor="rgba(255, 255, 255, 0.15)"},onMouseLeave:e=>{e.currentTarget.style.background="linear-gradient(135deg, #E36756 0%, #c85545 100%)",e.currentTarget.style.transform="translateY(0)",e.currentTarget.style.boxShadow="0 2px 6px rgba(227, 103, 86, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1)",e.currentTarget.style.borderColor="rgba(255, 255, 255, 0.1)"},children:"Ã—"}),o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",paddingLeft:"7.5%",paddingRight:"7.5%",width:"90%",margin:"0 auto",marginTop:60,marginBottom:15},children:[o.jsx("div",{style:{display:"flex",alignItems:"center",gap:10}}),o.jsx("div",{style:{width:"100%"},children:o.jsxs(V,{style:{display:"flex",flexDirection:"column",padding:8,position:"relative",width:"100%",gap:6},children:[o.jsxs("div",{style:{fontSize:12,color:"#aaa",textAlign:"center",fontWeight:300,textShadow:"none",userSelect:"none",fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif"},children:["Daily tokens: ",((Fe=L==null?void 0:L.used)==null?void 0:Fe.toLocaleString())||0," / ",((je=L==null?void 0:L.limit)==null?void 0:je.toLocaleString())||125e3]}),o.jsx("div",{style:{width:"100%",height:n<600?8:n<800?10:12,backgroundColor:"rgba(20, 22, 25, 0.8)",borderRadius:(n<600?8:n<800?10:12)/2,border:"1px solid rgba(255, 255, 255, 0.15)",overflow:"hidden",position:"relative",boxShadow:"inset 0 2px 4px rgba(0, 0, 0, 0.4), 0 1px 2px rgba(0, 0, 0, 0.2)"},children:o.jsx("div",{style:{width:`${Math.min((L==null?void 0:L.percentage)||0,100)}%`,height:"100%",backgroundColor:((L==null?void 0:L.percentage)||0)>90?"#E36756":((L==null?void 0:L.percentage)||0)>75?"#E1865D":"#3ABC96",transition:"all 0.3s ease",borderRadius:`${(n<600?8:n<800?10:12)/2}px 0 0 ${(n<600?8:n<800?10:12)/2}px`,boxShadow:"0 0 12px rgba(58, 188, 150, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2)"}})})]})})]}),o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",paddingLeft:"7.5%",paddingRight:"7.5%",width:"90%",margin:"0 auto",marginBottom:10},children:[o.jsx("div",{style:{display:"flex",alignItems:"center",gap:10,WebkitAppRegion:"no-drag",zIndex:1,position:"relative"}}),o.jsx("div",{style:{display:"flex",alignItems:"center",gap:10},children:o.jsxs(V,{style:{display:"flex",padding:2},children:[o.jsx("button",{onClick:()=>ie("openai"),style:{padding:"6px 12px",backgroundColor:D==="openai"?"#5F33FF":"transparent",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.1)",boxShadow:D==="openai"?"0 4px 12px rgba(95, 51, 255, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15)":"0 2px 6px rgba(0, 0, 0, 0.1)",...D==="openai"?{background:"linear-gradient(135deg, #5F33FF 0%, #4a28cc 100%)",color:"#fff",textShadow:"none"}:{background:"linear-gradient(to bottom, #ffffff, #999999, #333333)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",textShadow:"none"},borderRadius:16,fontSize:14,fontWeight:300,transition:"all 0.2s ease"},children:"GPT-4o"}),o.jsx("button",{onClick:()=>ie("gemini"),style:{padding:"6px 12px",backgroundColor:D==="gemini"?"#5F33FF":"transparent",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.1)",boxShadow:D==="gemini"?"0 4px 12px rgba(95, 51, 255, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15)":"0 2px 6px rgba(0, 0, 0, 0.1)",...D==="gemini"?{background:"linear-gradient(135deg, #5F33FF 0%, #4a28cc 100%)",color:"#fff",textShadow:"none"}:{background:"linear-gradient(to bottom, #ffffff, #999999, #333333)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",textShadow:"none"},borderRadius:16,fontSize:14,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",transition:"all 0.2s ease"},children:"Gemini 2.5 Flash"}),o.jsx("button",{onClick:()=>ie("claude-sonnet"),style:{padding:"6px 12px",backgroundColor:D==="claude-sonnet"?"#5F33FF":"transparent",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.1)",boxShadow:D==="claude-sonnet"?"0 4px 12px rgba(95, 51, 255, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15)":"0 2px 6px rgba(0, 0, 0, 0.1)",...D==="claude-sonnet"?{background:"linear-gradient(135deg, #5F33FF 0%, #4a28cc 100%)",color:"#fff",textShadow:"none"}:{background:"linear-gradient(to bottom, #ffffff, #999999, #333333)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",textShadow:"none"},borderRadius:16,fontSize:14,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",transition:"all 0.2s ease"},children:"Claude 4 Sonnet"}),o.jsx("button",{onClick:()=>ie("claude-opus"),style:{padding:"6px 12px",backgroundColor:D==="claude-opus"?"#5F33FF":"transparent",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.1)",boxShadow:D==="claude-opus"?"0 4px 12px rgba(95, 51, 255, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15)":"0 2px 6px rgba(0, 0, 0, 0.1)",...D==="claude-opus"?{background:"linear-gradient(135deg, #5F33FF 0%, #4a28cc 100%)",color:"#fff",textShadow:"none"}:{background:"linear-gradient(to bottom, #ffffff, #999999, #333333)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",textShadow:"none"},borderRadius:16,fontSize:14,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",transition:"all 0.2s ease"},children:"Claude 4 Opus"}),o.jsx("button",{onClick:()=>ie("kimi"),style:{padding:"6px 12px",backgroundColor:D==="kimi"?"#5F33FF":"transparent",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.1)",boxShadow:D==="kimi"?"0 4px 12px rgba(95, 51, 255, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15)":"0 2px 6px rgba(0, 0, 0, 0.1)",...D==="kimi"?{background:"linear-gradient(135deg, #5F33FF 0%, #4a28cc 100%)",color:"#fff",textShadow:"none"}:{background:"linear-gradient(to bottom, #ffffff, #999999, #333333)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",textShadow:"none"},borderRadius:16,fontSize:14,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",transition:"all 0.2s ease"},children:"Kimi v2"})]})})]}),o.jsxs("div",{style:{position:"relative",width:"90%",margin:"0 auto 20px auto",opacity:C?0:1,maxHeight:C?0:100,overflow:"visible",transition:"all 0.3s ease",pointerEvents:C?"none":"auto"},children:[o.jsx("input",{list:"study-types",value:N,onChange:e=>{we(e.target.value),e.target.value&&(H([]),K(""),ne.current=Date.now())},placeholder:"Select or search study type...",style:{width:"100%",padding:"12px 16px",backgroundColor:"rgba(42, 45, 49, 0.95)",color:N?"#fff":"#999",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:12,fontSize:14,fontFamily:"DM Sans, sans-serif",outline:"none",cursor:"text",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)"}}),o.jsx("datalist",{id:"study-types",children:J&&Object.keys(J).sort().map(e=>o.jsx("option",{value:e},e))}),(Se.length>0||ke)&&!N&&o.jsx("div",{style:{position:"absolute",top:"100%",left:0,right:0,marginTop:4,background:"rgba(58, 188, 150, 0.1)",border:"1px solid rgba(58, 188, 150, 0.3)",borderRadius:8,padding:"8px 12px",color:"#3ABC96",fontSize:12,fontWeight:500,backdropFilter:"blur(10px)",WebkitBackdropFilter:"blur(10px)",zIndex:10},children:ke?o.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[o.jsx("div",{style:{width:12,height:12,border:"2px solid rgba(58, 188, 150, 0.3)",borderTop:"2px solid #3ABC96",borderRadius:"50%"},className:i.spin}),"Analyzing findings..."]}):o.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"6px"},children:[o.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"4px"},children:[o.jsx("span",{children:"ðŸ¤– AI Suggestions:"}),o.jsx("button",{onClick:()=>{H([]),K(""),ne.current=Date.now()},style:{background:"transparent",border:"none",color:"rgba(58, 188, 150, 0.7)",fontSize:10,cursor:"pointer",padding:"2px"},children:"Ã—"})]}),Se.map((e,a)=>o.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"4px 6px",background:a===0?"rgba(58, 188, 150, 0.15)":"rgba(58, 188, 150, 0.05)",borderRadius:"4px",fontSize:"11px"},children:[o.jsxs("span",{style:{flex:1},children:[o.jsx("strong",{children:e.type}),o.jsxs("span",{style:{opacity:.7,marginLeft:"6px"},children:["(",e.confidence,"%)"]})]}),o.jsx("button",{onClick:()=>{we(e.type),H([]),K(""),ne.current=Date.now()},style:{background:"rgba(58, 188, 150, 0.2)",border:"1px solid rgba(58, 188, 150, 0.3)",borderRadius:3,color:"#3ABC96",fontSize:9,padding:"2px 5px",cursor:"pointer",marginLeft:"8px"},children:"Use"})]},e.type))]})})]}),o.jsx("div",{style:{maxHeight:C?0:500,opacity:C?0:1,overflow:"visible",transition:"all 0.3s ease",marginBottom:C?0:20,pointerEvents:C?"none":"auto",width:"90%",margin:"0 auto"},children:o.jsxs("div",{style:{position:"relative",background:"rgba(42, 45, 49, 0.95)",backdropFilter:"none",WebkitBackdropFilter:"none",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:16,overflow:"hidden"},children:[o.jsx("textarea",{value:r,onChange:e=>{const a=e.target.value;if(s(a),a.trim().length<10){H([]),K("");return}if(a.trim().length>20)try{Ke(a)}catch(u){console.log("Auto-suggest error:",u)}},placeholder:"Enter findings here...",style:{width:"100%",height:"40vh",minHeight:200,maxHeight:"50vh",padding:"16px 40px 16px 16px",backgroundColor:"transparent",color:"#fff",border:"none",borderRadius:16,resize:"none",fontSize:14,outline:"none",fontFamily:"DM Sans, sans-serif"}}),o.jsx("button",{onClick:pe,style:{position:"absolute",top:r?54:16,right:16,background:c?"rgba(227, 103, 86, 0.2)":"rgba(58, 188, 150, 0.1)",backdropFilter:"blur(6px)",WebkitBackdropFilter:"blur(6px)",color:c?"#E36756":"#3ABC96",border:`1px solid ${c?"rgba(227, 103, 86, 0.3)":"rgba(58, 188, 150, 0.2)"}`,borderRadius:"50%",width:32,height:32,fontSize:16,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",display:"flex",alignItems:"center",justifyContent:"center",lineHeight:1,transition:"all 0.2s ease",cursor:"pointer",boxShadow:c?"0 2px 6px rgba(227, 103, 86, 0.3), 0 0 10px rgba(227, 103, 86, 0.2)":"0 1px 3px rgba(58, 188, 150, 0.2)",animation:c?"pulse 1.5s infinite":"none"},onMouseEnter:e=>{c?(e.currentTarget.style.background="rgba(227, 103, 86, 0.3)",e.currentTarget.style.borderColor="rgba(227, 103, 86, 0.4)",e.currentTarget.style.boxShadow="0 3px 8px rgba(227, 103, 86, 0.4), 0 0 15px rgba(227, 103, 86, 0.3)"):(e.currentTarget.style.background="rgba(58, 188, 150, 0.2)",e.currentTarget.style.borderColor="rgba(58, 188, 150, 0.3)",e.currentTarget.style.boxShadow="0 2px 6px rgba(58, 188, 150, 0.3)"),e.currentTarget.style.transform="scale(1.1)"},onMouseLeave:e=>{e.currentTarget.style.background=c?"rgba(227, 103, 86, 0.2)":"rgba(58, 188, 150, 0.1)",e.currentTarget.style.borderColor=c?"rgba(227, 103, 86, 0.3)":"rgba(58, 188, 150, 0.2)",e.currentTarget.style.transform="scale(1)",e.currentTarget.style.boxShadow=c?"0 2px 6px rgba(227, 103, 86, 0.3), 0 0 10px rgba(227, 103, 86, 0.2)":"0 1px 3px rgba(58, 188, 150, 0.2)"},"aria-label":c?"Stop dictation":"Start dictation",title:c?"Stop dictation":"Start dictation",children:"ðŸŽ™ï¸"}),r&&o.jsx("button",{onClick:()=>{s("")},style:{position:"absolute",top:16,right:16,background:"transparent",color:"#E36756",border:"none",fontSize:14,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",padding:0,lineHeight:1,transition:"transform 0.2s ease"},className:i.clearButton,"aria-label":"Clear findings",children:"Ã—"})]})}),h&&o.jsxs("div",{style:{padding:"8px 12px",margin:"8px 0",backgroundColor:"rgba(227, 103, 86, 0.1)",border:"1px solid rgba(227, 103, 86, 0.3)",borderRadius:"8px",color:"#E36756",fontSize:"12px",fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",textAlign:"center"},children:["âš ï¸ ",h,o.jsx("button",{onClick:()=>m(null),style:{marginLeft:"8px",background:"none",border:"none",color:"#E36756",fontSize:"12px",padding:0},children:"âœ•"})]}),E&&o.jsxs("div",{style:{padding:"8px 12px",margin:"8px 0",backgroundColor:"rgba(227, 103, 86, 0.1)",border:"1px solid rgba(227, 103, 86, 0.3)",borderRadius:"8px",color:"#E36756",fontSize:"12px",fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",textAlign:"center"},children:["ðŸ§  ",E,o.jsx("button",{onClick:()=>S(null),style:{marginLeft:"8px",background:"none",border:"none",color:"#E36756",cursor:"pointer",fontSize:"12px",padding:"2px 4px",borderRadius:"4px"},children:"âœ•"})]}),F&&o.jsx("div",{style:{padding:"8px 12px",margin:"8px 0",backgroundColor:"rgba(95, 51, 255, 0.1)",border:"1px solid rgba(95, 51, 255, 0.3)",borderRadius:"8px",color:"#7C5AFF",fontSize:"12px",fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",textAlign:"center",animation:"pulse 1.5s infinite"},children:"ðŸ§  Auto-cleaning up text..."}),o.jsxs("div",{className:"button-row",style:{marginBottom:0,transition:"margin-bottom 0.3s ease",gap:16},children:[o.jsx("button",{onClick:ge,disabled:B||U,style:{padding:"10px 20px",background:"linear-gradient(135deg, #3ABC96 0%, #2a9b7a 100%)",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:16,fontSize:14,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",color:"#FFFFFF",boxShadow:"0 4px 12px rgba(58, 188, 150, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.15)",width:120,opacity:B||U?.5:1,pointerEvents:B||U?"none":"auto",transition:"all 0.2s ease",transform:"translateY(0)",cursor:"pointer"},onMouseEnter:e=>{!B&&!U&&(e.currentTarget.style.background="linear-gradient(135deg, #2a9b7a 0%, #238463 100%)",e.currentTarget.style.transform="translateY(-2px) scale(1.02)",e.currentTarget.style.boxShadow="0 6px 16px rgba(58, 188, 150, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2)",e.currentTarget.style.borderColor="rgba(255, 255, 255, 0.2)")},onMouseLeave:e=>{!B&&!U&&(e.currentTarget.style.background="linear-gradient(135deg, #3ABC96 0%, #2a9b7a 100%)",e.currentTarget.style.transform="translateY(0)",e.currentTarget.style.boxShadow="0 4px 12px rgba(58, 188, 150, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.15)",e.currentTarget.style.borderColor="rgba(255, 255, 255, 0.1)")},children:"Report"}),o.jsx("button",{onClick:fe,disabled:B||U,style:{padding:"10px 20px",background:"linear-gradient(135deg, #3ABC96 0%, #2a9b7a 100%)",backdropFilter:"blur(12px) saturate(180%)",WebkitBackdropFilter:"blur(12px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:16,fontSize:14,fontWeight:300,fontFamily:"SF Pro, -apple-system, BlinkMacSystemFont, sans-serif",color:"#FFFFFF",boxShadow:"0 4px 12px rgba(58, 188, 150, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.15)",width:120,opacity:B||U?.5:1,pointerEvents:B||U?"none":"auto",transition:"all 0.2s ease",transform:"translateY(0)",cursor:"pointer"},onMouseEnter:e=>{!B&&!U&&(e.currentTarget.style.background="linear-gradient(135deg, #2a9b7a 0%, #238463 100%)",e.currentTarget.style.transform="translateY(-2px) scale(1.02)",e.currentTarget.style.boxShadow="0 6px 16px rgba(58, 188, 150, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2)",e.currentTarget.style.borderColor="rgba(255, 255, 255, 0.2)")},onMouseLeave:e=>{!B&&!U&&(e.currentTarget.style.background="linear-gradient(135deg, #3ABC96 0%, #2a9b7a 100%)",e.currentTarget.style.transform="translateY(0)",e.currentTarget.style.boxShadow="0 4px 12px rgba(58, 188, 150, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.15)",e.currentTarget.style.borderColor="rgba(255, 255, 255, 0.1)")},children:"Impression"})]}),Q&&o.jsxs("div",{className:"card",children:[o.jsx("h3",{children:"ðŸ§  Prompt Sent to GPT:"}),o.jsx("pre",{children:Je}),o.jsx("h3",{children:"ðŸ“¥ Raw GPT Response:"}),o.jsx("pre",{children:He})]}),o.jsx(Pe,{visible:ee,selected:Y,onSelect:e=>{var a,u;O(e),Z.setItem("dictationTarget",e),(u=(a=window==null?void 0:window.electron)==null?void 0:a.ipcRenderer)==null||u.invoke("set-dictation-target",e)},onClose:()=>{var e,a;q(!1),C||(W(!0),Z.setItem("autoFindings","true"),(a=(e=window==null?void 0:window.electron)==null?void 0:e.ipcRenderer)==null||a.send("resize-main-ui",!0))},onCancel:()=>{q(!1)}}),o.jsx(Ne,{visible:he,onClose:()=>se(!1)})]}),t&&o.jsxs("div",{style:{height:"50px",display:"flex",alignItems:"center",justifyContent:"space-between",padding:"0 16px",boxSizing:"border-box",overflow:"visible",position:"relative"},children:[o.jsx("div",{style:{position:"absolute",top:0,left:80,right:160,height:50,WebkitAppRegion:"drag",zIndex:999},onDoubleClick:e=>e.preventDefault()}),o.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",WebkitAppRegion:"no-drag",zIndex:1002},children:[o.jsx("button",{className:"radpal-button-report radpal-button-mini",onClick:ge,disabled:B||U,style:{padding:"2px 6px",fontSize:11,lineHeight:1.1,color:"#fff",fontFamily:"SF Pro, system-ui, sans-serif",fontWeight:400,opacity:B||U?.5:1,pointerEvents:B||U?"none":"auto"},children:"Report"}),o.jsx("button",{className:"radpal-button-impression radpal-button-mini",onClick:fe,disabled:B||U,style:{padding:"2px 6px",fontSize:11,lineHeight:1.1,color:"#fff",fontFamily:"SF Pro, system-ui, sans-serif",fontWeight:400,opacity:B||U?.5:1,pointerEvents:B||U?"none":"auto"},children:"Impression"})]}),o.jsxs("div",{style:{display:"flex",gap:"6px",alignItems:"center",WebkitAppRegion:"no-drag",zIndex:1002},children:[o.jsx("button",{onClick:$e,style:{background:"rgba(255, 255, 255, 0.05)",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",border:"1px solid rgba(255, 255, 255, 0.08)",borderRadius:16,padding:"4px 10px",color:"#ccc",transition:"all 0.2s ease",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.1)",cursor:"pointer"},onMouseEnter:e=>{e.currentTarget.style.background="rgba(255, 255, 255, 0.15)",e.currentTarget.style.borderColor="rgba(255, 255, 255, 0.15)",e.currentTarget.style.color="#fff",e.currentTarget.style.transform="translateY(-1px)",e.currentTarget.style.boxShadow="0 3px 6px rgba(0, 0, 0, 0.15)"},onMouseLeave:e=>{e.currentTarget.style.background="rgba(255, 255, 255, 0.05)",e.currentTarget.style.borderColor="rgba(255, 255, 255, 0.08)",e.currentTarget.style.color="#ccc",e.currentTarget.style.transform="translateY(0)",e.currentTarget.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)"},children:"+"}),o.jsx("button",{onClick:_e,style:{background:"rgba(255, 255, 255, 0.05)",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",border:"1px solid rgba(255, 255, 255, 0.08)",borderRadius:16,padding:"4px 10px",color:"#ccc",transition:"all 0.2s ease",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.1)",cursor:"pointer"},onMouseEnter:e=>{e.currentTarget.style.background="rgba(255, 255, 255, 0.15)",e.currentTarget.style.borderColor="rgba(255, 255, 255, 0.15)",e.currentTarget.style.color="#fff",e.currentTarget.style.transform="translateY(-1px)",e.currentTarget.style.boxShadow="0 3px 6px rgba(0, 0, 0, 0.15)"},onMouseLeave:e=>{e.currentTarget.style.background="rgba(255, 255, 255, 0.05)",e.currentTarget.style.borderColor="rgba(255, 255, 255, 0.08)",e.currentTarget.style.color="#ccc",e.currentTarget.style.transform="translateY(0)",e.currentTarget.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)"},children:"â€“"}),o.jsx("button",{onClick:Ce,style:{background:"linear-gradient(135deg, #E36756 0%, #c85545 100%)",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:16,padding:"4px 10px",color:"#fff",transition:"all 0.2s ease",boxShadow:"0 2px 6px rgba(227, 103, 86, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1)",cursor:"pointer"},onMouseEnter:e=>{e.currentTarget.style.background="linear-gradient(135deg, #c85545 0%, #b04436 100%)",e.currentTarget.style.transform="translateY(-1px)",e.currentTarget.style.boxShadow="0 4px 8px rgba(227, 103, 86, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.15)",e.currentTarget.style.borderColor="rgba(255, 255, 255, 0.15)"},onMouseLeave:e=>{e.currentTarget.style.background="linear-gradient(135deg, #E36756 0%, #c85545 100%)",e.currentTarget.style.transform="translateY(0)",e.currentTarget.style.boxShadow="0 2px 6px rgba(227, 103, 86, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1)",e.currentTarget.style.borderColor="rgba(255, 255, 255, 0.1)"},children:"Ã—"})]})]}),oe&&o.jsxs(o.Fragment,{children:[o.jsx("div",{className:`settings-sidebar-overlay ${oe?"open":""}`,onClick:()=>te(!1)}),o.jsxs("div",{className:`settings-sidebar ${oe?"open":""}`,children:[o.jsxs("div",{className:"settings-sidebar-header",children:[o.jsx("h2",{className:"settings-sidebar-title",children:"Settings"}),o.jsx("button",{className:"settings-sidebar-close",onClick:()=>te(!1),children:"Ã—"})]}),o.jsxs("div",{className:"settings-sidebar-content",children:[o.jsx("button",{className:"settings-sidebar-item",onClick:()=>{var e,a;(a=(e=window.electron)==null?void 0:e.ipcRenderer)==null||a.send("open-popup-templates")},children:"â€» Manage Templates"}),o.jsx("button",{className:"settings-sidebar-item",onClick:()=>{be(!0),te(!1)},children:"âš¡ Edit Logic"}),o.jsx("button",{className:`settings-sidebar-item ${C?"active":""}`,onClick:()=>{var e,a;C?(W(!1),Z.setItem("autoFindings","false"),(a=(e=window==null?void 0:window.electron)==null?void 0:e.ipcRenderer)==null||a.send("resize-main-ui",!1)):q(!0)},children:"â†» Auto-pull"}),o.jsx("button",{className:"settings-sidebar-item",onClick:()=>{se(!0)},children:"âŒ¨ï¸ Keyboard Shortcuts"}),o.jsxs("div",{className:"settings-sidebar-section",style:{marginTop:"20px",marginBottom:"10px"},children:[o.jsx("h3",{className:"settings-sidebar-section-title",style:{margin:"0 0 12px 0",padding:"8px 16px",textAlign:"center",fontSize:"14px",fontWeight:600,color:"#fff",backgroundColor:"rgba(255, 255, 255, 0.1)",borderRadius:"8px",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif"},children:"Backup & Restore"}),o.jsx("button",{className:"settings-sidebar-item",onClick:Ye,children:"ðŸ‘ï¸ View Offline Data"}),o.jsx("button",{className:"settings-sidebar-item",onClick:Ue,children:"ðŸ’¾ Export Backup"}),o.jsx("button",{className:"settings-sidebar-item",onClick:Ge,children:"ðŸ“¥ Import Backup"})]}),o.jsx("button",{className:"settings-sidebar-item danger",onClick:()=>{Le("logout")},children:"â†’ Log Out"})]})]})]}),Q&&o.jsxs("div",{style:{position:"fixed",bottom:20,right:20,background:"rgba(20, 20, 20, 0.95)",border:"1px solid #333",borderRadius:8,padding:"12px",color:"#fff",fontSize:12,maxWidth:300,zIndex:1e4},children:[o.jsxs("div",{children:["API Provider: ",D]}),o.jsxs("div",{children:["Window Size: ",n,"px"]}),o.jsxs("div",{children:["User: ",(k==null?void 0:k.email)||"Not logged in"]}),o.jsxs("div",{children:["Templates Loading: ",U?"Yes":"No"]}),o.jsxs("div",{children:["GPT Loading: ",B?"Yes":"No"]}),o.jsxs("div",{children:["Contracted: ",t?"Yes":"No"]})]}),!t&&o.jsxs(o.Fragment,{children:[o.jsx(Pe,{visible:ee,selected:Y,onSelect:e=>{var a,u;O(e),Z.setItem("dictationTarget",e),(u=(a=window==null?void 0:window.electron)==null?void 0:a.ipcRenderer)==null||u.invoke("set-dictation-target",e)},onClose:()=>{var e,a;q(!1),C||(W(!0),Z.setItem("autoFindings","true"),(a=(e=window==null?void 0:window.electron)==null?void 0:e.ipcRenderer)==null||a.send("resize-main-ui",!0))},onCancel:()=>{q(!1)}}),o.jsx(Ne,{visible:he,onClose:()=>se(!1)}),We&&o.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.4)",backdropFilter:"blur(4px)",WebkitBackdropFilter:"blur(4px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:9999},children:o.jsxs("div",{style:{width:"90%",maxWidth:"800px",height:"80%",backgroundColor:"rgba(42, 45, 49, 0.95)",backdropFilter:"blur(12px)",WebkitBackdropFilter:"blur(12px)",borderRadius:16,border:"1px solid rgba(255, 255, 255, 0.1)",display:"flex",flexDirection:"column",overflow:"hidden"},children:[o.jsxs("div",{style:{padding:"20px 24px",borderBottom:"1px solid rgba(255, 255, 255, 0.1)",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[o.jsx("h2",{style:{margin:0,color:"#fff",fontSize:"20px",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:600},children:"Offline Data Viewer"}),o.jsx("button",{onClick:()=>ce(!1),style:{background:"none",border:"none",color:"#fff",fontSize:"24px",cursor:"pointer",padding:"4px",borderRadius:"4px",lineHeight:1},children:"Ã—"})]}),o.jsx("div",{style:{flex:1,padding:"20px 24px",overflow:"auto",color:"#fff",fontFamily:"'JetBrains Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace",fontSize:"13px",lineHeight:"1.5"},children:o.jsx("pre",{style:{margin:0,whiteSpace:"pre-wrap",wordBreak:"break-word"},children:JSON.stringify(R.exportOfflineData(),null,2)})}),o.jsxs("div",{style:{padding:"16px 24px",borderTop:"1px solid rgba(255, 255, 255, 0.1)",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[o.jsxs("span",{style:{color:"rgba(255, 255, 255, 0.7)",fontSize:"12px",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif"},children:["Last sync: ",((Ee=R.getLastSync())==null?void 0:Ee.toLocaleString())||"Never"]}),o.jsxs("div",{style:{display:"flex",gap:"12px"},children:[o.jsx("button",{onClick:()=>{navigator.clipboard.writeText(JSON.stringify(R.exportOfflineData(),null,2)),P("ðŸ“‹ Copied to clipboard!")},style:{padding:"8px 16px",backgroundColor:"#3b82f6",color:"#fff",border:"none",borderRadius:"6px",fontSize:"14px",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:500,cursor:"pointer"},children:"ðŸ“‹ Copy JSON"}),o.jsx("button",{onClick:()=>{R.clearAll(),P("ðŸ—‘ï¸ All offline data cleared!"),ce(!1)},style:{padding:"8px 16px",backgroundColor:"#dc2626",color:"#fff",border:"none",borderRadius:"6px",fontSize:"14px",fontFamily:"'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif",fontWeight:500,cursor:"pointer"},children:"ðŸ—‘ï¸ Clear All"})]})]})]})})]}),De&&(k==null?void 0:k.id)&&o.jsx(wt,{userId:k.id,studyType:N||"",templates:J,onClose:()=>be(!1),isOfflineMode:b}),f&&o.jsx("div",{style:{position:"fixed",top:"20px",right:"20px",background:"#ff6b6b",color:"white",padding:"12px 16px",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",zIndex:1e4,fontSize:"14px",maxWidth:"300px",pointerEvents:"none"},children:f})]})}):o.jsx("div",{className:"radpal-outer-frame",children:o.jsx("div",{className:"window-frame",children:o.jsx(ht,{})})})});console.log("ðŸ”¥ MAIN.TSX LOADING - Entry point reached!");console.log("ðŸ”¥ MAIN.TSX IMPORTS COMPLETE - About to render App");Ve.createRoot(document.getElementById("root")).render(o.jsx(Oe.StrictMode,{children:o.jsx(kt,{})}));
